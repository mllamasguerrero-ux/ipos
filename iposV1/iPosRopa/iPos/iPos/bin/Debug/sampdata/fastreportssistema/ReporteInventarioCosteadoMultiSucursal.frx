<?xml version="1.0" encoding="utf-8"?>
<Report ScriptLanguage="CSharp" ReportInfo.Created="11/09/2016 11:16:58" ReportInfo.Modified="11/28/2016 19:32:04" ReportInfo.CreatorVersion="2013.3.2.0">
  <ScriptText>using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Windows.Forms;
using System.Drawing;
using System.Data;
using FastReport;
using FastReport.Data;
using FastReport.Dialog;
using FastReport.Barcode;
using FastReport.Table;
using FastReport.Utils;

namespace FastReport
{
  public class DatosReporte
  {
    private string claveProducto;
    public string ClaveProducto
    {
      get
      {
        return this.claveProducto;
      }
      set
      {
        this.claveProducto = value;
      }
    }
    
    private string lineaNombre;
    public string LineaNombre
    {
      get
      {
        return this.lineaNombre;
      }
      set
      {
        this.lineaNombre = value;
      }
    }
    
    private string claveProveedor;
    public string ClaveProveedor
    {
      get
      {
        return this.claveProveedor;
      }
      set
      {
        this.claveProveedor = value;
      }
    }
    
    private string descripcion1;
    public string Descripcion1
    {
      get
      {
        return this.descripcion1;
      }
      set
      {
        this.descripcion1 = value;
      }
    }
    
    private string descripcion2;
    public string Descripcion2
    {
      get
      {
        return this.descripcion2;
      }
      set
      {
        this.descripcion2 = value;
      }
    }
    
    public System.Collections.Generic.Dictionary&lt;string, decimal&gt; existenciaSucursales = new System.Collections.Generic.Dictionary&lt;string, decimal&gt;();
    
    private decimal existenciaTotal;
    public decimal ExistenciaTotal
    {
      get
      {
        return this.existenciaTotal;
      }
      set
      {
        this.existenciaTotal = value;
      }
    }
    
    private decimal costoRepo;
    public decimal CostoRepo
    {
      get
      {
        return this.costoRepo;
      }
      set
      {
        this.costoRepo = value;
      }
    }
    
    private decimal totalCostoRepo;
    public decimal TotalCostoRepo
    {
      get
      {
        return this.totalCostoRepo;
      }
      set
      {
        this.totalCostoRepo = value;
      }
    }
    
  }
  public class ReportScript
  {                      
    
    private void ImprimirRegistros(ref System.Collections.Generic.Dictionary&lt;string, DatosReporte&gt; datosP, int numSucursales)
    {
      int contReg = 2;
      bool imprimirHeaders = true;
      FastReport.Table.TableCell tc = null;
      Table1.PrintRow(0);
      
      foreach(KeyValuePair&lt;string, DatosReporte&gt; entry in datosP)
      { 
        FastReport.Table.TableRow tr =  new FastReport.Table.TableRow();
        
        DatosReporte dr = entry.Value;
        
        
        if(imprimirHeaders)
        {
          Table1.ColumnCount = (8 + numSucursales);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;ClaveProveedor&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Linea&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;ClaveProducto&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tc.Width=12.3f * Units.Centimeters;
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Descripcion1&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Descripcion2&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          /*foreach(DatosReporte suc in entry.Value)
          {  */
            foreach(string sucName in dr.existenciaSucursales.Keys)
            {
              tc = new FastReport.Table.TableCell();
              tc.Text = sucName;
              tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
              tr.AddChild(tc);
            }

          //} 
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Existencia Total&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Costo Repo&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          tc = new FastReport.Table.TableCell();
          tc.Text = &quot;Total Costo Repo&quot;;
          tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
          tr.AddChild(tc);
          
          Table1.Rows.Add(tr);
          Table1.PrintRow(1); 
          Table1.PrintColumns();
          imprimirHeaders = false;
        }
        
        
        //imprimir datos
        tr =  new FastReport.Table.TableRow();
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.ClaveProveedor;
        tr.AddChild(tc);
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.LineaNombre;
        tr.AddChild(tc);
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.ClaveProducto;
        tr.AddChild(tc);
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.Descripcion1;
        tr.AddChild(tc);
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.Descripcion2;
        tr.AddChild(tc);
        
        foreach(KeyValuePair&lt;string, decimal&gt; es in dr.existenciaSucursales)
        {
          tc = new FastReport.Table.TableCell();
          tc.Format = new FastReport.Format.NumberFormat();
          tc.Text = es.Value.ToString();
          dr.ExistenciaTotal += es.Value;
          tr.AddChild(tc);
        }
        
        tc = new FastReport.Table.TableCell();
        tc.Text = dr.ExistenciaTotal.ToString();
        tc.Format = new FastReport.Format.NumberFormat();
        tr.AddChild(tc);
        
        
        tc = new FastReport.Table.TableCell();
        //aqui puedes investigar bien con c# como formatear la conversion a string
        //tc.Format=Format(&quot;{0:$#,##0.00}&quot;, 1024.25) //FastReport.Format.FormatBase.Number;
        //tc.Format.UseLocale=&quot;true&quot;;
        tc.HorzAlign= FastReport.HorzAlign.Right;
        tc.Text = dr.CostoRepo.ToString(&quot;#,0.00#&quot;);
        tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
        tc.Format = new FastReport.Format.CurrencyFormat();
        tr.AddChild(tc);
        
        
        dr.TotalCostoRepo = dr.ExistenciaTotal * dr.CostoRepo;
        tc = new FastReport.Table.TableCell();
        tc.HorzAlign= FastReport.HorzAlign.Right;
        tc.Text = dr.TotalCostoRepo.ToString(&quot;#,0.00#&quot;);
        tc.Font = new System.Drawing.Font(&quot;Microsoft Sans Serif&quot;, 8.25F, System.Drawing.FontStyle.Regular, System.Drawing.GraphicsUnit.Point, ((byte)(0)));
        tc.Format = new FastReport.Format.CurrencyFormat();
        tr.AddChild(tc);
        
        Table1.Rows.Add(tr);
        Table1.PrintRow(contReg); 
        Table1.PrintColumns();
        contReg++;
      }
    }
    
    private void Table1_ManualBuild(object sender, EventArgs e)
    {
      System.Collections.Generic.Dictionary&lt;string, DatosReporte&gt; datosP = new System.Collections.Generic.Dictionary&lt;string, DatosReporte&gt;(); // string seria la clave de producto
      DatosReporte dr = new DatosReporte();
      
      int iCount = 0; 
      string strCadenasConexion = ((String)Report.GetParameterValue(&quot;conexiones&quot;));//TextBox1.Text;//&quot;initial catalog=C:\\IposProject\\iPosRopa\\iPos\\iPos\\bin\\Debug\\sampdata\\IPOSDB.fdb;user id=sysdba;password=masterkey|initial catalog=C:\\IPOSTHINGS\\fama\\fama.fdb;user id=sysdba;password=masterkey&quot;;
      
      string[] cadenasConexion  = strCadenasConexion.Split(new string[] { &quot;masterkey&quot; }, StringSplitOptions.None); //strCadenasConexion.Split('|');
      iCount  = cadenasConexion.Length;
                            
      
      foreach(string strCadena in cadenasConexion)
      {    
        
       String strConexion = strCadena;
        if(strCadena.Trim().Length == 0)
          continue;
                                  
        
        strConexion += &quot;masterkey&quot;;
        
        dr = new DatosReporte();
        Report.Dictionary.Connections[0].ConnectionString = strConexion;
        DataSourceBase rowDataSuc1 = Report.GetDataSource(&quot;Table&quot;); 
        rowDataSuc1.ForceLoadData = true;
        rowDataSuc1.Init();
        rowDataSuc1.First();
        
        DataSourceBase rowDataSuc2 = Report.GetDataSource(&quot;Suc&quot;); 
        rowDataSuc2.ForceLoadData = true;
        rowDataSuc2.Init();
        rowDataSuc2.First();
        
        while(rowDataSuc1.HasMoreRows &amp;&amp; rowDataSuc2.HasMoreRows)
        {
          dr = new DatosReporte();
          if(datosP.ContainsKey(((String)Report.GetColumnValue(&quot;Table.CLAVEPORDUCTO&quot;))))//aqui iria el if llave no existe en el dicti
          {
            dr = datosP[((String)Report.GetColumnValue(&quot;Table.CLAVEPORDUCTO&quot;))];
            //MessageBox.Show(((String)Report.GetColumnValue(&quot;Suc.NOMBRE&quot;)));
            try{
              dr.existenciaSucursales.Add(((String)Report.GetColumnValue(&quot;Suc.NOMBRE&quot;)), ((Decimal)Report.GetColumnValue(&quot;Table.EXISTENCIA&quot;)));
            }
            catch(Exception ex)
            {
              
            }  
          } 
          else
          {
             
            try{
              dr.ClaveProveedor = ((String)Report.GetColumnValue(&quot;Table.CLAVEPROVEEDOR&quot;));
            }
            catch(Exception ex)
            {
              dr.ClaveProveedor = &quot;&quot;;
            }
            
            try{
              dr.LineaNombre = ((String)Report.GetColumnValue(&quot;Table.LINEANOMBRE&quot;));
            }
            catch(Exception ex)
            {
              dr.LineaNombre = &quot;&quot;;
            }
            
            try{
              dr.ClaveProducto = ((String)Report.GetColumnValue(&quot;Table.CLAVEPORDUCTO&quot;));
            }
            catch(Exception ex)
            {
              dr.ClaveProducto = &quot;&quot;;
            }
            
            try{
              dr.Descripcion1 = ((String)Report.GetColumnValue(&quot;Table.DESCRIPCION1&quot;));
            }
            catch(Exception ex)
            {
              dr.Descripcion1 = &quot;&quot;;
            }
            
            try{
              dr.Descripcion2 = ((String)Report.GetColumnValue(&quot;Table.DESCRIPCION2&quot;));
            }
            catch(Exception ex)
            {
              dr.Descripcion2 = &quot;&quot;;
            }
            
            try{
              dr.existenciaSucursales.Add(((String)Report.GetColumnValue(&quot;Suc.NOMBRE&quot;)), ((Decimal)Report.GetColumnValue(&quot;Table.EXISTENCIA&quot;)));
            }
            catch(Exception ex)
            {
              
            }
            
            try{
              dr.CostoRepo = ((Decimal)Report.GetColumnValue(&quot;Table.COSTOREPOSICION&quot;));
            }
            catch(Exception ex)
            {
              dr.CostoRepo   = 0;
            }
            
            
            datosP.Add(((String)Report.GetColumnValue(&quot;Table.CLAVEPORDUCTO&quot;)) ,dr);
          }
          rowDataSuc1.Next();
        }
        
         // datosP.Add(dr);
        //MessageBox.Show(strCadena + &quot;masterkey&quot;);
       //ImprimeFilas( ref iCount,  strCadena + &quot;masterkey&quot;);
         //MessageBox.Show(((String)Report.GetColumnValue(&quot;Suc.NOMBRE&quot;)));
         rowDataSuc2.Next();
      }
      ImprimirRegistros(ref datosP, iCount);
      
      Table1.ResultTable.AfterCalcBounds += new EventHandler(ResultTable_AfterCalcBounds);
      
      datosP = null;
      
    }
    
    private void ResultTable_AfterCalcBounds(object sender, EventArgs e)
    {
      TableResult resultTable = sender as TableResult;
      float tableWidth = resultTable.Width;
      float pageWidth = Engine.PageWidth;
      
      if (tableWidth &gt; pageWidth)
      {
        // table is wider than page, correct the columns width
        float ratio =  tableWidth / pageWidth;
        //foreach (TableColumn column in resultTable.Columns)
        //{
          Page1.PaperWidth = 39;     
       // Report.Page.Width = tableWidth + 100;
          //column.AutoSize = false;
          //column.Width *= ratio;
       // }
        
        // this will recalculate table rows height
        resultTable.CalcHeight();
      }
    }
    
  }
  
}
</ScriptText>
  <Dictionary>
    <FirebirdDataConnection Name="Connection" ConnectionString="rijcmlqDEsChHWgW5OFiwSyA3zls2mCAWDWIhtE3dZ3WRoD3RGa4fuV4MzKWm/7hfiVWbDFvOZVx8SOHX0gb5rmLrybnbvH2HsHWOfPgCFQoKr29izDhiy+8Awj/+LeDV/2ybkkaRwuppBeY+kFp2ZduFz9uhVrN3BzvblLh5n/XvAUUdM=">
      <TableDataSource Name="Table" DataType="System.Int32" Enabled="true" SelectCommand="select p.CLAVE ClaveProveedor, l.NOMBRE LineaNombre, pr.CLAVE ClavePorducto, pr.DESCRIPCION1, pr.DESCRIPCION2, pr.EXISTENCIA, pr.COSTOREPOSICION&#13;&#10;from PRODUCTO pr&#13;&#10;left join PERSONA p on p.id = pr.proveedor1id&#13;&#10;left join LINEA l on l.id = pr.lineaid&#13;&#10;where  (p.clave = @proveedorclave or @proveedorclave =cast('' as D_CLAVE_NULL)) and&#13;&#10;(l.clave = @lineaclave or  @lineaclave = cast('' as D_CLAVE_NULL)) and&#13;&#10;(pr.inventariable = 'S')&#13;&#10;order by p.clave">
        <Column Name="DESCRIPCION1" DataType="System.String"/>
        <Column Name="DESCRIPCION2" DataType="System.String"/>
        <Column Name="EXISTENCIA" DataType="System.Decimal"/>
        <Column Name="COSTOREPOSICION" DataType="System.Decimal"/>
        <Column Name="CLAVEPROVEEDOR" DataType="System.String"/>
        <Column Name="LINEANOMBRE" DataType="System.String"/>
        <Column Name="CLAVEPORDUCTO" DataType="System.String"/>
        <CommandParameter Name="proveedorclave" DataType="16" Expression="[proveedorclave]" DefaultValue="&quot;&quot;"/>
        <CommandParameter Name="lineaclave" DataType="16" Expression="[lineaclave]" DefaultValue="&quot;&quot;"/>
      </TableDataSource>
      <TableDataSource Name="Table2" Alias="Suc" DataType="System.Int32" Enabled="true" SelectCommand="select first 1 sucursal.clave, sucursal.nombre&#13;&#10;from parametro&#13;&#10;left join sucursal on sucursal.id = parametro.sucursalid">
        <Column Name="CLAVE" DataType="System.String"/>
        <Column Name="NOMBRE" DataType="System.String"/>
      </TableDataSource>
    </FirebirdDataConnection>    <Parameter Name="US_ID" DataType="System.Decimal"/>    <Parameter Name="US_NAME" DataType="System.String"/>
    <Parameter Name="conexiones" DataType="System.String"/>
    <Parameter Name="proveedorclave" DataType="System.String"/>
    <Parameter Name="lineaclave" DataType="System.String"/>
  </Dictionary>
  <ReportPage Name="Page1" Landscape="true" PaperWidth="500" PaperHeight="210" FirstPageSource="15" OtherPagesSource="15">
    <ReportTitleBand Name="ReportTitle1" Width="1814.4" Height="37.8"/>
    <PageHeaderBand Name="PageHeader1" Top="41.8" Width="1814.4" Height="28.35"/>
    <DataBand Name="Data1" Top="74.15" Width="1814.4" Height="47.25">
      <TableObject Name="Table1" Left="9.45" Top="9.45" Width="1266.3" Height="18.9" ManualBuildEvent="Table1_ManualBuild">
        <TableColumn Name="Column1" Width="103.95"/>
        <TableColumn Name="Column2" Width="103.95"/>
        <TableColumn Name="Column3" Width="103.95"/>
        <TableColumn Name="Column4" Width="122.85"/>
        <TableColumn Name="Column5" Width="132.3"/>
        <TableColumn Name="Column6" Width="94.5"/>
        <TableColumn Name="Column7" Width="94.5"/>
        <TableColumn Name="Column8" Width="103.95"/>
        <TableColumn Name="Column9" Width="94.5"/>
        <TableColumn Name="Column10" Width="85.05"/>
        <TableColumn Name="Column11" Width="85.05"/>
        <TableColumn Name="Column12" Width="75.6"/>
        <TableColumn Name="Column13"/>
        <TableRow Name="Row1">
          <TableCell Name="Cell1"/>
          <TableCell Name="Cell2"/>
          <TableCell Name="Cell3"/>
          <TableCell Name="Cell4"/>
          <TableCell Name="Cell5"/>
          <TableCell Name="Cell6"/>
          <TableCell Name="Cell7"/>
          <TableCell Name="Cell8"/>
          <TableCell Name="Cell9"/>
          <TableCell Name="Cell10"/>
          <TableCell Name="Cell11"/>
          <TableCell Name="Cell12"/>
          <TableCell Name="Cell13"/>
        </TableRow>
      </TableObject>
    </DataBand>
    <PageFooterBand Name="PageFooter1" Top="125.4" Width="1814.4" Height="18.9"> <TextObject Name="TextFooterGeneral2" Left="151.2" Width="66.15" Height="18.9" PrintOn="LastPage, OddPages, EvenPages, RepeatedBand, SinglePage" Text="[Date]" Format="Date" Format.Format="d" Font="Arial, 8pt, style=Bold"/> <TextObject Name="TextFooterGeneral3" Left="217.35" Width="151.2" Height="18.9" CanShrink="true" PrintOn="LastPage, OddPages, EvenPages, RepeatedBand, SinglePage" CanBreak="false" Text="[Date]" Format="Time" Format.Format="T" WordWrap="false" Font="Arial, 8pt, style=Bold"/> <TextObject Name="TextFooterGeneral1" Left="9.45" Width="141.75" Height="18.9" CanShrink="true" CanBreak="false" Text="Power by I-POS" HorzAlign="Center" WordWrap="false" Font="Arial, 8pt, style=Bold"/> <TextObject Name="TextFooterGeneral4" Left="368.55" Width="94.5" Height="18.9" Text="[US_NAME]" Font="Arial, 8pt, style=Bold"/> </PageFooterBand>
  </ReportPage>
</Report>
