create or alter procedure VENTAFUTUROAPLICACION_COMPLETAR (
    DOCTOID D_FK,
    OBSERVACION D_OBSERVACION,
    REFERENCIAS D_REFERENCIA,
    VENDEDORID D_FK,
    MANTENERRESTANTE D_BOOLCS)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable TIPODOCTOID D_FK;
declare variable ESTATUSDOCTOID D_FK;
declare variable CANTIDAD D_CANTIDAD;
declare variable MOVTOREFID D_FK;
declare variable VENTAFUTUID D_FK;
declare variable FALTANTE integer;
BEGIN
   -- Si no es documento de compra 11.
   IF ((:DOCTOID IS NULL) OR (:DOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1060;
      SUSPEND;
      EXIT;
   END

   -- Validar estatus.
   SELECT TIPODOCTOID, ESTATUSDOCTOID, VENTAFUTUID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :TIPODOCTOID, :ESTATUSDOCTOID, :VENTAFUTUID;

   -- Si no es documento de compra 21.
   IF ((:TIPODOCTOID IS NULL) OR (:TIPODOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1060;
      SUSPEND;
      EXIT;
   END

   -- Si no es documento de compra 21.
   IF (:TIPODOCTOID <> 21 ) THEN
   BEGIN
      ERRORCODE = 1061;
      SUSPEND;
      EXIT;
   END

   -- Si el estatus no es borrador .
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1062;
      SUSPEND;
      EXIT;
   END


    FOR
       SELECT MOVTOREFID, CANTIDAD
       FROM MOVTO WHERE DOCTOID  = :DOCTOID AND COALESCE(CANTIDAD,0) > 0 AND COALESCE(MOVTOREFID , 0) > 0
       INTO :MOVTOREFID, :CANTIDAD
     DO
     BEGIN
        UPDATE MOVTO SET CANTIDADSURTIDA = COALESCE(CANTIDADSURTIDA,0) + :CANTIDAD WHERE ID = :MOVTOREFID;
     END






   -- Completar el documento con afectacion de inventarios.
   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;
   
   IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
   


   UPDATE docto SET OBSERVACION = :OBSERVACION , REFERENCIA = :REFERENCIAS
   WHERE ID = :DOCTOID;

   UPDATE DOCTO SET VENTAFUTUID = :DOCTOID
   WHERE ID = :VENTAFUTUID AND  COALESCE(VENTAFUTUID,0) <> :DOCTOID ;



   SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :VENTAFUTUID AND COALESCE(CANTIDAD,0) > COALESCE(CANTIDADSURTIDA,0)
   INTO :FALTANTE;

   IF( COALESCE(:MANTENERRESTANTE,'S') <> 'S' OR  COALESCE(:FALTANTE,0) = 0) THEN
   BEGIN
    SELECT ERRORCODE FROM VENTAFUTUROFINALIZAR(:VENTAFUTUID) INTO :ERRORCODE;
    ERRORCODE = 0;
   END


   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1063;
      SUSPEND;
   END
END