create or alter procedure EMIDA_REAJUSTARUTILIDADES (
    FECHAINICIAL D_FECHA,
    FECHAFINAL D_FECHA)
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable EMIDAPORCUTILIDADRECARGAS D_PORCENTAJE;
declare variable EMIDAUTILIDADPAGOSERVICIOS D_PRECIO;
declare variable TIPOUTILIDADID D_PRECIO;
declare variable DOCTOID D_FK;
declare variable UTILIDAD D_PRECIO;
declare variable MOVTOID D_FK;
declare variable COSTOREPOSICION D_PRECIO;
BEGIN


   SELECT
    EMIDAPORCUTILIDADRECARGAS,
    EMIDAUTILIDADPAGOSERVICIOS,
    TIPOUTILIDADID
   FROM
    PARAMETRO 
   WHERE 1 = 1
   INTO
    :EMIDAPORCUTILIDADRECARGAS,
    :EMIDAUTILIDADPAGOSERVICIOS,
    :TIPOUTILIDADID;




    UPDATE MOVTO
    SET UTILIDAD = COALESCE(:EMIDAUTILIDADPAGOSERVICIOS,0)
    WHERE ID IN
    (SELECT MOVTO.ID FROM DOCTO INNER JOIN MOVTO ON MOVTO.DOCTOID = DOCTO.ID
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL AND
    DOCTO.TIPODOCTOID IN (21,23,25,26) and DOCTO.subtipodoctoid in (24)  AND DOCTO.ESTATUSDOCTOID = 1 ) ;


    
    FOR
     SELECT DOCTO.ID , SUM(COALESCE(MOVTO.utilidad,0)) UTILIDAD
     FROM DOCTO INNER JOIN MOVTO ON MOVTO.DOCTOID = DOCTO.ID
     WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL   AND
            DOCTO.TIPODOCTOID IN (21,23,25,26) and DOCTO.subtipodoctoid in (24)  AND DOCTO.ESTATUSDOCTOID = 1
     GROUP BY DOCTO.ID
     INTO :DOCTOID, :UTILIDAD
     DO
     BEGIN  
        UPDATE DOCTO SET UTILIDAD = :UTILIDAD WHERE ID = :DOCTOID;
     END


     FOR
        SELECT DOCTO.ID,MOVTO.ID MOVTOID, PRODUCTO.costoreposicion ,
           ( coalesce(MOVTO.precio,0)  - COALESCE(PRODUCTO.costoreposicion,0) ) * COALESCE(MOVTO.cantidad, 0) AS UTILIDAD

         FROM DOCTO INNER JOIN MOVTO ON MOVTO.DOCTOID = DOCTO.ID
         INNER JOIN PRODUCTO ON PRODUCTO.Id = movto.productoid
         WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL   AND
            DOCTO.TIPODOCTOID IN (21,23,25,26) and DOCTO.subtipodoctoid in (22) AND DOCTO.ESTATUSDOCTOID = 1

         INTO :DOCTOID,:MOVTOID, :COSTOREPOSICION  ,:UTILIDAD
    DO
    BEGIN
         
        UPDATE MOVTO
        SET
        COSTOREPOSICION  = COALESCE(:COSTOREPOSICION,0),
        UTILIDAD = COALESCE(:UTILIDAD,0)
        WHERE ID = :MOVTOID ;

        
            UPDATE DOCTO SET UTILIDAD = COALESCE(:UTILIDAD,0)
            WHERE ID = :DOCTOID;
    END









   ERRORCODE = 0;
   SUSPEND;
END