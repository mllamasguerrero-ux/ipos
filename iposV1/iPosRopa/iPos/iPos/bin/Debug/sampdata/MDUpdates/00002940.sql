create or alter procedure CONSOLIDADO_PORCONSOLIDAR (
    FECHAINICIAL D_FECHA,
    FECHAFINAL D_FECHA,
    OMITIRVENTASAFRANQUICIAS varchar(2))
returns (
    ID D_FK,
    FOLIO D_DOCTOFOLIO,
    SERIE D_DOCTOSERIE,
    IMPORTE D_PRECIO,
    DESCUENTO D_PRECIO,
    SUBTOTAL D_PRECIO,
    IVA D_PRECIO,
    IEPS D_PRECIO,
    IMPUESTO D_PRECIO,
    TOTAL D_PRECIO,
    SALDO D_PRECIO,
    ABONO D_PRECIO,
    CARGO D_PRECIO,
    TIPODOCTONOMBRE D_NOMBRE_NULL,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    TIPODOCTOID D_FK)
as
declare variable NUMERO integer;
BEGIN
   NUMERO = 0;


   FOR SELECT        DOCTO.ID,
            DOCTO.FOLIO,
            DOCTO.SERIE,
            COALESCE(DOCTO.IMPORTE,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPORTE,
            COALESCE(DOCTO.DESCUENTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS DESCUENTO,
                         COALESCE(DOCTO.SUBTOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SUBTOTAL,
                         COALESCE(DOCTO.IVA,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVA,
                         COALESCE(DOCTO.IEPS,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IEPS,
                         COALESCE(DOCTO.IMPUESTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPUESTO,
                         COALESCE(DOCTO.TOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS TOTAL,
                         COALESCE(DOCTO.SALDO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SALDO, 
                         COALESCE(DOCTO.ABONO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ABONO,
                         COALESCE(DOCTO.CARGO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS CARGO, 
                         TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
                         DOCTO.FECHA,
                         DOCTO.FECHAHORA ,
                         DOCTO.TIPODOCTOID

   FROM            DOCTO LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
         AND DOCTO.esfacturaelectronica = 'N'
         AND DOCTO.ESTATUSDOCTOID = 1
         AND DOCTO.TIPODOCTOID IN (21)
         AND (DOCTO.FACTCONSID IS NULL)
         AND (DOCTO.DEVCONSID IS NULL)
         AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8)))


        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) AS SUBTOTAL,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTOPAGO.FECHA,
            MIN(DOCTOPAGO.FECHAHORA) FECHAHORA ,
            DOCTODEV.TIPODOCTOID



        FROM    DOCTO INNER join
                DOCTOPAGO ON DOCTOPAGO.DOCTOID = DOCTO.id INNER JOIN
                DOCTO DOCTODEV ON DOCTOPAGO.doctosalidaid = DOCTODEV.ID  LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID


        WHERE
           (DOCTO.FECHA >= :FECHAINICIAL) AND
            (DOCTO.FECHA <= :FECHAFINAL) AND
            (DOCTO.ESFACTURAELECTRONICA = 'N') AND
            (DOCTO.ESTATUSDOCTOID = 1) AND
            ( DOCTO.TIPODOCTOID IN (21, 22)) AND 
            (DOCTO.FACTCONSID IS NULL) AND
            (DOCTO.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1 AND DOCTODEV.tipodoctoid = 22
            AND DOCTOPAGO.formapagoid IN (6,7,8,9,10,11,12,13)

         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTOPAGO.FECHA


           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) SUBTOTAL ,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            MIN(DOCTOPAGO.FECHAHORA) FECHAHORA ,
            DOCTODEV.TIPODOCTOID



        FROM    DOCTO DOCTODEV INNER join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (21, 22)) AND 
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22
            AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)

         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA

                   /*
           SELECT
           DOCTO.ID,
            DOCTO.FOLIO,
            DOCTO.SERIE,
            COALESCE(DOCTO.IMPORTE,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPORTE,
            COALESCE(DOCTO.DESCUENTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS DESCUENTO,
                         COALESCE(DOCTO.SUBTOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SUBTOTAL,
                         COALESCE(DOCTO.IVA,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVA,
                         COALESCE(DOCTO.IEPS,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IEPS,
                         COALESCE(DOCTO.IMPUESTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPUESTO,
                         COALESCE(DOCTO.TOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS TOTAL,
                         COALESCE(DOCTO.SALDO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SALDO, 
                         COALESCE(DOCTO.ABONO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ABONO,
                         COALESCE(DOCTO.CARGO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS CARGO, 
                         TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
                         DOCTO.FECHA,
                         DOCTO.FECHAHORA ,
                         DOCTO.TIPODOCTOID



   FROM            DOCTO LEFT OUTER JOIN
                   TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID  LEFT OUTER JOIN
                   DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTOID  AND DOCTOPAGO.FORMAPAGOID IN (1,2,3,5,15)
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
         AND DOCTO.esfacturaelectronica = 'N'
         AND DOCTO.ESTATUSDOCTOID = 1
         AND DOCTO.TIPODOCTOID IN (22)
         AND (DOCTO.FACTCONSID IS NULL)
         AND (DOCTO.DEVCONSID IS NULL)
         AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8)))


         GROUP BY
                DOCTO.ID,
                DOCTO.FOLIO,
                DOCTO.SERIE,
                DOCTO.IMPORTE,
                DOCTO.TIPODOCTOID,
                DOCTO.DESCUENTO ,
                DOCTO.SUBTOTAL,
                DOCTO.IVA ,
                DOCTO.IEPS,
                DOCTO.IMPUESTO,
                DOCTO.TOTAL ,
                DOCTO.SALDO ,
                DOCTO.ABONO ,
                DOCTO.CARGO,
                TIPODOCTO.NOMBRE ,
                DOCTO.FECHA,
                DOCTO.FECHAHORA
         HAVING   COUNT(DOCTOPAGO.ID) > 0   */

   INTO
          :ID ,
    :FOLIO ,
    :SERIE ,
    :IMPORTE ,
    :DESCUENTO ,
    :SUBTOTAL ,
    :IVA ,
    :IEPS ,
    :IMPUESTO ,
    :TOTAL ,
    :SALDO ,
    :ABONO ,
    :CARGO ,
    :TIPODOCTONOMBRE ,
    :FECHA ,
    :FECHAHORA,
    :TIPODOCTOID
   DO
   BEGIN
      NUMERO = :NUMERO + 1;
      SUSPEND;
   END

   if (:numero = 0) then
   begin
      ID = 0;
    FOLIO = 0;
    SERIE = '';
    IMPORTE = 0.0;
    DESCUENTO = 0.0;
    SUBTOTAL = 0.0;
    IVA = 0.0;
    IEPS  = 0.0;
    IMPUESTO  = 0.0;
    TOTAL  = 0.0;
    SALDO  = 0.0;
    ABONO  = 0.0;
    CARGO  = 0.0;
    TIPODOCTONOMBRE = '';
    FECHA = CURRENT_DATE;
    FECHAHORA = CURRENT_TIMESTAMP;
    TIPODOCTOID = 0;

   end

END