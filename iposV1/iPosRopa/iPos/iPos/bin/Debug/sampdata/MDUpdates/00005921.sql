CREATE OR ALTER trigger doctopago_ppc_insert_matriz_tr for doctopago
active after insert position 9998
AS
declare variable CLAVEMATRIZ D_CLAVE_NULL;
declare variable SUCURSALCLAVE D_CLAVE_NULL; 
declare variable DESTINOSUCURSALCLAVE D_CLAVE_NULL;
declare variable DOCTOSALIDAID D_CLAVE_NULL; 
declare variable TIPODOCTOSALIDAID D_CLAVE_NULL; 
declare variable SUBTIPODOCTOSALIDAID D_CLAVE_NULL;
declare variable ESTATUSDOCTOID D_FK;

declare variable TIPODOCTOENTRADAID D_CLAVE_NULL;  
declare variable SUBTIPODOCTOENTRADAID D_CLAVE_NULL; 
declare variable HABPPC D_BOOLCN;

begin
  /* Trigger text */
  -- SI NO CUMPLE CON LAS CONDICIONES RAPIDAS PARA SEGUIR , SALIRSE
  IF(NOT (NEW.FORMAPAGOID not in (4,6,7) AND COALESCE(NEW.DOCTOSALIDAID,0) > 0 AND
        COALESCE(NEW.TIPOPAGOID,0) = 2 AND COALESCE(NEW.TIPOABONOID,0) <> 3)) THEN
  BEGIN
     EXIT;
  END

    
  SELECT SUCURSALNUMERO, HABPPC FROM PARAMETRO INTO :SUCURSALCLAVE, :HABPPC;

  IF(COALESCE(:HABPPC,'N') <> 'S') THEN
  BEGIN
    EXIT;
  END

  SELECT FIRST 1 CLAVEMATRIZ FROM MATRIZPRINCIPAL INTO :CLAVEMATRIZ;

  IF(COALESCE(:SUCURSALCLAVE,'') = COALESCE(:CLAVEMATRIZ,'')) THEN
  BEGIN


    IF(NEW.FORMAPAGOID not in (4,6,7) AND COALESCE(NEW.DOCTOSALIDAID,0) > 0 AND
        COALESCE(NEW.TIPOPAGOID,0) = 2 AND COALESCE(NEW.TIPOABONOID,0) <> 3)  THEN
    BEGIN

        SELECT DOCTO.TIPODOCTOID, DOCTO.SUBTIPODOCTOID, SUCDEST.CLAVE DESTINOSUCURSALCLAVE FROM DOCTO
        LEFT JOIN SUCURSAL SUCDEST ON SUCDEST.ID = SUCURSALTID
        WHERE DOCTO.ID = NEW.DOCTOSALIDAID
        INTO :TIPODOCTOSALIDAID, :SUBTIPODOCTOSALIDAID, :DESTINOSUCURSALCLAVE;


        IF(COALESCE(:TIPODOCTOSALIDAID,0) = 1011
            AND COALESCE(:DESTINOSUCURSALCLAVE,'') <> '') THEN
         BEGIN
            
                UPDATE OR INSERT INTO REPLEXPOCTRL
                (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
                VALUES (:DESTINOSUCURSALCLAVE,  NEW.ID, CURRENT_TIMESTAMP, 2, 1)
                MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);
         END
    END

  END


end