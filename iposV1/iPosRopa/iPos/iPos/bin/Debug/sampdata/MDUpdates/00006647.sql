create or alter procedure FACTURAELECTRONICA_XML_CORE_1 (
    DOCTOID D_FK,
    DESGLOSEIEPSPARENT D_BOOLCN_NULL,
    MOSTRARDESCUENTOPARENT D_BOOLCN_NULL)
returns (
    ID D_FK,
    TIPOLINEA D_NOMBRE_NULL,
    PADRELINEA integer,
    ORDENLINEA integer,
    SUBORDEN integer,
    SERIE D_STDTEXT_64,
    FOLIO D_STDTEXT_64,
    FECHA D_TIMESTAMP,
    TIPOCOMPROBANTE D_STDTEXT_64,
    FORMAPAGO D_STDTEXT_64,
    SUBTOTAL D_IMPORTE,
    DESCUENTO D_IMPORTE,
    TOTAL D_IMPORTE,
    MONEDA D_STDTEXT_64,
    TIPOCAMBIO D_STDTEXT_64,
    CONDICIONESPAGO D_STDTEXT_LARGE,
    METODOPAGO D_STDTEXT_64,
    MOTIVODESCUENTO D_STDTEXT_64,
    LUGAREXPEDICION D_STDTEXT_LARGE,
    NUMEROCTAPAGO D_STDTEXT_LARGE,
    SERIEFOLIOFISCALORIGINAL D_STDTEXT_64,
    FOLIOFISCALORIGINAL D_STDTEXT_64,
    MONTOFOLIOFISCALORIGINAL D_IMPORTE,
    FECHAFOLIOFISCALORIGINAL D_FECHA,
    RFC D_STDTEXT_64,
    RAZONSOCIAL D_STDTEXT_LARGE,
    REGIMENFISCAL D_STDTEXT_64,
    CALLE D_STDTEXT_LARGE,
    NOINTERIOR D_STDTEXT_64,
    NOEXTERIOR D_STDTEXT_64,
    COLONIA D_STDTEXT_LARGE,
    LOCALIDAD D_STDTEXT_LARGE,
    REFERENCIA D_STDTEXT_LARGE,
    MUNICIPIO D_STDTEXT_LARGE,
    ESTADO D_STDTEXT_MEDIUM,
    PAIS D_STDTEXT_64,
    CODIGOPOSTAL D_STDTEXT_64,
    NOMBRE D_STDTEXT_LARGE,
    RESIDENCIAFISCAL D_STDTEXT_LARGE,
    NUMREGIDTRIB D_STDTEXT_64,
    USOCFDI D_STDTEXT_64,
    CANTIDAD D_CANTIDAD,
    UNIDAD D_STDTEXT_64,
    DESCRIPCION D_SAT_DESCRIPCION,
    VALORUNITARIO D_IMPORTE,
    IMPORTE D_IMPORTE,
    NOIDENTIFICACION D_STDTEXT_64,
    CUENTAPREDIAL D_STDTEXT_64,
    CLAVEPRODSERV D_STDTEXT_64,
    CLAVEUNIDAD D_STDTEXT_64,
    NUMERO D_STDTEXT_64,
    ADUANA D_STDTEXT_64,
    IMPUESTO D_STDTEXT_64,
    TASA D_PORCENTAJE,
    BASEIMP D_PRECIO,
    TIPOFACTOR D_STDTEXT_64,
    TASACUOTA D_STDTEXT_64,
    FECHAPAGO D_FECHA,
    FORMADEPAGOP D_STDTEXT_64,
    MONEDAP D_STDTEXT_64,
    TIPOCAMBIOP D_STDTEXT_64,
    MONTO D_IMPORTE,
    NUMOPERACION D_STDTEXT_64,
    RFCEMISORCTAORD D_STDTEXT_64,
    NOMBANCOORDEXT D_NOMBRE_NULL,
    CTAORDENANTE D_STDTEXT_64,
    RFCEMISORCTABEN D_STDTEXT_64,
    CTABENEFICIARIO D_STDTEXT_64,
    TIPOCADPAGO D_STDTEXT_64,
    CERTPAGO D_STDTEXT_64,
    CADPAGO D_STDTEXT_64,
    SELLOPAGO D_STDTEXT_64,
    IDDOCUMENTO D_STDTEXT_64,
    MONEDADR D_STDTEXT_64,
    TIPOCAMBIODR D_STDTEXT_64,
    METODODEPAGODR D_STDTEXT_64,
    NUMPARCIALIDAD D_STDTEXT_64,
    IMPSALDOANT D_IMPORTE,
    IMPPAGADO D_IMPORTE,
    IMPSALDOINSOLUTO D_IMPORTE,
    TOTALTRASLADOS D_IMPORTE,
    TOTALRETENCIONES D_IMPORTE,
    TIPORELACION D_STDTEXT_64,
    UUID D_STDTEXT_64,
    IMPRIMIRCOMPROBANTESPAGO D_BOOLCN,
    NUMEROPEDIMENTO D_STDTEXT_64,
    MOVTOID D_FK,
    MOVTOKITID D_FK,
    PAGOSATID D_FK,
    MOVTOREFID D_FK,
    EXPORTACION D_STDTEXT_64,
    OBJETOIMP D_STDTEXT_64,
    DOMICILIOFISCAL D_STDTEXT_64,
    PERIODICIDAD D_STDTEXT_64,
    MESES D_STDTEXT_64,
    ANIO D_STDTEXT_64)
as
declare variable TIPODOCTOID D_FK;
declare variable ESVERSION33 D_BOOLCS;
declare variable ESRECIBOELECTRONICO D_BOOLCN;
declare variable CUENTADOCTOPAGOCREDITO integer;
declare variable PAGOACREDITO D_BOOLCN;
declare variable CUENTAPAGOSNOCREDITO integer;
declare variable PAGOENUNASOLAEXIBICION D_BOOLCN;
declare variable EMPRESA_FISCALCODIGOPOSTAL D_STDTEXT_64;
declare variable PERSONADESGLOSAIEPS D_BOOLCN;
declare variable EMPRESADESGLOSAIEPS D_BOOLCN;
declare variable PERSONAID D_FK;
declare variable MOSTRARDESCUENTOENFACTURA D_BOOLCN;
declare variable SUBTOTAL_D D_IMPORTE;
declare variable DESCUENTO_D D_IMPORTE;
declare variable USARFISCALESENEXPEDICION D_BOOLCN;
declare variable IDLINEANIVEL1 D_FK;
declare variable IDLINEANIVEL2 D_FK;
declare variable MANEJALOTEIMPORTACION D_BOOLCN;
declare variable DESGLOSARIEPSMOVTO D_BOOLCN;
declare variable SUBTOTALMOVTO D_IMPORTE;
declare variable PORCENTAJEIEPSMOVTO D_PORCENTAJE;
declare variable PORCENTAJEIVAMOVTO D_PORCENTAJE;
declare variable MONTOIVAMOVTO D_IMPORTE;
declare variable MONTOIEPSMOVTO D_PORCENTAJE;
declare variable MONTOIVARETENIDOMOVTO D_IMPORTE;
declare variable PORCENTAJEIVARETENIDOMOVTO D_PORCENTAJE;
declare variable PERSONARETIENEIVA D_BOOLCN;
declare variable PERSONARETIENEISR D_BOOLCN;
declare variable ESARRENDATARIO D_BOOLCN;
declare variable MONTOISRRETENIDOMOVTO D_IMPORTE;
declare variable PORCENTAJEISRRETENIDOMOVTO D_PORCENTAJE;
declare variable SUMAIEPSTRASLADADO D_IMPORTE;
declare variable SUMAIVATRASLADADO D_IMPORTE;
declare variable SUMAISRRETENIDO D_IMPORTE;
declare variable SUMAIVARETENIDO D_IMPORTE;
declare variable ESKIT D_BOOLCN;
declare variable ERRORCODE D_ERRORCODE;
declare variable DOCTOKITREFID D_FK;
declare variable DESCUENTOMOVTO D_IMPORTE;
declare variable PRE_FORMAPAGOSAT D_STDTEXT_SHORT;
declare variable SUBTIPODOCTOID D_FK;
declare variable ANIOADUANEROMIN varchar(2);
declare variable ANIOADUANERO varchar(2);
declare variable DOCTOREFID D_FK;
declare variable CUENTADESCUENTOSNEGATIVOS integer;
declare variable SUBTOTALCONS D_IMPORTE;
declare variable DOCTOIDCONS D_FK;
declare variable DOCTOFOLIOCONS D_DOCTOFOLIO;
declare variable IVACONS D_IMPORTE;
declare variable TOTALCONS D_IMPORTE;
declare variable IEPSCONS D_IMPORTE;
declare variable SUMASUBTOTALDEVOCONS D_IMPORTE;
declare variable PERSONADESGLOSAIEPSCONS D_BOOLCN;
declare variable DOCTODEVOCONSID D_FK;
declare variable DESGLOSEIEPSLOCAL D_BOOLCN_NULL;
declare variable DOCTOIDCONSMAYOR D_FK;
declare variable OMITIRVALES D_BOOLCN_NULL;
declare variable PREGUNTARDATOSENTREGA D_BOOLCN;
declare variable PERSONAENTREGACALLE D_STDTEXT_MEDIUM;
declare variable DESGLOSEIEPSFACTURA D_BOOLCN;
declare variable KITIMPFIJO D_BOOLCN;
declare variable FECHAINI D_FECHA;
declare variable FECHAFIN D_FECHA;
declare variable VERSIONCFDI D_STDTEXT_SHORT;
BEGIN

   ID = 1;
   TIPOLINEA = 'COMPROBANTE';
   ESVERSION33 = 'S';
   ESRECIBOELECTRONICO = 'N';
   IMPRIMIRCOMPROBANTESPAGO = 'N';
   PAGOENUNASOLAEXIBICION = 'N';
   EXPORTACION = '01';
   MONEDA = 'MXN'; MONEDAP = 'MXN'; MONEDADR = 'MXN'; TIPOCAMBIO = ''; TIPOCAMBIOP = ''; TIPOCAMBIODR = '';

   
   SELECT PARAMETRO.fiscalcodigopostal,  parametro.desgloseieps,PARAMETRO.mostrardescuentofactura , USARFISCALESENEXPEDICION   ,
      PARAMETRO.manejarloteimportacion , PARAMETRO.arrendatario, PARAMETRO.preguntardatosentrega  , PARAMETRO.desgloseiepsfactura ,
      PARAMETRO.VERSIONCFDI
    FROM PARAMETRO
    INTO :EMPRESA_FISCALCODIGOPOSTAL, :EMPRESADESGLOSAIEPS, :MOSTRARDESCUENTOENFACTURA, :USARFISCALESENEXPEDICION,
      :MANEJALOTEIMPORTACION, :ESARRENDATARIO, :PREGUNTARDATOSENTREGA, :DESGLOSEIEPSFACTURA,
      :VERSIONCFDI;


    IF( :MOSTRARDESCUENTOPARENT IS NOT NULL ) THEN
    BEGIN
        MOSTRARDESCUENTOENFACTURA = :MOSTRARDESCUENTOPARENT;
    END

   SELECT PERSONAID, TIPODOCTOID, PAGOACREDITO,  TIMBRADOFORMAPAGOSAT , SUBTIPODOCTOID , DOCTOREFID, FECHAINI, FECHAFIN
    FROM docto WHERE ID = :DOCTOID
    INTO :PERSONAID, :TIPODOCTOID, :PAGOACREDITO, :PRE_FORMAPAGOSAT, :SUBTIPODOCTOID, :DOCTOREFID, :FECHAINI, :FECHAFIN;

    SELECT PERSONA.desgloseieps, PERSONA.retieneisr ,PERSONA.RETIENEIVA FROM PERSONA WHERE ID = :PERSONAID INTO :PERSONADESGLOSAIEPS, :PERSONARETIENEISR,  :PERSONARETIENEIVA;

   IF(:TIPODOCTOID IN (21,701)) THEN
   BEGIN    
        TIPOCOMPROBANTE = 'I';
   END
   ELSE IF(:TIPODOCTOID IN (22)) THEN
   BEGIN  
        TIPOCOMPROBANTE = 'E';
   END 
   ELSE IF(:TIPODOCTOID IN (205)) THEN
   BEGIN  
        TIPOCOMPROBANTE = 'P';
   END

   
   DESGLOSEIEPSLOCAL = CASE WHEN
                                        (((COALESCE(:PERSONADESGLOSAIEPS,'N') = 'S' or COALESCE(:TIPODOCTOID,0) = 701 ) AND COALESCE(:EMPRESADESGLOSAIEPS,'N') = 'S') or (:DESGLOSEIEPSPARENT IS NOT NULL AND :DESGLOSEIEPSPARENT = 'S'))
                                        AND (:DESGLOSEIEPSPARENT IS  NULL OR :DESGLOSEIEPSPARENT <> 'N') THEN
                                        'S' ELSE 'N' END;

   --COMPROBANTE
   IF(:TIPODOCTOID IN (21,22)) THEN
   BEGIN
        
        SELECT COUNT(*) FROM DOCTOPAGO WHERE ((:TIPODOCTOID = 21 AND DOCTOID = :DOCTOID) or (:TIPODOCTOID = 22 AND DOCTOSALIDAID = :DOCTOID)  )
          AND DOCTOPAGO.formapagoid = 4 INTO :CUENTADOCTOPAGOCREDITO;
          
        SELECT COUNT(*) FROM doctopago
           WHERE ((:TIPODOCTOID = 21 AND DOCTOID = :DOCTOID) or (:TIPODOCTOID = 22 AND DOCTOID = :DOCTOREFID)  ) --(:TIPODOCTOID = 22 AND DOCTOSALIDAID = :DOCTOID)  )
                    AND COALESCE(DOCTOPAGO.formapagosatid,0) <> 0 AND
                    COALESCE(DOCTOPAGO.revertido, 'N') = 'N'  AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)
           INTO :CUENTAPAGOSNOCREDITO;

        IF(COALESCE(:PAGOACREDITO,'N') = 'S' or COALESCE(:PRE_FORMAPAGOSAT,'') = '99' or
           (:TIPODOCTOID = 22 AND COALESCE(:cuentadoctopagocredito, 0) > 0) ) THEN
        BEGIN      
            FORMAPAGO = '99';
            PAGOENUNASOLAEXIBICION = 'N';

           IF(COALESCE(:CUENTAPAGOSNOCREDITO, 0) > 0 ) THEN
           BEGIN
                    IMPRIMIRCOMPROBANTESPAGO = 'S';
           END
        END
        ELSE
        BEGIN

          IF(COALESCE(:PRE_FORMAPAGOSAT,'') = '' OR COALESCE(:PRE_FORMAPAGOSAT,'') LIKE '%|%') THEN
          BEGIN    
            SELECT FIRST 1 FORMAPAGOSAT.CLAVE
            FROM doctopago
            LEFT JOIN FORMAPAGOSAT ON FORMAPAGOSAT.ID = DOCTOPAGO.FORMAPAGOSATID
            WHERE ((:TIPODOCTOID = 21 AND DOCTOID = :DOCTOID) or (:TIPODOCTOID = 22 AND DOCTOID = :DOCTOREFID)  )
                    AND COALESCE(DOCTOPAGO.formapagosatid,0) <> 0 AND
                    COALESCE(DOCTOPAGO.revertido, 'N') = 'N'  AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)
            GROUP BY DOCTOPAGO.formapagosatid ,FORMAPAGOSAT.CLAVE
            ORDER by SUM(COALESCE(DOCTOPAGO.IMPORTE,0)) DESC
            INTO :FORMAPAGO;
          END
          ELSE
          BEGIN
            FORMAPAGO = COALESCE(:PRE_FORMAPAGOSAT,'');
          END

           IF(COALESCE(:CUENTAPAGOSNOCREDITO, 0) > 0 ) THEN
           BEGIN
                    PAGOENUNASOLAEXIBICION = 'S';
           END
        END

            SELECT FIRST 1 DOCTOPAGO.REFERENCIABANCARIA FROM DOCTOPAGO
            WHERE ((:TIPODOCTOID = 21 AND DOCTOID = :DOCTOID)  or (:TIPODOCTOID = 22 AND DOCTOID = :DOCTOREFID)  ) --or (:TIPODOCTOID = 22 AND DOCTOSALIDAID = :DOCTOID)  )
                    AND COALESCE(DOCTOPAGO.formapagosatid,0) <> 0 AND
                    COALESCE(DOCTOPAGO.revertido, 'N') = 'N'  AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)
            INTO :NUMEROCTAPAGO;


            SELECT
                SERIESAT, FOLIOSAT, DATEADD(-5 MINUTE TO TIMBRADOFECHAFACTURA) FECHA, TOTAL - COALESCE(IVARETENIDO,0) -  COALESCE(ISRRETENIDO,0) AS TOTAL
                , 'MXN' ,'', '',
                CASE WHEN :PAGOENUNASOLAEXIBICION = 'S' or DOCTO.TIPODOCTOID = 22  THEN 'PUE' ELSE 'PPD' END  ,
                'X',  :EMPRESA_FISCALCODIGOPOSTAL

                FROM DOCTO
                WHERE DOCTO.ID = :DOCTOID

            INTO
                :SERIE, :FOLIO, :FECHA, :TOTAL, :MONEDA, :TIPOCAMBIO, :CONDICIONESPAGO,
                :METODOPAGO ,
                :MOTIVODESCUENTO, :LUGAREXPEDICION;
                 
            SUBTOTAL = 0.0;
            DESCUENTO = 0.0;


            SELECT SUM(COALESCE(SUBTOTAL,0) +
                  CASE when ((COALESCE(:PERSONADESGLOSAIEPS,'N') = 'S' AND COALESCE(:EMPRESADESGLOSAIEPS,'N') = 'S') or (:DESGLOSEIEPSPARENT IS NOT NULL AND :DESGLOSEIEPSPARENT = 'S'))
                            AND (:DESGLOSEIEPSPARENT IS  NULL OR :DESGLOSEIEPSPARENT <> 'N')
                    THEN 0.0 ELSE COALESCE(MOVTO.ieps,0.0) END   +
                  CASE WHEN COALESCE(:MOSTRARDESCUENTOENFACTURA,'N') = 'S' THEN COALESCE(MOVTO.DESCUENTO,0) ELSE 0.0 END)
                   SUBTOTAL ,

                   SUM( CASE WHEN COALESCE(:MOSTRARDESCUENTOENFACTURA,'N') = 'S' THEN COALESCE(MOVTO.DESCUENTO,0) ELSE 0.0 END) DESCUENTO

                   FROM MOVTO LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
                      LEFT JOIN sat_productoservicio ON SAT_PRODUCTOSERVICIO.id = PRODUCTO.sat_productoservicioid
                      WHERE MOVTO.DOCTOID = :DOCTOID
                  INTO :SUBTOTAL, :DESCUENTO;

             SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :DOCTOID AND COALESCE(DESCUENTO,0) < 0 INTO :CUENTADESCUENTOSNEGATIVOS;

             IF(COALESCE(:DESCUENTO,0) < 0 or COALESCE(:CUENTADESCUENTOSNEGATIVOS,0) > 0 ) THEN
             BEGIN                         
                 SUBTOTAL = COALESCE(:SUBTOTAL,0) + COALESCE(:DESCUENTO,0);
                 MOSTRARDESCUENTOENFACTURA = 'N';
                 DESCUENTO = 0;
             END
             FORMAPAGO = COALESCE(:FORMAPAGO, 99);
   END    
   ELSE IF(:TIPODOCTOID = 701) THEN
   BEGIN

            PAGOENUNASOLAEXIBICION = 'N';
            IMPRIMIRCOMPROBANTESPAGO = 'S';
            FORMAPAGO = COALESCE(:FORMAPAGO,'01');
            PERSONADESGLOSAIEPS = COALESCE(:DESGLOSEIEPSFACTURA, 'S');
            MOSTRARDESCUENTOENFACTURA = 'N';

            SELECT FIRST 1 DOCTO.ID FROM DOCTO WHERE FACTCONSID = :DOCTOID AND COALESCE(DOCTO.factconsaplicado, 'S') = 'S'
            ORDER BY DOCTO.TOTAL DESC INTO :DOCTOIDCONSMAYOR;

                SELECT FIRST 1 FORMAPAGOSAT.CLAVE --DOCTOPAGO.formapagosatid
                FROM doctopago
                LEFT JOIN FORMAPAGOSAT ON FORMAPAGOSAT.ID = DOCTOPAGO.FORMAPAGOSATID
                WHERE  DOCTOID = :DOCTOIDCONSMAYOR
                    AND COALESCE(DOCTOPAGO.formapagosatid,0) <> 0 AND
                    COALESCE(DOCTOPAGO.revertido, 'N') = 'N'  AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)
                GROUP BY DOCTOPAGO.formapagosatid ,FORMAPAGOSAT.CLAVE
                ORDER by SUM(COALESCE(DOCTOPAGO.IMPORTE,0)) DESC
                INTO :FORMAPAGO;


            SELECT
                SERIESAT, FOLIOSAT, DATEADD(-5 MINUTE TO TIMBRADOFECHAFACTURA) FECHA, TOTAL, 'MXN' ,'', '',
                'PUE'  ,
                'X',  :EMPRESA_FISCALCODIGOPOSTAL,
                COALESCE(SUBTOTAL,0) +
                  CASE when ((COALESCE(:PERSONADESGLOSAIEPS,'N') = 'S' AND COALESCE(:EMPRESADESGLOSAIEPS,'N') = 'S') or (:DESGLOSEIEPSPARENT IS NOT NULL AND :DESGLOSEIEPSPARENT = 'S'))
                            AND (:DESGLOSEIEPSPARENT IS  NULL OR :DESGLOSEIEPSPARENT <> 'N')
                    THEN 0.0 ELSE COALESCE(DOCTO.ieps,0.0) END   +
                  CASE WHEN COALESCE(:MOSTRARDESCUENTOENFACTURA,'N') = 'S' THEN COALESCE(DOCTO.DESCUENTO,0) ELSE 0.0 END
                   SUBTOTAL ,
                COALESCE(DESCUENTO,0.0) DESCUENTO,
                DOCTO.OMITIRVALES
                FROM DOCTO
                WHERE DOCTO.ID = :DOCTOID

            INTO
                :SERIE, :FOLIO, :FECHA, :TOTAL, :MONEDA, :TIPOCAMBIO, :CONDICIONESPAGO,
                :METODOPAGO ,
                :MOTIVODESCUENTO, :LUGAREXPEDICION, :SUBTOTAL, :DESCUENTO, :OMITIRVALES;
   END
   ELSE IF(:TIPODOCTOID = 205) THEN
   BEGIN
            ESRECIBOELECTRONICO = 'S';
            FORMAPAGO = '';
       
            SELECT FIRST 1 DOCTOPAGO.CUENTAPAGOCREDITO FROM DOCTOPAGO
            WHERE ((:TIPODOCTOID = 21 AND DOCTOID = :DOCTOID) or (:TIPODOCTOID = 22 AND DOCTOSALIDAID = :DOCTOID)  )
                    AND COALESCE(DOCTOPAGO.formapagosatid,0) <> 0 AND
                    COALESCE(DOCTOPAGO.revertido, 'N') = 'N'  AND DOCTOPAGO.formapagoid IN (1,2,3,5,15)
            INTO :NUMEROCTAPAGO;

            SELECT
                SERIESAT, FOLIOSAT, DATEADD(-5 MINUTE TO TIMBRADOFECHAFACTURA) FECHA, '0', 'XXX' ,'', '',
                '' METODOPAGO,
                'X' MOTIVODESCUENTO, :EMPRESA_FISCALCODIGOPOSTAL

                FROM DOCTO
                WHERE DOCTO.ID = :DOCTOID
            INTO
                :SERIE, :FOLIO, :FECHA, :TOTAL, :MONEDA, :TIPOCAMBIO, :CONDICIONESPAGO,
                :METODOPAGO ,
                :MOTIVODESCUENTO, :LUGAREXPEDICION;

            SUBTOTAL = 0.0;
            DESCUENTO = 0.0;
   END

   ID = :ID + 1;
   TIPOLINEA = 'COMPROBANTE';
   SUSPEND;


   --COMPROBANTE INFO EXP
   ID = :ID + 1;
   TIPOLINEA = 'COMPROBANTEINFOEX';
   LUGAREXPEDICION = :EMPRESA_FISCALCODIGOPOSTAL;
   --NUMEROCTAPAGO
   IF(:TIPODOCTOID IN (22)) THEN
   BEGIN
        SELECT DOCTOREF.SERIESAT, DOCTOREF.FOLIOSAT, DOCTOREF.TOTAL, CAST(DOCTOREF.TIMBRADOFECHAFACTURA AS DATE)
        FROM DOCTO LEFT JOIN DOCTO DOCTOREF ON DOCTO.doctorefid = DOCTOREF.ID
        WHERE DOCTO.ID = :DOCTOID
        INTO :SERIEFOLIOFISCALORIGINAL, :FOLIOFISCALORIGINAL , :MONTOFOLIOFISCALORIGINAL , :FECHAFOLIOFISCALORIGINAL ;
   END

   SUSPEND;

   --EMISOR
   ID = :ID + 1;
   TIPOLINEA = 'EMISOR';
     SELECT PARAMETRO.FISCALCALLE, PARAMETRO.FISCALNUMEROEXTERIOR,
                CASE WHEN COALESCE( PARAMETRO.FISCALNUMEROINTERIOR, '') = '' THEN '_' ELSE COALESCE( PARAMETRO.FISCALNUMEROINTERIOR, '') END NOINTERIOR,
                PARAMETRO.FISCALCOLONIA,  '.' LOCALIDAD,  '.' REFERENCIA,
                PARAMETRO.FISCALMUNICIPIO, PARAMETRO.FISCALESTADO, 'MEX',
                PARAMETRO.FISCALCODIGOPOSTAL,PARAMETRO.RFC, PARAMETRO.FISCALNOMBRE, SAT_REGIMENFISCAL.sat_CLAVE , PARAMETRO.FISCALNOMBRE
                FROM PARAMETRO
                    LEFT JOIN SAT_REGIMENFISCAL ON PARAMETRO.sat_regimenfiscalid = SAT_REGIMENFISCAL.ID
                INTO :CALLE, :NOEXTERIOR, :NOINTERIOR, :COLONIA, :LOCALIDAD, :REFERENCIA, :MUNICIPIO,
                    :ESTADO, :PAIS, :CODIGOPOSTAL, :RFC, :RAZONSOCIAL, :REGIMENFISCAL, :NOMBRE;
      SUSPEND;
      
   --EMISOR EXPEDIDO EN
   ID = :ID + 1;
   TIPOLINEA = 'EMISOREXPEDIDOEN';

   IF(COALESCE(:USARFISCALESENEXPEDICION,'S') = 'S') THEN
   BEGIN
     SELECT PARAMETRO.FISCALCALLE, PARAMETRO.FISCALNUMEROEXTERIOR,
                CASE WHEN COALESCE( PARAMETRO.FISCALNUMEROINTERIOR, '') = '' THEN '_' ELSE COALESCE( PARAMETRO.FISCALNUMEROINTERIOR, '') END NOINTERIOR,
                PARAMETRO.FISCALCOLONIA,  '.' LOCALIDAD,  '.' REFERENCIA,
                PARAMETRO.FISCALMUNICIPIO, PARAMETRO.FISCALESTADO, 'MEX',
                PARAMETRO.FISCALCODIGOPOSTAL,PARAMETRO.RFC, PARAMETRO.nombre, SAT_REGIMENFISCAL.sat_CLAVE
                FROM PARAMETRO
                    LEFT JOIN SAT_REGIMENFISCAL ON PARAMETRO.sat_regimenfiscalid = SAT_REGIMENFISCAL.ID
                INTO :CALLE, :NOEXTERIOR, :NOINTERIOR, :COLONIA, :LOCALIDAD, :REFERENCIA, :MUNICIPIO,
                    :ESTADO, :PAIS, :CODIGOPOSTAL, :RFC, :RAZONSOCIAL, :REGIMENFISCAL
                    ;
   END
   ELSE
   BEGIN  
     SELECT PARAMETRO.CALLE, PARAMETRO.NUMEROEXTERIOR,
                CASE WHEN COALESCE( PARAMETRO.NUMEROINTERIOR, '') = '' THEN '_' ELSE COALESCE( PARAMETRO.NUMEROINTERIOR, '') END NOINTERIOR,
                PARAMETRO.COLONIA,  '.' LOCALIDAD,  '.' REFERENCIA,
                PARAMETRO.LOCALIDAD, PARAMETRO.ESTADO, 'MEX',
                PARAMETRO.CP,PARAMETRO.RFC, PARAMETRO.nombre, SAT_REGIMENFISCAL.sat_CLAVE
                FROM PARAMETRO
                    LEFT JOIN SAT_REGIMENFISCAL ON PARAMETRO.sat_regimenfiscalid = SAT_REGIMENFISCAL.ID
                INTO :CALLE, :NOEXTERIOR, :NOINTERIOR, :COLONIA, :LOCALIDAD, :REFERENCIA, :MUNICIPIO,
                    :ESTADO, :PAIS, :CODIGOPOSTAL, :RFC, :RAZONSOCIAL, :REGIMENFISCAL
                    ;
   END
        
      SUSPEND;

      --RECEPTOR INFO
     IF(COALESCE(:tipodoctoid,  0) not in (701)) THEN
     BEGIN

        SELECT P.ENTREGACALLE , SRF.sat_clave , p.codigopostal
        FROM PERSONA P
         LEFT JOIN sat_regimenfiscal SRF on P.sat_regimenfiscalid = SRF.ID
         WHERE P.ID = :PERSONAID
         INTO :PERSONAENTREGACALLE, :REGIMENFISCAL, :DOMICILIOFISCAL;

        IF(COALESCE(:PREGUNTARDATOSENTREGA,'N') = 'N' or COALESCE(:PERSONAENTREGACALLE, '') = '' ) THEN
        BEGIN
            SELECT PERSONA.DOMICILIO, PERSONA.NUMEROEXTERIOR,
                CASE WHEN COALESCE( PERSONA.NUMEROINTERIOR, '') = '' THEN '_' ELSE COALESCE( PERSONA.NUMEROINTERIOR, '') END NOINTERIOR,
                PERSONA.COLONIA,  COALESCE(PERSONA.LOCALIDAD,'.'),  COALESCE(PERSONA.referenciadom,'.') REFERENCIA,
                PERSONA.CIUDAD, PERSONA.ESTADO, 'MEX',
                PERSONA.CODIGOPOSTAL,PERSONA.RFC, PERSONA.nombres || ' ' || PERSONA.apellidos, '',
                PERSONA.nombres || ' ' || PERSONA.apellidos ,''
                FROM PERSONA
                WHERE ID = :PERSONAID
                INTO :CALLE, :NOEXTERIOR, :NOINTERIOR, :COLONIA, :LOCALIDAD, :REFERENCIA, :MUNICIPIO,
                    :ESTADO, :PAIS, :CODIGOPOSTAL, :RFC, :RAZONSOCIAL, :RESIDENCIAFISCAL ,
                    :NOMBRE, :NUMREGIDTRIB
                    ;
         END
         ELSE
         BEGIN
            SELECT PERSONA.ENTREGACALLE, PERSONA.ENTREGANUMEROEXTERIOR,
                CASE WHEN COALESCE( PERSONA.ENTREGANUMEROINTERIOR, '') = '' THEN '_' ELSE COALESCE( PERSONA.ENTREGANUMEROINTERIOR, '') END NOINTERIOR,
                PERSONA.ENTREGACOLONIA,  '.' REFERENCIA,
                PERSONA.ENTREGAMUNICIPIO, PERSONA.ENTREGAESTADO, 'MEX',
                PERSONA.ENTREGACODIGOPOSTAL,PERSONA.RFC, PERSONA.nombres || ' ' || PERSONA.apellidos, '',
                PERSONA.nombres || ' ' || PERSONA.apellidos ,''
                FROM PERSONA
                WHERE ID = :PERSONAID
                INTO :CALLE, :NOEXTERIOR, :NOINTERIOR, :COLONIA, :REFERENCIA, :MUNICIPIO,
                    :ESTADO, :PAIS, :CODIGOPOSTAL, :RFC, :RAZONSOCIAL, :RESIDENCIAFISCAL ,
                    :NOMBRE, :NUMREGIDTRIB
                    ;
         END

        IF(COALESCE(:tipodoctoid,  0)  in (205)  AND  COALESCE(:VERSIONCFDI,'4.0') = '4.0'  ) THEN
        BEGIN
            USOCFDI = 'CP01';
        END
        ELSE
        BEGIN

            SELECT sat_usocfdi.sat_clave FROM
            DOCTO LEFT JOIN SAT_USOCFDI ON DOCTO.sat_usocfdiid = SAT_USOCFDI.id
            WHERE DOCTO.ID = :DOCTOID
            INTO :USOCFDI;

            IF(COALESCE(:usoCFDI ,'') = '') THEN
            BEGIN
                USOCFDI = CASE WHEN :TIPODOCTOID IN (21) THEN 'G01'
                                    WHEN :TIPODOCTOID IN (22) THEN 'G02'
                                    WHEN :TIPODOCTOID IN (205) THEN 'P01'
                                    ELSE  'G01'
                                    END;
            END
        END
     END
     ELSE IF(COALESCE(:tipodoctoid,  0)  in (701)) THEN
     BEGIN
        RFC =  'XAXX010101000';
        CALLE = NULL;
        NOEXTERIOR = NULL;
        NOINTERIOR = NULL;
        COLONIA = NULL;
        LOCALIDAD = NULL;
        REFERENCIA = NULL;
        MUNICIPIO = NULL;
        ESTADO = NULL;
        PAIS = NULL;
        CODIGOPOSTAL = NULL;
        RAZONSOCIAL = NULL;
        RESIDENCIAFISCAL  = NULL;
        NOMBRE = 'PUBLICO EN GENERAL';
        NUMREGIDTRIB   = NULL;
        USOCFDI = 'S01';
        REGIMENFISCAL = '616';
        DOMICILIOFISCAL =  :EMPRESA_FISCALCODIGOPOSTAL;
     END

     ID = :ID + 1;
     TIPOLINEA = 'RECEPTORINFO';
     SUSPEND;


     IF(:TIPODOCTOID = 701) THEN
     BEGIN
        IF(datediff (day from COALESCE(:FECHAINI, CURRENT_DATE) to COALESCE(:FECHAFIN, CURRENT_DATE)) = 0) THEN
        BEGIN
                PERIODICIDAD = '01';
        END
        ELSE
        BEGIN  
                PERIODICIDAD = '04';
        END
        
        MESES =  LPAD(CAST(EXTRACT( MONTH FROM COALESCE(:FECHAINI, CURRENT_DATE)) AS D_STDTEXT_64),2,'0');
        ANIO = CAST(EXTRACT( YEAR FROM COALESCE(:FECHAINI, CURRENT_DATE)) AS D_STDTEXT_64);
        
        ID = :ID + 1;
        TIPOLINEA = 'INFORMACIONGLOBAL';
        SUSPEND;

     END


END