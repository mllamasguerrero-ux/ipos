create or alter procedure EMIDA_AJUSTARCAMPOSPRODUCTOS
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable EMIDARECARGALINEAID D_FK;
declare variable EMIDARECARGAMARCAID D_FK;
declare variable EMIDARECARGAPROVEEDORID D_FK;
declare variable EMIDASERVICIOLINEAID D_FK;
declare variable EMIDASERVICIOMARCAID D_FK;
declare variable EMIDASERVICIOPROVEEDORID D_FK;
declare variable EMIDAPORCUTILIDADRECARGAS D_PORCENTAJE;
declare variable EMIDAUTILIDADPAGOSERVICIOS D_PRECIO;
BEGIN

   SELECT 
    EMIDARECARGALINEAID,
    EMIDARECARGAMARCAID, 
    EMIDARECARGAPROVEEDORID,
    EMIDASERVICIOLINEAID,
    EMIDASERVICIOMARCAID,
    EMIDASERVICIOPROVEEDORID,
    EMIDAPORCUTILIDADRECARGAS,
    EMIDAUTILIDADPAGOSERVICIOS
   FROM
    PARAMETRO 
   WHERE 1 = 1
   INTO 
    :EMIDARECARGALINEAID,
    :EMIDARECARGAMARCAID, 
    :EMIDARECARGAPROVEEDORID,
    :EMIDASERVICIOLINEAID,
    :EMIDASERVICIOMARCAID,
    :EMIDASERVICIOPROVEEDORID,
    :EMIDAPORCUTILIDADRECARGAS,
    :EMIDAUTILIDADPAGOSERVICIOS;

    UPDATE PRODUCTO SET 
    MARCAID = CASE WHEN COALESCE(:EMIDARECARGAMARCAID,0) > 0 THEN  :EMIDARECARGAMARCAID ELSE MARCAID END,
    LINEAID = CASE WHEN COALESCE(:EMIDARECARGALINEAID,0) > 0 THEN  :EMIDARECARGALINEAID ELSE LINEAID END,
    PROVEEDOR1ID = CASE WHEN COALESCE(:EMIDARECARGAPROVEEDORID,0) > 0 THEN  :EMIDARECARGAPROVEEDORID ELSE PROVEEDOR1ID END,
    COSTOREPOSICION = COALESCE(PRECIO1,0.00 )  * ((100.00 - COALESCE(:EMIDAPORCUTILIDADRECARGAS,0)) / 100.00 )
     WHERE EMIDAPRODUCTOID IN (SELECT ID FROM EMIDAPRODUCT WHERE COALESCE(ESSERVICIO,'N') = 'N');

     UPDATE PRODUCTO SET
     COSTOPROMEDIO = COSTOREPOSICION,
     COSTOULTIMO = COSTOREPOSICION
      WHERE EMIDAPRODUCTOID IN (SELECT ID FROM EMIDAPRODUCT WHERE COALESCE(ESSERVICIO,'N') = 'N');


    UPDATE PRODUCTO SET 
    MARCAID = CASE WHEN COALESCE(:EMIDASERVICIOMARCAID,0) > 0 THEN  :EMIDASERVICIOMARCAID ELSE MARCAID END,
    LINEAID = CASE WHEN COALESCE(:EMIDASERVICIOLINEAID,0) > 0 THEN  :EMIDASERVICIOLINEAID ELSE LINEAID END,
    PROVEEDOR1ID = CASE WHEN COALESCE(:EMIDASERVICIOPROVEEDORID,0) > 0 THEN  :EMIDASERVICIOPROVEEDORID ELSE PROVEEDOR1ID END
     WHERE EMIDAPRODUCTOID IN (SELECT ID FROM EMIDAPRODUCT WHERE COALESCE(ESSERVICIO,'N') = 'S');


   ERRORCODE = 0;
   SUSPEND;
END