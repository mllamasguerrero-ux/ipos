create or alter procedure DOCTOPAGOMOVIL_REGISTRAR (
    PAGOMOVILID D_FK,
    COBRANZAID D_FK,
    FECHA D_FECHA,
    CORTEID D_FK,
    IMPORTE D_PRECIO,
    VENTACOBRANZA D_STDTEXT_64,
    SALDOANTERIOR D_PRECIO,
    SALDONUEVO D_PRECIO,
    SALDOPAGO D_PRECIO)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable DOCTOPAGOMOVILID D_FK;
declare variable ACTIVO D_BOOLCS;
BEGIN
  ACTIVO = 'N';
  SELECT COALESCE(ACTIVO,'N') FROM CORTE WHERE ID = :CORTEID INTO :ACTIVO;

  IF(:ACTIVO <> 'S') THEN
  BEGIN
      ERRORCODE = 1001;
      SUSPEND;
      EXIT;
  END

  SELECT ID FROM DOCTOPAGOMOVIL
  WHERE  PAGOMOVILID = :PAGOMOVILID AND COBRANZAID = :COBRANZAID AND TIPOPAGOID = 5 AND ESTATUS = 1
  INTO :DOCTOPAGOMOVILID;

   IF(COALESCE(:DOCTOPAGOMOVILID, 0) = 0  and COALESCE(:IMPORTE,0) > 0 ) THEN
   BEGIN
     INSERT INTO DOCTOPAGOMOVIL
      (

        PAGOMOVILID,

        COBRANZAID,

        ESTATUS,

        FECHA,

        CORTEID,

        IMPORTE,

        REVERTIDO,

        DOCTOPAGOMOVILREFID,

        TIPOPAGOID,

        VENTACOBRANZA  ,
        SALDOANTERIOR,
        SALDONUEVO,
    SALDOPAGO
         )

Values (


        :PAGOMOVILID,

        :COBRANZAID,

        1,

        :FECHA,

        :CORTEID,

        :IMPORTE,

        'N',

        NULL,

        5,

        :VENTACOBRANZA,
        :SALDOANTERIOR,
        :SALDONUEVO,
    :SALDOPAGO
    );
   END
   ELSE
   BEGIN

    update  DOCTOPAGOMOVIL
    set
        IMPORTE=:IMPORTE    ,
        SALDOANTERIOR = :SALDOANTERIOR,
        SALDONUEVO = :SALDONUEVO,
    SALDOPAGO = :SALDOPAGO
    where ID=:DOCTOPAGOMOVILID ;
    END

   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 11012;
      SUSPEND;
   END
END
