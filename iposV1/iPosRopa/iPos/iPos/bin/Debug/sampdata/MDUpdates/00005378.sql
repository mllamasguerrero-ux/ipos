create or alter procedure TRASPASODEVO_COMPLETAR (
    DOCTOID D_FK,
    OBSERVACION D_OBSERVACION,
    VENDEDORID D_FK,
    DOCTOTRASLAID D_FK)
returns (
    DOCTONOTACREDITOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable TIPODOCTOID D_FK;
declare variable ESTATUSDOCTOID D_FK;
declare variable FALTANTES integer;
declare variable REFERENCIAS varchar(255);
declare variable TIPODOCTOID_REF D_FK;
declare variable ESTATUSDOCTOID_REF D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable MOVTOID D_FK;
declare variable PRECIO D_PRECIO;
declare variable LOTEIMPORTADO D_FK;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable DESCRIPCION1 D_DESCRIPCION;
declare variable DESCRIPCION2 D_DESCRIPCION;
declare variable DESCRIPCION3 D_DESCRIPCION;
declare variable PERSONASUCURSALID D_FK;
declare variable MOVTOID_REF D_FK;
declare variable DOCTOVENTAID D_FK;
declare variable HAYDEVOLUCIONESAPROBADAS D_BOOLCN;
declare variable MOVTOID_NOTACREDITO D_FK;
declare variable CLAVECLIENTESUCURSAL D_CLAVE_NULL;
declare variable FECHAREF D_FECHA;
BEGIN

   DOCTONOTACREDITOID = 0;
   HAYDEVOLUCIONESAPROBADAS = 'N';

   -- Si no es documento de compra 41.
   IF ((:DOCTOID IS NULL) OR (:DOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1060;
      SUSPEND;
      EXIT;
   END

   -- Validar estatus.
   SELECT TIPODOCTOID, ESTATUSDOCTOID, REFERENCIAS, SUCURSALTID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :TIPODOCTOID, :ESTATUSDOCTOID, :REFERENCIAS, :SUCURSALTID;

   -- Si no es documento de compra 32.
   IF ((:TIPODOCTOID IS NULL) OR (:TIPODOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1060;
      SUSPEND;
      EXIT;
   END

   -- Si no es documento de compra 32.
   IF (:TIPODOCTOID <> 32) THEN
   BEGIN
      ERRORCODE = 10061;
      SUSPEND;
      EXIT;
   END

   -- Si el estatus no es borrador .
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1062;
      SUSPEND;
      EXIT;
   END

   --insert into traza values('Trapaso completar 1');

    IF( COALESCE(:DOCTOTRASLAID,0) > 0) THEN
    BEGIN

         UPDATE DOCTO SET DOCTOREFID = :DOCTOTRASLAID WHERE ID = :DOCTOID;

        SELECT TIPODOCTOID, ESTATUSDOCTOID  , DOCTOREFID , FECHA
        FROM DOCTO WHERE ID = :DOCTOTRASLAID
        INTO :TIPODOCTOID_REF, :ESTATUSDOCTOID_REF, :DOCTOVENTAID, :FECHAREF;

         IF (COALESCE(:TIPODOCTOID_REF,0) not in (31,21)) THEN
        BEGIN
            ERRORCODE = 11061;
            SUSPEND;
            EXIT;
        END

             -- si la referencia es una venta, hay que obtener los datos del traslado al que hace referencia
        IF(:TIPODOCTOID_REF = 21) THEN
        BEGIN

            SELECT first 1 ID , TIPODOCTOID, ESTATUSDOCTOID  , DOCTOREFID
            FROM DOCTO WHERE FECHA = :FECHAREF AND DOCTOREFID = :DOCTOTRASLAID AND TIPODOCTOID = 31
            INTO  :DOCTOTRASLAID, :TIPODOCTOID_REF, :ESTATUSDOCTOID_REF, :DOCTOVENTAID;

            IF( COALESCE(:DOCTOTRASLAID,0) = 0 or COALESCE(:TIPODOCTOID_REF,0) not in (31)) THEN
            BEGIN  
                ERRORCODE = 12061;
                SUSPEND;
                EXIT;
            END

        END

        -- Si el estatus no es borrador .
        IF (:ESTATUSDOCTOID_REF <> 1) THEN
        BEGIN
            ERRORCODE = 1062;
            SUSPEND;
            EXIT;
        END

        FOR SELECT MOVTO.ID , MOVTO.PRODUCTOID, MOVTO.LOTE, MOVTO.FECHAVENCE , MOVTO.CANTIDADSURTIDA , MOVTO.PRECIO , MOVTO.LOTEIMPORTADO
            FROM movto WHERE DOCTOID = :DOCTOID AND  COALESCE(MOVTO.CANTIDADSURTIDA,0) > 0
            INTO :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE  , :CANTIDADSURTIDA  , :PRECIO , :LOTEIMPORTADO
            DO
         BEGIN

                  HAYDEVOLUCIONESAPROBADAS = 'S';

                  SELECT FIRST 1 ID FROM MOVTO WHERE DOCTOID = :DOCTOTRASLAID AND PRODUCTOID = :PRODUCTOID
                  AND COALESCE(:LOTE,'') = COALESCE(LOTE,'') AND COALESCE(:FECHAVENCE,CURRENT_DATE) = COALESCE(FECHAVENCE, CURRENT_DATE)  AND COALESCE(:LOTEIMPORTADO,0) = COALESCE(LOTEIMPORTADO,0)
                  AND PRECIO = :PRECIO
                  INTO :MOVTOID_REF;

                  IF(COALESCE(:MOVTOID_REF,0) = 0) THEN
                  BEGIN
                    

                    SELECT FIRST 1 ID FROM MOVTO WHERE DOCTOID = :DOCTOTRASLAID AND PRODUCTOID = :PRODUCTOID
                    AND COALESCE(:LOTE,'') = COALESCE(LOTE,'') AND COALESCE(:FECHAVENCE,CURRENT_DATE) = COALESCE(FECHAVENCE, CURRENT_DATE)  AND COALESCE(:LOTEIMPORTADO,0) = COALESCE(LOTEIMPORTADO,0)
                    INTO :MOVTOID_REF;
                  END

                  
                  IF(COALESCE(:MOVTOID_REF,0) <> 0) THEN
                  BEGIN
                       UPDATE movto SET MOVTOREFID = :MOVTOID_REF WHERE ID = :MOVTOID;
                       UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) + :CANTIDADSURTIDA where ID = :MOVTOID_REF;

                  END


         END


         -- si es un traslado con venta( con fact electronica) crea la nota de credito
         IF(COALESCE(:DOCTOVENTAID,0) <> 0 AND :HAYDEVOLUCIONESAPROBADAS = 'S') THEN
         BEGIN


                
            CLAVECLIENTESUCURSAL = NULL;
            SELECT SUCURSAL.clienteclave FROM SUCURSAL WHERE ID = :SUCURSALTID AND SUCURSAL.esfranquicia = 'S'
            INTO :CLAVECLIENTESUCURSAL;

            IF(COALESCE(CLAVECLIENTESUCURSAL,'') <> '') THEN
            BEGIN
                                   
                SELECT id from persona where clave = :CLAVECLIENTESUCURSAL AND TIPOPERSONAID = 50 into :personasucursalid;

            END


             
            -- Agrega el DOCTO.
            INSERT INTO DOCTO
            (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
            PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
            PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
            CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
            FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT,ESAPARTADO,DOCTOREFID, IEPS, IMPUESTO, SUBTIPODOCTOID)
            SELECT
            ALMACENID, SUCURSALID, 22, 0, 0,
            COALESCE(:PERSONASUCURSALID,1), CAJEROID, :VENDEDORID, CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, NULL, NULL,
            PLAZO, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
            CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, 'N' , 'N' ,
            FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT , ESAPARTADO,:DOCTOVENTAID, 0.00, 0.00 ,8
            FROM DOCTO WHERE ID = :DOCTOID
            RETURNING ID INTO :DOCTONOTACREDITOID;



            
            FOR SELECT MOVTO.ID , MOVTO.PRODUCTOID, MOVTO.LOTE, MOVTO.FECHAVENCE , MOVTO.CANTIDADSURTIDA , MOVTO.PRECIO , MOVTO.LOTEIMPORTADO ,
                DOCTO.SUCURSALTID, DOCTO.ALMACENTID , DOCTO.ALMACENID , DOCTO.SUCURSALID , DOCTO.PERSONAID , MOVTO.COSTO , DOCTO.REFERENCIA , DOCTO.REFERENCIAS , MOVTO.TIPODIFERENCIAINVENTARIOID , MOVTO.DESCRIPCION1 , MOVTO.DESCRIPCION2 , MOVTO.DESCRIPCION3
                FROM movto LEFT JOIN DOCTO ON DOCTO.ID = MOVTO.DOCTOID WHERE DOCTOID = :DOCTOID AND  COALESCE(MOVTO.CANTIDADSURTIDA,0) > 0
                INTO :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE  , :CANTIDADSURTIDA  , :PRECIO , :LOTEIMPORTADO
                ,:SUCURSALTID ,:ALMACENTID , :ALMACENID , :SUCURSALID , :PERSONAID , :COSTO , :REFERENCIA , :REFERENCIAS , :TIPODIFERENCIAINVENTARIOID , :DESCRIPCION1 , :DESCRIPCION2 , :DESCRIPCION3
            DO
            BEGIN



                  
                SELECT ERRORCODE,MOVTOID
                FROM MOVTO_INSERT (
                :DOCTONOTACREDITOID, 0, :ALMACENID, :SUCURSALID, 22, 0, 0, :PERSONAID, :VENDEDORID, 1,
                0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADSURTIDA, 0, 0, 0, 0 , :PRECIO, 0,
                :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENTID, 'N',
                :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,NULL,NULL,NULL,NULL,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL , :LOTEIMPORTADO , 'N', 'N'
                ) INTO :ERRORCODE,:MOVTOID_NOTACREDITO;
            
                IF (:ERRORCODE <> 0) THEN
                BEGIN

                    SUSPEND;
                    EXIT;
                END


                  SELECT FIRST 1 ID FROM MOVTO WHERE DOCTOID = :DOCTOVENTAID AND PRODUCTOID = :PRODUCTOID
                  AND COALESCE(:LOTE,'') = COALESCE(LOTE,'') AND COALESCE(:FECHAVENCE,CURRENT_DATE) = COALESCE(FECHAVENCE, CURRENT_DATE)  AND COALESCE(:LOTEIMPORTADO,0) = COALESCE(LOTEIMPORTADO,0)
                  AND PRECIO = :PRECIO
                  INTO :MOVTOID_REF;

                  IF(COALESCE(:MOVTOID_REF,0) = 0) THEN
                  BEGIN
                    

                    SELECT FIRST 1 ID FROM MOVTO WHERE DOCTOID = :DOCTOVENTAID AND PRODUCTOID = :PRODUCTOID
                    AND COALESCE(:LOTE,'') = COALESCE(LOTE,'') AND COALESCE(:FECHAVENCE,CURRENT_DATE) = COALESCE(FECHAVENCE, CURRENT_DATE)  AND COALESCE(:LOTEIMPORTADO,0) = COALESCE(LOTEIMPORTADO,0)
                    INTO :MOVTOID_REF;
                  END


                  
                  IF(COALESCE(:MOVTOID_REF,0) <> 0) THEN
                  BEGIN
                       UPDATE movto SET MOVTOREFID = :MOVTOID_REF WHERE ID = :MOVTOID_NOTACREDITO;
                       --UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) + :CANTIDADSURTIDA where ID = :MOVTOID_REF;

                  END


             END

             UPDATE DOCTO SET SUBTIPODOCTOID = 8, DOCTOREFID = :DOCTONOTACREDITOID WHERE ID = :DOCTOID;

           END

        END

           

   --insert into traza values('Trapaso completar 1');

   -- Completar el documento con afectacion de inventarios.
   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;
  
   IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
  

   
   UPDATE docto SET OBSERVACION = :OBSERVACION
   WHERE ID = :DOCTOID;

   SUSPEND;
  
  /* WHEN ANY DO
   BEGIN
      ERRORCODE = 1063;
      SUSPEND;
   END */
END