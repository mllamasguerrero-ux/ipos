create or alter procedure OBTEN_CANTIDADORIGENFISCAL (
    EXISFACTURADO D_CANTIDAD,
    EXISREMISIONADO D_CANTIDAD,
    CANTIDAD D_CANTIDAD,
    ULTIMOORIGENFISCAL D_FK)
returns (
    CANTIDADFACTURADO D_CANTIDAD,
    CANTIDADREMISIONADO D_CANTIDAD,
    CANTIDADINDEFINIDO D_CANTIDAD,
    NUEVOULTIMOORIGENFISCAL D_FK)
as
declare variable RESIDUO D_CANTIDAD;
declare variable CANTIDADBUFFER D_CANTIDAD;
declare variable CANTIDADBUFFERHALF D_CANTIDAD;
declare variable CANTIDADAPROCESAR D_CANTIDAD;
BEGIN

   CANTIDADINDEFINIDO = 0;

   CANTIDADAPROCESAR = :CANTIDAD;
   IF(:CANTIDAD > (:EXISFACTURADO + :EXISREMISIONADO) ) THEN
   BEGIN

        if((:EXISFACTURADO + :EXISREMISIONADO) > 0 ) then
        begin
            CANTIDADAPROCESAR  = :EXISFACTURADO + :EXISREMISIONADO;
        end
        else
        begin      
            CANTIDADAPROCESAR  = 0;
        end

   END

   RESIDUO = MOD(:CANTIDADAPROCESAR, 2);
   CANTIDADBUFFER = (:CANTIDADAPROCESAR - :RESIDUO);

   IF(:CANTIDADBUFFER > 0) THEN
   BEGIN
      CANTIDADBUFFERHALF  = :CANTIDADBUFFER / 2;
      IF( :EXISFACTURADO >= :CANTIDADBUFFERHALF AND :EXISREMISIONADO >= :CANTIDADBUFFERHALF) THEN
      BEGIN
            CANTIDADFACTURADO = :CANTIDADBUFFERHALF; 
            CANTIDADREMISIONADO = :CANTIDADBUFFERHALF;
            --CANTIDADINDEFINIDO = 0;
      END
      ELSE  IF( :EXISFACTURADO >= :CANTIDADBUFFERHALF AND :EXISREMISIONADO < :CANTIDADBUFFERHALF) THEN
      BEGIN
             IF( :EXISFACTURADO >= :CANTIDADBUFFER - :EXISREMISIONADO) THEN
             BEGIN                 
                CANTIDADREMISIONADO = :EXISREMISIONADO;
                CANTIDADFACTURADO = :CANTIDADBUFFER - :EXISREMISIONADO;
                --CANTIDADINDEFINIDO = 0;
             END
             ELSE
             BEGIN
             
                CANTIDADFACTURADO = :EXISFACTURADO;
                CANTIDADREMISIONADO = :CANTIDADBUFFER  - :EXISFACTURADO;
                --CANTIDADINDEFINIDO = :CANTIDADBUFFER - :EXISREMISIONADO - :EXISFACTURADO;
             END
      END  
      ELSE  IF( :EXISFACTURADO < :CANTIDADBUFFERHALF AND :EXISREMISIONADO >= :CANTIDADBUFFERHALF) THEN
      BEGIN
             IF( :EXISREMISIONADO >= :CANTIDADBUFFER - :EXISFACTURADO) THEN
             BEGIN    
                CANTIDADFACTURADO = :EXISFACTURADO;
                CANTIDADREMISIONADO = :CANTIDADBUFFER - :EXISFACTURADO;
                --CANTIDADINDEFINIDO = 0;
             END
             ELSE
             BEGIN
                               
                CANTIDADFACTURADO = :EXISFACTURADO;
                CANTIDADREMISIONADO = :CANTIDADBUFFER - :EXISFACTURADO;
                --CANTIDADREMISIONADO= :CANTIDADREMISIONADO +:CANTIDADBUFFER - :EXISREMISIONADO - :EXISFACTURADO;
             END
      END
      ELSE
      BEGIN
              
             CANTIDADFACTURADO = :EXISFACTURADO; 
             CANTIDADREMISIONADO = :EXISREMISIONADO; 
             --CANTIDADINDEFINIDO = 0;
      END
   END


    IF(:RESIDUO = 0) THEN
    BEGIN
       NUEVOULTIMOORIGENFISCAL = :ULTIMOORIGENFISCAL;
    END
    ELSE
    BEGIN
       IF(:EXISFACTURADO <= :CANTIDADFACTURADO AND  :EXISREMISIONADO > :CANTIDADFACTURADO) THEN
       BEGIN
            CANTIDADREMISIONADO = :CANTIDADREMISIONADO + 1;
            NUEVOULTIMOORIGENFISCAL = 2;
       END
       ELSE if(:EXISFACTURADO > :CANTIDADFACTURADO AND  :EXISREMISIONADO <= :CANTIDADFACTURADO) then
       BEGIN
            CANTIDADFACTURADO = :CANTIDADFACTURADO +1;
            NUEVOULTIMOORIGENFISCAL = 3;
       END 
       ELSE if(:EXISFACTURADO <= :CANTIDADFACTURADO AND  :EXISREMISIONADO <= :CANTIDADFACTURADO) then
       BEGIN
            CANTIDADREMISIONADO= :CANTIDADREMISIONADO +1;
            NUEVOULTIMOORIGENFISCAL = 2;
       END 
       ELSE if(:EXISFACTURADO > :CANTIDADFACTURADO AND  :EXISREMISIONADO > :CANTIDADFACTURADO) then
       BEGIN
           IF(:ULTIMOORIGENFISCAL = 2) THEN
           BEGIN  
            CANTIDADFACTURADO = :CANTIDADFACTURADO +1;
            NUEVOULTIMOORIGENFISCAL = 3;
           END
           ELSE if (:ULTIMOORIGENFISCAL = 3) then
           BEGIN 
            CANTIDADREMISIONADO = :CANTIDADREMISIONADO + 1;
            NUEVOULTIMOORIGENFISCAL = 2;
           END
           ELSE
           BEGIN   
            CANTIDADFACTURADO = :CANTIDADFACTURADO +1;
            NUEVOULTIMOORIGENFISCAL = 3;
           END

       END
    END

    CANTIDADREMISIONADO = :CANTIDADREMISIONADO + ( :CANTIDAD -:CANTIDADAPROCESAR );

   SUSPEND;

END