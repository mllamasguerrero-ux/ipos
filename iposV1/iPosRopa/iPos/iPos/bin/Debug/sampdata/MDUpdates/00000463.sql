create or alter procedure CORTE_TOTALES (
    SUCURSALID D_FK,
    CAJEROID D_FK)
returns (
    CORTEID D_FK,
    FECHACORTE D_FECHA,
    SALDOINICIAL D_IMPORTE,
    INGRESO D_IMPORTE,
    EGRESO D_IMPORTE,
    DEVOLUCION D_IMPORTE,
    SALDOFINAL D_IMPORTE,
    APORTACION D_IMPORTE,
    RETIRO D_IMPORTE,
    INGRESOTARJETA D_IMPORTE,
    INGRESOEFECTIVO D_IMPORTE,
    INGRESOCREDITO D_IMPORTE,
    INGRESOCHEQUE D_IMPORTE,
    INGRESOVALE D_IMPORTE,
    CAMBIOCHEQUE D_IMPORTE,
    SALDOREAL D_IMPORTE,
    PAGOPROVEEDORES D_IMPORTE,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCN;
declare variable TICKETSVENTA integer;
declare variable TICKETSDEVOLUCION integer;
declare variable INGRESOPORIVA D_IMPORTE;
declare variable INGRESOSUBTOTAL D_IMPORTE;
declare variable INGRESODESCUENTO D_IMPORTE;
declare variable INGRESOIMPORTE D_IMPORTE;
BEGIN

   SELECT CORTEID
   FROM PERSONA
   WHERE ID = :CAJEROID
   INTO :CORTEID ;




   SELECT  ACTIVO, SALDOINICIAL, APORTACION, RETIRO, FECHACORTE , SALDOREAL
   FROM CORTE
   WHERE ID = :CORTEID
   INTO :ACTIVO, :SALDOINICIAL, :APORTACION, :RETIRO,  :FECHACORTE, :SALDOREAL;

   IF (:CORTEID IS NULL) THEN
   BEGIN
      ERRORCODE = 1020;
      SUSPEND;
      EXIT;
   END

   IF (:ACTIVO <> 'S') THEN
   BEGIN
      ERRORCODE = 1021;
      SUSPEND;
      EXIT;
   END

   SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1,2)
   INTO :INGRESO;


   
   SELECT COALESCE(SUM(IVA), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1,2)
   INTO :INGRESOPORIVA;
   
   SELECT COALESCE(SUM(SUBTOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1,2)
   INTO :INGRESOSUBTOTAL;

   
   SELECT COALESCE(SUM(DESCUENTO), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1,2)
   INTO :INGRESODESCUENTO;

   
   SELECT COALESCE(SUM(IMPORTE), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1,2)
   INTO :INGRESOIMPORTE;



   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     --AND CAJAID = :CAJAID
     --AND TURNOID = :TURNOID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1, 2)
   INTO :TICKETSVENTA;
   
   SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (23,60,61)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     --AND CAJAID = :CAJAID
     --AND TURNOID = :TURNOID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :EGRESO;

   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 23
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     --AND CAJAID = :CAJAID
     --AND TURNOID = :TURNOID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :TICKETSDEVOLUCION;

   SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID = 23
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     --AND CAJAID = :CAJAID
     --AND TURNOID = :TURNOID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :DEVOLUCION;



  
   SELECT COALESCE(SUM(doctopago.importe), 0.00)
   FROM DOCTO
   inner join doctopago on docto.id = doctopago.doctoid
   WHERE docto.TIPODOCTOID = 21
     AND docto.FECHA = :FECHACORTE
     AND docto.SUCURSALID = :SUCURSALID
     --AND docto.CAJAID = :CAJAID
     --AND docto.TURNOID = :TURNOID
     AND docto.VENDEDORID = :CAJEROID
      AND docto.ESTATUSDOCTOID IN (1,2)
      and doctopago.formapagoid = 1
   INTO :INGRESOEFECTIVO;

                              
   SELECT COALESCE(SUM(doctopago.importe), 0.00)
   FROM DOCTO
   inner join doctopago on docto.id = doctopago.doctoid
   WHERE docto.TIPODOCTOID = 21
     AND docto.FECHA = :FECHACORTE
     AND docto.SUCURSALID = :SUCURSALID
     --AND docto.CAJAID = :CAJAID
     --AND docto.TURNOID = :TURNOID
     AND docto.VENDEDORID = :CAJEROID
      AND docto.ESTATUSDOCTOID  IN (1,2)
      and doctopago.formapagoid = 2
   INTO :INGRESOTARJETA;

             
   SELECT COALESCE(SUM(doctopago.importe), 0.00)  ,
           COALESCE(SUM(doctopago.importecambio), 0.00)
   FROM DOCTO
   inner join doctopago on docto.id = doctopago.doctoid
   WHERE docto.TIPODOCTOID = 21
     AND docto.FECHA = :FECHACORTE
     AND docto.SUCURSALID = :SUCURSALID
     --AND docto.CAJAID = :CAJAID
     --AND docto.TURNOID = :TURNOID
     AND docto.VENDEDORID = :CAJEROID
      AND docto.ESTATUSDOCTOID  IN (1,2)
      and doctopago.formapagoid = 3
   INTO :INGRESOCHEQUE, :CAMBIOCHEQUE;

             
   SELECT COALESCE(SUM(doctopago.importe), 0.00)
   FROM DOCTO
   inner join doctopago on docto.id = doctopago.doctoid
   WHERE docto.TIPODOCTOID = 21
     AND docto.FECHA = :FECHACORTE
     AND docto.SUCURSALID = :SUCURSALID
     --AND docto.CAJAID = :CAJAID
     --AND docto.TURNOID = :TURNOID
     AND docto.VENDEDORID = :CAJEROID
      AND docto.ESTATUSDOCTOID IN (1,2)
      and doctopago.formapagoid = 4
   INTO :INGRESOCREDITO;

      SELECT COALESCE(SUM(doctopago.importe), 0.00)
   FROM DOCTO
   inner join doctopago on docto.id = doctopago.doctoid
   WHERE docto.TIPODOCTOID = 21
     AND docto.FECHA = :FECHACORTE
     AND docto.SUCURSALID = :SUCURSALID
     --AND docto.CAJAID = :CAJAID
     --AND docto.TURNOID = :TURNOID
     AND docto.VENDEDORID = :CAJEROID
      AND docto.ESTATUSDOCTOID IN (1,2)
      and doctopago.formapagoid = 5
   INTO :INGRESOVALE;


      SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (60,61)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :RETIRO  ;

   
      SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (60)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :PAGOPROVEEDORES  ;

   
      SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (61)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :RETIRO  ;





   SALDOFINAL = :SALDOINICIAL + :INGRESO - :EGRESO;

   UPDATE CORTE
   SET
      INGRESO = :INGRESO,
      EGRESO = :EGRESO,
      SALDOFINAL = :SALDOFINAL,
      DEVOLUCION = :DEVOLUCION,
        NUMEROTICKETS = :TICKETSVENTA,
        NUMERODEVOLUCIONES = :TICKETSDEVOLUCION ,
        INGRESOEFECTIVO = :INGRESOEFECTIVO,
        INGRESOTARJETA = :INGRESOTARJETA,
        INGRESOCREDITO = :INGRESOCREDITO,    
        INGRESOCHEQUE = :INGRESOCHEQUE ,
        INGRESOVALE = :INGRESOVALE ,
        CAMBIOCHEQUE = :CAMBIOCHEQUE,
        INGRESOPORIVA = :INGRESOPORIVA,
        INGRESOSUBTOTAL = :INGRESOSUBTOTAL,
        INGRESODESCUENTO = :INGRESODESCUENTO,
        INGRESOIMPORTE = :INGRESOIMPORTE,
        RETIRO = :RETIRO ,
        PAGOPROVEEDORES = :PAGOPROVEEDORES

   WHERE ID = :CORTEID;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1022;
      SUSPEND;
   END
END
