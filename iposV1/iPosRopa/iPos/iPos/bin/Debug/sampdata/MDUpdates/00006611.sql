create or alter procedure FACTURAELECTRONICA_XML (
    DOCTOID D_FK,
    P_TIPOCOMPROBANTE D_STDTEXT_64)
returns (
    ID D_FK,
    TIPOLINEA D_NOMBRE_NULL,
    PADRELINEA integer,
    ORDENLINEA integer,
    SUBORDEN integer,
    SERIE D_STDTEXT_64,
    FOLIO D_STDTEXT_64,
    FECHA D_TIMESTAMP,
    TIPOCOMPROBANTE D_STDTEXT_64,
    FORMAPAGO D_STDTEXT_64,
    SUBTOTAL D_IMPORTE,
    DESCUENTO D_IMPORTE,
    TOTAL D_IMPORTE,
    MONEDA D_STDTEXT_64,
    TIPOCAMBIO D_STDTEXT_64,
    CONDICIONESPAGO D_STDTEXT_LARGE,
    METODOPAGO D_STDTEXT_64,
    MOTIVODESCUENTO D_STDTEXT_64,
    LUGAREXPEDICION D_STDTEXT_LARGE,
    NUMEROCTAPAGO D_STDTEXT_LARGE,
    SERIEFOLIOFISCALORIGINAL D_STDTEXT_64,
    FOLIOFISCALORIGINAL D_STDTEXT_64,
    MONTOFOLIOFISCALORIGINAL D_IMPORTE,
    FECHAFOLIOFISCALORIGINAL D_FECHA,
    RFC D_STDTEXT_64,
    RAZONSOCIAL D_STDTEXT_LARGE,
    REGIMENFISCAL D_STDTEXT_64,
    CALLE D_STDTEXT_LARGE,
    NOINTERIOR D_STDTEXT_64,
    NOEXTERIOR D_STDTEXT_64,
    COLONIA D_STDTEXT_LARGE,
    LOCALIDAD D_STDTEXT_LARGE,
    REFERENCIA D_STDTEXT_LARGE,
    MUNICIPIO D_STDTEXT_LARGE,
    ESTADO D_STDTEXT_MEDIUM,
    PAIS D_STDTEXT_64,
    CODIGOPOSTAL D_STDTEXT_64,
    NOMBRE D_STDTEXT_LARGE,
    RESIDENCIAFISCAL D_STDTEXT_LARGE,
    NUMREGIDTRIB D_STDTEXT_64,
    USOCFDI D_STDTEXT_64,
    CANTIDAD D_CANTIDAD,
    UNIDAD D_STDTEXT_64,
    DESCRIPCION D_SAT_DESCRIPCION,
    VALORUNITARIO D_IMPORTE,
    IMPORTE D_IMPORTE,
    NOIDENTIFICACION D_STDTEXT_64,
    CUENTAPREDIAL D_STDTEXT_64,
    CLAVEPRODSERV D_STDTEXT_64,
    CLAVEUNIDAD D_STDTEXT_64,
    NUMERO D_STDTEXT_64,
    ADUANA D_STDTEXT_64,
    IMPUESTO D_STDTEXT_64,
    TASA D_PORCENTAJE,
    BASEIMP D_PRECIO,
    TIPOFACTOR D_STDTEXT_64,
    TASACUOTA D_STDTEXT_64,
    FECHAPAGO D_FECHA,
    FORMADEPAGOP D_STDTEXT_64,
    MONEDAP D_STDTEXT_64,
    TIPOCAMBIOP D_STDTEXT_64,
    MONTO D_IMPORTE,
    NUMOPERACION D_STDTEXT_64,
    RFCEMISORCTAORD D_STDTEXT_64,
    NOMBANCOORDEXT D_NOMBRE_NULL,
    CTAORDENANTE D_STDTEXT_64,
    RFCEMISORCTABEN D_STDTEXT_64,
    CTABENEFICIARIO D_STDTEXT_64,
    TIPOCADPAGO D_STDTEXT_64,
    CERTPAGO D_STDTEXT_64,
    CADPAGO D_STDTEXT_64,
    SELLOPAGO D_STDTEXT_64,
    IDDOCUMENTO D_STDTEXT_64,
    MONEDADR D_STDTEXT_64,
    TIPOCAMBIODR D_STDTEXT_64,
    METODODEPAGODR D_STDTEXT_64,
    NUMPARCIALIDAD D_STDTEXT_64,
    IMPSALDOANT D_IMPORTE,
    IMPPAGADO D_IMPORTE,
    IMPSALDOINSOLUTO D_IMPORTE,
    TOTALTRASLADOS D_IMPORTE,
    TOTALRETENCIONES D_IMPORTE,
    TIPORELACION D_STDTEXT_64,
    UUID D_STDTEXT_64,
    IMPRIMIRCOMPROBANTESPAGO D_BOOLCN,
    NUMEROPEDIMENTO D_STDTEXT_64,
    MOVTOID D_FK,
    MOVTOKITID D_FK,
    PAGOSATID D_FK,
    OMITIRVALES D_BOOLCN_NULL)
as
declare variable TIPODOCTOID D_FK;
declare variable SUBTIPODOCTOID D_FK;
declare variable ESFACTURAELECTRONICA D_BOOLCN;
declare variable TIMBRADOUUID D_STDTEXT_64;
BEGIN

  SELECT TIPODOCTOID, DOCTO.OMITIRVALES , SUBTIPODOCTOID , ESFACTURAELECTRONICA, TIMBRADOUUID
   FROM DOCTO
   WHERE ID = :DOCTOID INTO :TIPODOCTOID, :OMITIRVALES, :SUBTIPODOCTOID, :ESFACTURAELECTRONICA, :TIMBRADOUUID;





  FOR SELECT
      ID    ,
    TIPOLINEA    ,
    PADRELINEA    ,
    ORDENLINEA    ,
    SUBORDEN    ,
    SERIE    ,
    FOLIO    ,
    FECHA    ,
    TIPOCOMPROBANTE    ,
    FORMAPAGO    ,
    SUBTOTAL    ,
    DESCUENTO    ,
    TOTAL    ,
    MONEDA    ,
    TIPOCAMBIO    ,
    CONDICIONESPAGO    ,
    METODOPAGO    ,
    MOTIVODESCUENTO    ,
    LUGAREXPEDICION    ,
    NUMEROCTAPAGO    ,
    SERIEFOLIOFISCALORIGINAL    ,
    FOLIOFISCALORIGINAL    ,
    MONTOFOLIOFISCALORIGINAL    ,
    FECHAFOLIOFISCALORIGINAL    ,
    RFC    ,
    RAZONSOCIAL    ,
    REGIMENFISCAL    ,
    CALLE    ,
    NOINTERIOR    ,
    NOEXTERIOR    ,
    COLONIA    ,
    LOCALIDAD    ,
    REFERENCIA    ,
    MUNICIPIO    ,
    ESTADO    ,
    PAIS    ,
    CODIGOPOSTAL    ,
    NOMBRE    ,
    RESIDENCIAFISCAL    ,
    NUMREGIDTRIB    ,
    USOCFDI    ,
    CANTIDAD    ,
    UNIDAD    ,
    DESCRIPCION    ,
    VALORUNITARIO    ,
    IMPORTE    ,
    NOIDENTIFICACION    ,
    CUENTAPREDIAL    ,
    CLAVEPRODSERV    ,
    CLAVEUNIDAD    ,
    NUMERO    ,
    ADUANA    ,
    IMPUESTO    ,
    TASA    ,
    BASEIMP    ,
    TIPOFACTOR    ,
    TASACUOTA    ,
    FECHAPAGO    ,
    FORMADEPAGOP    ,
    MONEDAP    ,
    TIPOCAMBIOP    ,
    MONTO    ,
    NUMOPERACION    ,
    RFCEMISORCTAORD    ,
    NOMBANCOORDEXT    ,
    CTAORDENANTE    ,
    RFCEMISORCTABEN    ,
    CTABENEFICIARIO    ,
    TIPOCADPAGO    ,
    CERTPAGO    ,
    CADPAGO    ,
    SELLOPAGO    ,
    IDDOCUMENTO    ,
    MONEDADR    ,
    TIPOCAMBIODR    ,
    METODODEPAGODR    ,
    NUMPARCIALIDAD    ,
    IMPSALDOANT    ,
    IMPPAGADO    ,
    IMPSALDOINSOLUTO    ,
    TOTALTRASLADOS    ,
    TOTALRETENCIONES    ,
    TIPORELACION    ,
    UUID    ,
    IMPRIMIRCOMPROBANTESPAGO    ,
    NUMEROPEDIMENTO    ,
    MOVTOID    ,
    MOVTOKITID    ,
    PAGOSATID     ,
    OMITIRVALES


    FROM

    FACTURAELECTRONICA_XML_GROUP(:DOCTOID)
     INTO
    :ID    ,
    :TIPOLINEA    ,
    :PADRELINEA    ,
    :ORDENLINEA    ,
    :SUBORDEN    ,
    :SERIE    ,
    :FOLIO    ,
    :FECHA    ,
    :TIPOCOMPROBANTE    ,
    :FORMAPAGO    ,
    :SUBTOTAL    ,
    :DESCUENTO    ,
    :TOTAL    ,
    :MONEDA    ,
    :TIPOCAMBIO    ,
    :CONDICIONESPAGO    ,
    :METODOPAGO    ,
    :MOTIVODESCUENTO    ,
    :LUGAREXPEDICION    ,
    :NUMEROCTAPAGO    ,
    :SERIEFOLIOFISCALORIGINAL    ,
    :FOLIOFISCALORIGINAL    ,
    :MONTOFOLIOFISCALORIGINAL    ,
    :FECHAFOLIOFISCALORIGINAL    ,
    :RFC    ,
    :RAZONSOCIAL    ,
    :REGIMENFISCAL    ,
    :CALLE    ,
    :NOINTERIOR    ,
    :NOEXTERIOR    ,
    :COLONIA    ,
    :LOCALIDAD    ,
    :REFERENCIA    ,
    :MUNICIPIO    ,
    :ESTADO    ,
    :PAIS    ,
    :CODIGOPOSTAL    ,
    :NOMBRE    ,
    :RESIDENCIAFISCAL    ,
    :NUMREGIDTRIB    ,
    :USOCFDI    ,
    :CANTIDAD    ,
    :UNIDAD    ,
    :DESCRIPCION    ,
    :VALORUNITARIO    ,
    :IMPORTE    ,
    :NOIDENTIFICACION    ,
    :CUENTAPREDIAL    ,
    :CLAVEPRODSERV    ,
    :CLAVEUNIDAD    ,
    :NUMERO    ,
    :ADUANA    ,
    :IMPUESTO    ,
    :TASA    ,
    :BASEIMP    ,
    :TIPOFACTOR    ,
    :TASACUOTA    ,
    :FECHAPAGO    ,
    :FORMADEPAGOP    ,
    :MONEDAP    ,
    :TIPOCAMBIOP    ,
    :MONTO    ,
    :NUMOPERACION    ,
    :RFCEMISORCTAORD    ,
    :NOMBANCOORDEXT    ,
    :CTAORDENANTE    ,
    :RFCEMISORCTABEN    ,
    :CTABENEFICIARIO    ,
    :TIPOCADPAGO    ,
    :CERTPAGO    ,
    :CADPAGO    ,
    :SELLOPAGO    ,
    :IDDOCUMENTO    ,
    :MONEDADR    ,
    :TIPOCAMBIODR    ,
    :METODODEPAGODR    ,
    :NUMPARCIALIDAD    ,
    :IMPSALDOANT    ,
    :IMPPAGADO    ,
    :IMPSALDOINSOLUTO    ,
    :TOTALTRASLADOS    ,
    :TOTALRETENCIONES    ,
    :TIPORELACION    ,
    :UUID    ,
    :IMPRIMIRCOMPROBANTESPAGO    ,
    :NUMEROPEDIMENTO    ,
    :MOVTOID    ,
    :MOVTOKITID    ,
    :PAGOSATID ,
    :OMITIRVALES
    DO
    BEGIN

    

        IF(COALESCE(:P_TIPOCOMPROBANTE,'') = 'T' ) THEN
        BEGIN

            IF(COALESCE( :TIPOLINEA,'' ) = 'COMPROBANTE') THEN
            BEGIN
                TIPOCOMPROBANTE = 'T';  
                SUBTOTAL = 0;
                DESCUENTO = 0;
                TOTAL = 0;
                CONDICIONESPAGO = '';
                FORMAPAGO = '';
                METODOPAGO = '';
                TIPOCOMPROBANTE = 'T';
                MONEDA = 'XXX';
                TIPOCAMBIO = '';

                SELECT FIRST 1  FOLIOSAT, SERIESAT
                FROM doctocomprobante
                WHERE DOCTOID = :DOCTOID AND TIPOCOMPROBANTE = COALESCE(:P_TIPOCOMPROBANTE,'')
                INTO :FOLIO, :SERIE;

            END


              
            --IF(COALESCE( :TIPOLINEA,'' ) = 'EMISOR') THEN
            --BEGIN
            --END

                    
            IF(COALESCE( :TIPOLINEA,'' ) = 'RECEPTORINFO') THEN
            BEGIN  
                USOCFDI = 'P01';
                
                 IF(COALESCE(:SUBTIPODOCTOID,0) IN (7,8)   ) THEN
                 BEGIN           
                    RFC = COALESCE(:RFC,'XAXX010101000');
                 END

                 IF(COALESCE(:TIMBRADOUUID, '') = '' OR COALESCE(:ESFACTURAELECTRONICA,'S') <> 'S' ) THEN
                 BEGIN      
                    RFC = 'XAXX010101000';
                 END

            END

              
            IF(COALESCE( :TIPOLINEA,'' ) = 'CONCEPTO') THEN
            BEGIN
                   VALORUNITARIO = 0;
                   IMPORTE = 0;
                   DESCUENTO = 0;
                   TOTAL = 0;
            END






            IF(COALESCE(:TIPOLINEA,'' ) <> 'INFORMACIONADUANERA' AND
               COALESCE(:TIPOLINEA,'' ) <> 'CONCEPTO_IEPS' AND
               COALESCE(:TIPOLINEA,'' ) <> 'CONCEPTO_IVA' AND
               COALESCE(:TIPOLINEA,'' ) <> 'CONCEPTO_IVARETENIDO' AND
               COALESCE(:TIPOLINEA,'' ) <> 'CONCEPTO_ISRRETENIDO' AND
               COALESCE(:TIPOLINEA,'' ) <> 'TOTAL_TRASLADOSRETENCIONES' AND
               COALESCE(:TIPOLINEA,'' ) <> 'COMPROBANTE_IVA' AND
               COALESCE(:TIPOLINEA,'' ) <> 'COMPROBANTE_IEPS' AND
               COALESCE(:TIPOLINEA,'' ) <> 'COMPROBANTE_IVARETENIDO' AND
               COALESCE(:TIPOLINEA,'' ) <> 'COMPROBANTE_ISRRETENIDO') THEN
            BEGIN
                SUSPEND;
            END
        END
        ELSE
        BEGIN  
                SUSPEND;
        END


    END

    
    IF(COALESCE(:P_TIPOCOMPROBANTE,'') = 'T' ) THEN
    BEGIN
    
       SELECT DOCTO.timbradouuid
       FROM DOCTO
       WHERE DOCTO.ID = :DOCTOID
       INTO :UUID ;

       IF(COALESCE(:UUID,'') <> '') THEN
       BEGIN
           TIPORELACION = '05';
           ID = :ID + 1;
           TIPOLINEA = 'DOCTORELACIONADO';
           SUSPEND;
       END
    END





END
