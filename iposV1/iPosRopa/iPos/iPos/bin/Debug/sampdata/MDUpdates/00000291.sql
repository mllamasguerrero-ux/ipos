CREATE OR ALTER TRIGGER MOVTO_AI_20 FOR MOVTO
ACTIVE AFTER INSERT POSITION 20
AS
   DECLARE VARIABLE ERRORCODE D_ERRORCODE;
   DECLARE VARIABLE INVENTARIABLE D_BOOLCS;
BEGIN
   IF ((NEW.ESTATUSMOVTOID IS NULL) OR (NEW.ESTATUSMOVTOID = 0)) THEN
   BEGIN
      EXIT;
   END

   --IF ((NEW.TOTAL IS NULL) OR (NEW.TOTAL = 0)) THEN
   IF ((NEW.CANTIDAD IS NULL) OR (NEW.CANTIDAD = 0)) THEN
   BEGIN
      EXIT;
   END

    -- Determinar si es inventariable para registrar kardex o no.
   SELECT COALESCE(P.INVENTARIABLE, 'S')
   FROM PRODUCTO P
   WHERE P.ID = NEW.PRODUCTOID
   INTO :INVENTARIABLE;

    -- Solo si es inventariable.
   IF (:INVENTARIABLE = 'S') THEN
   BEGIN
      SELECT ERRORCODE FROM KARDEX_INSERT (
         NEW.DOCTOID,
         NEW.ID,
         NEW.PRODUCTOID,
         NEW.LOTE,
         NEW.FECHAVENCE,
         NEW.CANTIDAD,
         NEW.PRECIO,
         NEW.COSTO
      ) INTO ERRORCODE;
   END
END;