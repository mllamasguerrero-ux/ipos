create or alter procedure KITDEFUNNIVEL_REFRESH_SI_REQ
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable KITSDEF_ULTACT D_TIMESTAMP_NULLE;
declare variable KITSDEF_UNNIV_ULTACT D_TIMESTAMP_NULLE;
BEGIN

    ERRORCODE = 0;

    SELECT  KITSDEF_ULTACT, KITSDEF_UNNIV_ULTACT
    FROM PARAMETRO
      INTO  :KITSDEF_ULTACT, :KITSDEF_UNNIV_ULTACT;

    IF(:KITSDEF_UNNIV_ULTACT IS NOT NULL AND
        COALESCE(:KITSDEF_ULTACT, COALESCE(:KITSDEF_UNNIV_ULTACT, CURRENT_TIMESTAMP)) <= COALESCE(:KITSDEF_UNNIV_ULTACT, CURRENT_TIMESTAMP)) THEN
    BEGIN
      SUSPEND;
      EXIT;
    END


     DELETE FROM KITSUNNIVEL;


    INSERT INTO KITSUNNIVEL
(PRODUCTOID,
    PRODUCTOKITID,
    PRODUCTOPARTEID,
    CANTIDADPARTE)
SELECT PRODUCTOID,
    PRODUCTOKITID,
    PRODUCTOPARTEID,
    SUM(COALESCE(CANTIDADPARTE,0))
    FROM KITSUNNIVEL_VIEW
     WHERE PRODUCTOID IS NOT NULL AND PRODUCTOKITID IS NOT NULL AND PRODUCTOPARTEID IS NOT NULL
    GROUP BY
    PRODUCTOID,
    PRODUCTOKITID,
    PRODUCTOPARTEID;


     UPDATE PARAMETRO SET  KITSDEF_UNNIV_ULTACT = CURRENT_TIMESTAMP;




    ERRORCODE = 0;
    SUSPEND;

   WHEN ANY DO
   BEGIN
     ERRORCODE = 4006;
     SUSPEND;
   END

END