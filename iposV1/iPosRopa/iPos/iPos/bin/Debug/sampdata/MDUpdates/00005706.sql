create or alter procedure PLAZO_HAYPLAZOSMEZCLADOS (
    DOCTOID D_FK)
returns (
    HAYPLAZOSMEZCLADOS D_BOOLCN,
    ERRORCODE D_ERRORCODE)
as
declare variable CUENTAPLAZOS integer;
declare variable CUENTAPLAZOSCOMISIONISTAS integer;
declare variable SEPARARPRODXPLAZO D_BOOLCN;
declare variable PLAZOXPRODUCTO D_BOOLCN;
declare variable GRUPO_PLAZOID D_FK;
BEGIN

    ERRORCODE = 0;
    HAYPLAZOSMEZCLADOS = 'N';
    CUENTAPLAZOS = 0;
    PLAZOXPRODUCTO = 'N';

    SELECT PLAZOXPRODUCTO FROM PARAMETRO INTO :PLAZOXPRODUCTO;

    IF(COALESCE(:PLAZOXPRODUCTO,'N') = 'N') THEN
    BEGIN
    
        HAYPLAZOSMEZCLADOS = 'N';
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END

    SELECT COALESCE(PERSONA.SEPARARPRODXPLAZO,'N') FROM DOCTO
    LEFT JOIN PERSONA ON PERSONA.ID = DOCTO.PERSONAID
    WHERE DOCTO.ID = :DOCTOID
    INTO :SEPARARPRODXPLAZO;


    SELECT COUNT(*) CUENTAPLAZOS,
           SUM( CASE WHEN COALESCE(COMISIONISTA,'N') = 'S' THEN 1 ELSE 0 END) CUENTAPLAZOSCOMISIONISTAS
       FROM
       (
        SELECT COALESCE(PRODUCTO.PLAZOID, 0) PLAZOID , COALESCE(PLAZO.COMISIONISTA,'N') COMISIONISTA
        FROM DOCTO  
            INNER JOIN MOVTO ON DOCTO.ID = MOVTO.DOCTOID
            INNER JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
            LEFT JOIN PLAZO ON PLAZO.id = PRODUCTO.plazoid
        WHERE DOCTO.ID = :DOCTOID
        GROUP BY COALESCE(PRODUCTO.PLAZOID, 0),COALESCE(PLAZO.COMISIONISTA,'N')
        ) Q
        INTO :CUENTAPLAZOS, :CUENTAPLAZOSCOMISIONISTAS;

     IF( COALESCE(:CUENTAPLAZOS,0) <= 1  OR
         (COALESCE(:SEPARARPRODXPLAZO,'N') = 'N' AND COALESCE(:CUENTAPLAZOSCOMISIONISTAS,0) = 0)) THEN
     BEGIN 

        IF(COALESCE(:CUENTAPLAZOS,0) = 1) THEN
        BEGIN
        
            SELECT FIRST 1 COALESCE(PRODUCTO.PLAZOID,0) FROM MOVTO LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
            WHERE DOCTOID = :DOCTOID INTO :GRUPO_PLAZOID;
            UPDATE DOCTO SET PLAZOID = :GRUPO_PLAZOID WHERE ID = :DOCTOID;
        END


        HAYPLAZOSMEZCLADOS = 'N';
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
     END





        HAYPLAZOSMEZCLADOS = 'S';
        ERRORCODE = 0;
        SUSPEND;
        EXIT;

   

   ERRORCODE = 0;
   SUSPEND;
   
  -- WHEN ANY DO
  -- BEGIN
  --   ERRORCODE = 1076;
  --   SUSPEND;
  -- END

END