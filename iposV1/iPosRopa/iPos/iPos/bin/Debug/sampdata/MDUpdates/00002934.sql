create or alter procedure SURTIDO_CAMBIAR_LOTE_PREPARE (
    FIRSTMOVTOID D_FK,
    FIRSTCANTIDAD D_CANTIDAD,
    FIRSTLOTE D_LOTE,
    FIRSTFECHAVENCE D_FECHAVENCE,
    FIRSTSURTIBLE D_BOOLCS,
    FIRSTMAXSURTIBLE D_CANTIDAD)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable PRODUCTOID D_FK;
declare variable DOCTOID D_FK;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable VENDEDORID D_FK;
declare variable KARDEXMOVTOID D_FK;
declare variable KARDEXLOTE D_LOTE;
declare variable KARDEXFECHAVENCE D_FECHAVENCE;
declare variable KARDEXALMACENID D_FK;
declare variable KARDEXCANTIDAD D_CANTIDAD;
declare variable KARDEXORIGENFISCALID D_FK;
declare variable KARDEXESAPARTADO D_BOOLCN;
declare variable INVENTARIOID D_FK;
declare variable KARDEXID D_FK;
declare variable ESTATUSDOCTOID D_FK;
BEGIN

   SELECT MOVTO.PRODUCTOID, MOVTO.DOCTOID, MOVTO.PRECIO
   , MOVTO.COSTO, MOVTO.TIPODIFERENCIAINVENTARIOID  ,  MOVTO.DESCRIPCION1, MOVTO.DESCRIPCION2, MOVTO.DESCRIPCION3
   , MOVTO.tipodoctoid, DOCTO.sucursalid, DOCTO.almacenid , DOCTO.VENDEDORID, DOCTO.ESTATUSDOCTOID
   FROM MOVTO
    LEFT JOIN DOCTO ON DOCTO.ID = MOVTO.DOCTOID
   WHERE MOVTO.ID = :FIRSTMOVTOID
   INTO :PRODUCTOID, :DOCTOID, :PRECIO
   ,:COSTO, :TIPODIFERENCIAINVENTARIOID, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
   ,:TIPODOCTOID, :SUCURSALID, :ALMACENID, :VENDEDORID, :ESTATUSDOCTOID;


   IF(:ESTATUSDOCTOID <> 1) THEN
   BEGIN
        ERRORCODE = 5007;
        SUSPEND;
        EXIT;
   END

   FOR
     SELECT ID FROM MOVTO
     WHERE DOCTOID = :DOCTOID AND PRODUCTOID = :PRODUCTOID AND PRECIO = :PRECIO
     INTO
     :KARDEXMOVTOID

   DO
   BEGIN

      SELECT FIRST 1 ID, ALMACENID, LOTE, FECHAVENCE, ORIGENFISCALID, ESAPARTADO, CANTIDAD
      FROM KARDEX WHERE MOVTOID = :KARDEXMOVTOID
      INTO :KARDEXID, :KARDEXALMACENID, :KARDEXLOTE, :KARDEXFECHAVENCE, :KARDEXORIGENFISCALID, :KARDEXESAPARTADO, :KARDEXCANTIDAD;

      IF(COALESCE(:KARDEXID,0) = 0) THEN
      BEGIN
        ERRORCODE = 1000;
        SUSPEND;
        EXIT;
      END


       SELECT FIRST 1 I.ID
       FROM  INVENTARIO I
       WHERE
                    I.ALMACENID= :KARDEXALMACENID
                AND I.PRODUCTOID = :PRODUCTOID
                AND I.LOTE = :KARDEXLOTE
                AND I.FECHAVENCE = :KARDEXFECHAVENCE
                AND I.ORIGENFISCALID = :KARDEXORIGENFISCALID
                AND I.ESAPARTADO = :KARDEXESAPARTADO
      INTO :INVENTARIOID;

      
      IF(COALESCE(:INVENTARIOID,0) = 0) THEN
      BEGIN
        

            INSERT INTO INVENTARIO
                (ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD,ORIGENFISCALID,ESAPARTADO)
            VALUES
                (:KARDEXALMACENID, :PRODUCTOID, :KARDEXLOTE, :KARDEXFECHAVENCE, :KARDEXCANTIDAD,:KARDEXORIGENFISCALID, :KARDEXESAPARTADO)
            RETURNING ID
            INTO :INVENTARIOID;
      END
      ELSE
      BEGIN
            
            UPDATE INVENTARIO
            SET
            CANTIDAD = CANTIDAD + :KARDEXCANTIDAD
            WHERE   ID = :INVENTARIOID;


      END

      
            UPDATE PRODUCTO SET EXISTENCIA = EXISTENCIA + :kardexcantidad , EXISTENCIAREMISIONADO = COALESCE(EXISTENCIAREMISIONADO,0) + :KARDEXCANTIDAD
            WHERE ID = :PRODUCTOID;

      DELETE FROM KARDEX WHERE ID = :KARDEXID;


   END



   DELETE FROM MOVTO WHERE  DOCTOID = :DOCTOID AND PRODUCTOID = :PRODUCTOID AND PRECIO = :PRECIO AND ID <> :FIRSTMOVTOID;
        /*
   UPDATE MOVTO SET
    ESTATUSMOVTOID = 0,
    CANTIDAD = :FIRSTCANTIDAD ,
    LOTE = :FIRSTLOTE,
    FECHAVENCE = :FIRSTFECHAVENCE,
    CANTIDADDEFACTURA = 0,
    CANTIDADDEREMISION = 0 ,
    CANTIDADDEINDEFINIDO = 0 ,
    SURTIBLE = :FIRSTSURTIBLE ,
    MAXSURTIBLE = :FIRSTMAXSURTIBLE
   WHERE ID = :FIRSTMOVTOID;


                  
    SELECT ERRORCODE
                    FROM MOVTO_INSERT (
                    :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, :VENDEDORID, 1,
                    0, :PRODUCTOID, :FIRSTLOTE, :FIRSTFECHAVENCE, 0, 0, 0, 0, 0, :PRECIO, 0,
                    :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
                    :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,NULL,NULL,NULL,:FIRSTMOVTOID,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
                ) INTO :ERRORCODE;

    IF(COALESCE(:ERRORCODE,0) <> 0 ) THEN
    BEGIN
        SUSPEND;
        EXIT;
    END     */


   ERRORCODE = 0;
   SUSPEND;
         /*
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1004;
      SUSPEND;
   END */
END