create or alter procedure SURTIDO_ASIGNARESTADO (
    DOCTOID D_FK,
    NOTASURTIDO D_STDTEXT_MEDIUM,
    ESTADOSURTIDOID D_FK,
    PERSONAIDSURTIDO D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable CUENTANOSURTIBLE integer;
declare variable TIPODOCTOID D_FK;
declare variable CURRENTESTADOSURTIDO D_FK;
declare variable ESAPROBACIONCXC D_BOOLCN_NULL;
BEGIN

   SELECT TIPODOCTOID,ESTADOSURTIDOID FROM DOCTO WHERE ID = :DOCTOID INTO :TIPODOCTOID, :CURRENTESTADOSURTIDO;

   --VER SI ESTAN HACIENDO UNA APROBACION LOS DE CREDITO Y COBRANZA
   IF(COALESCE(:ESTADOSURTIDOID,0) = 2 AND COALESCE(:CURRENTESTADOSURTIDO,0) = 4) THEN
   BEGIN
          ESAPROBACIONCXC = 'S';
   END
   ELSE
   BEGIN
        ESAPROBACIONCXC = 'N';
   END


   IF(:ESTADOSURTIDOID = 1 AND COALESCE(:TIPODOCTOID,0) = 21) THEN
   BEGIN
     select count(*) from movto where doctoid = :doctoid and surtible = 'N' into :CUENTANOSURTIBLE;

     IF(COALESCE(:CUENTANOSURTIBLE,0) > 0) THEN
     BEGIN
        ERRORCODE = 5006;
        SUSPEND;
        EXIT;
     END


   END
   ELSE IF(:ESTADOSURTIDOID = 3 AND COALESCE(:TIPODOCTOID,0) = 21) THEN
   BEGIN
        UPDATE DOCTO SET ESFACTURAELECTRONICA = 'N' WHERE ID = :DOCTOID;
   END

   UPDATE DOCTO
   SET  NOTASURTIDO = :NOTASURTIDO, ESTADOSURTIDOID = :ESTADOSURTIDOID  ,
   PROCESOSURTIDO  = CASE WHEN :ESTADOSURTIDOID = 1 THEN 'S' ELSE 'N' END  ,
   FECHASURTIDO  = CASE WHEN :ESTADOSURTIDOID = 1 THEN CURRENT_DATE ELSE NULL END,
   PERSONAIDSURTIDO  = CASE WHEN :ESTADOSURTIDOID = 1 THEN :PERSONAIDSURTIDO ELSE NULL END ,
   FECHAAPROBACIONCXC = CASE WHEN COALESCE(:ESAPROBACIONCXC,'N') = 'S' THEN CURRENT_DATE ELSE FECHAAPROBACIONCXC END,
   PERSONAIDAPROBACIONCXC = CASE WHEN COALESCE(:ESAPROBACIONCXC,'N') = 'S' THEN :PERSONAIDSURTIDO ELSE PERSONAIDAPROBACIONCXC END

   WHERE ID = :DOCTOID;





   ERRORCODE = 0;
   SUSPEND;
         /*
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1004;
      SUSPEND;
   END */
END