CREATE OR ALTER TRIGGER DOCTOPAGO_AIU0 FOR DOCTOPAGO
ACTIVE AFTER INSERT POSITION 0
AS
declare variable ABONO d_precio;
declare variable TIPODOCTOIDENTRADA d_fk;
declare variable TIPODOCTOIDSALIDA d_fk;
declare variable ABONA d_boolcn;
declare variable AFECTASALDOPERSONA D_BOOLCN ;
declare variable SENTIDO d_precio;
declare variable PERSONAIDENTRADA D_FK;
declare variable PERSONAIDSALIDA D_FK;
declare variable DOCTOIDBUFFER D_FK;
declare variable SALDOBUFFER D_PRECIO;   
declare variable RESTANTEBUFFER D_PRECIO;

BEGIN

-- Los pagos de apartados no se procesan aqui
IF(NEW.ESAPARTADO = 'N') THEN
BEGIN

   SELECT tipodoctoid from docto where  id = NEW.DOCTOID  INTO :TIPODOCTOIDENTRADA;
   SELECT tipodoctoid from docto where  id = NEW.DOCTOSALIDAID  INTO :TIPODOCTOIDSALIDA;

   if(:TIPODOCTOIDENTRADA  in (11,12,13,15,60) or :TIPODOCTOIDSALIDA in (11,12,13,15,60)) then
   begin
     exit;
   end

   SELECT abona, afectasaldopersona from formapago where id = new.formapagoid into :ABONA,:AFECTASALDOPERSONA;



    SELECT personaid FROM DOCTO WHERE ID = NEW.DOCTOID INTO :PERSONAIDENTRADA;   
    SELECT personaid FROM DOCTO WHERE ID = NEW.DOCTOSALIDAID INTO :PERSONAIDSALIDA;





   IF(:ABONA = 'S') then
   begin
       --if (:TIPODOCTOIDENTRADA IN (21,24,25) AND (NEW.formapagoid in (6,7) or NEW.tipopagoid = 1 ) ) THEN
        IF(NEW.DOCTOID  IS NOT NULL) THEN
       BEGIN


          select coalesce(sum(p.importe *
          (CASE WHEN ((TIPOPAGOID = 1 AND FORMAPAGOID IN (1,2,3,4,5,6,14)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (7)))  THEN 1
                when ((TIPOPAGOID = 1 AND FORMAPAGOID IN (7)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (6))) THEN -1
                ELSE 0 END)
          ),0) from doctopago p inner join formapago f on p.formapagoid = f.id
          where p.doctoid = new.doctoid and f.abona = 'S' into :abono;

          UPDATE DOCTO SET ABONO = :ABONO , SALDO = CARGO - :ABONO WHERE ID = NEW.DOCTOID;
       END


       
       --if (:TIPODOCTOIDSALIDA = 22 AND (NEW.formapagoid  in (6,7) or NEW.tipopagoid = 2 )) THEN
       IF(NEW.DOCTOSALIDAID  IS NOT NULL) THEN
       BEGIN
          select coalesce(sum(p.importe *
           (CASE WHEN ((TIPOPAGOID = 2 AND FORMAPAGOID IN (1,2,3,4,5,7,14)) or (TIPOPAGOID = 1 AND FORMAPAGOID IN (6)))  THEN 1
                when ((TIPOPAGOID = 1 AND FORMAPAGOID IN (7)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (6)))  THEN -1
                ELSE 0 END)
          ),0) from doctopago p inner join formapago f on p.formapagoid = f.id
          where p.doctosalidaid = new.doctosalidaid and f.abona = 'S' into :abono;
          UPDATE DOCTO SET ABONO = :ABONO , SALDO = CARGO - :ABONO WHERE ID = NEW.DOCTOSALIDAID;
       END

    END

     IF(:afectasaldopersona  = 'S') THEN
     BEGIN

       IF(new.tipopagoid = 1) then
       begin
            SENTIDO = 1.00;
       end
       ELSE IF(new.tipopagoid = 2) THEN
       BEGIN
            SENTIDO = -1.00;
       END
       else
       begin
          SENTIDO = 0;
       end
     
        if (:TIPODOCTOIDENTRADA IN (21,24,25) AND NEW.TIPOPAGOID = 1) THEN
        BEGIN
           UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + (NEW.IMPORTE * :SENTIDO) WHERE ID = :PERSONAIDENTRADA;
        END
        ELSE if (:TIPODOCTOIDSALIDA in (22,23)  AND NEW.TIPOPAGOID = 2) then
        BEGIN
           UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + (NEW.IMPORTE * :SENTIDO) WHERE ID = :PERSONAIDSALIDA;
        END
     END





     RESTANTEBUFFER =   NEW.IMPORTE;

     /*IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 21 AND NEW.tipoaplicacioncreditoid = 2) THEN
     BEGIN
        FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.tipodoctoid = 22 AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDENTRADA and D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

           IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
           BEGIN
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTOIDBUFFER);
               RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
           END
           ELSE
           BEGIN
                  
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 2, :DOCTOIDBUFFER);
               RESTANTEBUFFER = 0;
               BREAK;
           END

        END
     END  */


     
    /* IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 21 AND NEW.tipoaplicacioncreditoid = 3) THEN
     BEGIN
      INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 7, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 2, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;

       DELETE FROM DOCTOPAGO  WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;
     END     */



     
     IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 2 AND :TIPODOCTOIDSALIDA = 22 AND :RESTANTEBUFFER > 0
        AND NEW.tipoaplicacioncreditoid = 2 AND NEW.DOCTOID IS NOT NULL) THEN
     BEGIN
            SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.SALDO > 0 AND D.ID = NEW.doctoid
            INTO   :DOCTOIDBUFFER, :SALDOBUFFER;

            IF(:DOCTOIDBUFFER IS NOT NULL AND COALESCE(:SALDOBUFFER,0)>0) THEN
            BEGIN
            
              IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
              BEGIN
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, NEW.DOCTOSALIDAID);
                  RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
              END
              ELSE
              BEGIN
                  
                   INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 1, NEW.DOCTOSALIDAID);
                    RESTANTEBUFFER = 0;
              END
            END

        /*IF(:RESTANTEBUFFER > 0) THEN
        BEGIN

            FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE (D.tipodoctoid IN (21,24)  or (D.tipodoctoid IN (25) and d.mercanciaentregada = 'S') )AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDSALIDA  and D.estatusdoctoid = 1
            INTO
            :DOCTOIDBUFFER, :SALDOBUFFER
             DO
             BEGIN
                IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
                BEGIN
                     INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, NEW.DOCTOSALIDAID);
                     RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
                END
                ELSE
                BEGIN
                  
                      INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 1, NEW.DOCTOSALIDAID);
                      RESTANTEBUFFER = 0;
                      BREAK;
                 END
              END
        END */
     END


     
     /*IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 2 AND :TIPODOCTOIDSALIDA = 22  AND NEW.tipoaplicacioncreditoid = 3) THEN
     BEGIN
             INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 6, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 1, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 10;

             DELETE FROM DOCTOPAGO  WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 10;
     END */

        /*
     
     IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 24  AND NEW.tipoaplicacioncreditoid in (4)) THEN
     BEGIN
     -- echar para atras las notas de credito que se crearon con la devolucion
            
            FOR SELECT P.doctoid, P.IMPORTE
            FROM DOCTOPAGO P
            WHERE P.DOCTOSALIDAID = NEW.doctosalidaid AND P.tipopagoid = 1 AND P.FORMAPAGOID = 6
            INTO
            :DOCTOIDBUFFER, :SALDOBUFFER
            DO
            BEGIN

              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, NEW.DOCTOSALIDAID);


            END


            SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE  D.SALDO > 0 AND D.ID = NEW.doctosalidaid
            INTO   :DOCTOIDBUFFER, :SALDOBUFFER;


                   
            IF(:DOCTOIDBUFFER IS NOT NULL AND COALESCE(:SALDOBUFFER,0)>0) THEN
            BEGIN
                      
              IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
              BEGIN
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, NEW.DOCTOSALIDAID);
                  RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
               END
               ELSE
               BEGIN
                    
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 2, NEW.DOCTOSALIDAID);
                  RESTANTEBUFFER = 0;
               END
             END

     END
        */
        /*

     IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 24  AND NEW.tipoaplicacioncreditoid in (2)) THEN
     BEGIN




       FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.tipodoctoid = 22 AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDENTRADA and D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

           IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
           BEGIN
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTOIDBUFFER);
               RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
           END
           ELSE
           BEGIN
                  
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 2, :DOCTOIDBUFFER);
               RESTANTEBUFFER = 0;
               BREAK;
           END

        END



     END
     */

     
    /* IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 24  AND NEW.tipoaplicacioncreditoid = 3) THEN
     BEGIN
      INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 7, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 2, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;

             DELETE FROM DOCTOPAGO  WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;
     END */





 END
END