create or alter procedure PERSONA_USUARIO_INSERT (
    CLAVE D_CLAVE,
    NOMBRE D_NOMBRE,
    USERNAME D_STDTEXT_SHORT,
    CLAVEACCESO D_STDTEXT_SHORT,
    EMPRESAID D_FK,
    VIGENCIA D_FECHA,
    RESET_PASS D_BOOLEAN,
    GAFFETE D_CLAVE_NULL,
    LISTAPRECIOID D_FK,
    TICKETLARGO D_BOOLCN,
    ALMACENID D_FK,
    CAJASBOTELLAS D_STDTEXT_MEDIUM,
    TICKETLARGOCREDITO D_BOOLCN,
    VENDEDORID D_FK,
    PENDMAXDIAS D_DIAS,
    GRUPOUSUARIOID D_FK,
    EMAIL1 D_STDTEXT_MEDIUM,
    CLERKPAGOSERVICIOSID D_FK,
    CLERKSERVICIOS D_FK,
    TICKETLARGOCOTIZACION D_BOOLCN,
    CODIGOAUTORIZACION D_STDTEXT_SHORT)
returns (
    PERSONAID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable REPETIDOS integer;
BEGIN
       ERRORCODE = 0;
       REPETIDOS = 0;

    SELECT COUNT(*) FROM PERSONA WHERE GAFFETE IS NOT NULL AND GAFFETE =:GAFFETE INTO :REPETIDOS;

    IF(COALESCE(:REPETIDOS ,0) > 0) THEN
    begin
         ERRORCODE = 3002;
         SUSPEND;
         EXIT;
    end 

    ALMACENID = case WHEN COALESCE(:ALMACENID,0) = 0 THEN 1 ELSE :ALMACENID END;


   INSERT INTO PERSONA 
   (
    CLAVE,
    NOMBRE,
    USERNAME,
    CLAVEACCESO,
    EMPRESAID,
    VIGENCIA,
    RESET_PASS,
    TIPOPERSONAID ,
    GAFFETE,
    LISTAPRECIOID,
    TICKETLARGO ,
    ALMACENID ,
    CAJASBOTELLAS  ,
    TICKETLARGOCREDITO ,
    VENDEDORID  ,
    PENDMAXDIAS ,
    GRUPOUSUARIOID ,
    EMAIL1      ,
    CLERKPAGOSERVICIOSID ,
    CLERKSERVICIOS   ,
    TICKETLARGOCOTIZACION ,
    CODIGOAUTORIZACION
    )
   VALUES
   (
    :CLAVE,
    :NOMBRE,
    :USERNAME,
    :CLAVEACCESO,
    :EMPRESAID,
    :VIGENCIA,
    :RESET_PASS ,
    20  ,
    :GAFFETE,
    :LISTAPRECIOID ,
    :TICKETLARGO ,
    :ALMACENID ,
    :CAJASBOTELLAS  ,
    :TICKETLARGOCREDITO ,
    :VENDEDORID  ,
    :PENDMAXDIAS ,
    :GRUPOUSUARIOID ,
    :EMAIL1     ,
    :CLERKPAGOSERVICIOSID ,
    :CLERKSERVICIOS,
    :TICKETLARGOCOTIZACION ,
    :CODIGOAUTORIZACION

   )
   RETURNING ID INTO :PERSONAID;

   IF ((:PERSONAID IS NULL) OR (:PERSONAID = 0)) THEN
   BEGIN
      ERRORCODE = 1001;
   END

   SUSPEND;
END