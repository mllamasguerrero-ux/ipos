CREATE OR ALTER PROCEDURE INVFIS_DIF_GENERAR (
    INVENTARIODOCTOID D_FK,
    TIPODOCTOID D_FK)
RETURNS (
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE DOCTOID D_FK;
DECLARE VARIABLE DOCTO2ID D_FK;
DECLARE VARIABLE MOVTOID D_FK;
DECLARE VARIABLE ALMACENID D_FK;
DECLARE VARIABLE CAJAID D_FK;
DECLARE VARIABLE SUCURSALID D_FK;
DECLARE VARIABLE PRODUCTOID D_FK;
DECLARE VARIABLE LOTE D_LOTE;
DECLARE VARIABLE FECHAVENCE D_FECHAVENCE;
DECLARE VARIABLE CANTIDAD D_CANTIDAD;
DECLARE VARIABLE CANTIDADSURTIDA D_CANTIDAD;
DECLARE VARIABLE CANTIDADFALTANTE D_CANTIDAD;
DECLARE VARIABLE CANTIDADDIFERENCIA D_CANTIDAD;
DECLARE VARIABLE ESTATUSDOCTOID D_FK;
DECLARE VARIABLE FALTANTES INTEGER;
DECLARE VARIABLE REFERENCIA D_REFERENCIA;
DECLARE VARIABLE COSTO D_COSTO;
DECLARE VARIABLE SUCURSALTID D_FK;
DECLARE VARIABLE ALMACENTID D_FK;
DECLARE VARIABLE TIPODIFERENCIAINVENTARIOID D_FK;
DECLARE VARIABLE TIPODOCTOINVFISID D_FK;
DECLARE VARIABLE PERSONAID D_FK;
BEGIN
   IF ((:INVENTARIODOCTOID IS NULL) OR (:INVENTARIODOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1073;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID NOT IN (51, 52)) THEN
   BEGIN
      ERRORCODE = 1074;
      SUSPEND;
      EXIT;
   END

   SELECT ALMACENID, SUCURSALID, CAJAID, TIPODOCTOID
   FROM DOCTO
   WHERE ID = :INVENTARIODOCTOID
   INTO :ALMACENID, :SUCURSALID, :CAJAID, :TIPODOCTOINVFISID;

   IF (:TIPODOCTOINVFISID <> 50) THEN
   BEGIN
      ERRORCODE = 1075;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID = 51) THEN
      REFERENCIA = 'Aplic Dif Inv Sobrante';
   ELSE IF (:TIPODOCTOID = 52) THEN
      REFERENCIA = 'Aplic Dif Inv Faltante';

   -- Inicializara para primer registro de movto
   DOCTOID = 0;

   -- Agrega un MOVTO para cada registro con diferencia
   -- entre CANTIDAD y CANTIDADSURTIDA
   FOR SELECT
      M.PRODUCTOID,
      M.LOTE,
      M.FECHAVENCE,
      M.CANTIDAD, 
      M.CANTIDADSURTIDA,
      M.CANTIDADFALTANTE,
      M.COSTO,
      M.TIPODIFERENCIAINVENTARIOID,
      D.PERSONAID
   FROM MOVTO M
     LEFT JOIN DOCTO D
       ON D.ID = M.DOCTOID
   WHERE M.DOCTOID = :INVENTARIODOCTOID
      AND (M.CANTIDAD <> M.CANTIDADSURTIDA)
   INTO
      :PRODUCTOID, :LOTE, :FECHAVENCE,
      :CANTIDAD, :CANTIDADSURTIDA, :CANTIDADFALTANTE,
      :COSTO, :TIPODIFERENCIAINVENTARIOID, :PERSONAID
   DO
   BEGIN
      COSTO = 0;

      SUCURSALTID = 0;
      ALMACENTID = 0;


      IF (:TIPODOCTOID = 51) THEN -- Sobrantes
         CANTIDADDIFERENCIA = :CANTIDADSURTIDA - :CANTIDAD;
      ELSE IF (:TIPODOCTOID = 52) THEN -- Faltantes
         CANTIDADDIFERENCIA = :CANTIDAD - :CANTIDADSURTIDA;
      ELSE
         CANTIDADDIFERENCIA = 0;

      IF (:CANTIDADDIFERENCIA > 0) THEN
      BEGIN
         --IF (((:CANTIDADDIFERENCIA > 0) AND (:TIPODOCTOID = 51)) OR
         --    ((:CANTIDADDIFERENCIA < 0) AND (:TIPODOCTOID = 52)))  THEN
         --BEGIN
            CANTIDADDIFERENCIA = ABS(:CANTIDADDIFERENCIA);

            SELECT DOCTOID, MOVTOID, ERRORCODE
            FROM MOVTO_INSERT(:DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1, 0,
               :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADDIFERENCIA, :CANTIDADDIFERENCIA, :CANTIDADDIFERENCIA, 0, 0, 0, 0,
               :REFERENCIA, '', :COSTO, :SUCURSALTID, :ALMACENTID, 'N', :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE)
            INTO :DOCTOID, :MOVTOID, :ERRORCODE;

            IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
            BEGIN
               SUSPEND;
               EXIT;
            END
         --END
      END
   END

   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;

   IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END
END
