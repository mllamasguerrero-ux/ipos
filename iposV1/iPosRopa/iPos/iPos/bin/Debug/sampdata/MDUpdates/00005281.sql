create or alter procedure CONSOLIDADO_PORCONSOLIDAR (
    FECHAINICIAL D_FECHA,
    FECHAFINAL D_FECHA,
    OMITIRVENTASAFRANQUICIAS varchar(2),
    INCLUIRGASTOS D_BOOLCN_NULL)
returns (
    ID D_FK,
    FOLIO D_DOCTOFOLIO,
    SERIE D_DOCTOSERIE,
    IMPORTE D_PRECIO,
    DESCUENTO D_PRECIO,
    SUBTOTAL D_PRECIO,
    IVA D_PRECIO,
    IEPS D_PRECIO,
    IMPUESTO D_PRECIO,
    TOTAL D_PRECIO,
    SALDO D_PRECIO,
    ABONO D_PRECIO,
    CARGO D_PRECIO,
    TIPODOCTONOMBRE D_NOMBRE_NULL,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    TIPODOCTOID D_FK,
    TIPOAPLICACION D_FK,
    DOCTOPAGOID D_FK,
    NOMBRETIPOAPLICACION D_NOMBRE_NULL)
as
declare variable NUMERO integer;
declare variable VERSIONCFDI D_STDTEXT_SHORT;
BEGIN
   NUMERO = 0;

    SELECT VERSIONCFDI FROM PARAMETRO INTO :VERSIONCFDI;


   FOR SELECT        DOCTO.ID,
            DOCTO.FOLIO,
            DOCTO.SERIE,
            COALESCE(DOCTO.IMPORTE,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPORTE,
            COALESCE(DOCTO.DESCUENTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS DESCUENTO,
                         COALESCE(DOCTO.SUBTOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SUBTOTAL,
                         COALESCE(DOCTO.IVA,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVA,
                         COALESCE(DOCTO.IEPS,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IEPS,
                         COALESCE(DOCTO.IMPUESTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPUESTO,
                         COALESCE(DOCTO.TOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS TOTAL,
                         COALESCE(DOCTO.SALDO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SALDO, 
                         COALESCE(DOCTO.ABONO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ABONO,
                         COALESCE(DOCTO.CARGO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS CARGO, 
                         TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
                         DOCTO.FECHA,
                         DOCTO.FECHAHORA ,
                         DOCTO.TIPODOCTOID ,
                          1 AS TIPOAPLICACION ,
                          0 AS DOCTOPAGOID ,
                          'VENTA' NOMBRETIPOAPLICACION

   FROM            DOCTO LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID LEFT JOIN
                         PARAMETRO ON 1 = 1
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
         AND DOCTO.esfacturaelectronica = 'N'
         AND DOCTO.ESTATUSDOCTOID = 1
         AND DOCTO.TIPODOCTOID IN (21)
         AND (DOCTO.FACTCONSID IS NULL)
         AND (DOCTO.DEVCONSID IS NULL)
         AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8))) 
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )


        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) IMPORTE ,
            0.0 DESCUENTO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) AS SUBTOTAL,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) AS TOTAL,
            0.0 AS SALDO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) ABONO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTOPAGO.FECHA,
            coalesce(DOCTOPAGO.FECHAHORA,CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID   ,
            2 AS TIPOAPLICACION  ,
            DOCTOPAGO.ID DOCTOPAGOID ,
            'PAGO POR NC DENTRO DE FACT' NOMBRETIPOAPLICACION



        FROM    DOCTO INNER join
                DOCTOPAGO ON DOCTOPAGO.DOCTOID = DOCTO.id INNER JOIN
                DOCTO DOCTODEV ON DOCTOPAGO.doctosalidaid = DOCTODEV.ID  LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID  LEFT JOIN
                PARAMETRO ON 1 = 1
                AND COALESCE(:VERSIONCFDI,'') <> '3.3'


        WHERE
           (DOCTO.FECHA >= :FECHAINICIAL) AND
            (DOCTO.FECHA <= :FECHAFINAL) AND
            (DOCTO.ESFACTURAELECTRONICA = 'N') AND
            (DOCTO.ESTATUSDOCTOID = 1) AND
            ( DOCTO.TIPODOCTOID IN (21, 22)) AND 
            (DOCTO.FACTCONSID IS NULL) AND
            (DOCTO.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1 AND DOCTODEV.tipodoctoid = 22
            AND DOCTOPAGO.formapagoid IN (6,7,8,9,10,11,12,13, 18,19,20,21)
            AND DOCTOPAGO.FECHA >= :FECHAINICIAL AND DOCTOPAGO.FECHA <= :FECHAFINAL
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )


           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) SUBTOTAL ,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS DEVOLUCIONES' NOMBRETIPOAPLICACION

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN
                PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (22)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22  
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTODEV.subtipodoctoid,0) NOT IN (24,22) )
            AND COALESCE(:VERSIONCFDI,'') <> '3.3'

         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA



            
           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTODEV.IMPORTE,0)) * -1 IMPORTE ,
            SUM(COALESCE(DOCTODEV.DESCUENTO,0)) * -1 DESCUENTO,
            SUM(COALESCE(DOCTODEV.SUBTOTAL,0)) * -1 AS SUBTOTAL,
            SUM(COALESCE(DOCTODEV.IVA,0)) * -1 IVA ,
            SUM(COALESCE(DOCTODEV.IEPS,0)) * -1 IEPS ,
            SUM(COALESCE(DOCTODEV.IMPUESTO,0)) * -1 IMPUESTO ,
            SUM(COALESCE(DOCTODEV.TOTAL,0)) * -1 AS TOTAL,
            SUM(COALESCE(DOCTODEV.SALDO,0)) * -1 AS SALDO,
            SUM(COALESCE(DOCTODEV.ABONO,0)) * -1 ABONO,
            SUM(COALESCE(DOCTODEV.CARGO,0)) * -1 CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS DEVOLUCIONES' NOMBRETIPOAPLICACION

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN
                PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (22)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22  
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTODEV.subtipodoctoid,0) NOT IN (24,22) )
            AND COALESCE(:VERSIONCFDI,'') = '3.3'

         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA




       
           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) SUBTOTAL ,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS GASTOS' NOMBRETIPOAPLICACION

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (60,61,63)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22
            and COALESCE(:INCLUIRGASTOS,'N') = 'S'
            AND COALESCE(:VERSIONCFDI,'') <> '3.3'



         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA



   INTO
          :ID ,
    :FOLIO ,
    :SERIE ,
    :IMPORTE ,
    :DESCUENTO ,
    :SUBTOTAL ,
    :IVA ,
    :IEPS ,
    :IMPUESTO ,
    :TOTAL ,
    :SALDO ,
    :ABONO ,
    :CARGO ,
    :TIPODOCTONOMBRE ,
    :FECHA ,
    :FECHAHORA,
    :TIPODOCTOID ,
    :TIPOAPLICACION,
    :DOCTOPAGOID,
    :NOMBRETIPOAPLICACION
   DO
   BEGIN
      NUMERO = :NUMERO + 1;
      SUSPEND;
   END

   if (:numero = 0) then
   begin
      ID = 0;
    FOLIO = 0;
    SERIE = '';
    IMPORTE = 0.0;
    DESCUENTO = 0.0;
    SUBTOTAL = 0.0;
    IVA = 0.0;
    IEPS  = 0.0;
    IMPUESTO  = 0.0;
    TOTAL  = 0.0;
    SALDO  = 0.0;
    ABONO  = 0.0;
    CARGO  = 0.0;
    TIPODOCTONOMBRE = '';
    FECHA = CURRENT_DATE;
    FECHAHORA = CURRENT_TIMESTAMP;
    TIPODOCTOID = 0;
    TIPOAPLICACION = 0;
   end

END