create or alter procedure BANCOMER_GETCONSECUTIVO (
    FECHA D_FECHA)
returns (
    CONSECUTIVONUEVO D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable CONSECUTIVOANTERIOR D_FK;
declare variable FECHAANTERIOR D_FK;
BEGIN
  SELECT CONSECUTIVO
  FROM BANCOMERCONSECUTIVO
  WHERE FECHA = :FECHA
  INTO :CONSECUTIVOANTERIOR;

  IF(COALESCE(:CONSECUTIVOANTERIOR,0) = 0) THEN
  BEGIN
    DELETE FROM BANCOMERCONSECUTIVO;

     EXECUTE STATEMENT
               'ALTER SEQUENCE SEQ_BANCOMERCONSECUTIVO RESTART WITH 1';


    CONSECUTIVONUEVO = GEN_ID(SEQ_BANCOMERCONSECUTIVO, 1);

    INSERT INTO BANCOMERCONSECUTIVO(FECHA, CONSECUTIVO)
    VALUES (:FECHA, :CONSECUTIVONUEVO);

  END
  ELSE
  BEGIN
         
    CONSECUTIVONUEVO = GEN_ID(SEQ_BANCOMERCONSECUTIVO, 1);

    UPDATE BANCOMERCONSECUTIVO
    SET FECHA = :FECHA, CONSECUTIVO = :CONSECUTIVONUEVO ;

  END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1047;
      SUSPEND;
   END 
END