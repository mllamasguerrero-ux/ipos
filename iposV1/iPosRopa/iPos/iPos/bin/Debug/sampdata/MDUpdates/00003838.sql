execute block
as
declare variable PRODUCTOID d_fk;
declare variable EMIDAPRODUCTOID d_fk;
declare variable EMIDAID D_NOMBRE;
declare variable EMIDADESCRIPTION D_NOMBRE;
declare variable EMIDASHORTDESCRIPTION D_NOMBRE;
declare variable EMIDAMONTO D_NOMBRE;

declare variable LINEAID D_FK;  
declare variable MARCAID D_FK;

begin



    SELECT ID FROM LINEA WHERE CLAVE = '--EMIDA--'
    INTO  :LINEAID;

    IF(COALESCE(:LINEAID, 0) = 0) THEN
    BEGIN
        INSERT INTO linea ( CLAVE, NOMBRE, ACUMULAPROMOCION, DESCUENTOVALE, TIPORECARGA, APLICAMAYOREOXLINEA)
        VALUES('--EMIDA--','--EMIDA--','N',0,NULL, 'N') returning ID INTO :LINEAID;
    END

    
    IF(COALESCE(:LINEAID,0) = 0 ) THEN
    BEGIN
        SUSPEND;
        EXIT;
    END


   
    SELECT ID FROM MARCA WHERE CLAVE = '--EMIDA--'
    INTO  :MARCAID;

    IF(COALESCE(:MARCAID, 0) = 0) THEN
    BEGIN
        INSERT INTO MARCA ( CLAVE, NOMBRE,  DESCONTINUADO)
        VALUES('--EMIDA--','--EMIDA--','N') returning ID INTO :MARCAID;
    END

    
   IF(COALESCE(:MARCAID,0) = 0 ) THEN
   BEGIN
        SUSPEND;
        EXIT;
   END





   FOR
   SELECT PRODUCTO.id PRODUCTOID, EMIDAPRODUCT.ID, EMIDAPRODUCT.PRODUCTID, EMIDAPRODUCT.DESCRIPTION, EMIDAPRODUCT.SHORTDESCRIPTION, EMIDAPRODUCT.AMOUNT
   FROM PRODUCTO
   INNER JOIN EMIDAPRODUCT ON PRODUCTO.emidaproductoid = EMIDAPRODUCT.ID
   WHERE COALESCE(PRODUCTO.emidaproductoid ,0) > 0
   INTO :PRODUCTOID, :EMIDAPRODUCTOID, :EMIDAID, :EMIDADESCRIPTION, :EMIDASHORTDESCRIPTION, :EMIDAMONTO
   DO
   BEGIN

        UPDATE PRODUCTO SET
        NOMBRE = COALESCE(:EMIDASHORTDESCRIPTION, NOMBRE),
        DESCRIPCION = COALESCE(:EMIDADESCRIPTION, DESCRIPCION),
        DESCRIPCION2 = COALESCE(:EMIDADESCRIPTION, DESCRIPCION),
        COSTOREPOSICION = CASE WHEN COALESCE(:EMIDAMONTO,'') <> '' THEN CAST(:EMIDAMONTO AS D_PRECIO) ELSE 0 end,
        COSTOPROMEDIO = CASE WHEN COALESCE(:EMIDAMONTO,'') <> '' THEN CAST(:EMIDAMONTO AS D_PRECIO) ELSE 0 end ,
        LINEAID = :LINEAID,
        MARCAID = :MARCAID
        WHERE ID = :PRODUCTOID ;

            
   END



   UPDATE MOVTO SET MOVTO.utilidad = 0 WHERE MOVTO.productoid IN ( SELECT PRODUCTO.id FROM PRODUCTO WHERE COALESCE(PRODUCTO.emidaproductoid ,0) > 0);

   UPDATE DOCTO  SET DOCTO.UTILIDAD = 0 WHERE DOCTO.TIPODOCTOID = 21 AND SUBTIPODOCTOID IN (22,24) AND FECHA >= '01.04.2016';

end