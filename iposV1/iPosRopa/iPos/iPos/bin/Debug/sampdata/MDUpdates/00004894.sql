create or alter procedure RETIRO_MONTOSUPEROMAXIMO (
    CAJEROID D_FK)
returns (
    MONTOSUPEROMAXIMO D_BOOLCN,
    TOTALCAJA D_IMPORTE,
    ERRORCODE D_ERRORCODE)
as
declare variable FECHACORTE D_FECHA;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable CORTEID D_FK;
declare variable EGRESOEFECTIVO D_IMPORTE;
declare variable INGRESOEFECTIVO D_IMPORTE;
declare variable EGRESOCHEQUE D_IMPORTE;
declare variable INGRESOCHEQUE D_IMPORTE;
declare variable EGRESOVALE D_IMPORTE;
declare variable INGRESOVALE D_IMPORTE;
declare variable MONTORETIROCAJA D_IMPORTE;
declare variable MANEJARRETIRODECAJA D_BOOLCN;
declare variable RETIRO_CAJA D_IMPORTE;
declare variable PAGOPROVEEDORES D_IMPORTE;
BEGIN

   MONTOSUPEROMAXIMO = 'N';

   SELECT MONTORETIROCAJA, MANEJARRETIRODECAJA
   FROM PARAMETRO INTO :MONTORETIROCAJA, :MANEJARRETIRODECAJA;

   IF(COALESCE(:MANEJARRETIRODECAJA, 'N') = 'N' or (coalesce(:MONTORETIROCAJA,0) = 0) ) THEN
   BEGIN
    SUSPEND;
    EXIT;
   END



   select FECHACORTE, HAYCORTEACTIVO, CORTEID
    FROM HAY_CORTE_ACTIVO(:CAJEROID) INTO :FECHACORTE, :HAYCORTEACTIVO, :CORTEID ;

    SELECT    EGRESOEFECTIVO , INGRESOEFECTIVO , EGRESOCHEQUE ,
            INGRESOCHEQUE , EGRESOVALE ,INGRESOVALE , RETIROSDECAJA  , PAGOPROVEEDORES
     FROM CORTE
     WHERE ID = :CORTEID
     INTO :EGRESOEFECTIVO , :INGRESOEFECTIVO , :EGRESOCHEQUE ,
            :INGRESOCHEQUE , :EGRESOVALE , :INGRESOVALE, :RETIRO_CAJA, :PAGOPROVEEDORES ;


     TOTALCAJA = COALESCE(:INGRESOEFECTIVO,0) -  COALESCE(:EGRESOEFECTIVO,0) + COALESCE(:RETIRO_CAJA,0) +  COALESCE(:PAGOPROVEEDORES,0) +
                  COALESCE(:INGRESOCHEQUE,0) -  COALESCE(:EGRESOCHEQUE,0) +
                  COALESCE(:INGRESOVALE,0) -  COALESCE(:EGRESOVALE,0) ;

      IF(COALESCE(:TOTALCAJA, 0) >= :MONTORETIROCAJA ) THEN
      BEGIN
       MONTOSUPEROMAXIMO = 'S';
      END


   SUSPEND;
END