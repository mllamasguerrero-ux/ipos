create or alter procedure INVFIS_DIF_GENERAR (
    INVENTARIODOCTOID D_FK,
    TIPODOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable DOCTOID D_FK;
declare variable DOCTO2ID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable CAJAID D_FK;
declare variable SUCURSALID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable CANTIDADFALTANTE D_CANTIDAD;
declare variable CANTIDADDIFERENCIA D_CANTIDAD;
declare variable ESTATUSDOCTOID D_FK;
declare variable FALTANTES integer;
declare variable REFERENCIA D_REFERENCIA;
declare variable COSTO D_COSTO;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable TIPODOCTOINVFISID D_FK;
declare variable PERSONAID D_FK;
declare variable VENDEDORID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
BEGIN

   ERRORCODE = 0;

   IF ((:INVENTARIODOCTOID IS NULL) OR (:INVENTARIODOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1073;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID NOT IN (51, 52)) THEN
   BEGIN
      ERRORCODE = 1074;
      SUSPEND;
      EXIT;
   END

   SELECT ALMACENID, SUCURSALID, CAJAID, TIPODOCTOID
   FROM DOCTO
   WHERE ID = :INVENTARIODOCTOID
   INTO :ALMACENID, :SUCURSALID, :CAJAID, :TIPODOCTOINVFISID;

   IF (:TIPODOCTOINVFISID <> 50) THEN
   BEGIN
      ERRORCODE = 1075;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID = 51) THEN
      REFERENCIA = 'Aplic Dif Inv Sobrante';
   ELSE IF (:TIPODOCTOID = 52) THEN
      REFERENCIA = 'Aplic Dif Inv Faltante';

   -- Inicializara para primer registro de movto
   DOCTOID = 0;

   -- Agrega un MOVTO para cada registro con diferencia
   -- entre CANTIDAD y CANTIDADSURTIDA
   FOR SELECT
      M.PRODUCTOID,
      M.LOTE,
      M.FECHAVENCE,
      M.CANTIDAD, 
      M.CANTIDADSURTIDA,
      M.CANTIDADFALTANTE,
      M.COSTO,
      M.TIPODIFERENCIAINVENTARIOID,
      D.PERSONAID  ,
      D.VENDEDORID ,
      M.DESCRIPCION1,
      M.DESCRIPCION2,
      M.DESCRIPCION3
   FROM MOVTO M
     LEFT JOIN DOCTO D
       ON D.ID = M.DOCTOID
   WHERE M.DOCTOID = :INVENTARIODOCTOID
      AND (coalesce(M.CANTIDAD,0) <> coalesce(M.CANTIDADSURTIDA,0))
      ORDER BY (COALESCE(M.CANTIDADSURTIDA,0) - COALESCE(M.CANTIDAD,0)) DESC
   INTO
      :PRODUCTOID, :LOTE, :FECHAVENCE,
      :CANTIDAD, :CANTIDADSURTIDA, :CANTIDADFALTANTE,
      :COSTO, :TIPODIFERENCIAINVENTARIOID, :PERSONAID , :VENDEDORID  , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
   DO
   BEGIN
      COSTO = 0;

      SUCURSALTID = 0;
      ALMACENTID = 0;


      IF (:TIPODOCTOID = 51) THEN -- Sobrantes
         CANTIDADDIFERENCIA = :CANTIDADSURTIDA - :CANTIDAD;
      ELSE IF (:TIPODOCTOID = 52) THEN -- Faltantes
         CANTIDADDIFERENCIA = :CANTIDAD - :CANTIDADSURTIDA;
      ELSE
         CANTIDADDIFERENCIA = 0;

      IF (:CANTIDADDIFERENCIA > 0) THEN
      BEGIN
         --IF (((:CANTIDADDIFERENCIA > 0) AND (:TIPODOCTOID = 51)) OR
         --    ((:CANTIDADDIFERENCIA < 0) AND (:TIPODOCTOID = 52)))  THEN
         --BEGIN
            CANTIDADDIFERENCIA = ABS(:CANTIDADDIFERENCIA);


            SELECT DOCTOID, MOVTOID, ERRORCODE
            FROM MOVTO_INSERT(:DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, :VENDEDORID, 1, 0,
               :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADDIFERENCIA, :CANTIDADDIFERENCIA, :CANTIDADDIFERENCIA, 0, 0, 0, 0,
               :REFERENCIA, '', :COSTO, :SUCURSALTID, :ALMACENTID, 'N', :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00,NULL,NULL,NULL,NULL,NULL, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3)
            INTO :DOCTOID, :MOVTOID, :ERRORCODE;

            IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
            BEGIN
            --insert into traza(valor) values('kkl. ' || cast(:productoid as varchar(10)));

               SUSPEND;
               EXIT;
            END
         --END
      END
   END

   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;

   IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
   ERRORCODE = 0;
   SUSPEND;
   
  /* WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END  */
END