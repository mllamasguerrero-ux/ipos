create or alter procedure PRODUCTO_INSERT (
    ACTIVO D_BOOLCS,
    CREADOPOR_USERID type of D_FK,
    MODIFICADOPOR_USERID type of D_FK,
    CLAVE D_CLAVE,
    NOMBRE D_NOMBRE,
    DESCRIPCION D_DESCRIPCION,
    EAN D_CLAVE,
    DESCRIPCION1 D_STDTEXT_MEDIUM,
    DESCRIPCION2 D_STDTEXT_MEDIUM,
    DESCRIPCION3 varchar(40),
    PROVEEDOR1ID integer,
    PROVEEDOR2ID integer,
    LINEAID integer,
    MARCAID integer,
    PRECIO1 D_PRECIO,
    PRECIO2 D_PRECIO,
    PRECIO3 D_PRECIO,
    PRECIO4 D_PRECIO,
    PRECIO5 D_PRECIO,
    TASAIVAID D_FK,
    TASAIVA D_PORCENTAJE,
    MONEDAID D_FK,
    COSTOREPOSICION D_COSTO,
    COSTOULTIMO D_COSTO,
    COSTOPROMEDIO D_COSTO,
    PRODUCTOSUSTITUTOID D_FK,
    MANEJALOTE D_BOOLCN,
    ESKIT D_BOOLCN,
    IMPRIMIR D_BOOLCN,
    INVENTARIABLE D_BOOLCN,
    NEGATIVOS D_BOOLCN,
    LIMITEPRECIO2 D_CANTIDAD,
    PRECIOMAXIMOPUBLICO D_PRECIO,
    FECHACAMBIOPRECIO D_FECHA,
    MANEJASTOCK D_BOOLCN,
    STOCK D_CANTIDAD,
    CAMBIARPRECIO D_BOOLCN,
    COMISION D_PRECIO,
    OFERTA D_PRECIO,
    TOMARPRECIOPADRE D_BOOLCN,
    TOMARCOMISIONPADRE D_BOOLCN,
    TOMAROFERTAPADRE D_BOOLCN,
    PRODUCTOPADRE D_FK,
    TEXTO1 D_STDTEXT_LIGHT,
    TEXTO2 D_STDTEXT_LIGHT,
    TEXTO3 D_STDTEXT_LIGHT,
    TEXTO4 D_STDTEXT_LIGHT,
    TEXTO5 D_STDTEXT_MEDIUM,
    TEXTO6 D_STDTEXT_LARGE,
    NUMERO1 D_PRECIO,
    NUMERO2 D_PRECIO,
    NUMERO3 D_PRECIO,
    NUMERO4 D_PRECIO,
    FECHA1 D_FECHA,
    FECHA2 D_FECHA,
    PZACAJA D_CANTIDAD,
    U_EMPAQUE D_CANTIDAD,
    UNIDAD D_CLAVE_NULL,
    CBARRAS D_CLAVE_NULL,
    CEMPAQUE D_CLAVE_NULL,
    PLUG D_CLAVE_NULL,
    MAYOKGS D_BOOLCN,
    INI_MAYO D_CANTIDAD,
    DESCRIPCION_COMODIN D_BOOLCN,
    CUENTAPREDIAL D_STDTEXT_64,
    IMAGEN D_IMAGEN,
    TASAIEPS D_PORCENTAJE,
    TASAIMPUESTO D_PORCENTAJE,
    MINUTILIDAD D_PORCENTAJE,
    SPRECIO1 D_PRECIO,
    SPRECIO2 D_PRECIO,
    SPRECIO3 D_PRECIO,
    SPRECIO4 D_PRECIO,
    SPRECIO5 D_PRECIO,
    DESCUENTO D_PORCENTAJE,
    REQUIERERECETA D_BOOLCN,
    PRECIOSUGERIDO D_PRECIO,
    PRECIOTOPE D_PRECIO,
    STOCKMAX D_CANTIDAD,
    SURTIRPORCAJA D_BOOLCN,
    TIPOABC D_BOOLCN,
    PRECIOMAT char(1),
    PRECIO6 D_PRECIO,
    MENUDEO D_CANTIDAD,
    CONTENIDOID D_FK,
    CONTENIDOVALOR D_CONTENIDO,
    CLASIFICAID D_FK,
    UNIDAD2 D_CLAVE_NULL,
    CANTXPIEZA D_CANTIDAD,
    MANEJALOTEIMPORTADO D_BOOLCN,
    COSTOENDOLAR D_COSTO)
returns (
    PRODUCTOID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable ESPRODUCTOFINAL D_BOOLCN;
declare variable ESPRODUCTOPADRE D_BOOLCN;
declare variable ESSUBPRODUCTO D_BOOLCN;
declare variable CARACTERISTICAID D_FK;
declare variable PRODUCTOIDBUFFER D_FK;
declare variable TASAIVAMONTO D_PORCENTAJE;
declare variable SUCURSALCLAVE D_CLAVE;
declare variable MANEJAKITS D_BOOLCN;
declare variable PRODUCTOPADREESKIT D_BOOLCN;
declare variable CUENTAESTAENKITS integer;
declare variable CUENTAAUX integer;
declare variable EANPUEDEREPETIRSE D_BOOLCN;
BEGIN


      select first 1 manejakits, EANPUEDEREPETIRSE from parametro into :MANEJAKITS, :EANPUEDEREPETIRSE;

    PRODUCTOID   = NULL;
    PRODUCTOIDBUFFER = null;

   IF(coalesce(:EAN,'') <> ''  AND COALESCE(:EANPUEDEREPETIRSE,'N') = 'N') THEN
   BEGIN
       select first 1 id from producto where ean = :ean
       into :PRODUCTOID;

        IF(COALESCE(:PRODUCTOID,0) <> 0 ) then
        BEGIN
            ERRORCODE = 1085;
            SUSPEND;
            EXIT;
        END
   END
   ELSE IF(coalesce(:EAN,'') = '') THEN
   BEGIN
     EAN = '';
   END


   IF (:ERRORCODE > 0) THEN
   BEGIN
      PRODUCTOID = 0;
      SUSPEND;
      EXIT;
   END

   ESPRODUCTOFINAL = 'S';
   ESPRODUCTOPADRE = 'N';

   IF(COALESCE(:PRODUCTOPADRE,0) = 0) THEN
   BEGIN
   
    TOMARPRECIOPADRE  = 'N';
    TOMARCOMISIONPADRE   = 'N';
    TOMAROFERTAPADRE   = 'N'; 
    ESSUBPRODUCTO   = 'N';

   END
   ELSE
   BEGIN
     ESSUBPRODUCTO   = 'S';
     select first 1 id, eskit from producto where id = :PRODUCTOPADRE
       into :PRODUCTOIDBUFFER, :PRODUCTOPADREESKIT;
       
        IF(COALESCE(:PRODUCTOIDBUFFER,0) = 0) then
        BEGIN
            ERRORCODE = 1004;-- TODO Poner el erro code correcto
            SUSPEND;
            EXIT;
        END

        IF(COALESCE(:MANEJAKITS,'N') = 'S') THEN
        BEGIN
             IF(COALESCE(:PRODUCTOPADREESKIT,'N') = 'S') THEN
             BEGIN
                ERRORCODE = 4010;-- TODO Poner el erro code correcto
                SUSPEND;
                EXIT;
             END

             SELECT COUNT(*) from KITDEFINICION WHERE PRODUCTOPARTEID = :PRODUCTOPADRE INTO :CUENTAESTAENKITS;
             IF(COALESCE(:CUENTAESTAENKITS,0) > 0) THEN
             BEGIN
                    
                ERRORCODE = 4012;
                SUSPEND;
                EXIT;
             END

        END

   END


  select  first 1 sucursal.clave
  from sucursal inner join parametro
  on sucursal.id = parametro.sucursalid
  into :sucursalclave;

   SELECT  COALESCE(TASA,0) FROM TASAIVA WHERE ID = :TASAIVAID INTO :TASAIVAMONTO;       
   TASAIMPUESTO = COALESCE(:TASAIEPS,0)  +  COALESCE(:TASAIVAMONTO,0) +  ((COALESCE(:TASAIEPS,0) * COALESCE(:TASAIVAMONTO,0))/100) ;

   
  IF ((CLAVE IS NULL) OR (CLAVE = '')) THEN
    CLAVE = 'AUTO-' || coalesce(:sucursalclave,'X') || '-' || cast(GEN_ID(SEQ_PRODUCTO_clave, 1) as d_clave);


    

     IF(  COALESCE(:MANEJAKITS,'N') = 'S') THEN
     BEGIN
        IF(COALESCE(:ESKIT,'N') = 'S' AND COALESCE(:NEGATIVOS,'N') = 'S') THEN
        BEGIN   
            ERRORCODE = 4009;-- TODO Poner el erro code correcto
            SUSPEND;
            EXIT;
        END


     END


     
   IF(coalesce(:CLAVE,'') <> '') THEN
   BEGIN
       select count(*) from producto where clave = :clave
       into :CUENTAAUX;

        IF(COALESCE(:CUENTAAUX,0) <> 0) then
        BEGIN
            ERRORCODE = 1086;
            SUSPEND;
            EXIT;
        END
   END
   ELSE
   BEGIN
     EAN = '';
   END



      INSERT INTO PRODUCTO
      (

    ACTIVO,

CREADOPOR_USERID,

MODIFICADOPOR_USERID,

CLAVE,

NOMBRE,

DESCRIPCION,

EAN,

DESCRIPCION1,

DESCRIPCION2,

DESCRIPCION3,

PROVEEDOR1ID,

PROVEEDOR2ID,

LINEAID,

MARCAID,

PRECIO1,

PRECIO2,

PRECIO3,

PRECIO4,

PRECIO5,

TASAIVAID,

TASAIVA,

MONEDAID,

COSTOREPOSICION,

COSTOULTIMO,

COSTOPROMEDIO,

PRODUCTOSUSTITUTOID,

MANEJALOTE,

ESKIT,

IMPRIMIR,

INVENTARIABLE,

NEGATIVOS,

LIMITEPRECIO2,

PRECIOMAXIMOPUBLICO,

FECHACAMBIOPRECIO,

MANEJASTOCK,

STOCK,

CAMBIARPRECIO ,

COMISION,
OFERTA ,
TOMARPRECIOPADRE ,
TOMARCOMISIONPADRE ,
TOMAROFERTAPADRE ,
PRODUCTOPADRE ,
ESPRODUCTOFINAL,
ESPRODUCTOPADRE,
ESSUBPRODUCTO ,

PZACAJA ,

U_EMPAQUE,
UNIDAD ,

CBARRAS,
CEMPAQUE,
PLUG,
MAYOKGS,

INI_MAYO,

DESCRIPCION_COMODIN ,
CUENTAPREDIAL,

IMAGEN ,

TASAIEPS,

TASAIMPUESTO,

MINUTILIDAD,

SPRECIO1,

SPRECIO2,

SPRECIO3,

SPRECIO4,

SPRECIO5 ,

DESCUENTO,

REQUIERERECETA,

PRECIOSUGERIDO,

PRECIOTOPE,

STOCKMAX,

SURTIRPORCAJA ,

TIPOABC,

PRECIOMAT ,

PRECIO6 ,

MENUDEO ,

CONTENIDOID  ,

CONTENIDOVALOR,

CLASIFICAID,

UNIDAD2,

CANTXPIEZA ,

MANEJALOTEIMPORTADO  ,

COSTOENDOLAR


         )

Values (
:ACTIVO,

:CREADOPOR_USERID,

:MODIFICADOPOR_USERID,

:CLAVE,

:NOMBRE,

:DESCRIPCION,

:EAN,

:DESCRIPCION1,

:DESCRIPCION2,

:DESCRIPCION3,

:PROVEEDOR1ID,

:PROVEEDOR2ID,

:LINEAID,

:MARCAID,

:PRECIO1,

:PRECIO2,

:PRECIO3,

:PRECIO4,

:PRECIO5,

:TASAIVAID,

:TASAIVA,
--:TASAIVAMONTO,

:MONEDAID,

:COSTOREPOSICION,

:COSTOULTIMO,

:COSTOPROMEDIO,

:PRODUCTOSUSTITUTOID,

:MANEJALOTE,

:ESKIT,

:IMPRIMIR,

:INVENTARIABLE,

:NEGATIVOS,

:LIMITEPRECIO2,

:PRECIOMAXIMOPUBLICO,

:FECHACAMBIOPRECIO,

:MANEJASTOCK,

:STOCK,

:CAMBIARPRECIO ,

:COMISION,
:OFERTA ,
:TOMARPRECIOPADRE ,
:TOMARCOMISIONPADRE ,
:TOMAROFERTAPADRE ,
:PRODUCTOPADRE ,
:ESPRODUCTOFINAL,
:ESPRODUCTOPADRE,
:ESSUBPRODUCTO ,

:PZACAJA,
:U_EMPAQUE,
:UNIDAD ,

:CBARRAS,
:CEMPAQUE,
:PLUG,
:MAYOKGS,
:INI_MAYO ,
:DESCRIPCION_COMODIN  ,
:CUENTAPREDIAL ,

:IMAGEN ,

:TASAIEPS,

:TASAIMPUESTO ,

:MINUTILIDAD,

:SPRECIO1,

:SPRECIO2,

:SPRECIO3,

:SPRECIO4,

:SPRECIO5,

:DESCUENTO,

:REQUIERERECETA,

:PRECIOSUGERIDO ,

:PRECIOTOPE,

:STOCKMAX,

:SURTIRPORCAJA,

:TIPOABC,

:PRECIOMAT,

:PRECIO6,

:MENUDEO ,

:CONTENIDOID  ,

:CONTENIDOVALOR,

:CLASIFICAID,

:UNIDAD2,

:CANTXPIEZA,

:MANEJALOTEIMPORTADO ,

:COSTOENDOLAR


)
   RETURNING ID INTO :PRODUCTOID;


 INSERT INTO productocaracteristicas
 ( PRODUCTOID,
    CLAVE,
   TEXTO1,
   TEXTO2,
   TEXTO3,
   TEXTO4,
   TEXTO5,
   TEXTO6,
   NUMERO1,
   NUMERO2,
   NUMERO3,
   NUMERO4,
   FECHA1,
   FECHA2
  )
  VALUES
   (:PRODUCTOID, 
    :CLAVE,
   :TEXTO1,
   :TEXTO2,
   :TEXTO3,
   :TEXTO4,
   :TEXTO5,
   :TEXTO6,
   :NUMERO1,
   :NUMERO2,
   :NUMERO3,
   :NUMERO4,
   :FECHA1,
   :FECHA2
   );





   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1002;
   END

   SUSPEND;
END