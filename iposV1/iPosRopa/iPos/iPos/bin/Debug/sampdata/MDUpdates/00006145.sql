create or alter procedure MOVILDOCTOSAPROBARCREDITO (
    ESTADOSURTIDOID D_FK,
    FECHAMINIMA D_FECHA,
    VENDEDORFINAL D_FK)
returns (
    ID D_FK,
    FOLIO D_DOCTOFOLIO,
    SERIE D_DOCTOSERIE,
    FOLIOSAT D_DOCTOFOLIO,
    SERIESAT D_DOCTOSERIE,
    TOTAL D_PRECIO,
    NOMBRECLIENTE D_NOMBRE_NULL,
    NOMBREVENDEDOR D_NOMBRE_NULL,
    USERNAME D_NOMBRE_NULL,
    PROCESOSURTIDO D_BOOLCN_NULL,
    OBSERVACIONFACTURACION D_REFERENCIA,
    FECHA D_FECHA,
    ALMACENID D_FK,
    ESVENTAMOVIL D_BOOLCN_NULL,
    NOMBRETIPODOCTO D_NOMBRE_NULL,
    TIPODOCTOID D_FK,
    ESPEDIDOTRASLADO D_NOMBRE_NULL,
    SUCURSALDESTINONOMBRE D_NOMBRE_NULL,
    SALDO D_PRECIO,
    LIMITECREDITO D_PRECIO,
    DIAS D_DIAS,
    VENDEDORCLIENTECLAVE D_CLAVE_NULL,
    VENDEDORCLIENTENOMBRE D_NOMBRE_NULL,
    CREDITOAPROBADO D_NOMBRE_NULL,
    REFERENCIA D_REFERENCIA,
    COBRANZAAPLICADA D_PRECIO,
    VENDEDORFINALID D_FK,
    VENDEDORFINALCLAVE D_CLAVE_NULL,
    CLIENTECLAVE D_CLAVE_NULL)
as
declare variable REFERENCIALPAD varchar(250);
BEGIN





   FOR SELECT        DOCTO.ID, DOCTO.FOLIO, DOCTO.SERIE, DOCTO.FOLIOSAT, DOCTO.SERIESAT, DOCTO.TOTAL, CLIENTE.NOMBRE AS NOMBRECLIENTE, VENDEDOR.NOMBRE AS NOMBREVENDEDOR, VENDEDOR.USERNAME, 
                         DOCTO.PROCESOSURTIDO, CASE WHEN (DOCTO.ESFACTURAELECTRONICA = 'S') AND (DOCTO.FOLIOSAT = - 3) THEN 'CON PROBLEMAS DE FACTURACION' ELSE '' END AS OBSERVACIONFACTURACION, 
                         DOCTO.FECHA, DOCTO.ALMACENID, CASE WHEN DOCTO.SUBTIPODOCTOID = 15 THEN 'S' ELSE 'N' END AS ESVENTAMOVIL, TIPODOCTO.NOMBRE AS NOMBRETIPODOCTO, DOCTO.TIPODOCTOID, 
                         CASE WHEN DOCTO.SUBTIPODOCTOID IN (7, 8) OR
                         DOCTO.TIPODOCTOID IN (31, 81) THEN 'S' ELSE 'N' END AS ESPEDIDOTRASLADO, SUCURSALDESTINO.NOMBRE AS SUCURSALDESTINONOMBRE, CLIENTE.SALDO, CLIENTE.LIMITECREDITO, 
                         CLIENTE.DIAS, VENDEDORCLIENTE.clave VENDEDORCLIENTECLAVE, VENDEDORCLIENTE.NOMBRE VENDEDORCLIENTENOMBRE, DOCTO.TOTAL CREDITOAPROBADO,
                         DOCTO.REFERENCIA, DOCTO.VENDEDORFINAL , VENDEDORFINALTABLE.CLAVE, CLIENTE.CLAVE CLIENTECLAVE

        FROM            DOCTO LEFT OUTER JOIN
                         PERSONA CLIENTE ON CLIENTE.ID = DOCTO.PERSONAID LEFT OUTER JOIN
                         PERSONA VENDEDOR ON VENDEDOR.ID = DOCTO.VENDEDORID LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID LEFT OUTER JOIN
                         SUCURSAL SUCURSALDESTINO ON SUCURSALDESTINO.ID = DOCTO.SUCURSALTID LEFT OUTER JOIN
                         PERSONA VENDEDORCLIENTE ON VENDEDORCLIENTE.ID = CLIENTE.vendedorid LEFT OUTER JOIN
                         PERSONA VENDEDORFINALTABLE ON VENDEDORFINALTABLE.ID = DOCTO.VENDEDORFINAL
        WHERE        (DOCTO.TIPODOCTOID IN (331)) AND
            (DOCTO.ESTATUSDOCTOID = 0) AND (DOCTO.ESTADOSURTIDOID = :ESTADOSURTIDOID) AND
            (DOCTO.FECHA >= :FECHAMINIMA) AND
            (DOCTO.VENDEDORFINAL = :VENDEDORFINAL OR :VENDEDORFINAL = 0)
        ORDER BY DOCTO.FECHAHORA

   INTO
      :ID ,
      :FOLIO ,
      :SERIE ,
      :FOLIOSAT ,
      :SERIESAT ,
      :TOTAL ,
      :NOMBRECLIENTE ,
      :NOMBREVENDEDOR ,
      :USERNAME ,
      :PROCESOSURTIDO ,
      :OBSERVACIONFACTURACION ,
      :FECHA ,
      :ALMACENID ,
      :ESVENTAMOVIL ,
      :NOMBRETIPODOCTO ,
      :TIPODOCTOID ,
      :ESPEDIDOTRASLADO ,
      :SUCURSALDESTINONOMBRE ,
      :SALDO ,
      :LIMITECREDITO ,
      :DIAS ,
      :VENDEDORCLIENTECLAVE ,
      :VENDEDORCLIENTENOMBRE ,
      :CREDITOAPROBADO,
      :REFERENCIA ,
      :VENDEDORFINALID ,
      :VENDEDORFINALCLAVE,
      :CLIENTECLAVE
   DO
   BEGIN

   COBRANZAAPLICADA = 0;

   IF(COALESCE(:REFERENCIA,'') <> '' AND
      COALESCE(:VENDEDORFINALCLAVE, '') <> '') THEN
   BEGIN
   
      REFERENCIALPAD = LPAD(COALESCE(:REFERENCIA,''),20,'0');


    --VENDEDORFINALCLAVE = 'SAHID';
    --CLIENTECLAVE = 'GG000005';
    --REFERENCIALPAD = '000000000000000100630';

      SELECT
       SUM(R_PAGOMOVIL.IMPORTE) MONTO
       FROM R_PAGOMOVIL
        LEFT JOIN
        ( SELECT FIRST 1 MOVILSESION.FOLIOINICIOCOBRA,
            MOVILSESION.FOLIOFINCOBRA  ,MOVILSESION.FECHAINICIOCOBRA,
            MOVILSESION.FECHAFINCOBRA
            FROM MOVILSESION
            WHERE
                COALESCE(MOVILSESION.VENDEDORCLAVE,'') = COALESCE(:VENDEDORFINALCLAVE, '') AND
                ( :REFERENCIALPAD >=  LPAD(COALESCE(MOVILSESION.FOLIOINICIOVENTA,''),20,'0') AND
                    ( :REFERENCIALPAD <  LPAD(COALESCE(MOVILSESION.FOLIOFINVENTA,''),20,'0') OR
                        LPAD(COALESCE(MOVILSESION.FOLIOINICIOVENTA,''),20,'0') > LPAD(COALESCE(MOVILSESION.FOLIOFINVENTA,''),20,'0')
                    )
                )
        ) MOVSES  ON 1 = 1
        WHERE
             COALESCE(r_pagomovil.personaclave,'') =  COALESCE(:CLIENTECLAVE, '') AND
             COALESCE(r_pagomovil.vendedor,'') =  COALESCE(:VENDEDORFINALCLAVE, '') AND
             (
                ( r_pagomovil.fecha >=  MOVSES.FECHAINICIOCOBRA  AND
                   ( r_pagomovil.fecha <=  MOVSES.FECHAFINCOBRA OR
                      MOVSES.FECHAINICIOCOBRA >= MOVSES.FECHAFINCOBRA
                    )
                )
                OR
                (R_PAGOMOVIL.FECHA = :FECHA)
             )
            /*( R_PAGOMOVIL.PAGOIDORIGINAL >= MOVSES.FOLIOINICIOCOBRA AND
              ( R_PAGOMOVIL.PAGOIDORIGINAL <  MOVSES.FOLIOFINCOBRA OR MOVSES.FOLIOINICIOCOBRA > MOVSES.FOLIOFINCOBRA) )
                */
        INTO :COBRANZAAPLICADA;


   END



      SUSPEND;
   END
END