create or alter procedure NOTACREDITO_DEVOLVERTODAVENTA (
    DOCTODEVOLVERID D_FK,
    VENDEDORID D_FK,
    DOCTONCID D_FK)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTODEVOLVERID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable NOTASCREDITOAPLICADAS D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable ESTADOSURTIDOID D_FK;
declare variable HABSURTIDOPOSTPUESTO D_BOOLCN;
declare variable DOCTOFACTCONSID D_FK;
declare variable SUBTIPODOCTOID D_FK;
declare variable DOCTOREFID D_FK;
declare variable SUBTIPODOCTOIDSECUNDARIO D_FK;
declare variable VENTAFUTUID D_FK;
declare variable LOTEIMPORTADO D_FK;
declare variable ESTATUSDOCTOID_NCACTUAL D_FK;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID, FACTCONSID, SUBTIPODOCTOID, DOCTOREFID, VENTAFUTUID
   FROM DOCTO
   WHERE ID = :DOCTODEVOLVERID
   INTO :ESTATUSDOCTOID, :TIPODOCTODEVOLVERID, :DOCTOFACTCONSID, :SUBTIPODOCTOID, :DOCTOREFID, :VENTAFUTUID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   
   -- Si no esta vigente: Salir.
   IF (COALESCE(:DOCTOFACTCONSID,0) <> 0) THEN
   BEGIN
      ERRORCODE = 5009;
      SUSPEND;
      EXIT;
   END

   -- Si no es de los tipos b?sicos: Salir.
   IF (:TIPODOCTODEVOLVERID NOT IN ( 21)) THEN
   BEGIN
      ERRORCODE = 1011;
      SUSPEND;
      EXIT;
   END




   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID, ESTADOSURTIDOID
   FROM DOCTO
   WHERE ID = :DOCTODEVOLVERID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID, ESTADOSURTIDOID;

   REFERENCIA = CAST('DEVOLUCION DEL DOCTO ' || COALESCE(SERIE, '' ) || '-' || COALESCE(:FOLIO, '') AS VARCHAR(31));

   REFERENCIAS = NULL;

   IF (:TIPODOCTODEVOLVERID = 21) THEN
      TIPODOCTOID = 22;



   IF(COALESCE(:DOCTONCID,0) = 0 ) THEN
   BEGIN
      
    -- Agrega el DOCTO.
        INSERT INTO DOCTO
        (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
        PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
        PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
        CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
        FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT,ESAPARTADO,DOCTOREFID, IEPS, IMPUESTO, SUBTIPODOCTOID)
        SELECT
            ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
            PERSONAID, CAJEROID, :VENDEDORID, CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, NULL, NULL,
            NULL, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
            CAJAID, :REFERENCIA, :REFERENCIAS, SUCURSALTID, ALMACENTID, 'N' , NULL ,
            NULL,NULL,NULL, NULL, NULL, ESAPARTADO,ID, 0.00, 0.00, SUBTIPODOCTOID
            FROM DOCTO WHERE ID = :DOCTODEVOLVERID
            RETURNING ID INTO :DOCTOID;
   END
   ELSE
   BEGIN
     SELECT ESTATUSDOCTOID FROM DOCTO WHERE ID = :DOCTONCID INTO :ESTATUSDOCTOID_NCACTUAL ;

     IF(:ESTATUSDOCTOID_NCACTUAL IS NULL or COALESCE(:ESTATUSDOCTOID_NCACTUAL,-1) <> 0 ) THEN
     BEGIN
           ERRORCODE = 7890;
           SUSPEND;
           EXIT;

     END

     --elimina los registros que esten en este momento
     DELETE FROM MOVTO WHERE DOCTOID = :DOCTONCID;

     DOCTOID = :DOCTONCID;

   END



   -- Agrega los MOVTO.
   FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, coalesce(CANTIDAD,0) - coalesce(CANTIDADDEVUELTA,0) CANTIDAD, PRECIO, COSTO,
      TIPODIFERENCIAINVENTARIOID  , CANTIDADDEFACTURA, CANTIDADDEREMISION, CANTIDADDEINDEFINIDO , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3 , LOTEIMPORTADO
   FROM MOVTO
   WHERE DOCTOID = :DOCTODEVOLVERID
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , :LOTEIMPORTADO
   DO
   BEGIN
      SELECT ERRORCODE,MOVTOID
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, :PRECIO, 0,
         :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,NULL,NULL,NULL,NULL, :MOVTOID, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, NULL  , :LOTEIMPORTADO
      ) INTO :ERRORCODE,:NEWMOVTOID;
            
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END

   END


     








   ERRORCODE = 0;
   SUSPEND;
      /*
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END  */
END