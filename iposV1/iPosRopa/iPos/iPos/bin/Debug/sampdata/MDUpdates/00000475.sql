CREATE OR ALTER TRIGGER MOVTO_AIU_30 FOR MOVTO
ACTIVE AFTER INSERT OR UPDATE POSITION 30
AS
   DECLARE VARIABLE ALMACENID D_FK;
   DECLARE VARIABLE TIPODOCTOID D_FK;
   DECLARE VARIABLE ERRORCODE D_ERRORCODE;
   declare variable sentidocostopromedio d_sentido;
BEGIN
   IF (NEW.ESTATUSMOVTOID <> 1 or (OLD.estatusmovtoid <> 0) ) THEN
   BEGIN
      EXIT;
   END

   SELECT TIPODOCTOID, ALMACENID
   FROM DOCTO
   WHERE ID = NEW.DOCTOID
   INTO :TIPODOCTOID, :ALMACENID;

   SELECT COALESCE(SENTIDOCOSTOPROMEDIO ,0) FROM TIPODOCTO WHERE ID = :TIPODOCTOID INTO :SENTIDOCOSTOPROMEDIO;

   -- Unicamente para Compras.
   IF (:SENTIDOCOSTOPROMEDIO <> 0) THEN
   BEGIN
      SELECT ERRORCODE FROM CALCULAR_COSTO_PROMEDIO(
         :ALMACENID, NEW.PRODUCTOID, NEW.COSTO, NEW.CANTIDAD, :TIPODOCTOID)
      INTO :ERRORCODE;

      IF( :TIPODOCTOID in (11,14)) THEN
      BEGIN
        UPDATE PRODUCTO
        SET COSTOULTIMO = NEW.COSTO
        WHERE ID = NEW.PRODUCTOID;
      END
   END
END