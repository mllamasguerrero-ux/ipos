create or alter procedure GET_PRECIO_CONCOMISIONTARJETA (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD,
    PRECIO1 D_PRECIO,
    PRECIOPREVIO D_PRECIO,
    PAGOCONTARJETA D_CHAR)
returns (
    PRECIOEXPORTACIONLINEA D_PRECIO,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIOACTUAL D_PRECIO;
declare variable PRECIOBUFFER D_PRECIO;
declare variable COMISIONPORTARJETA D_PRECIO;
declare variable MULTXCOMISION D_PRECIO;
BEGIN

--INSERT INTO TRAZA(VALOR) VALUES ( 'bE 1 ' || CAST(:PRECIOPREVIO AS VARCHAR(12)));


     PRECIOACTUAL = :PRECIOPREVIO;
     PRECIOEXPORTACIONLINEA = :PRECIOPREVIO;

     IF(COALESCE(:PAGOCONTARJETA,'N') IN ('S','D','C')) THEN
     BEGIN
        SELECT CASE WHEN COALESCE(:PAGOCONTARJETA,'N') = 'D' THEN
                        COMISIONDEBPORTARJETA
                 ELSE   COMISIONPORTARJETA
               END FROM PARAMETRO INTO :COMISIONPORTARJETA;
     END
     ELSE
     BEGIN
        COMISIONPORTARJETA = 0;
     END


     --MULTXCOMISION = ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);
     
     PRECIOACTUAL = :PRECIOPREVIO * ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);


     PRECIOEXPORTACIONLINEA = :PRECIOACTUAL ;

     
--INSERT INTO TRAZA(VALOR) VALUES ( 'bE 2 ' || CAST(:PRECIOEXPORTACIONLINEA AS VARCHAR(12)));
--INSERT INTO TRAZA(VALOR) VALUES ( 'bE 3 ' || CAST(:MULTXCOMISION AS VARCHAR(12)));

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END 
END