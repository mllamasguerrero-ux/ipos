create or alter procedure GET_REFERENCIAS_DEVOLUCION (
    PRODUCTOID D_FK,
    DOCTOID D_FK,
    DOCTOREFID D_FK,
    P_MOVTOREFID D_FK)
returns (
    PRECIODEVOLUCION D_PRECIO,
    MOVTOREFID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIOREFERENCIA D_PRECIO;
declare variable COSTOREPOSICION D_COSTO;
BEGIN
   ERRORCODE = 0;

   MOVTOREFID = NULL;
   PRECIOREFERENCIA = NULL;

   IF( :P_MOVTOREFID IS NULL) THEN
   BEGIN
        SELECT FIRST 1 PRECIO,ID FROM MOVTO WHERE DOCTOID = :DOCTOREFID AND PRODUCTOID = :PRODUCTOID   INTO :PRECIOREFERENCIA, :MOVTOREFID;
   END
   ELSE
   BEGIN   
        SELECT FIRST 1 PRECIO, ID FROM MOVTO WHERE DOCTOID = :DOCTOREFID AND PRODUCTOID = :PRODUCTOID AND ID = :P_MOVTOREFID  INTO :PRECIOREFERENCIA, :MOVTOREFID;
   END


   IF(:PRECIOREFERENCIA IS NOT NULL) THEN
   BEGIN
      PRECIODEVOLUCION = :PRECIOREFERENCIA;
   END
   ELSE
   begin
       SELECT FIRST 1 COSTOREPOSICION FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :COSTOREPOSICION;
       IF(:COSTOREPOSICION IS NOT NULL) THEN
       BEGIN
            PRECIODEVOLUCION = :COSTOREPOSICION;
       END
       ELSE
       BEGIN
          PRECIODEVOLUCION = 0;
          ERRORCODE = 3333;
       END
   END

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      PRECIODEVOLUCION = 0;
      ERRORCODE = 3333;
      SUSPEND;
      EXIT;
   END
      
END