CREATE OR ALTER TRIGGER DOCTO_AU31 FOR DOCTO
ACTIVE AFTER UPDATE POSITION 31
AS
declare variable MOVTOREFID d_fk;
declare variable CANTIDAD D_CANTIDAD; 
declare variable CANTIDADDEFACTURA D_CANTIDAD;  
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable SUBTOTALCONIVA D_PRECIO;
declare variable SUBTOTALSINIVA D_PRECIO;
BEGIN
    IF ((OLD.ESTATUSDOCTOID = 0) AND (NEW.ESTATUSDOCTOID = 1) ) THEN
    BEGIN

       IF( NEW.TIPODOCTOID = 21 or NEW.TIPODOCTOID = 24 ) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) - NEW.total WHERE ID = NEW.PERSONAID;
       END

       
       IF( NEW.TIPODOCTOID = 23 ) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + NEW.total WHERE ID = NEW.PERSONAID;
       END

       
       IF( NEW.TIPODOCTOID = 25 ) THEN
       BEGIN
         UPDATE PERSONAAPARTADO SET SALDOAPARTADO = coalesce(SALDOAPARTADO,0) - NEW.total WHERE ID = NEW.PERSONAAPARTADOID;
       END




       
       IF( NEW.TIPODOCTOID = 22) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + NEW.total WHERE ID = NEW.PERSONAID;
         
         FOR SELECT M.movtorefid , M.cantidad, m.cantidaddefactura, m.cantidadderemision, m.cantidaddeindefinido
            FROM MOVTO M
            WHERE M.DOCTOID = NEW.ID AND COALESCE(M.movtorefid , 0) <> 0
         INTO
            :MOVTOREFID, :CANTIDAD  , :CANTIDADDEFACTURA, :cantidadderemision,  :CANTIDADDEINDEFINIDO
         DO
         BEGIN
            UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) + :CANTIDAD ,
                     CANTDEVUELTADEFACTURA =  COALESCE(CANTDEVUELTADEFACTURA,0) + COALESCE(:CANTIDADDEFACTURA,0),
                     CANTDEVUELTADEREMISION =  COALESCE(CANTDEVUELTADEREMISION,0) + COALESCE(:CANTIDADDEREMISION,0), 
                     CANTDEVUELTADEINDEFINIDO =  COALESCE(CANTDEVUELTADEINDEFINIDO,0) + COALESCE(:CANTIDADDEINDEFINIDO,0)
                     WHERE ID = :MOVTOREFID;
         END
       END

       
         IF( NEW.TIPODOCTOID = 26 ) THEN
         BEGIN
            UPDATE PERSONAAPARTADO SET SALDOAPARTADO = coalesce(SALDOAPARTADO,0) + NEW.total WHERE ID = NEW.personaapartadoid;
         END

         
       IF( NEW.TIPODOCTOID in (11,15,16) ) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + NEW.total WHERE ID = NEW.PERSONAID;
       END


       IF( NEW.TIPODOCTOID = 12) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) - NEW.total WHERE ID = NEW.PERSONAID;
         
         FOR SELECT M.movtorefid , M.cantidad, m.cantidaddefactura, m.cantidadderemision, m.cantidaddeindefinido
            FROM MOVTO M
            WHERE M.DOCTOID = NEW.ID AND COALESCE(M.movtorefid , 0) <> 0
         INTO
            :MOVTOREFID, :CANTIDAD   , :CANTIDADDEFACTURA, :cantidadderemision,  :CANTIDADDEINDEFINIDO
         DO
         BEGIN
            UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) + :CANTIDAD,
                     CANTDEVUELTADEFACTURA =  COALESCE(CANTDEVUELTADEFACTURA,0) + COALESCE(:CANTIDADDEFACTURA,0),
                     CANTDEVUELTADEREMISION =  COALESCE(CANTDEVUELTADEREMISION,0) + COALESCE(:CANTIDADDEREMISION,0), 
                     CANTDEVUELTADEINDEFINIDO =  COALESCE(CANTDEVUELTADEINDEFINIDO,0) + COALESCE(:CANTIDADDEINDEFINIDO,0)
                     WHERE ID = :MOVTOREFID;
         END
       END

       
       IF( NEW.TIPODOCTOID IN (13,18)  ) THEN
       BEGIN
         UPDATE PERSONA SET SALDO = coalesce(SALDO,0) - NEW.total WHERE ID = NEW.PERSONAID;
       END





    END





    
    IF ((OLD.ESTATUSDOCTOID = 1) AND (NEW.ESTATUSDOCTOID = 2) ) THEN
    BEGIN
    IF( NEW.TIPODOCTOID = 22) THEN
       BEGIN
         FOR SELECT M.movtorefid ,  M.cantidad, m.cantidaddefactura, m.cantidadderemision, m.cantidaddeindefinido
            FROM MOVTO M
            WHERE M.DOCTOID = NEW.ID AND COALESCE(M.movtorefid , 0) <> 0
         INTO
            :MOVTOREFID, :CANTIDAD , :CANTIDADDEFACTURA, :cantidadderemision,  :CANTIDADDEINDEFINIDO
         DO
         BEGIN
            UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) - :CANTIDAD,
                     CANTDEVUELTADEFACTURA =  COALESCE(CANTDEVUELTADEFACTURA,0) - COALESCE(:CANTIDADDEFACTURA,0),
                     CANTDEVUELTADEREMISION =  COALESCE(CANTDEVUELTADEREMISION,0) - COALESCE(:CANTIDADDEREMISION,0),
                     CANTDEVUELTADEINDEFINIDO =  COALESCE(CANTDEVUELTADEINDEFINIDO,0) - COALESCE(:CANTIDADDEINDEFINIDO,0)
                      WHERE ID = :MOVTOREFID;
         END
       END

       
    IF( NEW.TIPODOCTOID = 12) THEN
       BEGIN
         FOR SELECT M.movtorefid , M.cantidad , m.cantidaddefactura, m.cantidadderemision, m.cantidaddeindefinido
            FROM MOVTO M
            WHERE M.DOCTOID = NEW.ID AND COALESCE(M.movtorefid , 0) <> 0
         INTO
            :MOVTOREFID, :CANTIDAD  , :CANTIDADDEFACTURA, :cantidadderemision,  :CANTIDADDEINDEFINIDO
         DO
         BEGIN
            UPDATE MOVTO SET CANTIDADDEVUELTA = COALESCE(CANTIDADDEVUELTA,0) - :CANTIDAD,
                     CANTDEVUELTADEFACTURA =  COALESCE(CANTDEVUELTADEFACTURA,0) - COALESCE(:CANTIDADDEFACTURA,0),
                     CANTDEVUELTADEREMISION =  COALESCE(CANTDEVUELTADEREMISION,0) - COALESCE(:CANTIDADDEREMISION,0),
                     CANTDEVUELTADEINDEFINIDO =  COALESCE(CANTDEVUELTADEINDEFINIDO,0) - COALESCE(:CANTIDADDEINDEFINIDO,0) WHERE ID = :MOVTOREFID;
         END
       END


    END

END