create or alter procedure GENERAR_PEDIDO (
    SUCURSALID D_FK,
    FECHA D_FECHA,
    TURNOID D_FK,
    FORZADO D_BOOLCN)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable PRODUCTOID D_FK;
declare variable CANTIDAD D_CANTIDAD;
declare variable TIPODOCTOID D_FK;
declare variable DOCTO2ID D_FK;
declare variable MOVTOID D_FK;
declare variable PRODUCTOCUENTA integer;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable COSTO D_COSTO;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
BEGIN
   IF ((:SUCURSALID IS NULL) OR (:SUCURSALID = 0)) THEN
   BEGIN
      ERRORCODE = 1055;
      SUSPEND;
      EXIT;
   END
  
   IF ((:FECHA IS NULL) OR (:FECHA > (CURRENT_DATE+365)) OR (:FECHA < (CURRENT_DATE-365))) THEN
   BEGIN
      ERRORCODE = 1056;
      SUSPEND;
      EXIT;
   END
  
   IF ((:TURNOID IS NULL) /*OR (:TURNOID = 0)*/) THEN
   BEGIN
      ERRORCODE = 1057;
      SUSPEND;
      EXIT;
   END
  
   -- Contar si hay registros para reportar.
   SELECT COUNT(M.ID)
   FROM MOVTO M
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID
      LEFT JOIN CORTE C
         ON C.ID = D.CORTEID
   WHERE D.FECHACORTE = :FECHA
      AND ((C.TURNOID = :TURNOID) OR (:TURNOID = 4))
      AND (D.TIPODOCTOID IN (21,31))
      AND (D.ESTATUSDOCTOID = 1)
      AND ((D.ESTATUSDOCTOPEDIDOID IS NULL) OR (D.ESTATUSDOCTOPEDIDOID = 0) OR (:FORZADO = 'S'))
   INTO :PRODUCTOCUENTA;

   IF ((:PRODUCTOCUENTA IS NULL) OR (:PRODUCTOCUENTA <= 0)) THEN
   BEGIN
      ERRORCODE = 1058;
      SUSPEND;
      EXIT;
   END
  
   -- Si hay prdductos para resurtir.
  
   TIPODOCTOID = 14; -- Pedido Compra

   REFERENCIA =
     'PEDIDO SUC ' || :SUCURSALID || ' ' || :FECHA || ' T. ' || :TURNOID;
    
   REFERENCIAS = NULL;

   SUCURSALTID = 0;
   ALMACENTID = 0;
    
   -- Pedido DOCTO.
   SELECT DOCTOID, ERRORCODE
   FROM DOCTO_INSERT(0, 1, :SUCURSALID, :TIPODOCTOID, 1, 0, 1, 0, 1,
     :REFERENCIA, :REFERENCIAS, :SUCURSALTID, :ALMACENTID)
   INTO :DOCTOID, :ERRORCODE;
  
   IF (:ERRORCODE > 0) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END

   FOR SELECT
      M.PRODUCTOID,
      SUM(M.CANTIDAD)
   FROM MOVTO M
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID
      LEFT JOIN CORTE C
         ON C.ID = D.CORTEID
   WHERE D.FECHACORTE = :FECHA
      AND ((C.TURNOID = :TURNOID) OR (:TURNOID = 4))
      AND (D.TIPODOCTOID IN (21,31))
      AND (D.ESTATUSDOCTOID = 1)
      AND ((D.ESTATUSDOCTOPEDIDOID IS NULL) OR (D.ESTATUSDOCTOPEDIDOID = 0) OR (:FORZADO = 'S'))
   GROUP BY M.PRODUCTOID
   INTO
      :PRODUCTOID, :CANTIDAD
   DO
   BEGIN
      COSTO = 0;

      -- Pedido MOVTO.
      SELECT DOCTOID, MOVTOID, ERRORCODE
      FROM MOVTO_INSERT(:DOCTOID, 0, 1, 1, :TIPODOCTOID, 1, 0, 1, 0, 0, 0,
         :PRODUCTOID, NULL, NULL, :CANTIDAD, 0, :CANTIDAD, 0, 0, 0, 0, :REFERENCIA, :REFERENCIAS, :COSTO,
       :SUCURSALTID, :ALMACENTID, 'N', 0)
      INTO :DOCTO2ID, :MOVTOID, :ERRORCODE;

      IF (:ERRORCODE > 0) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END
   END

   -- Marcar los pedidos como YA pedidos con ESTATUSDOCTOPEDIDOID = 1
   FOR SELECT
      DISTINCT D.ID
   FROM MOVTO M
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID
      LEFT JOIN CORTE C
         ON C.ID = D.CORTEID
   WHERE D.FECHACORTE = :FECHA
      AND ((C.TURNOID = :TURNOID) OR (:TURNOID = 4))
      AND (D.TIPODOCTOID IN (21,31))
      AND (D.ESTATUSDOCTOID = 1)
      AND ((D.ESTATUSDOCTOPEDIDOID IS NULL) OR (D.ESTATUSDOCTOPEDIDOID = 0) OR (:FORZADO = 'S'))
   INTO
      :DOCTO2ID
   DO
   BEGIN
      UPDATE DOCTO
      SET ESTATUSDOCTOPEDIDOID = 1
      WHERE ID = :DOCTO2ID;
   END

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1059;
      SUSPEND;
   END
END