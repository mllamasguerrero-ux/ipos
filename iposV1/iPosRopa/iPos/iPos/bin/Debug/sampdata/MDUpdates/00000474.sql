create or alter procedure CALCULAR_COSTO_PROMEDIO (
    ALMACENID D_FK,
    PRODUCTOID D_FK,
    COSTOENTRADA D_COSTO,
    CANTIDADENTRADA D_CANTIDAD,
    TIPODOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable COSTOTOTALPREVIO D_COSTO;
declare variable COSTOTOTALNUEVO D_COSTO;
declare variable CANTIDADNUEVA D_CANTIDAD;
declare variable CANTIDADPREVIA D_CANTIDAD;
declare variable COSTOPROMEDIONUEVO D_COSTO;
declare variable SENTIDOCOSTOPROMEDIO D_SENTIDO;
BEGIN
   SELECT COALESCE(COSTOTOTALENTRADAS, 0.0000),
   COALESCE(CANTTOTALENTRADAS, 0.0000)
   FROM PRODUCTO
   WHERE ID = :PRODUCTOID
   INTO :COSTOTOTALPREVIO, :CANTIDADPREVIA;

       
       COSTOTOTALNUEVO = :COSTOTOTALPREVIO ;
       CANTIDADNUEVA =  :CANTIDADPREVIA;


       SELECT COALESCE(SENTIDOCOSTOPROMEDIO,0) FROM TIPODOCTO WHERE ID = :TIPODOCTOID INTO :SENTIDOCOSTOPROMEDIO;

            /*
   IF(:TIPODOCTOID IN (11,14)) THEN
   BEGIN*/
       COSTOTOTALNUEVO = :COSTOTOTALPREVIO + ((COALESCE(:COSTOENTRADA,0)   * COALESCE(:CANTIDADENTRADA,0)) * :SENTIDOCOSTOPROMEDIO);
       CANTIDADNUEVA =  :CANTIDADPREVIA +  (COALESCE(:CANTIDADENTRADA,0) * :SENTIDOCOSTOPROMEDIO);


   /*END
   ELSE IF(:TIPODOCTOID IN (13)) THEN
   BEGIN
                 
       COSTOTOTALNUEVO = :COSTOTOTALPREVIO - (COALESCE(:COSTOENTRADA,0)   * COALESCE(:CANTIDADENTRADA,0));
       CANTIDADNUEVA =  :CANTIDADPREVIA -  COALESCE(:CANTIDADENTRADA,0);



   END */

    IF(:CANTIDADNUEVA = 0) THEN
    BEGIN
        COSTOPROMEDIONUEVO = 0;
    END
    ELSE
    BEGIN
         COSTOPROMEDIONUEVO = :COSTOTOTALNUEVO / :CANTIDADNUEVA;
    END

   
   --insert into traza (valor) values ('COSTO PROM' || cast(:COSTOPROMEDIONUEVO AS VARCHAR(12)));


   UPDATE PRODUCTO
   SET
      COSTOPROMEDIO = :COSTOPROMEDIONUEVO,
      COSTOTOTALENTRADAS = :COSTOTOTALNUEVO ,
      CANTTOTALENTRADAS =  :CANTIDADNUEVA

   WHERE ID = :PRODUCTOID;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 9999;
      SUSPEND;
   END

END