create or alter procedure GET_TIPOMAYOREO_DOCTO (
    DOCTOID D_FK)
returns (
    TIPOMAYOREOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable APLICARMAYOREOPORLINEA D_BOOLCN;
declare variable PIEZASIGUALESMEDIOMAYOREO D_CANTIDAD;
declare variable PIEZASDIFMEDIOMAYOREO D_CANTIDAD;
declare variable PIEZASIGUALESMAYOREO D_CANTIDAD;
declare variable PIEZASDIFMAYOREO D_CANTIDAD;
declare variable TOTALCANTIDAD D_CANTIDAD;
declare variable MAXCANTIDADXPROD D_CANTIDAD;
BEGIN

    TIPOMAYOREOID = 1;

    SELECT   APLICARMAYOREOPORLINEA ,PIEZASIGUALESMEDIOMAYOREO , PIEZASDIFMEDIOMAYOREO , PIEZASIGUALESMAYOREO , PIEZASDIFMAYOREO
    FROM PARAMETRO
    INTO :APLICARMAYOREOPORLINEA ,:PIEZASIGUALESMEDIOMAYOREO , :PIEZASDIFMEDIOMAYOREO , :PIEZASIGUALESMAYOREO , :PIEZASDIFMAYOREO ;


    IF(COALESCE(:APLICARMAYOREOPORLINEA  ,'N') = 'N') THEN
    BEGIN
         TIPOMAYOREOID = 1;
         ERRORCODE = 0;
         SUSPEND;
         EXIT;
    END

    SELECT SUM(COALESCE(MOVTO.CANTIDAD,0) *
                CASE WHEN COALESCE(PRODUCTO.CANTXPIEZA,0) > 0  THEN PRODUCTO.CANTXPIEZA ELSE 1 END )
            TOTALCANTIDAD
    FROM  MOVTO
    LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
    LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
    WHERE MOVTO.DOCTOID = :DOCTOID AND COALESCE(LINEA.aplicamayoreoxlinea,'N') = 'S'
    INTO  :TOTALCANTIDAD;


    SELECT MAX(COALESCE(SUB.CANTIDAD,0)) MAXCANTIDADXPROD
    FROM
    (SELECT SUM(COALESCE(MOVTO.CANTIDAD,0) *
                CASE WHEN COALESCE(PRODUCTO.CANTXPIEZA,0) > 0  THEN PRODUCTO.CANTXPIEZA ELSE 1 END )
                 CANTIDAD
    FROM  MOVTO
    LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
    LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
    WHERE MOVTO.DOCTOID = :DOCTOID AND COALESCE(LINEA.aplicamayoreoxlinea,'N') = 'S'
    GROUP BY MOVTO.PRODUCTOID) SUB
    INTO :MAXCANTIDADXPROD;

    TOTALCANTIDAD = COALESCE(:TOTALCANTIDAD,0);   
    MAXCANTIDADXPROD = COALESCE(:MAXCANTIDADXPROD,0);

    PIEZASIGUALESMEDIOMAYOREO = COALESCE(:PIEZASIGUALESMEDIOMAYOREO,0);
    PIEZASDIFMEDIOMAYOREO  = COALESCE(:PIEZASDIFMEDIOMAYOREO,0);
    PIEZASIGUALESMAYOREO  = COALESCE(:PIEZASIGUALESMAYOREO,0);
    PIEZASDIFMAYOREO  = COALESCE(:PIEZASDIFMAYOREO,0);

    IF(:TOTALCANTIDAD >= :PIEZASDIFMAYOREO or :MAXCANTIDADXPROD >= :PIEZASIGUALESMAYOREO ) THEN
    BEGIN
            
         TIPOMAYOREOID = 3;
         ERRORCODE = 0;
         SUSPEND;
         EXIT;
    END


         
    IF(:TOTALCANTIDAD >= :PIEZASDIFMEDIOMAYOREO  or :MAXCANTIDADXPROD >= :PIEZASIGUALESMEDIOMAYOREO) THEN
    BEGIN
            
         TIPOMAYOREOID = 2;
         ERRORCODE = 0;
         SUSPEND;
         EXIT;
    END


   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END 
END