create or alter procedure COMPRA_REASIGNAR_DATOS (
    DOCTOID D_FK,
    PROVEEDORID D_FK,
    VENDEDORID D_FK,
    ORIGENFISCALID D_FK,
    FECHAFACTURA D_FECHA,
    REFERENCIA D_REFERENCIA
    )
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable CUENTADEVOLUCIONES integer;
BEGIN

     ERRORCODE = 0;


    SELECT TIPODOCTOID, ESTATUSDOCTOID
    FROM DOCTO
    WHERE ID = :DOCTOID
    INTO :TIPODOCTOID, :ESTATUSDOCTOID;

    IF(COALESCE(:TIPODOCTOID,0) NOT IN (11,1011)) THEN
    BEGIN
        ERRORCODE = 1011;
        SUSPEND;
        EXIT;
    END
    
    IF(COALESCE(:ESTATUSDOCTOID,0) NOT IN (1)) THEN
    BEGIN
        ERRORCODE = 1012;
        SUSPEND;
        EXIT;
    END


    SELECT COUNT(*) FROM DOCTO
    WHERE DOCTOREFID = :DOCTOID AND TIPODOCTOID = (CASE WHEN :TIPODOCTOID = 11 THEN 12 ELSE 1012 END)
    INTO :CUENTADEVOLUCIONES;

    IF(COALESCE(:CUENTADEVOLUCIONES,0) > 0) THEN
    BEGIN    
        ERRORCODE = 1013;
        SUSPEND;
        EXIT;
    END


    UPDATE DOCTO SET  
        ORIGENFISCALID = :ORIGENFISCALID ,
        FECHAFACTURA = :FECHAFACTURA ,
        REFERENCIA = :REFERENCIA
        WHERE ID = :DOCTOID;


    SELECT ERRORCODE FROM  COMPRA_REASIGNAR_PROVEE (
        :DOCTOID ,
        :PROVEEDORID ,
        :VENDEDORID )
        INTO :ERRORCODE;



   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END
