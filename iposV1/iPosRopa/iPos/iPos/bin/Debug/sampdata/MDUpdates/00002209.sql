create or alter procedure KIT_TOTALIZARIMPUESTOS (
    PRODUCTOKITID D_FK)
returns (
    SUMAIVAPARTE NUMERIC(18,4),
    SUMAIEPSPARTE NUMERIC(18,4),
    PORCENTAJEIEPS D_PORCENTAJE,
    PORCENTAJEIVA D_PORCENTAJE,
    PORCENTAJEIMPUESTO D_PORCENTAJE,
    TASAIVAID D_FK,
    SUMACOSTOTOTALSINIMPUESTO NUMERIC(18,4),
    SUMACOSTOTOTALCONIMPUESTO NUMERIC(18,4),
    ERRORCODE D_ERRORCODE)
as
declare variable ESKIT D_BOOLCN;
declare variable MANEJAKIT D_BOOLCN;
BEGIN

    ERRORCODE = 0;
    PORCENTAJEIEPS = 0;
    PORCENTAJEIVA  = 0;
    PORCENTAJEIMPUESTO  = 0;
    TASAIVAID  = 0;   
    SUMACOSTOTOTALSINIMPUESTO  = 0;  
    SUMACOSTOTOTALCONIMPUESTO  = 0;  
    SUMAIVAPARTE  = 0;  
    SUMAIEPSPARTE  = 0;  

    SELECT ESKIT, TASAIVAID, TASAIVA, TASAIEPS, TASAIMPUESTO
        FROM PRODUCTO
        WHERE ID = :PRODUCTOKITID
        INTO :ESKIT, :TASAIVAID, :PORCENTAJEIVA, :PORCENTAJEIEPS, :PORCENTAJEIMPUESTO;
    IF(COALESCE(:ESKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -1;
        SUSPEND;
        EXIT;
    END

    SELECT FIRST 1 MANEJAKITS FROM PARAMETRO WHERE 1 = 1 INTO :MANEJAKIT;
    IF(COALESCE(:MANEJAKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -2;
        SUSPEND;  
        EXIT;
    END

    SELECT


                        SUM(COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0)) AS SUMACOSTOTOTALSINIMPUESTO,
                        SUM(COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN COALESCE(PRODUCTO.TASAIEPS,0) / 100.00 ELSE 0
                          END)) AS IEPSPARTE,

                         SUM((COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN 1 + (COALESCE(PRODUCTO.TASAIEPS,0) / 100.00)
                         ELSE 1 END)) * (COALESCE(PRODUCTO.TASAIVA,0) / 100.00)) AS IVAPARTE,

                         SUM(
                         COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0)
                         + COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN COALESCE(PRODUCTO.TASAIEPS,0) / 100.00 ELSE
                          0 END)
                         + (COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN 1 + (COALESCE(PRODUCTO.TASAIEPS,0) / 100.00)
                          ELSE 1 END)) * (COALESCE(PRODUCTO.TASAIVA,0) / 100.00)
                          ) AS COSTOTOTALCONIMPUESTO
    FROM            KITDEFINICION LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = KITDEFINICION.PRODUCTOPARTEID INNER JOIN
                         PARAMETRO ON 1 = 1
    WHERE        (KITDEFINICION.PRODUCTOKITID = :PRODUCTOKITID)
    INTO :SUMACOSTOTOTALSINIMPUESTO, :SUMAIEPSPARTE, :SUMAIVAPARTE, :SUMACOSTOTOTALCONIMPUESTO;

    IF(COALESCE(:SUMACOSTOTOTALSINIMPUESTO,0) = 0) THEN
    BEGIN
        PORCENTAJEIEPS = 0;
        PORCENTAJEIVA = 0;
        PORCENTAJEIMPUESTO = 0;
        TASAIVAID = -1;

    END
    ELSE
    BEGIN
        TASAIVAID = -1;
        PORCENTAJEIEPS = ROUND((100.00) * COALESCE(:SUMAIEPSPARTE,0) /  COALESCE(:SUMACOSTOTOTALSINIMPUESTO,0),2);
        PORCENTAJEIVA = ROUND((100.00) * COALESCE(:SUMAIVAPARTE,0) /  (COALESCE(:SUMACOSTOTOTALSINIMPUESTO,0) + COALESCE(:SUMAIEPSPARTE,0)), 2);
        PORCENTAJEIMPUESTO =  COALESCE(:PORCENTAJEIEPS,0) + COALESCE(:PORCENTAJEIVA,0) + (COALESCE(:PORCENTAJEIEPS,0) *  COALESCE(:PORCENTAJEIVA,0))/100.00;

    END

    


   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END

END
