create or alter procedure VENTA_REVERTIR_PAGOS (
    DOCTOACANCELARID D_FK,
    DOCTODECANCELACION D_FK,
    VENDEDORID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TOTAL D_FK;
declare variable CORTEID D_FK;
declare variable DOCTOIDBUFFER D_FK;
declare variable SALDOBUFFER D_PRECIO;
declare variable FORMAPAGOID D_FK;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable TIPOABONOID D_FK;
declare variable REVERTIDO D_BOOLCN;
declare variable CORTEACANCELAR D_FK;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID , CORTEID
   FROM DOCTO
   WHERE ID = :DOCTOACANCELARID
   INTO :ESTATUSDOCTOID, :TIPODOCTOCANCELARID, CORTEACANCELAR;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   -- Si no es devolucion
   IF (:TIPODOCTOCANCELARID NOT IN (31,21,81)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   
   
   SELECT  TOTAL
   FROM DOCTO
   WHERE ID = :DOCTODECANCELACION
   INTO  :TOTAL;

   SELECT HAYCORTEACTIVO,CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :CORTEID, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END


   --RESTANTEBUFFER = :TOTAL;

    FOR SELECT P.doctosalidaid, P.IMPORTE
            FROM DOCTOPAGO P
            left join DOCTO D ON D.id = P.DOCTOSALIDAID
            WHERE P.DOCTOID = :DOCTOACANCELARID AND P.tipopagoid = 1 AND P.FORMAPAGOID = 6  AND D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESPAGOINICIAL, CORTETRANSCANCELADA)
                             VALUES (:DOCTOACANCELARID, 7, CURRENT_DATE, CURRENT_TIME,:CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, :DOCTOIDBUFFER, 'S', :CORTEACANCELAR);


        END







        
            SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE  D.SALDO > 0 AND D.ID = :DOCTOACANCELARID
            INTO   :DOCTOIDBUFFER, :SALDOBUFFER;



              IF(COALESCE(:SALDOBUFFER,0)>0) THEN
              BEGIN
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESPAGOINICIAL, CORTETRANSCANCELADA)
                             VALUES (:DOCTOACANCELARID, 7, CURRENT_DATE, CURRENT_TIME,:CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTODECANCELACION, 'S', :CORTEACANCELAR);
               END


               
   FOR SELECT P.doctoid, P.IMPORTE , P.FORMAPAGOID ,P.TIPOABONOID, P.REVERTIDO
   FROM DOCTOPAGO P
   WHERE P.DOCTOID = :DOCTOACANCELARID AND P.tipopagoid = 1 AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16)
   INTO
   :DOCTOIDBUFFER, :SALDOBUFFER, :FORMAPAGOID , :TIPOABONOID, :REVERTIDO
   DO
   BEGIN

         INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESPAGOINICIAL, TIPOABONOID, REVERTIDO, CORTETRANSCANCELADA)
                             VALUES (:DOCTOACANCELARID, :FORMAPAGOID, CURRENT_DATE, CURRENT_TIME,  :CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTODECANCELACION,'S', :TIPOABONOID, :REVERTIDO, :CORTEACANCELAR);

   END











   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END