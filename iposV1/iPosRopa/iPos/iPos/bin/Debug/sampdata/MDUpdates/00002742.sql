create or alter procedure ORDENCOMPRA_CREARRESTANTE (
    DOCTOORIGINALID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable DOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOORIGINALID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable MOVTOSCONRESTANTE integer;
declare variable DOCTOREFID D_FK;
declare variable PORCENTAJEDESCUENTO D_PORCENTAJE;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID
   FROM DOCTO
   WHERE ID = :DOCTOORIGINALID
   INTO :ESTATUSDOCTOID, :TIPODOCTOORIGINALID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   -- Si no es de los tipos b?sicos: Salir.
   IF (:TIPODOCTOORIGINALID NOT IN (11, 17)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID , DOCTOREFID
   FROM DOCTO
   WHERE ID = :DOCTOORIGINALID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID, :DOCTOREFID;

   REFERENCIA = CAST('RESTANTE DEL DOCTO ' || COALESCE(SERIE, '' ) || '-' || COALESCE(:FOLIO, '') AS VARCHAR(31));

   REFERENCIAS = NULL;

    TIPODOCTOID = :TIPODOCTOORIGINALID;


    SELECT COUNT(*) FROM MOVTO WHERE  DOCTOID = :DOCTOORIGINALID AND  COALESCE(CANTIDAD,0) - COALESCE(CANTIDADSURTIDA,0) > 0
    INTO :MOVTOSCONRESTANTE;

    IF(COALESCE(:MOVTOSCONRESTANTE,0) = 0) THEN
    BEGIN
      ERRORCODE = 0;
      SUSPEND;
      EXIT;
    END




   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT, IEPS, IMPUESTO)
   SELECT
    ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, SERIE, FOLIO,
    PLAZO, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
    CAJAID, :REFERENCIA, :REFERENCIAS, SUCURSALTID, ALMACENTID, 'N', ESFACTURAELECTRONICA ,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT , 0.00, 0.00
    FROM DOCTO WHERE ID = :DOCTOORIGINALID
   RETURNING ID INTO :DOCTOID;

   UPDATE DOCTO SET DOCTOREFID = :DOCTOREFID WHERE ID = :DOCTOID;

   -- Agrega los MOVTO.
   FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, 
      TIPODIFERENCIAINVENTARIOID  , CANTIDADDEFACTURA, CANTIDADDEREMISION, CANTIDADDEINDEFINIDO, DESCRIPCION1, DESCRIPCION2, DESCRIPCION3, CANTIDADSURTIDA, MOVTO.descuentoporcentaje
   FROM MOVTO
   WHERE DOCTOID = :DOCTOORIGINALID AND  COALESCE(CANTIDAD,0) - COALESCE(CANTIDADSURTIDA,0) > 0
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , :CANTIDADSURTIDA ,:PORCENTAJEDESCUENTO
   DO
   BEGIN
      SELECT ERRORCODE,MOVTOID
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, COALESCE(:CANTIDAD,0) - COALESCE(:CANTIDADSURTIDA,0), 0, 0, 0, 0, :PRECIO, 0,
         :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, :PORCENTAJEDESCUENTO ,NULL,NULL,NULL,NULL,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
      ) INTO :ERRORCODE,:NEWMOVTOID;



   END




   ERRORCODE = 0;
   SUSPEND;
   
    /*WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END  */
END