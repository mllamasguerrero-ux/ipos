create or alter procedure GET_PRODUCTO_PRECIO (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD,
    PAGOCONTARJETA D_BOOLCN_NULL,
    TIPOMAYOREOID D_FK)
returns (
    PRECIO D_PRECIO,
    ESPROMOCION D_BOOLCN,
    PROMOCIONID D_FK,
    PROMOCIONDESGLOSE D_STDTEXT_64,
    MONEDEROABONO D_PRECIO,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIO1 D_PRECIO;
declare variable PRECIO2 D_PRECIO;
declare variable PRECIO3 D_PRECIO;
declare variable PRECIO4 D_PRECIO;
declare variable PRECIO5 D_PRECIO;
declare variable PRECIO6 D_PRECIO;
declare variable LISTAPRECIO varchar(1);
declare variable LIMITEPRECIO2 D_CANTIDAD;
declare variable U_EMPAQUE D_CANTIDAD;
declare variable PZACAJA D_CANTIDAD;
declare variable UNIDAD varchar(10);
declare variable INI_MAYO D_CANTIDAD;
declare variable MAYOKGS char(1);
declare variable LISTAPRECIOCLIENTE varchar(1);
declare variable CAMBIARPRECIOXUEMPAQUE D_BOOLCN;
declare variable CAMBIARPRECIOXPZACAJA D_BOOLCN;
declare variable LISTAPRECIOXUEMPAQUE D_FK;
declare variable LISTAPRECIOXPZACAJA D_FK;
declare variable LISTAPRECIOINIMAYO D_FK;
declare variable LINEA_CLAVE D_CLAVE_NULL;
declare variable SUPERLISTAPRECIOID D_FK;
declare variable MANEJASUPERLISTAPRECIO D_BOOLCN;
declare variable TIPODESCUENTOPRODID D_FK;
declare variable PRODUCTODESCUENTO D_PORCENTAJE;
declare variable TEMPPRECIO D_PRECIO;
declare variable APLICARMAYOREOPORLINEA D_BOOLCN;
BEGIN
   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1048;
      SUSPEND;
      EXIT;
   END
   
   IF ((:PERSONAID IS NULL) OR (:PERSONAID = 0)) THEN
   BEGIN
      ERRORCODE = 1049;
      SUSPEND;
      EXIT;
   END


   
   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1050;
      SUSPEND;
      EXIT;
   END
   

   




   -- Tomar la lista de precios correspondiente a la persona.
   -- Null, 1..5. Para Precio1, ... Precio5
   SELECT CAST(COALESCE(LISTAPRECIOID, 1) AS CHAR(1)),SUPERLISTAPRECIOID
   FROM PERSONA
   WHERE ID = :PERSONAID
   INTO :LISTAPRECIOCLIENTE,:SUPERLISTAPRECIOID;

    SELECT MANEJASUPERLISTAPRECIO, TIPODESCUENTOPRODID FROM PARAMETRO INTO :MANEJASUPERLISTAPRECIO, :TIPODESCUENTOPRODID;
    IF(COALESCE(:MANEJASUPERLISTAPRECIO ,'N') = 'N') THEN
    BEGIN
        SUPERLISTAPRECIOID = 1;
     END


   select first 1 CAST(COALESCE(LISTA_PRECIO_DEF, 1) AS CHAR(1)),
   CAMBIARPRECIOXUEMPAQUE, CAMBIARPRECIOXPZACAJA ,
   LISTAPRECIOXUEMPAQUE, LISTAPRECIOXPZACAJA , LISTAPRECIOINIMAYO, APLICARMAYOREOPORLINEA
   FROM parametro
   INTO :LISTAPRECIO, :CAMBIARPRECIOXUEMPAQUE, :CAMBIARPRECIOXPZACAJA
   , :LISTAPRECIOXUEMPAQUE, :LISTAPRECIOXPZACAJA , :LISTAPRECIOINIMAYO, :APLICARMAYOREOPORLINEA ;

   -- Tomar los precios y el LimitePrecio2 del Producto.

   IF(COALESCE(:SUPERLISTAPRECIOID,1) = 2) THEN
   BEGIN          
        SELECT SPRECIO1, SPRECIO2, SPRECIO3, SPRECIO4, SPRECIO5, PRECIO6, COALESCE(LIMITEPRECIO2, 0.00)
        ,COALESCE(U_EMPAQUE ,0), COALESCE(PZACAJA,0), COALESCE(UNIDAD, ' '), COALESCE(INI_MAYO,0) , COALESCE(MAYOKGS,'N') ,
        LINEA.CLAVE, PRODUCTO.DESCUENTO
        FROM PRODUCTO
        LEFT JOIN LINEA ON PRODUCTO.LINEAID = LINEA.ID
        WHERE PRODUCTO.ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5, :PRECIO6, :LIMITEPRECIO2,
        :U_EMPAQUE, :PZACAJA , :UNIDAD ,  :INI_MAYO, :MAYOKGS, :LINEA_CLAVE, :PRODUCTODESCUENTO;
    
   END
   ELSE
   BEGIN      
        SELECT PRECIO1, PRECIO2, PRECIO3, PRECIO4, PRECIO5, PRECIO6, COALESCE(LIMITEPRECIO2, 0.00)
        ,COALESCE(U_EMPAQUE ,0), COALESCE(PZACAJA,0), COALESCE(UNIDAD, ' '), COALESCE(INI_MAYO,0) , COALESCE(MAYOKGS,'N') ,
        LINEA.CLAVE ,PRODUCTO.DESCUENTO
        FROM PRODUCTO
        LEFT JOIN LINEA ON PRODUCTO.LINEAID = LINEA.ID
        WHERE PRODUCTO.ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5, :PRECIO6, :LIMITEPRECIO2,
        :U_EMPAQUE, :PZACAJA , :UNIDAD ,  :INI_MAYO, :MAYOKGS, :LINEA_CLAVE, :PRODUCTODESCUENTO;
   END


   -- Para la lista de precio1
   PRECIO = :PRECIO1;


   if(:CANTIDAD >= :LIMITEPRECIO2  AND coalesce(:LIMITEPRECIO2,0) > 1)then
   begin
         PRECIO = :PRECIO2;
   end


   if (:PZACAJA > 1  AND :LISTAPRECIO = '1' AND :CANTIDAD>= :U_EMPAQUE AND :U_EMPAQUE>1  AND :CAMBIARPRECIOXUEMPAQUE = 'S' ) then
   begin
            --PRECIO = :PRECIO2;
            PRECIO = (case when :LISTAPRECIOXUEMPAQUE = 1 then :PRECIO1
              when :LISTAPRECIOXUEMPAQUE = 2 then  :PRECIO2
              when :LISTAPRECIOXUEMPAQUE = 3 then  :PRECIO3
              when :LISTAPRECIOXUEMPAQUE = 4 then  :PRECIO4
              when :LISTAPRECIOXUEMPAQUE = 5 then  :PRECIO5
              else  :PRECIO2
            end);
   end
   if (:PZACAJA > 1  AND :LISTAPRECIO = '1' AND :CANTIDAD>= :PZACAJA   AND :CAMBIARPRECIOXPZACAJA = 'S' ) then
   begin
            --PRECIO = :PRECIO3;  
            PRECIO = (case when :LISTAPRECIOXPZACAJA = 1 then :PRECIO1
              when :LISTAPRECIOXPZACAJA = 2 then  :PRECIO2
              when :LISTAPRECIOXPZACAJA = 3 then  :PRECIO3
              when :LISTAPRECIOXPZACAJA = 4 then  :PRECIO4
              when :LISTAPRECIOXPZACAJA = 5 then  :PRECIO5
              else  :PRECIO3
            end);
   end
   if(trim(:UNIDAD) = 'KG'  AND :CANTIDAD>= :INI_MAYO AND :MAYOKGS = 'S') then
   begin
            --PRECIO = :PRECIO3;  
            PRECIO = (case when :LISTAPRECIOINIMAYO = 1 then :PRECIO1
              when :LISTAPRECIOINIMAYO = 2 then  :PRECIO2
              when :LISTAPRECIOINIMAYO = 3 then  :PRECIO3
              when :LISTAPRECIOINIMAYO = 4 then  :PRECIO4
              when :LISTAPRECIOINIMAYO = 5 then  :PRECIO5
              else  :PRECIO3
            end);
   end


   IF (:LISTAPRECIOCLIENTE = '2' AND :PRECIO > :PRECIO2 ) THEN
      PRECIO = :PRECIO2;
   IF (:LISTAPRECIOCLIENTE = '3' AND :PRECIO > :PRECIO3 ) THEN
      PRECIO = :PRECIO3;
   ELSE IF (:LISTAPRECIOCLIENTE = '4' AND :PRECIO > :PRECIO4) THEN
      PRECIO = :PRECIO4;
   ELSE IF (:LISTAPRECIOCLIENTE = '5' AND :PRECIO > :PRECIO5) THEN
      PRECIO = :PRECIO5;



   IF(coalesce(:APLICARMAYOREOPORLINEA,'N') = 'S') THEN
   BEGIN
        SELECT PRECIOEXPORTACIONLINEA, ERRORCODE FROM GET_MAYOREOLINEA_PRECIO(:PRODUCTOID ,:PERSONAID, :CANTIDAD ,:PRECIO1 ,:PRECIO,:PAGOCONTARJETA,:PRECIO3,:PRECIO4, :TIPOMAYOREOID, :PRECIO6)
        INTO :PRECIO , :ERRORCODE;
   END




      /* temporal por lo del buen fin */
     if(current_date >= '2013-11-16' and current_date < '2013-11-19' and :precio > :precio2
       and COALESCE(:linea_clave,'') not in ('')  ) then
     begin
            precio = :precio2;
     end


     IF(:TIPODESCUENTOPRODID = 2 AND COALESCE(:PRODUCTODESCUENTO,0) > 0) THEN
     BEGIN
        PRECIO =  :PRECIO * ((100 - COALESCE(:PRODUCTODESCUENTO,0)) / 100) ;
     END


    SELECT PRECIOPROMO, ESPROMOCION, PROMOCIONID ,PROMOCIONDESGLOSE, MONEDEROABONO, ERRORCODE
    FROM GET_PROMO_PRECIO(:PRODUCTOID ,:PERSONAID, :CANTIDAD ,:PRECIO1 ,:PRECIO)
    INTO :PRECIO, :ESPROMOCION, :PROMOCIONID ,:PROMOCIONDESGLOSE, :MONEDEROABONO, :ERRORCODE;

    IF(:TIPODESCUENTOPRODID = 1 AND COALESCE(:PRODUCTODESCUENTO,0) > 0) THEN
    BEGIN
      TEMPPRECIO = :PRECIO1 * ((100 - COALESCE(:PRODUCTODESCUENTO,0)) / 100) ;
      IF(:TEMPPRECIO < :PRECIO) THEN
      BEGIN
        PRECIO = :TEMPPRECIO;
      END
    END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END
END