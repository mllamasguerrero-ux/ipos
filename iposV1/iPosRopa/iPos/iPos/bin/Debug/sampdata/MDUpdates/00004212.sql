CREATE OR ALTER PROCEDURE REBAJA_AUTORIZA_DETALLE (
    MOVTOREFID D_FK,
    CANTIDAD D_CANTIDAD,
    DOCTOID D_FK)
RETURNS (
    ERRORCODE D_ERRORCODE)
AS
declare variable ESTATUSDOCTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable TOTAL D_FK;
declare variable PRODUCTOSINSUFICIENTES D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable DOCTOREFID D_FK;
declare variable LOTEIMPORTADO D_FK;
BEGIN

   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID, TOTAL, ESTATUSDOCTOID, TIPODOCTOID , DOCTOREFID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID,  :TOTAL, :ESTATUSDOCTOID, :TIPODOCTOID, :DOCTOREFID;

   -- Si no es devolucion
   IF (:TIPODOCTOID NOT IN (22)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   -- Agrega los MOVTO.
   SELECT
       PRODUCTOID, LOTE, FECHAVENCE, movto.precio -  coalesce(movto.precioconrebaja,0) , COSTO,
      TIPODIFERENCIAINVENTARIOID  , CANTIDADDEFACTURA, CANTIDADDEREMISION, CANTIDADDEINDEFINIDO , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3, LOTEIMPORTADO
   FROM MOVTO
   WHERE ID = :MOVTOREFID
   INTO
      :PRODUCTOID, :LOTE, :FECHAVENCE,  :PRECIO, :COSTO,
      :TIPODIFERENCIAINVENTARIOID , :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :LOTEIMPORTADO
  ;

      SELECT ERRORCODE,MOVTOID
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, :PRECIO, 0,
         :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,:DOCTOREFID ,NULL,NULL,NULL, :MOVTOREFID , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL, :LOTEIMPORTADO
      ) INTO :ERRORCODE,:NEWMOVTOID;


      
      IF (:ERRORCODE <> 0) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END


    
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END









   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END


