create or alter procedure INVFIS_MOV_UPDATE_XLOC (
    DOCTOID D_FK,
    PRODUCTOID D_FK,
    CAJAS D_CANTIDAD,
    PIEZAS D_CANTIDAD,
    PRODUCTOLOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable CANTIDAD D_CANTIDAD;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable MOVTOID D_FK;
declare variable PZACAJA D_CANTIDAD;
BEGIN

SELECT COALESCE(PZACAJA,1) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PZACAJA;

IF(:PZACAJA = 0)THEN
BEGIN
   PZACAJA = 1;
END




CANTIDADSURTIDA = (:PZACAJA * COALESCE(:CAJAS, 0)) + COALESCE(:PIEZAS,0);


SELECT FIRST 1 MOVTO.ID FROM MOVTO
LEFT JOIN ANAQUEL ON MOVTO.anaquelid = ANAQUEL.ID
WHERE MOVTO.DOCTOID = :DOCTOID AND MOVTO.PRODUCTOID = :PRODUCTOID
ORDER BY ANAQUEL.CLAVE, MOVTO.LOCALIDAD
INTO :MOVTOID;



      select COALESCE(sum(cantidad),0) from inventario
        where  productoid = :PRODUCTOID and
              coalesce(lote,'') = coalesce(:PRODUCTOLOTE,'') AND
              coalesce(fechavence,current_date) = coalesce(:FECHAVENCE,current_date)
        into :CANTIDAD;




UPDATE MOVTO SET CAJAS = 0, PIEZAS = 0 , CANTIDADSURTIDA = 0, CANTIDAD = :CANTIDAD
WHERE MOVTO.DOCTOID = :DOCTOID AND MOVTO.PRODUCTOID = :PRODUCTOID  AND MOVTO.ID <> :MOVTOID;




UPDATE MOVTO
SET CAJAS = COALESCE(:CAJAS,0), PIEZAS = COALESCE(:PIEZAS,0)  , CANTIDADSURTIDA = :CANTIDADSURTIDA  ,
CANTIDAD = :CANTIDAD
    WHERE ID = :MOVTOID ;




   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
     ERRORCODE = 1077;
     SUSPEND;
   END
END