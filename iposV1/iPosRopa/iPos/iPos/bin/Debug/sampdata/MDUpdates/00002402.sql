create or alter procedure GET_VENTA_DEVOLUCION_REF (
    DOCTOID D_FK,
    DOCTOBUFFERID D_FK)
returns (
    DOCTOREFID D_FK,
    MOVTOREFID D_FK,
    PARTIDAREF smallint,
    CANTIDADREF D_CANTIDAD,
    DESCRIPCION D_DESCRIPCION,
    PRECIOUNIDADREF D_PRECIO,
    IMPORTEREF D_PRECIO,
    DESCUENTOREF D_PRECIO,
    DESCRIPCION2 D_DESCRIPCION,
    LOTE D_LOTE,
    CLAVEPRODUCTO D_CLAVE,
    SUBTOTALREF D_PRECIO,
    IVAREF D_PRECIO,
    CANTIDAD D_CANTIDAD,
    MOVTOID D_FK,
    PRECIOUNIDAD D_PRECIO,
    IMPORTE D_PRECIO,
    PARTIDA smallint,
    CANTIDADDEVUELTA D_CANTIDAD,
    CANTDISP D_CANTIDAD,
    CANTDISPDESPUES D_CANTIDAD,
    TASAIVA D_PORCENTAJE,
    TASAIEPS D_PORCENTAJE,
    TASAIMPUESTO D_PORCENTAJE,
    MONTOREBAJA D_PRECIO,
    PRECIOCONREBAJA D_PRECIO,
    TOTALCONREBAJA D_PRECIO,
    ESTADOREBAJA D_FK)
as
--declare variable DOCTOBUFFERID D_FK;
BEGIN
   
--Initialitation

    
         DOCTOREFID = 0;
         MOVTOREFID  = 0;
         PARTIDAREF = 0;
         CANTIDADREF  = 0;
         DESCRIPCION = '';
         PRECIOUNIDADREF  = 0;
         IMPORTEREF   = 0;
         DESCUENTOREF   = 0;
         DESCRIPCION2 = '';
         LOTE = '';
         CLAVEPRODUCTO = '';
         SUBTOTALREF   = 0;
         IVAREF   = 0;
         CANTIDAD  = 0;
         MOVTOID  = 0;
         PRECIOUNIDAD  = 0;
         IMPORTE  = 0;
         PARTIDA  = 0;
         CANTIDADDEVUELTA  = 0;
         CANTDISP  = 0;
         CANTDISPDESPUES  = 0;
         TASAIVA = 0;
         TASAIEPS = 0;
         TASAIMPUESTO = 0;
         MONTOREBAJA = 0;
         PRECIOCONREBAJA = 0;
         TOTALCONREBAJA = 0;
         ESTADOREBAJA = 0;


    --SELECT DOCTOREFID FROM DOCTO WHERE ID = :DOCTOID INTO :DOCTOBUFFERID;


   if(:DOCTOID is null) then
   BEGIN
      --ERRORCODE = 1001;
      EXIT;
   END


   FOR 
    SELECT * from
    (

       SELECT        R.ID AS DOCTOREFID, MR.ID AS MOVTOREFID, MR.PARTIDA PARTIDAREF, MR.CANTIDAD CANTIDADREF, PRODUCTO.DESCRIPCION1 AS DESCRIPCION,
                         MR.PRECIO AS PRECIOUNIDADREF, MR.TOTAL AS IMPORTEREF,  MR.DESCUENTO AS DESCUENTOREF, PRODUCTO.DESCRIPCION2, MR.LOTE,
                         PRODUCTO.CLAVE AS CLAVEPRODUCTO, MR.SUBTOTAL SUBTOTALREF, MR.IVA IVAREF, sum(COALESCE(M.CANTIDAD,0)) AS CANTIDAD , min(M.id) AS MOVTOID,  min(M.precio) AS PRECIOUNIDAD , min(M.IMPORTE) IMPORTE,min(M.PARTIDA)PARTIDA ,
                          coalesce(MR.CANTIDADDEVUELTA,0) CANTIDADDEVUELTA, (coalesce(MR.CANTIDAD,0) - coalesce(MR.CANTIDADDEVUELTA,0) - ( case when (min(m.estatusmovtoid) = 1 ) then 0 else sum(coalesce(M.cantidad,0)) end)) CANTDISP, (coalesce(MR.CANTIDAD,0) - coalesce(MR.CANTIDADDEVUELTA,0) - sum(coalesce(M.cantidad,0))) CANTDISPDESPUES
                          , MR.tasaiva AS TASAIVA, MR.TASAIEPS AS TASAIEPS, MR.TASAIMPUESTO AS TASAIMPUESTO , COALESCE(MR.precioconrebaja,0) precioconrebaja, COALESCE(MR.montorebaja,0) MONTOREBAJA, COALESCE(MR.TOTALCONREBAJA, 0) TOTALCONREBAJA , COALESCE(MR.ESTADOREBAJA  ,0) ESTADOREBAJA
       FROM            DOCTO R LEFT OUTER JOIN
                DOCTO D ON D.doctorefid = R.ID AND D.ID = :DOCTOID LEFT OUTER JOIN
                         MOVTO MR ON MR.DOCTOID = R.ID LEFT OUTER JOIN
                         MOVTO M ON M.movtorefid = MR.ID  AND M.DOCTOID = D.ID LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = MR.PRODUCTOID LEFT OUTER JOIN
                         LINEA ON LINEA.ID = PRODUCTO.LINEAID, PARAMETRO LEFT OUTER JOIN
                         PERSONA ON PERSONA.ID = D.PERSONAID
       WHERE         (MR.CANTIDAD > 0)  AND R.ID = :DOCTOBUFFERID
       group by R.ID , MR.ID , MR.PARTIDA , MR.CANTIDAD , PRODUCTO.DESCRIPCION1,
                         MR.PRECIO , MR.TOTAL ,  MR.DESCUENTO , PRODUCTO.DESCRIPCION2, MR.LOTE,
                         PRODUCTO.CLAVE, MR.SUBTOTAL , MR.IVA ,MR.CANTIDADDEVUELTA,MR.CANTIDAD,MR.CANTIDADDEVUELTA,
                           MR.tasaiva, MR.TASAIEPS, MR.TASAIMPUESTO , MR.precioconrebaja,  MR.MONTOREBAJA, MR.TOTALCONREBAJA  , MR.estadorebaja
       UNION
       SELECT       0 AS DOCTOID, 0 AS MOVTOREFID, 9999 PARTIDAREF, 0 CANTIDADREF, PRODUCTO.descripcion1 AS DESCRIPCION,
                         0 AS PRECIOUNIDADREF, 0 AS IMPORTEREF, 0 AS DESCUENTOREF, PRODUCTO.DESCRIPCION2, '' AS lote,
                         PRODUCTO.CLAVE AS CLAVEPRODUCTO, 0 AS SUBTOTALREF, 0 AS IVAREF, M.CANTIDAD, M.id AS MOVTOID,  M.precio AS PRECIOUNIDAD , M.IMPORTE,M.PARTIDA  ,
                          0 AS CANTIDADDEVUELTA, 0 AS CANTDISP, (0 - M.cantidad) CANTDISPDESPUES, 0 AS TASAIVA , 0 AS TASAIEPS, 0 AS TASAIMPUESTO, 0 PRECIOCONREBAJA, 0 MONTOREBAJA, 0 TOTALCONREBAJA , 0 AS ESTADOREBAJA
       FROM  DOCTO D
       INNER JOIN MOVTO M ON M.DOCTOID = D.ID AND COALESCE(M.MOVTOREFID,0) = 0
       LEFT JOIN producto ON PRODUCTO.ID = M.PRODUCTOID
       WHERE D.ID = :DOCTOID

       )  q
     ORDER BY q.PARTIDAREF, q.partida
       --GROUP BY PRODUCTOID,LOTE,FECHAVENCE,PRODUCTO.NOMBRE,PRODUCTO.DESCRIPCION1
       INTO 
         :DOCTOREFID ,
         :MOVTOREFID ,
         :PARTIDAREF ,
         :CANTIDADREF ,
         :DESCRIPCION ,
         :PRECIOUNIDADREF  ,
         :IMPORTEREF  ,
         :DESCUENTOREF  ,
         :DESCRIPCION2 ,
         :LOTE ,
         :CLAVEPRODUCTO ,
         :SUBTOTALREF  ,
         :IVAREF  ,
         :CANTIDAD ,
         :MOVTOID ,
         :PRECIOUNIDAD  ,
         :IMPORTE ,
         :PARTIDA  ,
         :CANTIDADDEVUELTA ,
         :CANTDISP ,
         :CANTDISPDESPUES,
         :TASAIVA ,
         :TASAIEPS,
         :TASAIMPUESTO ,
         :PRECIOCONREBAJA,
         :MONTOREBAJA,
         :TOTALCONREBAJA ,
         :ESTADOREBAJA
 
   DO
   BEGIN
           SUSPEND;
   END
    


   WHEN ANY DO
   BEGIN
      --ERRORCODE = 1016;
      SUSPEND;
   END 


END