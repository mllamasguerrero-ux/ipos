create or alter procedure MOVILCREDITO_APROBACION (
    DOCTOID D_FK,
    MONTOAPROBADO D_PRECIO,
    APROBADO D_BOOLCS,
    USUARIOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable MOVTOID D_FK;
declare variable ESTATUSDOCTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable LOTEIMPORTADO D_FK;
declare variable CUENTAMOVTOPEND integer;
declare variable CANTIDADAFECTAR D_CANTIDAD;
declare variable MOVTOTOTAL D_PRECIO;
declare variable DOCTOTOTAL D_PRECIO;
declare variable MONTOAREBAJAR D_PRECIO;
declare variable PRECIOCU D_PRECIO;
declare variable CUENTAMOVTO integer;   
declare variable COTI_ENRUTADA D_BOOLCN_NULL;
BEGIN

   --SEPROMOVIOREBAJA = 'N';



   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID  , COTI_ENRUTADA
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :ESTATUSDOCTOID, :TIPODOCTOID, :COTI_ENRUTADA;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1082;
      SUSPEND;
      EXIT;
   END

   -- Si no es de los tipos b?sicos: Salir.
   IF (:TIPODOCTOID NOT IN (331) AND NOT (:TIPODOCTOID = 21 AND COALESCE(:COTI_ENRUTADA,'N') = 'S')) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END


   IF(COALESCE(:APROBADO,'N') = 'N' OR COALESCE(:MONTOAPROBADO,0) = 0) THEN
   BEGIN
      
        UPDATE DOCTO SET PERSONAIDSURTIDO = :USUARIOID,  ESTADOSURTIDOID = 6 WHERE ID = :DOCTOID;
        SUSPEND;
        EXIT;
   END
   ELSE IF(COALESCE(:APROBADO,'N') = 'S' AND COALESCE(:MONTOAPROBADO,0) <> COALESCE(:DOCTOTOTAL,0))  THEN
   BEGIN


    -- Leer del DOCTO a recalcular.
    SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID, TOTAL
    FROM DOCTO
    WHERE ID = :DOCTOID
    INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID, :DOCTOTOTAL;

    
    MONTOAREBAJAR = COALESCE(:DOCTOTOTAL,0) - COALESCE(:MONTOAPROBADO,0);


    -- Agrega los MOVTO.
       --INSERT INTO TRAZA(VALOR) VALUES(' MCA ' || CAST(:MONTOAREBAJAR AS VARCHAR(10)));
   
 FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, 
      TIPODIFERENCIAINVENTARIOID , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3, LOTEIMPORTADO,
      TOTAL
   FROM MOVTO
   WHERE DOCTOID = :DOCTOID
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :LOTEIMPORTADO,
      :MOVTOTOTAL
   DO
   BEGIN

       IF(COALESCE(:MONTOAREBAJAR,0) <= 0) THEN
       BEGIN
         BREAK;
       END

       CANTIDADAFECTAR = 0;
       PRECIOCU = CAST(COALESCE(:MOVTOTOTAL,0) /  CASE WHEN COALESCE(:CANTIDAD,0) = 0 THEN 1 ELSE COALESCE(:CANTIDAD,0) END AS D_PRECIO);
            
       IF( :MONTOAREBAJAR >= COALESCE(:MOVTOTOTAL,0)) THEN
       BEGIN
            CANTIDADAFECTAR = COALESCE(:CANTIDAD,0) * -1;
       END
       ELSE
       BEGIN
            IF(COALESCE(:PRECIOCU,0) <> 0) THEN
            BEGIN      
                CANTIDADAFECTAR = CAST(  CEIL(:MONTOAREBAJAR / :PRECIOCU) AS D_CANTIDAD) * -1;
                IF(COALESCE(:CANTIDADAFECTAR,0) * -1 > COALESCE(:CANTIDAD,0)) THEN
                BEGIN
                    CANTIDADAFECTAR = COALESCE(:CANTIDAD,0) * -1;
                END
            END

       END




      SELECT ERRORCODE
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 5, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADAFECTAR, 0, 0, 0, 0, /*:PRECIO*/NULL, 0,
         /*:REFERENCIA*/ '', /*:REFERENCIAS*/ '', :COSTO, :SUCURSALID, :ALMACENID, 'N',
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, null,NULL ,NULL,NULL,:MOVTOID,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL, :LOTEIMPORTADO , 'R','S'
      ) INTO :ERRORCODE;




        IF(:ERRORCODE <> 0) THEN
        BEGIN
          SUSPEND;
          EXIT;
        END

        MONTOAREBAJAR = COALESCE(:MONTOAREBAJAR,0.00) +  (COALESCE(:CANTIDADAFECTAR,0.00) * COALESCE(:PRECIOCU,0));
            
       --INSERT INTO TRAZA(VALOR) VALUES(' MCA2 ' || CAST(:MONTOAREBAJAR AS VARCHAR(10)));
   END

   END

   DELETE FROM MOVTO WHERE DOCTOID = :DOCTOID AND COALESCE(:CANTIDAD,0) = 0;


      --CHECA SI SE ELIMINARON LOS DETALLES QUE REQUERIAN REVISION DE TOPE , SI ES ASI CAMBIAR EL FLAG A NIVEL DE DOCTO
      SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :DOCTOID AND COALESCE(ESTADOREBAJA,0) = 1 INTO :CUENTAMOVTOPEND;

      IF(COALESCE(:CUENTAMOVTOPEND,0) = 0) THEN
      BEGIN
            UPDATE DOCTO SET ESTADOREBAJA = 2 WHERE ID = :DOCTOID;
      END
      ELSE
      BEGIN
            UPDATE DOCTO SET ESTADOREBAJA = 1 WHERE ID = :DOCTOID;
      END



   SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :DOCTOID  INTO :CUENTAMOVTO;
   IF(COALESCE(:CUENTAMOVTO,0) = 0) THEN
   BEGIN
            DELETE FROM DOCTO WHERE ID = :DOCTOID;
   END


   UPDATE DOCTO SET  PERSONAIDSURTIDO = :USUARIOID, ESTADOSURTIDOID = 1 WHERE ID = :DOCTOID;




   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END
