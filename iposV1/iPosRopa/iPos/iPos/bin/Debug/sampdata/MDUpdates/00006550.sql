create or alter procedure GUIA_INSERT (
    ENCARGADOGUIAID D_FK,
    ESTADOGUIAID D_FK,
    CAJEROID D_FK,
    CORTEID D_FK,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    NOTA D_DESCRIPCION,
    TIPOENTREGAID D_FK,
    GUIAPAQUETERIA D_STDTEXT_MEDIUM,
    VEHICULOID D_FK,
    FECHAESTIMADAREC D_FECHA,
    HORAESTIMADREC D_TIMESTAMP)
returns (
    GUIAID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable CORTEID2 D_FK;
declare variable FECHACORTE D_FECHA;
BEGIN

  -- FALTA COMPLETAR
             SELECT HAYCORTEACTIVO,CORTEID, FECHACORTE, ERRORCODE
   FROM HAY_CORTE_ACTIVO(:CAJEROID)
   INTO :HAYCORTEACTIVO, :CORTEID2, :FECHACORTE, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
        GUIAID = 0;
        SUSPEND;
        EXIT;
   END


   IF(:FECHACORTE IS NULL or  COALESCE(:FECHACORTE,CURRENT_DATE) <> CURRENT_DATE) THEN
   BEGIN
        ERRORCODE = 1001;
        SUSPEND;
        EXIT;
   END



        INSERT INTO GUIA
        (ENCARGADOGUIAID , ESTADOGUIAID, cajeroid,  CORTEID, FECHA, FECHAHORA, NOTA, TIPOENTREGAID, GUIAPAQUETERIA,VEHICULOID , FECHAESTIMADAREC ,HORAESTIMADREC )
        VALUES
        (:ENCARGADOGUIAID,  :ESTADOGUIAID  , :CAJEROID, :CORTEID2,  current_date,  CURRENT_TIME, :NOTA, :TIPOENTREGAID, :GUIAPAQUETERIA,:VEHICULOID , :FECHAESTIMADAREC ,:HORAESTIMADREC )
        RETURNING ID INTO :GUIAID;



   ERRORCODE = 0;
   SUSPEND;
END