create or alter procedure INVFIS_UNICOLOTEPRODUCTO (
    PRODUCTOID D_FK,
    NUEVOLOTE D_LOTE,
    NUEVAFECHAVENCE D_FECHAVENCE,
    PERSONAID D_FK,
    DOCTOREFERENCIAID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable DOCTOIDENTRADA D_FK;
declare variable DOCTOIDSALIDA D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable CAJAID D_FK;
declare variable SUCURSALID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable CANTIDADFALTANTE D_CANTIDAD;
declare variable CANTIDADDIFERENCIA D_CANTIDAD;
declare variable ESTATUSDOCTOID D_FK;
declare variable FALTANTES integer;
declare variable REFERENCIA D_REFERENCIA;
declare variable COSTO D_COSTO;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable TIPODOCTOINVFISID D_FK;
declare variable VENDEDORID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable TIPODOCTOID D_FK;
declare variable FECHAREFERENCIA D_FECHA;
declare variable PRIMERCICLO D_BOOLCN;
BEGIN

   ERRORCODE = 0;
   TIPODOCTOID = 50;

   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1039;
      SUSPEND;
      EXIT;
   END



   SELECT FIRST 1 PARAMETRO.sucursalid FROM PARAMETRO  INTO :SUCURSALID;
   
   SELECT FECHA FROM DOCTO WHERE ID = :DOCTOREFERENCIAID INTO :FECHAREFERENCIA;

   FOR
      SELECT COALESCE(ALMACENID,1) ALMACENID FROM INVENTARIO
      WHERE COALESCE(CANTIDAD,0) > 0 AND PRODUCTOID = :PRODUCTOID
      GROUP BY  COALESCE(ALMACENID,1)
      INTO :ALMACENID
   DO
   BEGIN

                 -- Inicializara para primer registro de movto


    SELECT ID FROM DOCTO
    WHERE FECHA = :FECHAREFERENCIA AND DOCTOREFID = :DOCTOREFERENCIAID AND ALMACENID = :ALMACENID
    AND SUBTIPODOCTOID = 18
    INTO :DOCTOIDSALIDA;

    
    SELECT ID FROM DOCTO
    WHERE FECHA = :FECHAREFERENCIA AND DOCTOREFID = :DOCTOREFERENCIAID AND ALMACENID = :ALMACENID
    AND SUBTIPODOCTOID = 19
    INTO :DOCTOIDENTRADA;

     DOCTOIDSALIDA = COALESCE(:DOCTOIDSALIDA,0);
    DOCTOIDENTRADA = COALESCE(:DOCTOIDENTRADA,0);
           ERRORCODE = 51;
        
    FOR
      SELECT PRODUCTOID, coalesce(CANTIDAD,0), LOTE, FECHAVENCE, COSTO
      FROM INVENTARIO
      WHERE coalesce(CANTIDAD,0) > 0
        AND PRODUCTOID = :PRODUCTOID
         AND COALESCE(inventario.almacenid ,1) = :ALMACENID
      INTO :PRODUCTOID, :CANTIDAD, :LOTE, :FECHAVENCE, :COSTO
    DO
    BEGIN

      IF(:DOCTOIDSALIDA = 0) THEN
      BEGIN
         PRIMERCICLO = 'S';
      END
      ELSE
      BEGIN
         PRIMERCICLO = 'N';
      END


      SELECT DOCTOID, MOVTOID, ERRORCODE
      FROM MOVTO_INSERT(:DOCTOIDSALIDA, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, 1, :PERSONAID, 1, 0,
         :PRODUCTOID, :LOTE, :FECHAVENCE, 0, 0, 0, 0, 0, 0, 0,
         '', '', :COSTO, 0, 0, 'N', 0, CURRENT_DATE, CURRENT_DATE, 0.00,NULL,NULL,NULL,NULL,NULL, NULL, NULL, NULL, NULL)
      INTO :DOCTOIDSALIDA, :MOVTOID, :ERRORCODE;
      
      IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END


      IF(COALESCE(:PRIMERCICLO ,'N') = 'S') THEN
      BEGIN
        UPDATE DOCTO SET SUBTIPODOCTOID = 18, DOCTOREFID = :DOCTOREFERENCIAID WHERE ID = :DOCTOIDSALIDA ;
      END


      
      SELECT DOCTOID, MOVTOID, ERRORCODE
      FROM MOVTO_INSERT(:DOCTOIDENTRADA, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, 1, :PERSONAID, 1, 0,
         :PRODUCTOID, :NUEVOLOTE, :NUEVAFECHAVENCE, 0, :CANTIDAD, 0, 0, 0, 0, 0,
         '', '', :COSTO, 0, 0, 'N', 0, CURRENT_DATE, CURRENT_DATE, 0.00,NULL,NULL,NULL,NULL,NULL, NULL, NULL, NULL, NULL)
      INTO :DOCTOIDENTRADA, :MOVTOID, :ERRORCODE;
      
      IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END

            
      IF(COALESCE(:PRIMERCICLO ,'N') = 'S') THEN
      BEGIN
        UPDATE DOCTO SET SUBTIPODOCTOID = 19, DOCTOREFID = :DOCTOREFERENCIAID WHERE ID = :DOCTOIDENTRADA ;
      END

    END


   END


   
   ERRORCODE = 0;
   SUSPEND;

   
  /* WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END  */

   END