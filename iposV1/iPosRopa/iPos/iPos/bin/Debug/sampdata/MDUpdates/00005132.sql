create or alter procedure KIT_TOTALIZARIMPUESTOS (
    PRODUCTOKITID D_FK)
returns (
    SUMAIVAPARTE D_DECIMAL_EXACT,
    SUMAIEPSPARTE D_DECIMAL_EXACT,
    PORCENTAJEIEPS D_DECIMAL_EXACT,
    PORCENTAJEIVA D_DECIMAL_EXACT,
    PORCENTAJEIMPUESTO D_DECIMAL_EXACT,
    TASAIVAID D_FK,
    SUMACOSTOTOTALSINIMPUESTO D_PRECIO,
    SUMACOSTOTOTALCONIMPUESTO D_PRECIO,
    ERRORCODE D_ERRORCODE)
as
declare variable ESKIT D_BOOLCN;
declare variable MANEJAKIT D_BOOLCN;
BEGIN

    ERRORCODE = 0;
    PORCENTAJEIEPS = 0;
    PORCENTAJEIVA  = 0;
    PORCENTAJEIMPUESTO  = 0;
    TASAIVAID  = 0;   
    SUMACOSTOTOTALSINIMPUESTO  = 0;  
    SUMACOSTOTOTALCONIMPUESTO  = 0;  
    SUMAIVAPARTE  = 0;
    SUMAIEPSPARTE  = 0;  

    SELECT ESKIT, TASAIVAID, TASAIVA, TASAIEPS, TASAIMPUESTO
        FROM PRODUCTO
        WHERE ID = :PRODUCTOKITID
        INTO :ESKIT, :TASAIVAID, :PORCENTAJEIVA, :PORCENTAJEIEPS, :PORCENTAJEIMPUESTO;
    IF(COALESCE(:ESKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -1;
        SUSPEND;
        EXIT;
    END

    SELECT FIRST 1 MANEJAKITS FROM PARAMETRO WHERE 1 = 1 INTO :MANEJAKIT;
    IF(COALESCE(:MANEJAKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -2;
        SUSPEND;  
        EXIT;
    END

    SELECT


                        SUM(COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0)) AS SUMACOSTOTOTALSINIMPUESTO,
                        SUM(
                         COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0)
                         + COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN COALESCE(PRODUCTO.TASAIEPS,0) / 100.00 ELSE
                          0 END)
                         + (COALESCE(KITDEFINICION.COSTOPARTE,0) * COALESCE(KITDEFINICION.CANTIDADPARTE,0) * (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN 1 + (COALESCE(PRODUCTO.TASAIEPS,0) / 100.00)
                          ELSE 1 END)) * (COALESCE(PRODUCTO.TASAIVA,0) / 100.00)
                          ) AS COSTOTOTALCONIMPUESTO
    FROM            KITDEFINICION LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = KITDEFINICION.PRODUCTOPARTEID INNER JOIN
                         PARAMETRO ON 1 = 1
    WHERE        (KITDEFINICION.PRODUCTOKITID = :PRODUCTOKITID)
    INTO :SUMACOSTOTOTALSINIMPUESTO, :SUMACOSTOTOTALCONIMPUESTO;


    SELECT

                        SUM(CAST((100.00 * COALESCE(KITDEFINICION.COSTOPARTE,0.00) * COALESCE(KITDEFINICION.CANTIDADPARTE,0.00) / COALESCE(:SUMACOSTOTOTALSINIMPUESTO, 0.00)) AS D_PRECIO) *
                            (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN COALESCE(PRODUCTO.TASAIEPS/100.00,0.00)  ELSE 0.00 END)) AS SUMAIEPSPARTE,


                        SUM(CAST((100.00 * COALESCE(KITDEFINICION.COSTOPARTE,0.00) * COALESCE(KITDEFINICION.CANTIDADPARTE,0.00) / COALESCE(:SUMACOSTOTOTALSINIMPUESTO, 0.00)) AS D_PRECIO) *
                            (CASE WHEN PARAMETRO.DESGLOSEIEPS = 'S' THEN 1 + (COALESCE(PRODUCTO.TASAIEPS,0) / 100.00) ELSE 1 END) * (COALESCE(PRODUCTO.TASAIVA,0.00) / 100.00)) AS SUMAIVAPARTE



    FROM                KITDEFINICION LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = KITDEFINICION.PRODUCTOPARTEID INNER JOIN
                         PARAMETRO ON 1 = 1
    WHERE        (KITDEFINICION.PRODUCTOKITID = :PRODUCTOKITID)
    INTO  :SUMAIEPSPARTE, :SUMAIVAPARTE;



    IF(COALESCE(:SUMACOSTOTOTALSINIMPUESTO,0) = 0) THEN
    BEGIN
        PORCENTAJEIEPS = 0;
        PORCENTAJEIVA = 0;
        PORCENTAJEIMPUESTO = 0;
        TASAIVAID = -1;

    END
    ELSE
    BEGIN
        TASAIVAID = -1;
        PORCENTAJEIEPS = cast( COALESCE(:SUMAIEPSPARTE,0.00)  as d_decimal_exact);
        PORCENTAJEIVA = cast( COALESCE(:SUMAIVAPARTE,0.00) as d_decimal_exact)/ (1.00 + COALESCE(:SUMAIEPSPARTE,0.00)/100.00);
        PORCENTAJEIMPUESTO =  COALESCE(:PORCENTAJEIEPS,0.00) + cast( COALESCE(:SUMAIVAPARTE,0.00) as d_decimal_exact) ;

    END




   ERRORCODE = 0;
   SUSPEND;

   --WHEN ANY DO
   --BEGIN
   --  ERRORCODE = 1076;
   --  SUSPEND;
   --END

END




