CREATE OR ALTER VIEW GRIDPV_ENTRADAS(
    DOCTOID,
    MOVTOID,
    PARTIDA,
    GRIDLINE,
    CANTIDAD,
    DESCRIPCION,
    PRECIOUNIDAD,
    TOTAL,
    IVA,
    IEPS,
    IMPORTE,
    SUBTOTAL,
    IMPUESTO,
    TITULOSTOTALES,
    DESCUENTO,
    DESCRIPCION2,
    LOTE,
    CLAVEPRODUCTO,
    TASAIVA,
    TEXTO1,
    TEXTO2,
    TEXTO3,
    TEXTO4,
    TEXTO5,
    TEXTO6,
    NUMERO1,
    NUMERO2,
    NUMERO3,
    NUMERO4,
    DESCUENTOPORCENTAJE,
    COSTO,
    PZACAJA,
    UNIDAD)
AS
SELECT        DOCTO.ID AS DOCTOID,
              MOVTO.ID AS MOVTOID,
              MOVTO.PARTIDA, 1 AS GRIDLINE,
              CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END CANTIDAD,
              PRODUCTO.DESCRIPCION1 AS DESCRIPCION,
              CASE WHEN MOVTO.TASAIMPUESTO IS NULL
                         THEN MOVTO.COSTO ELSE (MOVTO.COSTO * ((100.00 + MOVTO.TASAIVA) / 100.00) * ((100.00 + MOVTO.TASAIEPS) / 100.00)) END AS PRECIOUNIDAD,
                         round(MOVTO.total * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS TOTAL,
                         round(MOVTO.iva * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS IVA,
                         round(MOVTO.ieps * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS IEPS,
                         round(MOVTO.total * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS IMPORTE,
                         round(MOVTO.subtotal * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS SUBTOTAL,
                         round(MOVTO.impuesto * (coalesce(CASE WHEN (DOCTO.TIPODOCTOID = 41 or (DOCTO.TIPODOCTOID = 11 AND DOCTO.SUBTIPODOCTOID = 23)) THEN MOVTO.CANTIDADSURTIDA ELSE MOVTO.CANTIDAD END,0)/coalesce(movto.cantidad,0)),2) AS IMPUESTO,
                         '' AS TITULOSTOTALES, 
                         MOVTO.DESCUENTO,
                         PRODUCTO.DESCRIPCION2,
                         MOVTO.LOTE,
                         PRODUCTO.CLAVE AS CLAVEPRODUCTO,
                         PRODUCTO.TASAIVA,
                         PRODUCTOCARACTERISTICAS.TEXTO1,
                         PRODUCTOCARACTERISTICAS.TEXTO2, 
                         PRODUCTOCARACTERISTICAS.TEXTO3,
                         PRODUCTOCARACTERISTICAS.TEXTO4,
                         PRODUCTOCARACTERISTICAS.TEXTO5,
                         PRODUCTOCARACTERISTICAS.TEXTO6,
                         PRODUCTOCARACTERISTICAS.NUMERO1, 
                         PRODUCTOCARACTERISTICAS.NUMERO2,
                         PRODUCTOCARACTERISTICAS.NUMERO3,
                         PRODUCTOCARACTERISTICAS.NUMERO4,
                         MOVTO.DESCUENTOPORCENTAJE,
                         MOVTO.COSTO,
                         PRODUCTO.PZACAJA, 
                         PRODUCTO.UNIDAD
FROM            DOCTO INNER JOIN
                         MOVTO ON MOVTO.DOCTOID = DOCTO.ID LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID LEFT OUTER JOIN
                         PRODUCTOCARACTERISTICAS ON PRODUCTOCARACTERISTICAS.PRODUCTOID = PRODUCTO.ID
WHERE        (MOVTO.CANTIDAD > 0)
--ORDER BY MOVTO.PARTIDA
;