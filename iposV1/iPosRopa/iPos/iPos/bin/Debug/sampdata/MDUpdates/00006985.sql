create or alter procedure MOVILREBAJA_APROBACION (
    MOVTOID D_FK,
    CANTIDADNUEVA D_CANTIDAD,
    PRECIONUEVO D_PRECIO,
    APROBADO D_BOOLCS)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable REBAJAESPECIAL D_BOOLCN;
declare variable LISTAPRECIOMINIMO D_FK;
declare variable PRECIOMINIMO D_PRECIO;
declare variable SUMATOTALCONREBAJA D_PRECIO;
declare variable SEPROMOVIOREBAJA D_BOOLCN;
declare variable SUMAMONTOREBAJA D_PRECIO;
declare variable LOTEIMPORTADO D_FK;
declare variable VERSIONTOPEID D_FK;
declare variable DOCTOID D_FK;
declare variable CUENTAMOVTOPEND integer;
declare variable CUENTAMOVTO integer;
declare variable CANTIDADAFECTAR D_CANTIDAD;         
declare variable COTI_ENRUTADA D_BOOLCN_NULL;
BEGIN

   --SEPROMOVIOREBAJA = 'N';

   SELECT COALESCE(REBAJAESPECIAL, 'N') , COALESCE( LISTAPRECIOMINIMO, 5) ,
      COALESCE(VERSIONTOPEID,0)
   FROM
   PARAMETRO INTO :REBAJAESPECIAL , :LISTAPRECIOMINIMO,
    :VERSIONTOPEID;
              
   IF (:REBAJAESPECIAL <> 'S') THEN
   BEGIN
      SUSPEND;
      EXIT;
   END


   SELECT DOCTOID FROM MOVTO WHERE ID = :MOVTOID INTO :DOCTOID;


   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID, COTI_ENRUTADA
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :ESTATUSDOCTOID, :TIPODOCTOID, :COTI_ENRUTADA;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1082;
      SUSPEND;
      EXIT;
   END

   -- Si no es de los tipos b?sicos: Salir.
   IF (:TIPODOCTOID NOT IN (331) AND NOT (:TIPODOCTOID = 21 AND COALESCE(:COTI_ENRUTADA,'N') = 'S')) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END


   IF(COALESCE(:APROBADO,'N') = 'N') THEN
   BEGIN
       SELECT ERRORCODE FROM MOVTO_DELETE (:MOVTOID, 'N') INTO :ERRORCODE;
       IF(COALESCE(:ERRORCODE,0) <> 0) THEN
       BEGIN
        SUSPEND;
        EXIT;
       END
   END
   ELSE
   BEGIN

    -- Leer del DOCTO a recalcular.
    SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID
    FROM DOCTO
    WHERE ID = :DOCTOID
    INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID;


    -- Agrega los MOVTO.

   


     SELECT
      MOVTO.ID, MOVTO.PRODUCTOID, MOVTO.LOTE, MOVTO.FECHAVENCE, MOVTO.CANTIDAD, MOVTO.PRECIO, MOVTO.COSTO,
      MOVTO.TIPODIFERENCIAINVENTARIOID , MOVTO.DESCRIPCION1, MOVTO.DESCRIPCION2, MOVTO.DESCRIPCION3,
      CASE
            WHEN COALESCE(:VERSIONTOPEID,0) = 2 THEN
                ROUND(PRODUCTO.PRECIOTOPE,2)
            ELSE
                (CASE :LISTAPRECIOMINIMO
                            WHEN 1 THEN COALESCE(PRODUCTO.PRECIO1 ,0)
                            WHEN 2 THEN COALESCE(PRODUCTO.PRECIO2 ,0)
                            WHEN 3 THEN COALESCE(PRODUCTO.PRECIO3 ,0)
                            WHEN 4 THEN COALESCE(PRODUCTO.PRECIO4 ,0)
                            ELSE PRODUCTO.PRECIO5
                        END
                      )
      END PRECIOMINIMO ,
      LOTEIMPORTADO
      FROM MOVTO  LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
      LEFT JOIN PROMOCION ON PROMOCION.ID = MOVTO.PROMOCIONID
      WHERE MOVTO.ID = :MOVTOID
       AND COALESCE(PRODUCTO.PRECIOTOPE,0) > 0
       AND COALESCE(PROMOCION.TIPOPROMOCIONID,0) <> 7
      INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :PRECIOMINIMO, :LOTEIMPORTADO;

      IF(COALESCE(:CANTIDADNUEVA,0) <> COALESCE(:CANTIDAD,0)) THEN
      BEGIN
        CANTIDADAFECTAR = COALESCE(:CANTIDADNUEVA,0) - COALESCE(:CANTIDAD,0);
      END

      IF(COALESCE(:PRECIONUEVO,0) = 0 OR COALESCE(:PRECIONUEVO,0) = COALESCE(:PRECIO,0)) THEN
      BEGIN
            PRECIONUEVO = COALESCE(:PRECIO,0);
      END


      SELECT ERRORCODE
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 5, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADAFECTAR, 0, 0, 0, 0,:PRECIONUEVO, 0,
          '',  '', :COSTO, :SUCURSALID, :ALMACENID, 'N',
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, null,NULL ,NULL,NULL,:MOVTOID,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL ,:LOTEIMPORTADO, 'N','N'
      ) INTO :ERRORCODE;




        IF(:ERRORCODE <> 0) THEN
        BEGIN
          SUSPEND;
          EXIT;
        END


      UPDATE MOVTO SET ESTADOREBAJA = 2
      WHERE ID = :MOVTOID;



     END


      SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :DOCTOID AND COALESCE(ESTADOREBAJA,0) = 1 INTO :CUENTAMOVTOPEND;

      IF(COALESCE(:CUENTAMOVTOPEND,0) = 0) THEN
      BEGIN
            UPDATE DOCTO SET ESTADOREBAJA = 2 WHERE ID = :DOCTOID;
      END
      ELSE
      BEGIN
            UPDATE DOCTO SET ESTADOREBAJA = 1 WHERE ID = :DOCTOID;
      END

      
      SELECT COUNT(*) FROM MOVTO WHERE DOCTOID = :DOCTOID  INTO :CUENTAMOVTO;
      
      IF(COALESCE(:CUENTAMOVTO,0) = 0) THEN
      BEGIN
            DELETE FROM DOCTO WHERE ID = :DOCTOID;
      END




   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END