create or alter procedure KARDEX_INSERT (
    DOCTOID D_FK,
    MOVTOID D_FK,
    PRODUCTOID D_FK,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    CANTIDAD D_CANTIDAD,
    PRECIO D_PRECIO,
    COSTO D_COSTO,
    ESAPARTADO D_BOOLCN,
    LOTEIMPORTADO D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable TIPODOCTOID type of D_FK;
declare variable ALMACENID D_FK;
declare variable FECHA D_FECHA;
declare variable FECHAHORA D_TIMESTAMP;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable EXISTENCIADEFACTURA D_CANTIDAD;
declare variable EXISTENCIADEREMISION D_CANTIDAD;
declare variable EXISTENCIADEINDEFINIDO D_CANTIDAD;
declare variable CANTIDADAASIGNAR D_CANTIDAD;
declare variable ULTIMOORIGENFISCAL D_FK;
declare variable NUEVOULTIMOORIGENFISCAL D_FK;
declare variable MOVTOREFID D_FK;
declare variable CANTIDADARESTAR D_CANTIDAD;
declare variable REFEXISTENCIADEFACTURA D_CANTIDAD;
declare variable REFEXISTENCIADEREMISION D_CANTIDAD;
declare variable REFEXISTENCIADEINDEFINIDO D_CANTIDAD;
declare variable CANTIDAD_FAC_INTERCAMBIO D_CANTIDAD;
declare variable CANTIDAD_REM_INTERCAMBIO D_CANTIDAD;
declare variable CANTIDADDEFACTURAORIGINAL D_CANTIDAD;
declare variable CANTIDADDEREMISIONORIGINAL D_CANTIDAD;
declare variable ESFACTURAELECTRONICA D_BOOLCN;
declare variable BUFFERCANTIDAD D_CANTIDAD;
declare variable DOCTOORIGENFISCAL D_FK;
declare variable NEGATIVOS D_BOOLCN;
declare variable DIVIDIR_REM_FACT D_BOOLCS;
declare variable SUBTIPODOCTOID D_FK;
BEGIN



         
      --INSERT INTO TRAZA(VALOR) VALUES ('SI ENTRA A KARDEXINSERT');

   IF (:DOCTOID IS NULL) THEN
   BEGIN
      ERRORCODE = 1028;
   END
   
   IF (:MOVTOID IS NULL) THEN
   BEGIN
      ERRORCODE = 1029;
   END

   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1030;
   END

   CANTIDADAASIGNAR = :CANTIDAD;

  SELECT COALESCE(CANTIDADDEFACTURA,0), COALESCE(CANTIDADDEREMISION,0), COALESCE(CANTIDADDEINDEFINIDO,0), MOVTOREFID
  FROM MOVTO WHERE ID = :MOVTOID INTO :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :MOVTOREFID ;
                    
  select TIPODOCTOID, FECHA, FECHAHORA, ALMACENID , COALESCE(ESFACTURAELECTRONICA , 'N') , ORIGENFISCALID, SUBTIPODOCTOID
  from DOCTO
  where ID = :DOCTOID
  into :TIPODOCTOID, :FECHA, :FECHAHORA, :ALMACENID, :ESFACTURAELECTRONICA, :DOCTOORIGENFISCAL, :SUBTIPODOCTOID;


    IF(:TIPODOCTOID = 16) THEN
    BEGIN
    
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END

    IF(:TIPODOCTOID in ( 81, 83) AND :SUBTIPODOCTOID = 7) THEN
    BEGIN 
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END
          

    IF(:TIPODOCTOID in ( 31, 32, 33 ) AND :SUBTIPODOCTOID = 8) THEN
    BEGIN 
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END     
          

    IF(:TIPODOCTOID = 22 AND :SUBTIPODOCTOID = 13) THEN
    BEGIN 
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END

    

    IF(:TIPODOCTOID = 20) THEN
    BEGIN 
        ERRORCODE = 0;
        SUSPEND;
        EXIT;
    END


  -- si el parametro de dividir remision de facturado NO esta activado
  select dividir_rem_fact from parametro into :dividir_rem_fact;
   IF(:dividir_rem_fact = 'N' AND  :CANTIDADDEFACTURA = 0 AND :CANTIDADDEREMISION = 0 AND :CANTIDADDEINDEFINIDO = 0) THEN
   BEGIN
      CANTIDADDEREMISION = :CANTIDAD;
      CANTIDADDEFACTURA = 0;
      CANTIDADDEINDEFINIDO = 0;
      
     update movto
     set cantidaddefactura = :cantidaddefactura,
        cantidadderemision = :cantidadderemision ,
        cantidaddeindefinido = :cantidaddeindefinido
     where id = :MOVTOID;
   END


  -- inventario fisico entrada
   IF(:TIPODOCTOID IN (51, 501,504) AND  :CANTIDADDEFACTURA = 0 AND :CANTIDADDEREMISION = 0 AND :CANTIDADDEINDEFINIDO = 0) THEN
   BEGIN
      CANTIDADDEREMISION = :CANTIDAD;
      
     update movto
     set cantidadderemision = :cantidadderemision
     where id = :MOVTOID;
   END



   -- traspaso entrada y compras por pedido de la matriz cuando se devolvio mercancia
    /*traspaso entrada, aqui se considera que la cantidad surtida puede ser menor que la cantidad que se registro de entrada en el pedido
     y la cantidad de entrada se conserva*/
   IF(:TIPODOCTOID IN (41,11) AND :CANTIDAD < (:CANTIDADDEFACTURA + :CANTIDADDEREMISION + :CANTIDADDEINDEFINIDO )) THEN
   BEGIN
        -- averiguamos que tanto se tiene que restar de la cantidad presumida inicialmente
        CANTIDADARESTAR =   (:CANTIDADDEFACTURA + :CANTIDADDEREMISION + :CANTIDADDEINDEFINIDO ) - :CANTIDAD;

        -- iniciamos los descuentos con indefinido
        IF(:CANTIDADARESTAR > :CANTIDADDEINDEFINIDO) then
        BEGIN                    
          CANTIDADARESTAR = :CANTIDADARESTAR - :CANTIDADDEINDEFINIDO;
          CANTIDADDEINDEFINIDO = 0;
        END
        ELSE
        BEGIN
           CANTIDADDEINDEFINIDO = :CANTIDADDEINDEFINIDO - :CANTIDADARESTAR;  
           CANTIDADARESTAR = 0;
        END

        -- luego remision
        IF(:CANTIDADARESTAR > 0 AND :CANTIDADARESTAR > :CANTIDADDEREMISION) then
        BEGIN           
          CANTIDADARESTAR = :CANTIDADARESTAR - :CANTIDADDEREMISION; 
          CANTIDADDEREMISION = 0;
        END
        ELSE IF(:CANTIDADARESTAR > 0) THEN
        BEGIN
           CANTIDADDEREMISION = :CANTIDADDEREMISION - :CANTIDADARESTAR; 
           CANTIDADARESTAR = 0;
        END

        -- por ultimo factura
          IF(:CANTIDADARESTAR > 0  AND :CANTIDADARESTAR <= :CANTIDADDEFACTURA) THEN
          BEGIN
                 
             CANTIDADDEFACTURA = :CANTIDADDEFACTURA - :CANTIDADARESTAR;
             CANTIDADARESTAR = 0;

          END
          ELSE
          BEGIN
             CANTIDADARESTAR = 0;

          END
          
        update movto
        set cantidaddefactura = :cantidaddefactura,
        cantidadderemision = :cantidadderemision ,
        cantidaddeindefinido = :cantidaddeindefinido
        where id = :MOVTOID;
        

   END

   -- para las cancelaciones de devolucion aproveedor vamos a consdierar toda la cantidad respecto al origen
   if (:TIPODOCTOID IN (15)) THEN
      BEGIN
          IF(:DOCTOORIGENFISCAL = 3) THEN
          BEGIN   
                CANTIDADDEFACTURA = COALESCE(:CANTIDAD,0);
                CANTIDADDEREMISION =  0.00;
                CANTIDADDEINDEFINIDO =  0.00;
          END
          ELSE IF(:DOCTOORIGENFISCAL = 2) then
          BEGIN      
                CANTIDADDEREMISION = COALESCE(:CANTIDAD,0);
                CANTIDADDEFACTURA =  0.00;
                CANTIDADDEINDEFINIDO =  0.00;
          END

      END


   -- ENTRADA DE MERCANCIA SE TIENEN AUN SALDOS DE INTERCAMBIO (REMISION-FACTURA) PENDIENTES
   SELECT COALESCE(EXIST_FAC_INTERCAMBIO,0) , COALESCE(EXIST_REM_INTERCAMBIO,0) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :CANTIDAD_FAC_INTERCAMBIO ,  :CANTIDAD_REM_INTERCAMBIO;
  if(:TIPODOCTOID IN (11,15,22,23,26,41) AND ((:CANTIDADDEFACTURA > 0 AND :CANTIDAD_FAC_INTERCAMBIO > 0) or (:CANTIDADDEREMISION > 0 AND :CANTIDAD_REM_INTERCAMBIO > 0) )) THEN
  BEGIN
     IF(:CANTIDADDEFACTURA > 0 AND :CANTIDAD_FAC_INTERCAMBIO > 0) THEN
     BEGIN
        IF(:CANTIDADDEFACTURA > :CANTIDAD_FAC_INTERCAMBIO) THEN
        BEGIN
           CANTIDADDEFACTURA = :CANTIDADDEFACTURA - :CANTIDAD_FAC_INTERCAMBIO;
           CANTIDADDEREMISION = :CANTIDADDEREMISION + :CANTIDAD_FAC_INTERCAMBIO;
           CANTIDAD_FAC_INTERCAMBIO = 0;
        END
        ELSE
        BEGIN           
           CANTIDAD_FAC_INTERCAMBIO = :CANTIDAD_FAC_INTERCAMBIO - :CANTIDADDEFACTURA;
           CANTIDADDEREMISION =  :CANTIDADDEREMISION + :CANTIDADDEFACTURA;
           CANTIDADDEFACTURA = 0;
        END
     END
         
     IF(:CANTIDADDEREMISION > 0 AND :CANTIDAD_REM_INTERCAMBIO > 0) THEN
     BEGIN
        IF(:CANTIDADDEREMISION > :CANTIDAD_REM_INTERCAMBIO) THEN
        BEGIN
           CANTIDADDEREMISION = :CANTIDADDEREMISION - :CANTIDAD_REM_INTERCAMBIO;
           CANTIDADDEFACTURA = :CANTIDADDEFACTURA + :CANTIDAD_REM_INTERCAMBIO;
           CANTIDAD_REM_INTERCAMBIO = 0;
        END
        ELSE
        BEGIN           
           CANTIDAD_REM_INTERCAMBIO = :CANTIDAD_REM_INTERCAMBIO - :CANTIDADDEREMISION;
           CANTIDADDEFACTURA =  :CANTIDADDEFACTURA + :CANTIDADDEREMISION;
           CANTIDADDEREMISION = 0;
        END
     END
        
     update movto
     set cantidaddefactura = :cantidaddefactura,
     cantidadderemision = :cantidadderemision
     where id = :MOVTOID;

     update producto set
     exist_fac_intercambio = :CANTIDAD_FAC_INTERCAMBIO,
     exist_rem_intercambio = :CANTIDAD_REM_INTERCAMBIO
     where id = :productoid;


  END



   --VENTAS, VENTAS DE APARTADO Y

   IF(:TIPODOCTOID IN (21,25,31,52,81) AND  :CANTIDADDEFACTURA = 0 AND :CANTIDADDEREMISION = 0 AND :CANTIDADDEINDEFINIDO = 0) THEN
   BEGIN
      SELECT COALESCE(EXIST_FAC_INTERCAMBIO,0) , COALESCE(EXIST_REM_INTERCAMBIO,0),
      COALESCE(EXISTENCIAFACTURADO,0),  COALESCE(EXISTENCIAREMISIONADO,0) , COALESCE(NEGATIVOS, 'N')
      FROM PRODUCTO WHERE ID = :PRODUCTOID INTO
      :CANTIDAD_FAC_INTERCAMBIO ,  :CANTIDAD_REM_INTERCAMBIO,
      :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :NEGATIVOS;
     --SELECT COALESCE(SUM( CANTIDAD),0) FROM INVENTARIO WHERE PRODUCTOID = :PRODUCTOID AND ORIGENFISCALID = 2 INTO :EXISTENCIADEREMISION;
     --SELECT COALESCE(SUM( CANTIDAD),0) FROM INVENTARIO WHERE PRODUCTOID = :PRODUCTOID AND ORIGENFISCALID = 3 INTO :EXISTENCIADEFACTURA;
      SELECT ULTIMOORIGENFISCALVENTA FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :ULTIMOORIGENFISCAL;


      IF(:CANTIDAD > (:EXISTENCIADEFACTURA + :EXISTENCIADEREMISION) AND :NEGATIVOS = 'N' ) THEN
      BEGIN
      
                    IN AUTONOMOUS TRANSACTION DO
                    INSERT INTO TRAZA (VALOR)
                    VALUES ('KI ' || CAST(:PRODUCTOID AS VARCHAR(20)) || ' ' || CAST(:CANTIDAD AS VARCHAR(20)));

          exception ERR_EXISTENCIAINSUFICIENTE;
      END

      IF(:ESFACTURAELECTRONICA  = 'N') THEN
      BEGIN
        SELECT CANTIDADFACTURADO , CANTIDADREMISIONADO , CANTIDADINDEFINIDO , NUEVOULTIMOORIGENFISCAL
        FROM OBTEN_CANTIDADORIGENFISCAL( :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :CANTIDAD, :ULTIMOORIGENFISCAL)
        INTO :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :NUEVOULTIMOORIGENFISCAL;
      END
      ELSE
      BEGIN   
        SELECT CANTIDADDEFACTURA , CANTIDADDEREMISION , CANTIDADINDEFINIDO , NUEVOULTIMOORIGENFISCAL
        FROM OBTEN_CANTIDADORIGEN_FRI( :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :CANTIDAD, :ULTIMOORIGENFISCAL)
        INTO :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :NUEVOULTIMOORIGENFISCAL;


        IF(COALESCE(:CANTIDADDEREMISION , 0) > 0) THEN
        BEGIN
              CANTIDAD_FAC_INTERCAMBIO = :CANTIDAD_FAC_INTERCAMBIO + :CANTIDADDEREMISION;
        END


      END


     update movto
     set cantidaddefactura = :cantidaddefactura,
     cantidadderemision = :cantidadderemision ,
     cantidaddeindefinido = :cantidaddeindefinido
     where id = :MOVTOID;

         
     update producto set
     exist_fac_intercambio = :CANTIDAD_FAC_INTERCAMBIO
     where id = :productoid;


   END   

   /**/
   ELSE  IF(:TIPODOCTOID IN (22) AND :CANTIDADDEFACTURA = 0 AND :CANTIDADDEREMISION = 0 AND :CANTIDADDEINDEFINIDO = 0 /*AND COALESCE(:MOVTOREFID,0) <> 0*/) THEN
   BEGIN

     IF( COALESCE(:MOVTOREFID,0) <> 0 ) THEN
     BEGIN
        SELECT  COALESCE(CANTIDADDEREMISION,0) - COALESCE(CANTDEVUELTADEREMISION,0) FROM MOVTO WHERE ID = :MOVTOREFID  INTO :EXISTENCIADEREMISION;
        SELECT COALESCE( CANTIDADDEFACTURA,0) - COALESCE( CANTDEVUELTADEFACTURA,0) FROM MOVTO WHERE ID = :MOVTOREFID  INTO :EXISTENCIADEFACTURA;
     END
     ELSE
     BEGIN
        EXISTENCIADEREMISION = 0;
        EXISTENCIADEFACTURA = 0;
     END

     SELECT ULTIMOORIGENFISCALVENTA FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :ULTIMOORIGENFISCAL;
     -- REVIERTE EL ORIGEN FISCAL
     IF(:ULTIMOORIGENFISCAL = 2) then
         ULTIMOORIGENFISCAL = 3;
     IF(:ULTIMOORIGENFISCAL = 3) then
         ULTIMOORIGENFISCAL = 2;

         
      IF(:ESFACTURAELECTRONICA  = 'N') THEN
      BEGIN
            SELECT CANTIDADFACTURADO , CANTIDADREMISIONADO , CANTIDADINDEFINIDO , NUEVOULTIMOORIGENFISCAL
            FROM OBTEN_CANTIDADORIGENFISCAL( :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :CANTIDAD, :ULTIMOORIGENFISCAL)
            INTO :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :NUEVOULTIMOORIGENFISCAL;
      end
      else
      begin
            SELECT CANTIDADDEFACTURA , CANTIDADDEREMISION , CANTIDADINDEFINIDO , NUEVOULTIMOORIGENFISCAL
            FROM OBTEN_CANTIDADORIGEN_RFI( :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :CANTIDAD, :ULTIMOORIGENFISCAL)
            INTO :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :NUEVOULTIMOORIGENFISCAL;

            
            IF(COALESCE(:CANTIDADDEREMISION , 0) > 0) THEN
            BEGIN
              if(:CANTIDAD_FAC_INTERCAMBIO > :CANTIDADDEREMISION) then
              begin
                   CANTIDAD_FAC_INTERCAMBIO = :CANTIDAD_FAC_INTERCAMBIO - :CANTIDADDEREMISION;
              end
              else
              begin
                  CANTIDAD_FAC_INTERCAMBIO =  0;
              end
            END

      end

     update movto
     set cantidaddefactura = :cantidaddefactura,
     cantidadderemision = :cantidadderemision ,
     cantidaddeindefinido = :cantidaddeindefinido
     where id = :MOVTOID;
     
     update producto set
     exist_fac_intercambio = :CANTIDAD_FAC_INTERCAMBIO
     where id = :productoid;

   END

   /*cancelaciones de compras, devoluciones de compras y cancelacion de devolucion de venta
     Aqui hay que checar todo el tiempo que no incurramos en numeros negativos*/
   ELSE  IF(:TIPODOCTOID IN (12,13,24) ) THEN
   BEGIN
        -- hay que obtener la existencia actual
       /*SELECT COALESCE(SUM( CANTIDAD),0) FROM INVENTARIO WHERE PRODUCTOID = :PRODUCTOID AND ORIGENFISCALID = 2 INTO :EXISTENCIADEREMISION;
       SELECT COALESCE(SUM( CANTIDAD),0) FROM INVENTARIO WHERE PRODUCTOID = :PRODUCTOID AND ORIGENFISCALID = 3 INTO :EXISTENCIADEFACTURA; 
       SELECT COALESCE(SUM( CANTIDAD),0) FROM INVENTARIO WHERE PRODUCTOID = :PRODUCTOID AND ORIGENFISCALID = 1 INTO :EXISTENCIADEINDEFINIDO;
           */
       
      --INSERT INTO TRAZA(VALOR) VALUES ('SI ENTRA A KARDEXINSERT 13');

      SELECT COALESCE(EXIST_FAC_INTERCAMBIO,0) , COALESCE(EXIST_REM_INTERCAMBIO,0),
      COALESCE(EXISTENCIAFACTURADO,0),  COALESCE(EXISTENCIAREMISIONADO,0) ,  COALESCE(EXISTENCIAINDEFINIDO,0) , COALESCE(NEGATIVOS,'N')
      FROM PRODUCTO WHERE ID = :PRODUCTOID INTO 
      :CANTIDAD_FAC_INTERCAMBIO ,  :CANTIDAD_REM_INTERCAMBIO,
      :EXISTENCIADEFACTURA, :EXISTENCIADEREMISION, :EXISTENCIADEINDEFINIDO, :NEGATIVOS;




       --SELECT COALESCE(EXIST_FAC_INTERCAMBIO,0) , COALESCE(EXIST_REM_INTERCAMBIO,0) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :CANTIDAD_FAC_INTERCAMBIO ,  :CANTIDAD_REM_INTERCAMBIO;

       -- se obtiene el origen fiscal si es que existe, si no se deja como remision
     IF(COALESCE(:MOVTOREFID,0) <> 0 and :TIPODOCTOID IN (12,13) )  THEN
     BEGIN
       /*SELECT COALESCE(CANTIDADDEREMISION,0) - COALESCE(CANTDEVUELTADEREMISION,0)  FROM MOVTO WHERE ID = :MOVTOREFID  INTO :REFEXISTENCIADEREMISION;
       SELECT COALESCE( CANTIDADDEFACTURA,0) - COALESCE( CANTDEVUELTADEFACTURA,0) FROM MOVTO WHERE ID = :MOVTOREFID  INTO :REFEXISTENCIADEFACTURA; 
       SELECT COALESCE( CANTIDADDEFACTURA,0) - COALESCE( CANTDEVUELTADEINDEFINIDO,0) FROM MOVTO WHERE ID = :MOVTOREFID  INTO :REFEXISTENCIADEINDEFINIDO; */
       SELECT MIN(D.ORIGENFISCALID) FROM DOCTO D INNER JOIN MOVTO M ON M.DOCTOID = D.ID WHERE M.ID = :MOVTOREFID INTO :ULTIMOORIGENFISCAL;

     END
     ELSE
     BEGIN
       /*REFEXISTENCIADEREMISION = 0;
       REFEXISTENCIADEFACTURA = 0;
       REFEXISTENCIADEINDEFINIDO = 0; */
       ULTIMOORIGENFISCAL = 2;
     END

     if( :ULTIMOORIGENFISCAL is null or :ULTIMOORIGENFISCAL = 1) then
     begin
        ULTIMOORIGENFISCAL = 2;
     end

     NUEVOULTIMOORIGENFISCAL = :ULTIMOORIGENFISCAL;

     -- en el caso de cancelcacion de devolucion con factura electronica hay que considerarlo todo facturado
      if(:ESFACTURAELECTRONICA = 'S' AND  :TIPODOCTOID = 24) then
      BEGIN
               
            CANTIDADDEFACTURA = COALESCE(:CANTIDAD,0);
            CANTIDADDEREMISION =  0.00;
            CANTIDADDEINDEFINIDO =  0.00;
      END

      -- aqui solo nos aseguramos de no tener nulos para evitar problemas
     CANTIDADDEFACTURA = COALESCE(:CANTIDADDEFACTURA,0);
     CANTIDADDEREMISION =  COALESCE(:CANTIDADDEREMISION,0);
     CANTIDADDEINDEFINIDO =  COALESCE(:CANTIDADDEINDEFINIDO,0);


     -- respaldamos la cantidad original  la necesitaremos mas adelante
     CANTIDADDEFACTURAORIGINAL = COALESCE(:CANTIDADDEFACTURA,0);
     CANTIDADDEREMISIONORIGINAL =  COALESCE(:CANTIDADDEREMISION,0);


     -- vemos inicialmente que cantidad necesitamos repartir entre fact y rem
     CANTIDADAASIGNAR = :CANTIDAD - :CANTIDADDEFACTURA - :CANTIDADDEREMISION - :CANTIDADDEINDEFINIDO;


     
                  --INSERT INTO TRAZA(VALOR) VALUES ('CANTIDAD A ASIGNAR' || CAST(:CANTIDADAASIGNAR AS VARCHAR(10)));

     --si se sobrepasa la existencia de cada tipo , quita cantidad y ponla para asignar
     IF(  :CANTIDADDEFACTURA > :EXISTENCIADEFACTURA) THEN
     BEGIN
        CANTIDADAASIGNAR = :CANTIDADAASIGNAR + (:CANTIDADDEFACTURA - :EXISTENCIADEFACTURA);
        CANTIDADDEFACTURA = :EXISTENCIADEFACTURA;
     END   
     IF(  :CANTIDADDEREMISION > :EXISTENCIADEREMISION) THEN
     BEGIN
        CANTIDADAASIGNAR = :CANTIDADAASIGNAR + (:CANTIDADDEREMISION - :EXISTENCIADEREMISION);
        CANTIDADDEREMISION = :EXISTENCIADEREMISION;
     END
     IF(  :CANTIDADDEINDEFINIDO > :EXISTENCIADEINDEFINIDO) THEN
     BEGIN
        CANTIDADAASIGNAR = :CANTIDADAASIGNAR + (:CANTIDADDEINDEFINIDO - :EXISTENCIADEINDEFINIDO);
        CANTIDADDEINDEFINIDO = :EXISTENCIADEINDEFINIDO;
     END

      -- si hay cantidad a asignar
     IF(:CANTIDADAASIGNAR > 0) THEN
     BEGIN
        -- el orden dependera del origen fiscal
        IF(:ULTIMOORIGENFISCAL = 2) THEN
        BEGIN
            IF(:CANTIDADAASIGNAR <= :EXISTENCIADEREMISION - :CANTIDADDEREMISION  ) THEN
            BEGIN

                CANTIDADDEREMISION = :CANTIDADDEREMISION + :CANTIDADAASIGNAR ;
                CANTIDADAASIGNAR = 0;
            END
            ELSE
            BEGIN
                BUFFERCANTIDAD  =    :EXISTENCIADEREMISION - :CANTIDADDEREMISION;
                CANTIDADDEREMISION = :CANTIDADDEREMISION + BUFFERCANTIDAD;
                CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  - BUFFERCANTIDAD;  

            END

            IF(:CANTIDADAASIGNAR > 0) THEN
            BEGIN
                IF(:CANTIDADAASIGNAR <= :EXISTENCIADEFACTURA - :CANTIDADDEFACTURA  ) THEN
                BEGIN
                    CANTIDADDEFACTURA = :CANTIDADDEFACTURA + :CANTIDADAASIGNAR ;
                    CANTIDADAASIGNAR = 0;
                END
                ELSE
                BEGIN
                      
                    BUFFERCANTIDAD  =    :EXISTENCIADEFACTURA - :CANTIDADDEFACTURA;
                    CANTIDADDEFACTURA = :CANTIDADDEFACTURA + BUFFERCANTIDAD;
                    CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  - BUFFERCANTIDAD;
                END


            END

        END
        ELSE IF(:ULTIMOORIGENFISCAL = 3) THEN
        BEGIN
        
            IF(:CANTIDADAASIGNAR <= :EXISTENCIADEFACTURA - :CANTIDADDEFACTURA  ) THEN
            BEGIN
                    CANTIDADDEFACTURA = :CANTIDADDEFACTURA + :CANTIDADAASIGNAR ;
                    CANTIDADAASIGNAR = 0;
            END
            ELSE
            BEGIN                 
                    BUFFERCANTIDAD  =    :EXISTENCIADEFACTURA - :CANTIDADDEFACTURA;
                    CANTIDADDEFACTURA = :CANTIDADDEFACTURA + BUFFERCANTIDAD;
                    CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  - BUFFERCANTIDAD;
            END


            IF(:CANTIDADAASIGNAR > 0) THEN
            BEGIN
                IF(:CANTIDADAASIGNAR <= :EXISTENCIADEREMISION - :CANTIDADDEREMISION  ) THEN
                BEGIN
                    CANTIDADDEREMISION = :CANTIDADDEREMISION + :CANTIDADAASIGNAR ;
                    CANTIDADAASIGNAR = 0;

                END
                ELSE
                BEGIN         
                    BUFFERCANTIDAD  =    :EXISTENCIADEREMISION - :CANTIDADDEREMISION;
                    CANTIDADDEREMISION = :CANTIDADDEREMISION + BUFFERCANTIDAD;
                    CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  - BUFFERCANTIDAD;
                    

                END
            END
        END



            IF(:CANTIDADAASIGNAR > 0) THEN
            BEGIN
                                  
                  --INSERT INTO TRAZA(VALOR) VALUES ('CANTIDAD A ASIGNAR > 0');
                    IF(:NEGATIVOS = 'N') THEN
                    BEGIN  

                    IN AUTONOMOUS TRANSACTION DO
                    INSERT INTO TRAZA (VALOR)
                    VALUES ('KI ' || CAST(:PRODUCTOID AS VARCHAR(20)));
                           
                        exception ERR_EXISTENCIAINSUFICIENTE;

                    END

                    CANTIDADDEREMISION = :CANTIDADDEREMISION + :CANTIDADAASIGNAR ;
                    CANTIDADAASIGNAR = 0;
            END
           -- Aqui se ponen las cantidades intercambiadas , hay que tener cuidado con indefinido
          IF(:CANTIDADDEREMISION < :CANTIDADDEREMISIONORIGINAL) THEN
          BEGIN
             CANTIDAD_REM_INTERCAMBIO   =  CANTIDAD_REM_INTERCAMBIO + (:CANTIDADDEREMISIONORIGINAL - :CANTIDADDEREMISION);
          END

          
          IF(:CANTIDADDEFACTURA < :CANTIDADDEFACTURAORIGINAL) THEN
          BEGIN
             CANTIDAD_FAC_INTERCAMBIO   =  CANTIDAD_FAC_INTERCAMBIO + (:CANTIDADDEFACTURAORIGINAL - :CANTIDADDEFACTURA);
          END

     END




     update movto
     set cantidaddefactura = :cantidaddefactura,
     cantidadderemision = :cantidadderemision ,
     cantidaddeindefinido = :cantidaddeindefinido
     where id = :MOVTOID;

     update producto set
     exist_fac_intercambio = :CANTIDAD_FAC_INTERCAMBIO,
     exist_rem_intercambio = :CANTIDAD_REM_INTERCAMBIO
     where id = :productoid;

   END

   


   ELSE  IF( :CANTIDADDEFACTURA = 0 AND :CANTIDADDEREMISION = 0 AND :CANTIDADDEINDEFINIDO = 0) THEN

   BEGIN
   
                 CANTIDADDEINDEFINIDO =  :CANTIDADAASIGNAR;
                 CANTIDADAASIGNAR  = 0;
   END


    /* aqui simplemente se agregan los kardex que ya se calcularon */
         
   IF (:CANTIDADDEFACTURA > 0 ) THEN
   BEGIN
      
      INSERT INTO KARDEX
         (TIPODOCTOID, DOCTOID, MOVTOID, FECHA, FECHAHORA,
          ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, ORIGENFISCALID, ESAPARTADO, LOTEIMPORTADO)
      VALUES
         (:TIPODOCTOID, :DOCTOID, :MOVTOID, :FECHA, :FECHAHORA,
          :AlmacenId, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADDEFACTURA, :PRECIO, :COSTO,3, :ESAPARTADO, :LOTEIMPORTADO);

   END

   
   IF (:CANTIDADDEREMISION > 0 ) THEN
   BEGIN
      
      INSERT INTO KARDEX
         (TIPODOCTOID, DOCTOID, MOVTOID, FECHA, FECHAHORA,
          ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, ORIGENFISCALID, ESAPARTADO, LOTEIMPORTADO)
      VALUES
         (:TIPODOCTOID, :DOCTOID, :MOVTOID, :FECHA, :FECHAHORA,
          :AlmacenId, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADDEREMISION, :PRECIO, :COSTO,2, :ESAPARTADO, :LOTEIMPORTADO);

   END

     
   IF (:CANTIDADDEINDEFINIDO > 0 ) THEN
   BEGIN
      
      INSERT INTO KARDEX
         (TIPODOCTOID, DOCTOID, MOVTOID, FECHA, FECHAHORA,
          ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, ORIGENFISCALID, ESAPARTADO, LOTEIMPORTADO)
      VALUES
         (:TIPODOCTOID, :DOCTOID, :MOVTOID, :FECHA, :FECHAHORA,
          :AlmacenId, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDADDEINDEFINIDO, :PRECIO, :COSTO,1,:ESAPARTADO, :LOTEIMPORTADO);

   END


   UPDATE PRODUCTO SET ULTIMOORIGENFISCALVENTA = :NUEVOULTIMOORIGENFISCAL
   WHERE ID = :PRODUCTOID;


   IF(COALESCE(:LOTEIMPORTADO, 0) > 0) THEN
   BEGIN

        UPDATE PRODUCTO SET LOTEIMPORTADOAPLICADO = 'S'  WHERE ID = :PRODUCTOID AND MANEJALOTEIMPORTADO = 'S' AND COALESCE(LOTEIMPORTADOAPLICADO, 'N') = 'N';

   END




   
   ERRORCODE = 0;
   SUSPEND;

   /*WHEN ANY DO
   BEGIN
      ERRORCODE = 1031;
      SUSPEND;
   END */
END
