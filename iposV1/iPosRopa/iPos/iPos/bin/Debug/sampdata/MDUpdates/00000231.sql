CREATE OR ALTER PROCEDURE GET_PRODUCTO_PRECIO (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD)
RETURNS (
    PRECIO D_PRECIO,
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE PRECIO1 D_PRECIO;
DECLARE VARIABLE PRECIO2 D_PRECIO;
DECLARE VARIABLE PRECIO3 D_PRECIO;
DECLARE VARIABLE PRECIO4 D_PRECIO;
DECLARE VARIABLE PRECIO5 D_PRECIO;
DECLARE VARIABLE LISTAPRECIO VARCHAR(1);
DECLARE VARIABLE LIMITEPRECIO2 D_CANTIDAD;
BEGIN
   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1048;
      SUSPEND;
      EXIT;
   END
   
   IF ((:PERSONAID IS NULL) OR (:PERSONAID = 0)) THEN
   BEGIN
      ERRORCODE = 1049;
      SUSPEND;
      EXIT;
   END
   
   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1050;
      SUSPEND;
      EXIT;
   END
   
   -- Tomar la lista de precios correspondiente a la persona.
   -- Null, 1..5. Para Precio1, ... Precio5
   SELECT CAST(COALESCE(LISTAPRECIOID, 1) AS CHAR(1))
   FROM PERSONA
   WHERE ID = :PERSONAID
   INTO :LISTAPRECIO;

   -- Tomar los precios y el LimitePrecio2 del Producto.
   SELECT PRECIO1, PRECIO2, PRECIO3, PRECIO4, PRECIO5, COALESCE(LIMITEPRECIO2, 0.00)
   FROM PRODUCTO
   WHERE ID = :PRODUCTOID
   INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5, :LIMITEPRECIO2;

   -- Para la lista de precio1
   IF (:LISTAPRECIO = '1') THEN
   BEGIN
      -- Si el limite de precio es null o 0.00
      IF (:LIMITEPRECIO2 < 0.001) THEN
      BEGIN
         PRECIO = :PRECIO1;
      END
      -- Si el Limite de precio es > 0
      ELSE
      BEGIN
         -- Tomar el PRECIO2
         IF (:CANTIDAD >= :LIMITEPRECIO2) THEN
            PRECIO = :PRECIO2;
         -- o el PRECIO1
         ELSE
            PRECIO = :PRECIO1;
      END
   END
   -- Tomar el precio correspondiente a LISTAPRECIO 2..5
   ELSE IF (:LISTAPRECIO = '2') THEN
      PRECIO = PRECIO2;
   ELSE IF (:LISTAPRECIO = '3') THEN
      PRECIO = PRECIO3;
   ELSE IF (:LISTAPRECIO = '4') THEN
      PRECIO = PRECIO4;
   ELSE IF (:LISTAPRECIO = '5') THEN
      PRECIO = PRECIO5;
   ELSE 
      PRECIO = PRECIO1;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END 
END;
