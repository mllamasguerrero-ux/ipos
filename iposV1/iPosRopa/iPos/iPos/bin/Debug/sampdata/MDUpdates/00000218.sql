CREATE OR ALTER PROCEDURE TRASPASO_DEVOLVER (
    COMPRADOCTOID D_FK)
RETURNS (
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE DOCTOID D_FK;
DECLARE VARIABLE DOCTO2ID D_FK;
DECLARE VARIABLE MOVTOID D_FK;
DECLARE VARIABLE ALMACENID D_FK;
DECLARE VARIABLE CAJAID D_FK;
DECLARE VARIABLE SUCURSALID D_FK;
DECLARE VARIABLE PRODUCTOID D_FK;
DECLARE VARIABLE LOTE D_LOTE;
DECLARE VARIABLE FECHAVENCE D_FECHAVENCE;
DECLARE VARIABLE CANTIDAD D_CANTIDAD;
DECLARE VARIABLE TIPODOCTOID D_FK;
DECLARE VARIABLE ESTATUSDOCTOID D_FK;
DECLARE VARIABLE FALTANTES INTEGER;
DECLARE VARIABLE REFERENCIA D_REFERENCIA;
DECLARE VARIABLE COSTO D_COSTO;
DECLARE VARIABLE SUCURSALTID D_FK;
DECLARE VARIABLE ALMACENTID D_FK;
DECLARE VARIABLE TIPODIFERENCIAINVENTARIOID D_FK;
BEGIN
   IF ((:COMPRADOCTOID IS NULL) OR (:COMPRADOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1064;
      SUSPEND;
      EXIT;
   END

   TIPODOCTOID = 42; -- Devolucion de Traspaso

   REFERENCIA = 'Dev. Traspaso';
  
   SELECT ALMACENID, SUCURSALID, CAJAID
   FROM DOCTO
   WHERE ID = :COMPRADOCTOID
   INTO :ALMACENID, :SUCURSALID, :CAJAID;

   -- Inicializara para primer registro de movto
   DOCTOID = 0;

   -- Agrega un MOVTO para cada registro con FALTANTES
   FOR SELECT
      M.PRODUCTOID,
      M.LOTE,
      M.FECHAVENCE,
      M.CANTIDADFALTANTE,
      M.COSTO,
      M.TIPODIFERENCIAINVENTARIOID
   FROM MOVTO M
   WHERE M.DOCTOID = :COMPRADOCTOID
      AND (M.CANTIDADFALTANTE > 0)
   INTO
      :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :COSTO, :TIPODIFERENCIAINVENTARIOID
   DO
   BEGIN
      COSTO = 0;

     SUCURSALTID = 0;
     ALMACENTID = 0;
    
      -- INSERT INTO TRAZA VALUES (5);
      SELECT DOCTOID, MOVTOID, ERRORCODE
      FROM MOVTO_INSERT(:DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, 0, 0, 1, 0,
         :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, :CANTIDAD, 0, 0, 0, 0,
         :REFERENCIA, '', :COSTO, :SUCURSALTID, :ALMACENTID, 'N', :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00)
      INTO :DOCTOID, :MOVTOID, :ERRORCODE;

      IF ((:ERRORCODE IS NOT NULL) OR (:ERRORCODE > 0)) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END
   END

   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;

   IF ((:ERRORCODE IS NOT NULL) OR (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
  
   ERRORCODE = 0;
   SUSPEND;
  
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1065;
      SUSPEND;
   END

   -- Marcar los faltantes como ya generados.
END;


