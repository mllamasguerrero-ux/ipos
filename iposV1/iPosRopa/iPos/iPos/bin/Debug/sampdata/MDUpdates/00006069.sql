create or alter procedure CORTE_ABRIR (
    FECHACORTE D_FECHA,
    SUCURSALID D_FK,
    CAJEROID D_FK,
    SALDOINICIAL D_IMPORTE,
    TIPOCORTEID D_FK)
returns (
    CORTEID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCN;
declare variable REABRIRCORTE D_BOOLCN;
declare variable FONDODINAMICO D_IMPORTE;
BEGIN
   SELECT REABRIRCORTES
   FROM PARAMETRO
   INTO :REABRIRCORTE;

   IF (:REABRIRCORTE = 'N') THEN
   BEGIN
      SELECT ID
      FROM CORTE
      WHERE FECHACORTE = :FECHACORTE
        AND SUCURSALID = :SUCURSALID 
        AND CAJEROID   = :CAJEROID
      INTO :CORTEID;
   
      IF ((:CORTEID IS NOT NULL)) THEN
      BEGIN
         ERRORCODE = 1017;
         SUSPEND;
         EXIT;
      END
   END

   SELECT ID, ACTIVO
   FROM CORTE
   WHERE FECHACORTE = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND CAJEROID   = :CAJEROID
   INTO :CORTEID, :ACTIVO;

   IF ((:CORTEID IS NOT NULL) AND (:ACTIVO = 'S')) THEN
   BEGIN
      ERRORCODE = 1017;
      SUSPEND;
      EXIT;
   END

   TIPOCORTEID = COALESCE(:TIPOCORTEID,1);


   IF ((:CORTEID IS NOT NULL) AND (:ACTIVO = 'N')) THEN
   BEGIN
      UPDATE CORTE
      SET ACTIVO = 'S'
      WHERE ID = :CORTEID;
   END
   ELSE
   BEGIN


       SELECT FONDODINAMICO FROM CORTE_ULTIMOFONDODINAMICO (:CAJEROID) INTO :FONDODINAMICO;


      INSERT INTO CORTE (
         FECHACORTE,
         SUCURSALID,
         CAJEROID,
         INICIA,
         SALDOINICIAL,
         TIPOCORTEID,
         FONDODINAMICO
      ) VALUES (
         :FECHACORTE,
         :SUCURSALID,
         :CAJEROID,
         CURRENT_TIMESTAMP,
         :SALDOINICIAL,
         :TIPOCORTEID,
         :FONDODINAMICO
      ) RETURNING ID INTO :CORTEID;
   END
   
   UPDATE PERSONA
   SET
      CORTEID = :CORTEID
   WHERE ID = :CAJEROID;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1019;
      SUSPEND;
   END 
END