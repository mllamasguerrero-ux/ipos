create or alter procedure INVENTARIO_INICIAL_AGREGAR (
    ALMACENID D_FK,
    PRODUCTOCLAVE D_CLAVE,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    CANTIDAD D_CANTIDAD,
    PRECIO D_PRECIO,
    COSTO D_COSTO,
    PEDIMENTO D_PEDIMENTO,
    ADUANA D_ADUANA,
    FECHAIMPO D_FECHA,
    TIPOCAMBIOIMPO D_PRECIO)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable INVENTARIOID type of D_FK;
declare variable PRODUCTOID type of D_FK;
declare variable LOTEIMPORTADO D_FK;  
declare variable SATADUANAID D_FK;
declare variable SAT_DESCRIPCION D_STDTEXT_LARGE;
BEGIN

   

      SELECT ID
      FROM PRODUCTO
      WHERE CLAVE = :PRODUCTOCLAVE
      INTO :PRODUCTOID;


   if( :PRODUCTOID IS NULL) then
   BEGIN
      ERRORCODE = 1069;
      SUSPEND;
      EXIT;
   END

   LOTEIMPORTADO = NULL;

   IF(COALESCE(:PEDIMENTO,'') <> '') THEN
   BEGIN
        
        SELECT ID, SAT_DESCRIPCION  FROM SAT_ADUANA
        WHERE SAT_CLAVEADUANA = :ADUANA INTO :SATADUANAID, :SAT_DESCRIPCION;

       
        SELECT ID FROM LOTESIMPORTADOS
        WHERE COALESCE(PEDIMENTO,'') = COALESCE(:PEDIMENTO,'')
        AND COALESCE(FECHAIMPORTACION, CURRENT_DATE) = COALESCE(:FECHAIMPO, CURRENT_DATE)
        AND ( (:SATADUANAID IS NOT NULL AND COALESCE(SATADUANAID,0) = COALESCE(:SATADUANAID, 0) ) OR 
        ( :SATADUANAID IS NULL AND :ADUANA IS NOT NULL AND COALESCE(ADUANA,'') = COALESCE(:ADUANA,'')))
        AND COALESCE(TIPOCAMBIO,0.0) = COALESCE(:TIPOCAMBIOIMPO ,0.0)
        INTO :LOTEIMPORTADO;

        IF(COALESCE(:LOTEIMPORTADO ,0) = 0 ) THEN
        BEGIN

            INSERT INTO LOTESIMPORTADOS
            (PEDIMENTO, FECHAIMPORTACION,ADUANA, TIPOCAMBIO, SATADUANAID)
            VALUES
            (:PEDIMENTO, :FECHAIMPO, CASE WHEN :SATADUANAID IS NULL THEN :ADUANA ELSE :SAT_DESCRIPCION END, :TIPOCAMBIOIMPO,:SATADUANAID)
            RETURNING ID INTO :LOTEIMPORTADO;
        END
   END


   if (:LOTE IS NULL) then
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
        AND ORIGENFISCALID = 2
        AND COALESCE(LOTEIMPORTADO ,0) = COALESCE(:loteimportado, 0)
      INTO :INVENTARIOID;
   END
   ELSE
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
        AND LOTE = :LOTE
        AND FECHAVENCE = :FECHAVENCE 
        AND ORIGENFISCALID = 2  
        AND COALESCE(LOTEIMPORTADO ,0) = COALESCE(:loteimportado, 0)

      INTO :INVENTARIOID;
   END


  

   IF (:INVENTARIOID IS NULL) THEN
   BEGIN
      INSERT INTO INVENTARIO
         (ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD,CANTIDADINICIAL, FECHAINICIAL,ORIGENFISCALID, LOTEIMPORTADO)
      VALUES
         (:ALMACENID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :CANTIDAD, CURRENT_DATE, 2, :LOTEIMPORTADO)
      RETURNING ID
         INTO :INVENTARIOID;
   END
   ELSE
   BEGIN
      if (:LOTE IS NULL) then
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD =  :CANTIDAD,
            CANTIDADINICIAL = :CANTIDAD,
            FECHAINICIAL = CURRENT_DATE ,
            ORIGENFISCALID = 2
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
        AND COALESCE(LOTEIMPORTADO ,0) = COALESCE(:loteimportado, 0)
         RETURNING ID
            INTO :INVENTARIOID;
      END
      ELSE
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD =  :CANTIDAD,
            CANTIDADINICIAL = :CANTIDAD ,
            FECHAINICIAL = CURRENT_DATE,
            ORIGENFISCALID = 2 
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
           AND LOTE = :LOTE
           AND FECHAVENCE = :FECHAVENCE
        AND COALESCE(LOTEIMPORTADO ,0) = COALESCE(:loteimportado, 0)
         RETURNING ID
            INTO :INVENTARIOID;
      END
   END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1016;
      SUSPEND;
   END 
END