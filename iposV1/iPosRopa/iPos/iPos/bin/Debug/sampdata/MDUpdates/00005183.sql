create or alter procedure SUSTITUCION_CREAR (
    DOCTOCANCELARID D_FK,
    VENDEDORID D_FK)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable NOTASCREDITOAPLICADAS D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable SURTIBLE D_BOOLCS;
declare variable MAXSURTIBLE D_CANTIDAD;
declare variable CANTIDADAPLICAR D_CANTIDAD;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable SUBTIPODOCTOCANCELARID D_FK;
declare variable LOTEIMPORTADO D_FK;
declare variable CUENTAPAGOSTIMBRADOS integer;
BEGIN


           
   SELECT HAYCORTEACTIVO,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END


   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID , SUBTIPODOCTOID
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ESTATUSDOCTOID, :TIPODOCTOCANCELARID, :SUBTIPODOCTOCANCELARID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   SELECT ERRORCODE FROM VENTA_CANCEL(:DOCTOCANCELARID, :VENDEDORID)
   INTO :ERRORCODE;

   
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END



    SELECT COUNT(*) FROM DOCTOPAGO
    WHERE DOCTOID = :DOCTOCANCELARID
        AND COALESCE(RECIBOELECTRONICOID,0) > 0
    INTO :CUENTAPAGOSTIMBRADOS;

    IF(COALESCE(:CUENTAPAGOSTIMBRADOS,0) > 0) THEN
    BEGIN
        ERRORCODE = 5027;
        SUSPEND;
        EXIT;
    END



   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID;

   REFERENCIA = CAST('SUSTITUIDO DEL DOCTO ' || COALESCE(SERIE, '' ) || '-' || COALESCE(:FOLIO, '') AS VARCHAR(31));

   REFERENCIAS = NULL;


    TIPODOCTOID = :TIPODOCTOCANCELARID;

   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT,ESAPARTADO,DOCTOREFID, IEPS, IMPUESTO,
    SUBTIPODOCTOID, DOCTOASUSTITUIRID )
   SELECT
    ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
    PERSONAID, CAJEROID, :VENDEDORID, CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, null, null,
    PLAZO, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
    CAJAID, :REFERENCIA, :REFERENCIAS, SUCURSALTID, ALMACENTID, 'N' , ESFACTURAELECTRONICA ,
    NULL,NULL,NULL, NULL,NULL , ESAPARTADO,null, 0.00, 0.00,
    26  , :DOCTOCANCELARID
    FROM DOCTO WHERE ID = :DOCTOCANCELARID
   RETURNING ID INTO :DOCTOID;


   -- Agrega los MOVTO.
   FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, 
      TIPODIFERENCIAINVENTARIOID  , CANTIDADDEFACTURA, CANTIDADDEREMISION, CANTIDADDEINDEFINIDO , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3,
      SURTIBLE, MAXSURTIBLE , LOTEIMPORTADO
   FROM MOVTO
   WHERE DOCTOID = :DOCTOCANCELARID
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3,
      :SURTIBLE, :MAXSURTIBLE, :LOTEIMPORTADO
   DO
   BEGIN



      SELECT ERRORCODE,MOVTOID
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, :PRECIO, 0,
         :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALTID, :ALMACENTID, 'N',
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,NULL,NULL,NULL,NULL,NULL, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, NULL, :LOTEIMPORTADO
      ) INTO :ERRORCODE,:NEWMOVTOID;
            
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END


   END


   INSERT INTO DOCTOPAGO ( DOCTOID,  FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESPAGOINICIAL, CORTETRANSCANCELADA,
                          RECIBOELECTRONICOID)
                   SELECT  :DOCTOID, P.FORMAPAGOID, P.FECHA, P.FECHAHORA, P.CORTEID, P.IMPORTE, P.IMPORTERECIBIDO, P.IMPORTECAMBIO, P.TIPOPAGOID, P.DOCTOSALIDAID, P.ESPAGOINICIAL, P.CORTETRANSCANCELADA,
                        CASE WHEN RECIBOELECTRONICOID < 0 THEN RECIBOELECTRONICOID ELSE NULL END
                   FROM DOCTOPAGO P  
                    left join DOCTO D ON D.id = P.DOCTOSALIDAID
                   WHERE P.DOCTOID = :DOCTOCANCELARID AND COALESCE(P.REVERTIDO,'N') = 'N'
                   AND P.tipopagoid = 1 AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16,20,21);



   
   -- Completa el documento.
   SELECT ERRORCODE
   FROM DOCTO_SAVE (:DOCTOID)
   INTO :ERRORCODE;
     
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END

   UPDATE DOCTO SET DOCTOSUSTITUTOID = :doctoid
   WHERE ID = :DOCTOCANCELARID;
     


   ERRORCODE = 0;
   SUSPEND;
      /*
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END  */
END