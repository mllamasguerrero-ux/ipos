create or alter procedure UPDATE_PRECIORECEPCIONTRASLADO (
    PRODUCTOID D_FK,
    TIPODOCTOID D_FK,
    SUCURSALID D_FK,
    SUCURSALTID D_FK,
    MOVTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIORECEPCIONTRASLADO D_FK;
declare variable TIPOPRECIORECEPCIONTRASLADO D_FK;
declare variable SUPERLISTAPRECIOID D_FK;
declare variable MANEJASUPERLISTAPRECIO D_BOOLCN;
declare variable CLAVECLIENTESUCURSAL D_FK;
declare variable PERSONASUCURSALID D_FK;
BEGIN



      CLAVECLIENTESUCURSAL = NULL;
      SUPERLISTAPRECIOID = 1;
      SELECT SUCURSAL.clienteclave FROM SUCURSAL WHERE ID = :SUCURSALTID AND SUCURSAL.esfranquicia = 'S'
      INTO :CLAVECLIENTESUCURSAL;

      IF(COALESCE(CLAVECLIENTESUCURSAL,'') <> '') THEN
      BEGIN
                                   
         SELECT id from persona where clave = :CLAVECLIENTESUCURSAL AND TIPOPERSONAID = 50 into :personasucursalid;
         
         IF(:PERSONASUCURSALID IS NOT NULL) THEN
         BEGIN
            SELECT MANEJASUPERLISTAPRECIO FROM PARAMETRO INTO :MANEJASUPERLISTAPRECIO;
            SELECT SUPERLISTAPRECIOID FROM persona WHERE ID = :PERSONASUCURSALID INTO :SUPERLISTAPRECIOID;

            IF(COALESCE(:MANEJASUPERLISTAPRECIO ,'N') = 'N') THEN
            BEGIN
                SUPERLISTAPRECIOID = 1;
            END
        END
      END


   -- Calculo del precio real y precio visible
   select coalesce(preciorecepciontraslado, (case when :tipodoctoid = 31 then 7  else 1 end))
    from SUCURSAL where id = :SUCURSALTID into :TIPOPRECIORECEPCIONTRASLADO;

   if(:TIPOPRECIORECEPCIONTRASLADO = 1) then
   begin
     SELECT COALESCE(COSTOREPOSICION,COALESCE(COSTOPROMEDIO,COALESCE(COSTOULTIMO,0))) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 2) then
   begin
      SELECT COALESCE(COSTOULTIMO,COALESCE(COSTOPROMEDIO,0)) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 3) then
   begin    
      SELECT COALESCE(COSTOPROMEDIO,COALESCE(COSTOULTIMO,0)) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 4) then
   begin     
      SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO1,0) ELSE COALESCE(PRECIO1,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 5) then
   begin                  
      SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO2,0) ELSE COALESCE(PRECIO2,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 6) then
   begin       
      SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO3,0) ELSE COALESCE(PRECIO3,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 7) then
   begin          
      SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO4,0) ELSE COALESCE(PRECIO4,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end
   else if(:TIPOPRECIORECEPCIONTRASLADO = 8) then
   begin   
      SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO5,0) ELSE COALESCE(PRECIO5,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIORECEPCIONTRASLADO;
   end



   UPDATE MOVTO SET  PRECIOVISIBLETRASLADO = :PRECIORECEPCIONTRASLADO WHERE ID = :MOVTOID ;


   ERRORCODE = 0;
   SUSPEND;

END