CREATE OR ALTER PROCEDURE CALC_COMISIONES (
   FECHAINI DATE,
   FECHAFIN DATE
)
RETURNS (
   COMISIONISTA VARCHAR(64),
   TURNOCLAVE VARCHAR(32),
   COMISION NUMERIC(18,4)
)
AS
DECLARE VARIABLE INGRESO NUMERIC(18,4);
DECLARE VARIABLE COMISIONMEDICO NUMERIC(18,4);
DECLARE VARIABLE COMISIONDEPENDIENTE NUMERIC(18,4);
BEGIN
   -- Totales para los medicos
   SELECT COMISIONMEDICO, COMISIONDEPENDIENTE
   FROM PARAMETRO
   INTO :COMISIONMEDICO, :COMISIONDEPENDIENTE;
   
   COMISIONISTA = 'MEDICO';
   
   FOR
      SELECT T.ID || ' - ' || T.CLAVE AS TURNOCLAVE, SUM(M.TOTAL) AS SUMTOTAL
      FROM MOVTO M
        LEFT JOIN PRODUCTO P
          ON P.ID = M.PRODUCTOID
        LEFT JOIN DOCTO D
          ON D.ID = M.DOCTOID
        LEFT JOIN TURNO T
          ON T.ID = D.TURNOID
      WHERE D.TIPODOCTOID = 21
        AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
        AND P.LINEAID = 1
        AND D.ID IN (
            SELECT DISTINCT M.DOCTOID
            FROM MOVTO M
              LEFT JOIN DOCTO D
                ON D.ID = M.DOCTOID
              LEFT JOIN PRODUCTO P
                ON P.ID = M.PRODUCTOID
            WHERE D.TIPODOCTOID = 21
              AND  P.LINEAID = 4
              AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN)
      GROUP BY TURNOCLAVE
      ORDER BY TURNOCLAVE
      INTO :TURNOCLAVE, :INGRESO DO
   BEGIN
      COMISION = :INGRESO * :COMISIONMEDICO / 100.00;
      SUSPEND;
   END

   -- Totales para los encargados
   COMISIONISTA = 'ENCARGADO';
   
   FOR
      SELECT T.ID || ' - ' || T.CLAVE AS TURNOCLAVE, SUM(M.TOTAL) AS SUMTOTAL
      FROM MOVTO M
        LEFT JOIN PRODUCTO P
          ON P.ID = M.PRODUCTOID
        LEFT JOIN DOCTO D
          ON D.ID = M.DOCTOID
        LEFT JOIN TURNO T
          ON T.ID = D.TURNOID
      WHERE D.TIPODOCTOID = 21
        AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
        AND P.LINEAID = 1
        AND D.ID NOT IN (
            SELECT DISTINCT M.DOCTOID
            FROM MOVTO M
              LEFT JOIN DOCTO D
                ON D.ID = M.DOCTOID
              LEFT JOIN PRODUCTO P
                ON P.ID = M.PRODUCTOID
            WHERE D.TIPODOCTOID = 21
              AND  P.LINEAID = 4
              AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN)
      GROUP BY TURNOCLAVE
      ORDER BY TURNOCLAVE
      INTO :TURNOCLAVE, :INGRESO DO
   BEGIN
      COMISION = :INGRESO * :COMISIONMEDICO / 100.00;
      SUSPEND;
   END

END;