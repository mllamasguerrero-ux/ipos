CREATE OR ALTER trigger doctopago_ai2 for doctopago
active after insert position 2
AS
declare variable ABONO d_precio;
declare variable TIPODOCTOIDENTRADA d_fk;
declare variable TIPODOCTOIDSALIDA d_fk;
declare variable ABONA d_boolcn;
declare variable AFECTASALDOPERSONA D_BOOLCN ;
declare variable SENTIDO d_precio;
declare variable PERSONAIDENTRADA D_FK;
declare variable PERSONAIDSALIDA D_FK;
declare variable DOCTOIDBUFFER D_FK;
declare variable SALDOBUFFER D_PRECIO;   
declare variable RESTANTEBUFFER D_PRECIO;
declare variable AFECTASALDOAPARTADOS D_BOOLCN;
BEGIN


   IF(NEW.formapagoid IN (18,19)) THEN
   BEGIN
    EXIT;
   END

IF(NEW.ESAPARTADO = 'S' )   THEN
BEGIN

   SELECT tipodoctoid from docto where  id = NEW.DOCTOID  INTO :TIPODOCTOIDENTRADA;
   SELECT tipodoctoid from docto where  id = NEW.DOCTOSALIDAID  INTO :TIPODOCTOIDSALIDA;

   
   if(:TIPODOCTOIDENTRADA  in (11,12,13,16,18) or :TIPODOCTOIDSALIDA in (11,12,13,16,18)) then
   begin
     exit;
   end


   SELECT abona, afectasaldopersona, afectasaldoapartados from formapago where id = new.formapagoid
   into :ABONA,:AFECTASALDOPERSONA,:AFECTASALDOAPARTADOS;



    SELECT personaapartadoid FROM DOCTO WHERE ID = NEW.DOCTOID INTO :PERSONAIDENTRADA;
    SELECT personaapartadoid FROM DOCTO WHERE ID = NEW.DOCTOSALIDAID INTO :PERSONAIDSALIDA;





   IF(:ABONA = 'S') then
   begin
       --if (:TIPODOCTOIDENTRADA IN (25) AND (NEW.formapagoid in (6,7,8,9) or NEW.tipopagoid = 1 ) ) THEN
       IF(NEW.DOCTOID is NOT NULL) THEN
       BEGIN


          select coalesce(sum(p.importe *
          (CASE WHEN ((TIPOPAGOID = 1 AND FORMAPAGOID IN (1,2,3,4,5,6,9,14,15,16,17,20,21)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (7/*,8*/)))  THEN 1
                when ((TIPOPAGOID = 1 AND FORMAPAGOID IN (7/*,8*/)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (6,8/*9*/))) THEN -1
                ELSE 0 END)
          ),0) from doctopago p inner join formapago f on p.formapagoid = f.id
          where p.doctoid = new.doctoid and f.abona = 'S'  into :abono;

          UPDATE DOCTO SET ABONO = :ABONO , SALDO = CARGO - :ABONO WHERE ID = NEW.DOCTOID;
       END


       
       --if (:TIPODOCTOIDSALIDA in (22,26) AND (NEW.formapagoid  in (6,7,8,9) or NEW.tipopagoid = 2 )) THEN
       IF(NEW.DOCTOSALIDAID is NOT NULL) THEN
       BEGIN
          select coalesce(sum(p.importe *
           (CASE WHEN ((TIPOPAGOID = 2 AND FORMAPAGOID IN (1,2,3,4,5,7/*,8*/,14,15,16,17,20,21)) or (TIPOPAGOID = 1 AND FORMAPAGOID IN (6,9)))  THEN 1
                when ((TIPOPAGOID = 1 AND FORMAPAGOID IN (7/*,8*/)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (6,8/*9*/)))  THEN -1
                ELSE 0 END)
          ),0) from doctopago p inner join formapago f on p.formapagoid = f.id
          where p.doctosalidaid = new.doctosalidaid and f.abona = 'S' into :abono;
          UPDATE DOCTO SET ABONO = :ABONO , SALDO = CARGO - :ABONO WHERE ID = NEW.DOCTOSALIDAID;
       END

    END

     /*IF(:afectasaldopersona  = 'S') THEN
     BEGIN

       IF(new.tipopagoid = 1) then
       begin
            SENTIDO = 1.00;
       end
       ELSE
       BEGIN
            SENTIDO = -1.00;
       END
      if (:TIPODOCTOIDSALIDA = 22  AND ((NEW.TIPOPAGOID = 1 AND NEW.FORMAPAGOID = 9)  or ( NEW.TIPOPAGOID = 2 AND NEW.FORMAPAGOID = 8 ) ) ) then
        BEGIN
           UPDATE PERSONA SET SALDO = coalesce(SALDO,0) + (NEW.IMPORTE * :SENTIDO * -1) WHERE ID = :PERSONAIDSALIDA;
        END

     END    */


       IF(:afectasaldoapartados  = 'S') THEN
     BEGIN

       IF(new.tipopagoid = 1) then
       begin
            SENTIDO = 1.00;
       end
       ELSE  IF(new.tipopagoid = 2) THEN
       BEGIN
            SENTIDO = -1.00;
       END
       else
       begin
          SENTIDO = 0;
       end

      if (:TIPODOCTOIDENTRADA = 25  AND NEW.TIPOPAGOID = 1) then
        BEGIN
           UPDATE PERSONAAPARTADO SET SALDOAPARTADO = coalesce(SALDOAPARTADO,0) + (NEW.IMPORTE * :SENTIDO) WHERE ID = :PERSONAIDENTRADA;
        END   

      if (:TIPODOCTOIDSALIDA in (26,22)  AND NEW.TIPOPAGOID = 2) then
        BEGIN
           UPDATE PERSONAAPARTADO SET SALDOAPARTADO = coalesce(SALDOAPARTADO,0) + (NEW.IMPORTE * :SENTIDO) WHERE ID = :PERSONAIDSALIDA;
        END

     END


     RESTANTEBUFFER =   NEW.IMPORTE;

    /* IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 25 AND NEW.tipoaplicacioncreditoid = 2) THEN
     BEGIN
        FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.tipodoctoid = 26 AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDENTRADA and D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

           IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
           BEGIN
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESAPARTADO)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTOIDBUFFER, NEW.ESAPARTADO);
               RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
           END
           ELSE
           BEGIN
                  
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (NEW.DOCTOID, 7, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 2, :DOCTOIDBUFFER, NEW.ESAPARTADO);
               RESTANTEBUFFER = 0;
               BREAK;
           END

        END

         FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.tipodoctoid = 22 AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDENTRADA and D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

           IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
           BEGIN
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESAPARTADO)
                             VALUES (NEW.DOCTOID, 9, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, :DOCTOIDBUFFER, NEW.ESAPARTADO);
               RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
           END
           ELSE
           BEGIN
                  
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (NEW.DOCTOID, 9, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 1, :DOCTOIDBUFFER, NEW.ESAPARTADO);
               RESTANTEBUFFER = 0;
               BREAK;
           END

        END




     END  */


     
     /*IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 1 AND :TIPODOCTOIDENTRADA = 25 AND NEW.tipoaplicacioncreditoid = 3) THEN
     BEGIN
     
      INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 7, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 2, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;

       DELETE FROM DOCTOPAGO  WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 11;


       
      INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 9, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 1, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 13;

       DELETE FROM DOCTOPAGO  WHERE DOCTOID = NEW.doctoid AND FORMAPAGOID = 13;

     END    */


                     /*
     IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 2 AND :TIPODOCTOIDSALIDA = 26 AND :RESTANTEBUFFER > 0 AND NEW.tipoaplicacioncreditoid = 2) THEN
     BEGIN
            FOR SELECT P.doctoid, P.IMPORTE
            FROM DOCTOPAGO P
            WHERE P.DOCTOID = NEW.doctoid AND P.tipopagoid = 1 AND P.FORMAPAGOID = 7
            INTO
            :DOCTOIDBUFFER, :SALDOBUFFER
            DO
            BEGIN

              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES ( NEW.DOCTOID, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, :DOCTOIDBUFFER, NEW.ESAPARTADO);

            END
            
            FOR SELECT P.doctosalidaid, P.IMPORTE
            FROM DOCTOPAGO P
            WHERE P.DOCTOID = NEW.doctoid AND P.tipopagoid = 1 AND P.FORMAPAGOID = 9
            INTO
            :DOCTOIDBUFFER, :SALDOBUFFER
            DO
            BEGIN

              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES ( NEW.DOCTOID, 8, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTOIDBUFFER, NEW.ESAPARTADO);

            END



            
            SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE  D.SALDO > 0 AND D.ID = NEW.doctoid
            INTO   :DOCTOIDBUFFER, :SALDOBUFFER;


                   
            IF(:DOCTOIDBUFFER IS NOT NULL AND COALESCE(:SALDOBUFFER,0)>0) THEN
            BEGIN
                      
              IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
              BEGIN
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (NEW.DOCTOID, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, NEW.DOCTOSALIDAID, NEW.ESAPARTADO);
                  RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
               END
               ELSE
               BEGIN
                    
                 INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (NEW.DOCTOID, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 1, NEW.DOCTOSALIDAID, NEW.ESAPARTADO);
                  RESTANTEBUFFER = 0;
               END
             END


             
       FOR SELECT D.ID, D.SALDO
            FROM DOCTO D
            WHERE D.tipodoctoid = 25 AND D.SALDO > 0 AND D.PERSONAID = :PERSONAIDENTRADA and D.estatusdoctoid = 1
        INTO
        :DOCTOIDBUFFER, :SALDOBUFFER
        DO
        BEGIN

           IF(:RESTANTEBUFFER > :SALDOBUFFER) THEN
           BEGIN
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :SALDOBUFFER,:SALDOBUFFER, 0, 1, NEW.DOCTOSALIDAID , NEW.ESAPARTADO);
               RESTANTEBUFFER = :RESTANTEBUFFER - :SALDOBUFFER;
           END
           ELSE
           BEGIN
                  
              INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID,ESAPARTADO)
                             VALUES (:DOCTOIDBUFFER, 6, NEW.FECHA, NEW.FECHAHORA,NEW.CORTEID, :RESTANTEBUFFER,:RESTANTEBUFFER, 0, 1, NEW.DOCTOSALIDAID, NEW.ESAPARTADO);
               RESTANTEBUFFER = 0;
               BREAK;
           END

        END

     END
            */

     
     /*IF(NEW.FORMAPAGOID = 4 AND NEW.TIPOPAGOID = 2 AND :TIPODOCTOIDSALIDA = 26 AND  NEW.tipoaplicacioncreditoid = 3) THEN
     BEGIN
        
             INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 6, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 1, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 10;

             DELETE FROM DOCTOPAGO  WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 10;

             
             INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID)
             SELECT   DOCTOID, 8, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, 2, DOCTOSALIDAID  FROM DOCTOPAGO
             WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 12;

             DELETE FROM DOCTOPAGO  WHERE DOCTOSALIDAID = NEW.doctosalidaid AND FORMAPAGOID = 12;
     END    */





 END
END