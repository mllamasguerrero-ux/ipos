create or alter procedure CARTAPORTE_XML (
    DOCTOID D_FK)
returns (
    ID D_FK,
    TIPOLINEA D_NOMBRE_NULL,
    PADRELINEA integer,
    ORDENLINEA integer,
    SUBORDEN integer,
    TRANSPINTERNAC D_STDTEXT_MEDIUM,
    ENTRADASALIDAMERC D_STDTEXT_MEDIUM,
    PAISORIGENDESTINO D_STDTEXT_MEDIUM,
    VIAENTRADASALIDA D_STDTEXT_MEDIUM,
    TOTALDISTREC D_STDTEXT_MEDIUM,
    TIPOUBICACION D_STDTEXT_MEDIUM,
    IDUBICACION D_STDTEXT_MEDIUM,
    RFCREMITENTEDESTINATARIO D_STDTEXT_MEDIUM,
    NOMBREREMITENTEDESTINATARIO D_STDTEXT_MEDIUM,
    NUMREGIDTRIB D_STDTEXT_MEDIUM,
    RESIDENCIAFISCAL D_STDTEXT_MEDIUM,
    NUMESTACION D_STDTEXT_MEDIUM,
    NOMBREESTACION D_STDTEXT_MEDIUM,
    NAVEGACIONTRAFICO D_STDTEXT_MEDIUM,
    FECHAHORASALIDALLEGADA D_STDTEXT_MEDIUM,
    TIPOESTACION D_STDTEXT_MEDIUM,
    DISTANCIARECORRIDA D_STDTEXT_MEDIUM,
    CALLE D_STDTEXT_MEDIUM,
    NUMEROEXTERIOR D_STDTEXT_MEDIUM,
    NUMEROINTERIOR D_STDTEXT_MEDIUM,
    COLONIA D_STDTEXT_MEDIUM,
    LOCALIDAD D_STDTEXT_MEDIUM,
    REFERENCIA D_STDTEXT_MEDIUM,
    MUNICIPIO D_STDTEXT_MEDIUM,
    ESTADO D_STDTEXT_MEDIUM,
    PAIS D_STDTEXT_MEDIUM,
    CODIGOPOSTAL D_STDTEXT_MEDIUM,
    PESOBRUTOTOTAL D_STDTEXT_MEDIUM,
    UNIDADPESO D_STDTEXT_MEDIUM,
    PESONETOTOTAL D_STDTEXT_MEDIUM,
    NUMTOTALMERCANCIAS D_STDTEXT_MEDIUM,
    CARGOPORTASACION D_STDTEXT_MEDIUM,
    BIENESTRANSP D_STDTEXT_MEDIUM,
    CLAVESTCC D_STDTEXT_MEDIUM,
    DESCRIPCION D_STDTEXT_MEDIUM,
    CANTIDAD D_STDTEXT_MEDIUM,
    CLAVEUNIDAD D_STDTEXT_MEDIUM,
    UNIDAD D_STDTEXT_MEDIUM,
    DIMENSIONES D_STDTEXT_MEDIUM,
    MATERIALPELIGROSO D_STDTEXT_MEDIUM,
    CVEMATERIALPELIGROSO D_STDTEXT_MEDIUM,
    EMBALAJE D_STDTEXT_MEDIUM,
    DESCRIPEMBALAJE D_STDTEXT_MEDIUM,
    PESOENKG D_STDTEXT_MEDIUM,
    VALORMERCANCIA D_STDTEXT_MEDIUM,
    MONEDA D_STDTEXT_MEDIUM,
    FRACCIONARANCELARIA D_STDTEXT_MEDIUM,
    UUIDCOMERCIOEXT D_STDTEXT_MEDIUM,
    UNIDADPESOMERC D_STDTEXT_MEDIUM,
    PESOBRUTO D_STDTEXT_MEDIUM,
    PESONETO D_STDTEXT_MEDIUM,
    PESOTARA D_STDTEXT_MEDIUM,
    NUMPIEZAS D_STDTEXT_MEDIUM,
    IDORIGEN D_STDTEXT_MEDIUM,
    IDDESTINO D_STDTEXT_MEDIUM,
    CVESTRANSPORTE D_STDTEXT_MEDIUM,
    TIPOFIGURA D_STDTEXT_MEDIUM,
    RFCFIGURA D_STDTEXT_MEDIUM,
    NUMLICENCIA D_STDTEXT_MEDIUM,
    NOMBREFIGURA D_STDTEXT_MEDIUM,
    NUMREGIDTRIBFIGURA D_STDTEXT_MEDIUM,
    RESIDENCIAFISCALFIGURA D_STDTEXT_MEDIUM,
    PARTETRANSPORTE D_STDTEXT_MEDIUM,
    PERMSCT D_STDTEXT_MEDIUM,
    NUMPERMISOSCT D_STDTEXT_MEDIUM,
    CONFIGVEHICULAR D_STDTEXT_MEDIUM,
    PLACAVM D_STDTEXT_MEDIUM,
    ANIOMODELOVM D_STDTEXT_MEDIUM,
    ASEGURARESPCIVIL D_STDTEXT_MEDIUM,
    POLIZARESPCIVIL D_STDTEXT_MEDIUM,
    ASEGURAMEDAMBIENTE D_STDTEXT_MEDIUM,
    POLIZAMEDAMBIENTE D_STDTEXT_MEDIUM,
    ASEGURACARGA D_STDTEXT_MEDIUM,
    POLIZACARGA D_STDTEXT_MEDIUM,
    PRIMASEGURO D_STDTEXT_MEDIUM,
    SUBTIPOREM1 D_STDTEXT_MEDIUM,
    PLACA1 D_STDTEXT_MEDIUM,
    SUBTIPOREM2 D_STDTEXT_MEDIUM,
    PLACA2 D_STDTEXT_MEDIUM,
    CLAVEPRODUCTO D_STDTEXT_MEDIUM)
as
declare variable PERSONAID D_FK;
declare variable SUCURSALID D_FK;
declare variable ORIGENPERSONAID D_FK;
declare variable DOCTOFOLIO D_DOCTOFOLIO;
declare variable ENCARGADOGUIAID D_FK;
declare variable DUENIOID D_FK;
declare variable CONTIENEMATERIALPELIGROSO D_BOOLCN;
declare variable SUBTIPODOCTOID D_FK;
declare variable ENTREGACALLESUCURSALDEST D_STDTEXT_MEDIUM;
declare variable PREGUNTARDATOSENTREGA D_BOOLCN;
declare variable PERSONAENTREGACALLE D_STDTEXT_MEDIUM;
declare variable ENTREGACALLESUCURSALORIGEN D_STDTEXT_MEDIUM;
declare variable USARDATOSENTREGA varchar(1);
BEGIN

   ID = 1;
   TIPOLINEA = 'COMPROBANTE';

   CONTIENEMATERIALPELIGROSO = 'N';
   USARDATOSENTREGA = 'N';


                        
   SELECT
        DOCTO.PERSONAID,
        DOCTO.FOLIO , PERSONA.ENTREGACALLE, DOCTO.SUBTIPODOCTOID  , SUCDEST.ENTREGACALLE ,
        DOCTO.USARDATOSENTREGA
    FROM DOCTO
    LEFT JOIN PERSONA ON PERSONA.ID = DOCTO.PERSONAID
    LEFT JOIN SUCURSAL SUCDEST ON DOCTO.SUCURSALTID = SUCDEST.ID
    WHERE DOCTO.ID = :DOCTOID
    INTO      
       :PERSONAID,
       :DOCTOFOLIO, :PERSONAENTREGACALLE, :SUBTIPODOCTOID, :ENTREGACALLESUCURSALDEST,
       :USARDATOSENTREGA ;


   
  SELECT PARAMETRO.SUCURSALID, PERSONA.ID ,PARAMETRO.PREGUNTARDATOSENTREGA , SUCURSAL.entregacalle
  FROM PARAMETRO
  LEFT JOIN SUCURSAL ON PARAMETRO.SUCURSALID = SUCURSAL.ID  
  LEFT JOIN PERSONA ON PERSONA.CLAVE = SUCURSAL.CLIENTECLAVE  and PERSONA.TIPOPERSONAID = 50
  INTO :SUCURSALID, :ORIGENPERSONAID, :PREGUNTARDATOSENTREGA, :ENTREGACALLESUCURSALORIGEN;


  IF(COALESCE(:ENTREGACALLESUCURSALORIGEN ,'') <> '' ) THEN
  BEGIN
  
    SELECT
        'Origen' TIPOUBICACION ,
        'OR' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDUBICACION  ,
        PARAMETRO.RFC RFCREMITENTEDESTINATARIO,
        PARAMETRO.FISCALNOMBRE NOMBREREMITENTEDESTINATARIO ,
        '' NUMREGIDTRIB  ,
        '' RESIDENCIAFISCAL ,
        '' NUMESTACION  ,
        '' NOMBREESTACION  ,
        '' NAVEGACIONTRAFICO  ,

        EXTRACT(YEAR FROM GUIA.FECHA) || '-'
        || SUBSTRING(100 + EXTRACT(MONTH FROM GUIA.FECHA) FROM 2 FOR 2) || '-'
        || SUBSTRING(100 + EXTRACT(DAY FROM GUIA.FECHA) FROM 2 FOR 2)
        || 'T'
        || SUBSTRING(100 + EXTRACT(HOUR FROM GUIA.FECHAHORA) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(MINUTE FROM GUIA.FECHAHORA) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(SECOND FROM GUIA.FECHAHORA) FROM 2 FOR 2)  FECHAHORASALIDALLEGADA  ,

        '' TIPOESTACION  ,
        '' DISTANCIARECORRIDA   ,
        SUCURSAL.ENTREGACALLE CALLE  ,
        SUCURSAL.ENTREGANUMEROEXTERIOR NUMEROEXTERIOR  ,
        SUCURSAL.ENTREGANUMEROINTERIOR NUMEROINTERIOR ,
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        '' REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS ,
        SUCURSAL.ENTREGACODIGOPOSTAL

    FROM DOCTO
        LEFT JOIN PARAMETRO ON 1 = 1
        LEFT JOIN SUCURSAL ON PARAMETRO.sucursalid = SUCURSAL.id
        LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id
        LEFT join SAT_COLONIA on SAT_COLONIA.id = SUCURSAL.entrega_sat_coloniaid
        LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = SUCURSAL.entrega_sat_localidadid
        LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = SUCURSAL.entrega_sat_municipioid
        LEFT join ESTADO on ESTADO.CLAVE = SUCURSAL.entregaestado
        WHERE DOCTO.ID = :DOCTOID
    INTO
        :TIPOUBICACION ,
        :IDUBICACION   ,
        :RFCREMITENTEDESTINATARIO  ,
        :NOMBREREMITENTEDESTINATARIO ,
        :NUMREGIDTRIB ,
        :RESIDENCIAFISCAL ,
        :NUMESTACION ,
        :NOMBREESTACION ,
        :NAVEGACIONTRAFICO ,
        :FECHAHORASALIDALLEGADA  ,
        :TIPOESTACION  ,
        :DISTANCIARECORRIDA ,
        :CALLE      ,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR ,
        :COLONIA  ,
        :LOCALIDAD ,
        :REFERENCIA ,
        :MUNICIPIO,
        :ESTADO  ,
        :PAIS   ,
        :CODIGOPOSTAL  ;
  END
  ELSE
  BEGIN
  
    SELECT
        'Origen' TIPOUBICACION ,
        'OR' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDUBICACION  ,
        PARAMETRO.RFC RFCREMITENTEDESTINATARIO,
        PARAMETRO.FISCALNOMBRE NOMBREREMITENTEDESTINATARIO ,
        '' NUMREGIDTRIB  ,
        '' RESIDENCIAFISCAL ,
        '' NUMESTACION  ,
        '' NOMBREESTACION  ,
        '' NAVEGACIONTRAFICO  ,

        EXTRACT(YEAR FROM GUIA.FECHA) || '-'
        || SUBSTRING(100 + EXTRACT(MONTH FROM GUIA.FECHA) FROM 2 FOR 2) || '-'
        || SUBSTRING(100 + EXTRACT(DAY FROM GUIA.FECHA) FROM 2 FOR 2)
        || 'T'
        || SUBSTRING(100 + EXTRACT(HOUR FROM GUIA.FECHAHORA) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(MINUTE FROM GUIA.FECHAHORA) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(SECOND FROM GUIA.FECHAHORA) FROM 2 FOR 2)  FECHAHORASALIDALLEGADA  ,

        '' TIPOESTACION  ,
        '' DISTANCIARECORRIDA   ,
        PERSONA.domicilio CALLE  ,
        PERSONA.NUMEROEXTERIOR NUMEROEXTERIOR  ,
        PERSONA.NUMEROINTERIOR NUMEROINTERIOR ,
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        PERSONA.referenciadom REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS ,
        PERSONA.CODIGOPOSTAL

    FROM DOCTO
        LEFT JOIN PERSONA ON :ORIGENPERSONAID = PERSONA.id
        LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id
        LEFT join SAT_COLONIA on SAT_COLONIA.id = PERSONA.sat_coloniaid 
        LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = PERSONA.sat_localidadid
        LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = PERSONA.sat_municipioid  
        LEFT join ESTADO on ESTADO.CLAVE = PERSONA.estado    
        LEFT JOIN PARAMETRO ON 1 = 1
        WHERE DOCTO.ID = :DOCTOID
    INTO
        :TIPOUBICACION ,
        :IDUBICACION   ,
        :RFCREMITENTEDESTINATARIO  ,
        :NOMBREREMITENTEDESTINATARIO ,
        :NUMREGIDTRIB ,
        :RESIDENCIAFISCAL ,
        :NUMESTACION ,
        :NOMBREESTACION ,
        :NAVEGACIONTRAFICO ,
        :FECHAHORASALIDALLEGADA  ,
        :TIPOESTACION  ,
        :DISTANCIARECORRIDA ,
        :CALLE      ,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR ,
        :COLONIA  ,
        :LOCALIDAD ,
        :REFERENCIA ,
        :MUNICIPIO,
        :ESTADO  ,
        :PAIS   ,
        :CODIGOPOSTAL  ;
  END


    
   ID = :ID + 1;
   ORDENLINEA = 5;
   TIPOLINEA = 'CARTAPORTE_UBICACION';
   SUSPEND;


   IF(COALESCE(:SUBTIPODOCTOID,0) IN (7,8) AND COALESCE(:ENTREGACALLESUCURSALDEST, '') <> '') THEN
   BEGIN
   
    SELECT
        'Destino' TIPOUBICACION ,
        'DE' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDUBICACION  ,
        CASE WHEN COALESCE(DOCTO.esfacturaelectronica, 'N') <> 'S' OR COALESCE(DOCTO.timbradouuid,'') = ''  THEN
                        'XAXX010101000'
             ELSE COALESCE(PERSONA.RFC,'XAXX010101000') END RFCREMITENTEDESTINATARIO,
        COALESCE(PERSONA.nombre, SUCDEST.nombre ) NOMBREREMITENTEDESTINATARIO ,
        '' NUMREGIDTRIB  ,
        '' RESIDENCIAFISCAL ,
        '' NUMESTACION  ,
        '' NOMBREESTACION  ,
        '' NAVEGACIONTRAFICO  ,

        EXTRACT(YEAR FROM GUIA.fechaestimadarec)  || '-'
        || SUBSTRING(100 + EXTRACT(MONTH FROM GUIA.fechaestimadarec) FROM 2 FOR 2) || '-'
        || SUBSTRING(100 + EXTRACT(DAY FROM GUIA.fechaestimadarec) FROM 2 FOR 2)
        ||  'T'
        || SUBSTRING(100 + EXTRACT(HOUR FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(MINUTE FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(SECOND FROM GUIA.horaestimadrec) FROM 2 FOR 2)  FECHAHORASALIDALLEGADA  ,

        '' TIPOESTACION ,
        CAST(cast(SUCDEST.ENTREGA_DISTANCIA as NUMERIC(18,3)) AS d_stdtext_medium) DISTANCIARECORRIDA ,
        SUCDEST.ENTREGACALLE CALLE,
        SUCDEST.ENTREGANUMEROEXTERIOR NUMEROEXTERIOR ,
        SUCDEST.ENTREGANUMEROINTERIOR NUMEROINTERIOR ,
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        '' REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS ,
        SUCDEST.ENTREGACODIGOPOSTAL

    FROM DOCTO
        LEFT JOIN PERSONA ON DOCTO.PERSONAID = PERSONA.id
        LEFT JOIN sucursal SUCDEST ON SUCDEST.ID = DOCTO.sucursaltid
        LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id 
        LEFT join SAT_COLONIA on SAT_COLONIA.id = SUCDEST.entrega_sat_coloniaid
        LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = SUCDEST.entrega_sat_localidadid
        LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = SUCDEST.entrega_sat_municipioid
        LEFT join ESTADO on ESTADO.CLAVE = SUCDEST.entregaestado
        WHERE DOCTO.ID = :DOCTOID
    INTO
        :TIPOUBICACION ,
        :IDUBICACION   ,
        :RFCREMITENTEDESTINATARIO  ,
        :NOMBREREMITENTEDESTINATARIO ,
        :NUMREGIDTRIB ,
        :RESIDENCIAFISCAL ,
        :NUMESTACION ,
        :NOMBREESTACION ,
        :NAVEGACIONTRAFICO ,
        :FECHAHORASALIDALLEGADA  ,
        :TIPOESTACION  ,
        :DISTANCIARECORRIDA ,
        :CALLE      ,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR ,
        :COLONIA  ,
        :LOCALIDAD ,
        :REFERENCIA ,
        :MUNICIPIO,
        :ESTADO  ,
        :PAIS   ,
        :CODIGOPOSTAL  ;
   END
   ELSE IF(COALESCE(:USARDATOSENTREGA,'N') <> 'N' AND COALESCE(:PERSONAENTREGACALLE, '') <> '' ) THEN
   BEGIN

   
    SELECT
        'Destino' TIPOUBICACION ,
        'DE' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDUBICACION  ,
        CASE WHEN COALESCE(DOCTO.esfacturaelectronica, 'N') <> 'S' OR COALESCE(DOCTO.timbradouuid,'') = ''  THEN
                        'XAXX010101000'
             ELSE COALESCE(PERSONA.RFC,'XAXX010101000') END RFCREMITENTEDESTINATARIO,
        PERSONA.nombre NOMBREREMITENTEDESTINATARIO ,
        '' NUMREGIDTRIB  ,
        '' RESIDENCIAFISCAL ,
        '' NUMESTACION  ,
        '' NOMBREESTACION  ,
        '' NAVEGACIONTRAFICO  ,

        EXTRACT(YEAR FROM GUIA.fechaestimadarec)  || '-'
        || SUBSTRING(100 + EXTRACT(MONTH FROM GUIA.fechaestimadarec) FROM 2 FOR 2) || '-'
        || SUBSTRING(100 + EXTRACT(DAY FROM GUIA.fechaestimadarec) FROM 2 FOR 2)
        ||  'T'
        || SUBSTRING(100 + EXTRACT(HOUR FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(MINUTE FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(SECOND FROM GUIA.horaestimadrec) FROM 2 FOR 2)  FECHAHORASALIDALLEGADA  ,

        '' TIPOESTACION ,
        CAST(cast(PERSONA.ENTREGA_DISTANCIA as NUMERIC(18,3)) AS d_stdtext_medium) DISTANCIARECORRIDA ,
        PERSONA.ENTREGACALLE CALLE,
        PERSONA.ENTREGANUMEROEXTERIOR NUMEROEXTERIOR ,
        PERSONA.ENTREGANUMEROINTERIOR NUMEROINTERIOR ,
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        '' REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS ,
        PERSONA.ENTREGACODIGOPOSTAL

    FROM DOCTO
        LEFT JOIN PERSONA ON DOCTO.PERSONAID = PERSONA.id
        LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id 
        LEFT join SAT_COLONIA on SAT_COLONIA.id = PERSONA.entrega_sat_coloniaid
        LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = PERSONA.entrega_sat_localidadid
        LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = PERSONA.entrega_sat_municipioid  
        LEFT join ESTADO on ESTADO.CLAVE = PERSONA.entregaestado
        WHERE DOCTO.ID = :DOCTOID
    INTO
        :TIPOUBICACION ,
        :IDUBICACION   ,
        :RFCREMITENTEDESTINATARIO  ,
        :NOMBREREMITENTEDESTINATARIO ,
        :NUMREGIDTRIB ,
        :RESIDENCIAFISCAL ,
        :NUMESTACION ,
        :NOMBREESTACION ,
        :NAVEGACIONTRAFICO ,
        :FECHAHORASALIDALLEGADA  ,
        :TIPOESTACION  ,
        :DISTANCIARECORRIDA ,
        :CALLE      ,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR ,
        :COLONIA  ,
        :LOCALIDAD ,
        :REFERENCIA ,
        :MUNICIPIO,
        :ESTADO  ,
        :PAIS   ,
        :CODIGOPOSTAL  ;

   END
   ELSE
   BEGIN

    
    SELECT
        'Destino' TIPOUBICACION ,
        'DE' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDUBICACION  ,
        CASE WHEN COALESCE(DOCTO.esfacturaelectronica, 'N') <> 'S' OR COALESCE(DOCTO.timbradouuid,'') = ''  THEN
                        'XAXX010101000'
             ELSE COALESCE(PERSONA.RFC,'XAXX010101000') END RFCREMITENTEDESTINATARIO,
        PERSONA.nombre NOMBREREMITENTEDESTINATARIO ,
        '' NUMREGIDTRIB  ,
        '' RESIDENCIAFISCAL ,
        '' NUMESTACION  ,
        '' NOMBREESTACION  ,
        '' NAVEGACIONTRAFICO  ,

        EXTRACT(YEAR FROM GUIA.fechaestimadarec)  || '-'
        || SUBSTRING(100 + EXTRACT(MONTH FROM GUIA.fechaestimadarec) FROM 2 FOR 2) || '-'
        || SUBSTRING(100 + EXTRACT(DAY FROM GUIA.fechaestimadarec) FROM 2 FOR 2)
        ||  'T'
        || SUBSTRING(100 + EXTRACT(HOUR FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(MINUTE FROM GUIA.horaestimadrec) FROM 2 FOR 2) || ':'
        || SUBSTRING(100 + EXTRACT(SECOND FROM GUIA.horaestimadrec) FROM 2 FOR 2)  FECHAHORASALIDALLEGADA  ,

        '' TIPOESTACION ,
        CAST(cast(PERSONA.distancia as NUMERIC(18,2)) AS d_stdtext_medium) DISTANCIARECORRIDA ,
        PERSONA.domicilio CALLE,
        PERSONA.NUMEROEXTERIOR NUMEROEXTERIOR ,
        PERSONA.NUMEROINTERIOR NUMEROINTERIOR ,
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        PERSONA.referenciadom REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS ,
        PERSONA.CODIGOPOSTAL

    FROM DOCTO
        LEFT JOIN PERSONA ON DOCTO.PERSONAID = PERSONA.id
        LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id 
        LEFT join SAT_COLONIA on SAT_COLONIA.id = PERSONA.sat_coloniaid 
        LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = PERSONA.sat_localidadid
        LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = PERSONA.sat_municipioid  
        LEFT join ESTADO on ESTADO.CLAVE = PERSONA.estado
        WHERE DOCTO.ID = :DOCTOID
    INTO
        :TIPOUBICACION ,
        :IDUBICACION   ,
        :RFCREMITENTEDESTINATARIO  ,
        :NOMBREREMITENTEDESTINATARIO ,
        :NUMREGIDTRIB ,
        :RESIDENCIAFISCAL ,
        :NUMESTACION ,
        :NOMBREESTACION ,
        :NAVEGACIONTRAFICO ,
        :FECHAHORASALIDALLEGADA  ,
        :TIPOESTACION  ,
        :DISTANCIARECORRIDA ,
        :CALLE      ,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR ,
        :COLONIA  ,
        :LOCALIDAD ,
        :REFERENCIA ,
        :MUNICIPIO,
        :ESTADO  ,
        :PAIS   ,
        :CODIGOPOSTAL  ;

   END


    
   ID = :ID + 1;
   ORDENLINEA = 5;
   TIPOLINEA = 'CARTAPORTE_UBICACION';
   SUSPEND;



   -- SE PONE DESPUES DE EL DESTINO PARA QUE COINCIDA LA DISTANCIA RECORRIDA
   SELECT
        DOCTO.PERSONAID, 'No' TRANSPINTERNAC, '' ENTRADASALIDAMERC , '' PAISORIGENDESTINO ,'' VIAENTRADASALIDA ,
        :DISTANCIARECORRIDA TOTALDISTREC ,
        DOCTO.FOLIO , PERSONA.ENTREGACALLE, DOCTO.SUBTIPODOCTOID  , SUCDEST.ENTREGACALLE
    FROM DOCTO
    LEFT JOIN PERSONA ON PERSONA.ID = DOCTO.PERSONAID
    LEFT JOIN SUCURSAL SUCDEST ON DOCTO.SUCURSALTID = SUCDEST.ID
    WHERE DOCTO.ID = :DOCTOID
    INTO      
       :PERSONAID, :TRANSPINTERNAC, :ENTRADASALIDAMERC , :PAISORIGENDESTINO  , :VIAENTRADASALIDA   , :TOTALDISTREC ,
       :DOCTOFOLIO, :PERSONAENTREGACALLE, :SUBTIPODOCTOID, :ENTREGACALLESUCURSALDEST ;


   ID = :ID + 1;  
   ORDENLINEA = 1;
   TIPOLINEA = 'CARTAPORTE';
   SUSPEND;


    
   SELECT
    CAST(cast(SUM(COALESCE(PRODUCTO.peso, 0) * MOVTO.CANTIDAD) as numeric(18,3) ) AS D_STDTEXT_MEDIUM ) PESOBRUTOTOTAL,
    'KGM' UNIDADPESO,          
    CAST(cast(SUM(COALESCE(PRODUCTO.peso, 0) * MOVTO.CANTIDAD) as numeric(18,3) ) AS D_STDTEXT_MEDIUM ) PESONETOTOTAL,
    CAST((COUNT(DISTINCT MOVTO.ID)) AS D_STDTEXT_MEDIUM ) NUMTOTALMERCANCIAS,
    '' CARGOPORTASACION
   FROM MOVTO
   LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
   WHERE MOVTO.DOCTOID = :DOCTOID
   INTO
    :PESOBRUTOTOTAL,
    :UNIDADPESO,
    :PESONETOTOTAL,
    :NUMTOTALMERCANCIAS,
    :CARGOPORTASACION;


                  
   ID = :ID + 1; 
   ORDENLINEA = 5;
   TIPOLINEA = 'CARTAPORTE_TOTALMERCANCIAS';
   SUSPEND;




   
   FOR SELECT
        SAT_PRODUCTOSERVICIO.sat_claveprodserv BIENESTRANSP ,
        '' CLAVESTCC ,
        PRODUCTO.descripcion1 DESCRIPCION,
        MOVTO.CANTIDAD CANTIDAD,
        sat_unidadmedida.sat_clave CLAVEUNIDAD,
        '' UNIDAD,
        '' DIMENSIONES,
        
        case when coalesce(producto.espeligroso,'N') = 'S' then 'Si' else 'No' end MATERIALPELIGROSO,
        case when coalesce(producto.espeligroso,'N') = 'S' then SAT_MATPELIGROSO.clave else null end   CVEMATERIALPELIGROSO  ,
        case when coalesce(producto.espeligroso,'N') = 'S' then sat_tipoembalaje.clave else '' end PRODUCTOEMBALAJE  ,

        case when coalesce(producto.espeligroso,'N') = 'S' then sat_tipoembalaje.descripcion else '' end DESCRIPEMBALAJE ,
        CAST(cast(COALESCE(PRODUCTO.peso,0) * COALESCE(movto.cantidad,0)  as numeric(18,3) ) AS D_STDTEXT_MEDIUM) PESOENKG,
        CAST(COALESCE(MOVTO.TOTAL,0) AS D_STDTEXT_MEDIUM) VALORMERCANCIA  ,
        'MXN' MONEDA ,
        '' FRACCIONARANCELARIA,
        '' UUIDCOMERCIOEXT ,
                    
        '' UNIDADPESOMERC ,
        '' PESOBRUTO ,
        '' PESONETO ,
        '' PESOTARA ,
        '' NUMPIEZAS,
        PRODUCTO.CLAVE

       --'KGM' UNIDADPESOMERC ,
       --CAST(cast(COALESCE(PRODUCTO.peso, 0) * MOVTO.CANTIDAD as numeric(18,3)) AS D_STDTEXT_MEDIUM) PESOBRUTO ,
       --CAST(cast(COALESCE(PRODUCTO.peso, 0) * MOVTO.CANTIDAD as numeric(18,3)) AS D_STDTEXT_MEDIUM) PESONETO ,
       --CAST(cast(COALESCE(PRODUCTO.peso, 0) * MOVTO.CANTIDAD as numeric(18,3)) AS D_STDTEXT_MEDIUM) PESOTARA ,
        -- '' NUMPIEZAS

   FROM MOVTO          
   LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID 
   LEFT JOIN UNIDAD ON PRODUCTO.unidad = UNIDAD.CLAVE
   LEFT JOIN sat_unidadmedida ON SAT_UNIDADMEDIDA.ID = UNIDAD.sat_unidadmedidaid
   LEFT JOIN sat_tipoembalaje ON  sat_tipoembalaje.ID = PRODUCTO.sat_tipoembalajeid   
   LEFT JOIN SAT_PRODUCTOSERVICIO  ON SAT_PRODUCTOSERVICIO.id = PRODUCTO.sat_productoservicioid 
   LEFT JOIN SAT_MATPELIGROSO ON SAT_MATPELIGROSO.id = PRODUCTO.sat_matpeligrosoid
   WHERE MOVTO.DOCTOID = :DOCTOID
   INTO
        :BIENESTRANSP,
        :CLAVESTCC ,
        :DESCRIPCION ,
        :CANTIDAD ,
        :CLAVEUNIDAD ,
        :UNIDAD   ,
        :DIMENSIONES  ,
        :MATERIALPELIGROSO  ,
        :CVEMATERIALPELIGROSO,
        :EMBALAJE ,
        :DESCRIPEMBALAJE   ,
        :PESOENKG ,
        :VALORMERCANCIA  ,
        :MONEDA ,
        :FRACCIONARANCELARIA ,
        :UUIDCOMERCIOEXT,
        :UNIDADPESOMERC ,
        :PESOBRUTO  ,
        :PESONETO ,
        :PESOTARA  ,
        :NUMPIEZAS ,
        :CLAVEPRODUCTO

   DO
   BEGIN

        IF( coalesce(:MATERIALPELIGROSO,'No') = 'Si' ) THEN
        BEGIN  
            CONTIENEMATERIALPELIGROSO  = 'S';
        END

                  
        ID = :ID + 1;   
        ORDENLINEA = 5;
        TIPOLINEA = 'CARTAPORTE_MERCANCIA';
        SUSPEND;
   END


   

   SELECT
    CAST(SUM(COALESCE(MOVTO.CANTIDAD,0)) AS D_STDTEXT_MEDIUM) CANTIDAD,
    'OR' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDORIGEN  ,
    'DE' || RIGHT(lpad(cast(:DOCTOFOLIO AS VARCHAR(20)), 6, '0'),6)  IDDESTINO  ,
    '' CVESTRANSPORTE
   FROM
   DOCTO
   LEFT JOIN MOVTO  ON MOVTO.DOCTOID = DOCTO.ID
   LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID   
   LEFT JOIN UNIDAD ON PRODUCTO.unidad = UNIDAD.CLAVE
   WHERE DOCTO.ID = :DOCTOID
   INTO
    :CANTIDAD,
    :IDORIGEN,
    :IDDESTINO,
    :CVESTRANSPORTE;
                 
   ID = :ID + 1;   
   ORDENLINEA = 5;
   TIPOLINEA = 'CARTAPORTE_CANTTRANSP';
   SUSPEND;



   
   SELECT
        sat_tipopermiso.clave PERMSCT ,
        VEHICULO.NUMPERMISOSCT  ,
        sat_configautotransporte.clave CONFIGVEHICULAR,
        VEHICULO.PLACAVM     ,
        VEHICULO.ANIOMODELOVM ,
        VEHICULO.ASEGURARESPCIVIL,
        VEHICULO.POLIZARESPCIVIL ,
        CASE WHEN COALESCE(:CONTIENEMATERIALPELIGROSO, 'N') = 'S' THEN VEHICULO.aseguramedambiente ELSE '' END ASEGURAMEDAMBIENTE ,
        CASE WHEN COALESCE(:CONTIENEMATERIALPELIGROSO, 'N') = 'S' THEN VEHICULO.polizamedambiente ELSE '' END  POLIZAMEDAMBIENTE ,
        VEHICULO.ASEGURACARGA,
        VEHICULO.POLIZACARGA ,
        VEHICULO.PRIMASEGURO ,
        sat_subtiporem1.clave SUBTIPOREM1,
        VEHICULO.PLACA1   ,
        sat_subtiporem2.clave SUBTIPOREM2 ,
        VEHICULO.PLACA2
   FROM DOCTO
    LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id
    LEFT JOIN VEHICULO ON VEHICULO.ID = GUIA.vehiculoid
    LEFT JOIN sat_tipopermiso  on vehiculo.sat_tipopermisoid = sat_tipopermiso.id
    LEFT JOIN sat_configautotransporte on vehiculo.sat_configautotransporteid = sat_configautotransporte.id
    LEFT JOIN sat_subtiporem sat_subtiporem1 on vehiculo.sat_subtiporem1id = sat_subtiporem1.id
    LEFT JOIN sat_subtiporem sat_subtiporem2 on vehiculo.sat_subtiporem2id = sat_subtiporem2.id
   WHERE DOCTO.ID = :DOCTOID
   INTO
        :PERMSCT  ,
        :NUMPERMISOSCT ,
        :CONFIGVEHICULAR ,
        :PLACAVM       ,
        :ANIOMODELOVM   ,
        :ASEGURARESPCIVIL  ,
        :POLIZARESPCIVIL  ,
        :ASEGURAMEDAMBIENTE  ,
        :POLIZAMEDAMBIENTE ,
        :ASEGURACARGA ,
        :POLIZACARGA ,
        :PRIMASEGURO ,
        :SUBTIPOREM1 ,
        :PLACA1     ,
        :SUBTIPOREM2 ,
        :PLACA2
            ;

            
        ID = :ID + 1;  
        ORDENLINEA = 5;
        TIPOLINEA = 'CARTAPORTE_AUTOTRANSP';
        SUSPEND;


               
   SELECT GUIA.encargadoguiaid ,
           VEHICULO.duenioid
   FROM DOCTO
    LEFT JOIN GUIA ON DOCTO.guiaid = GUIA.id
    LEFT JOIN VEHICULO ON VEHICULO.ID = GUIA.vehiculoid
   WHERE DOCTO.ID = :DOCTOID
   INTO    :ENCARGADOGUIAID , :DUENIOID ;

   SELECT FIRST 1
        sat_figuratransporte.clave TIPOFIGURA,
        PERSONA.rfc RFCFIGURA,
        PERSONAFIGURA.numlicencia NUMLICENCIA,
        PERSONA.nombre NOMBREFIGURA,
        PERSONAFIGURA.numregidtrib NUMREGIDTRIB,
        '' RESIDENCIAFISCAL,
        case when sat_figuratransporte.clave <> '01' then  sat_partetransporte.CLAVE else '' end PARTETRANSPORTE,
        PERSONA.DOMICILIO CALLE,
        PERSONA.numeroexterior NUMEROEXTERIOR, 
        PERSONA.numeroexterior NUMEROINTERIOR, 
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        PERSONA.referenciadom REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS,
        PERSONA.codigopostal CODIGOPOSTAL

   FROM PERSONA
    LEFT JOIN PERSONAFIGURA ON PERSONAFIGURA.personaid =PERSONA.ID
    LEFT JOIN sat_partetransporte ON sat_partetransporte.id = PERSONAFIGURA.sat_partetransporteid 
    LEFT JOIN sat_figuratransporte ON sat_figuratransporte.id = PERSONAFIGURA.sat_figuratransporteid 
    LEFT join SAT_COLONIA on SAT_COLONIA.id = PERSONA.sat_coloniaid 
    LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = PERSONA.sat_localidadid
    LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = PERSONA.sat_municipioid  
    LEFT join ESTADO on ESTADO.CLAVE = PERSONA.estado   
   WHERE PERSONA.ID =  :ENCARGADOGUIAID
    INTO
        :TIPOFIGURA,
        :RFCFIGURA,
        :NUMLICENCIA,
        :NOMBREFIGURA,
        :NUMREGIDTRIB,
        :RESIDENCIAFISCAL,
        :PARTETRANSPORTE,
        :CALLE,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR,
        :COLONIA,
        :LOCALIDAD,
        :REFERENCIA,
        :MUNICIPIO,
        :ESTADO,
        :PAIS,
        :CODIGOPOSTAL;

             
   ID = :ID + 1;   
   ORDENLINEA = 5;
   TIPOLINEA = 'CARTAPORTE_TRANSPTIPOFIGURA';
   SUSPEND;


   IF(COALESCE(:DUENIOID,0) <> 0 AND  COALESCE(:DUENIOID,0) <> COALESCE(:ENCARGADOGUIAID,0) ) THEN
   BEGIN

        
    SELECT FIRST 1
        sat_figuratransporte.clave TIPOFIGURA,
        PERSONA.rfc RFCFIGURA,
        PERSONAFIGURA.numlicencia NUMLICENCIA,
        PERSONA.nombre NOMBREFIGURA,
        PERSONAFIGURA.numregidtrib NUMREGIDTRIB,
        '' RESIDENCIAFISCAL,
        case when sat_figuratransporte.clave <> '01' then  sat_partetransporte.CLAVE else '' end PARTETRANSPORTE,
        PERSONA.DOMICILIO CALLE,
        PERSONA.numeroexterior NUMEROEXTERIOR, 
        PERSONA.numeroexterior NUMEROINTERIOR, 
        SAT_COLONIA.colonia COLONIA  ,
        SAT_LOCALIDAD.clave_localidad LOCALIDAD  ,
        PERSONA.referenciadom REFERENCIA ,
        sat_municipio.clave_municipio MUNICIPIO,
        ESTADO.acronimo ESTADO,
        'MEX' PAIS,
        PERSONA.codigopostal CODIGOPOSTAL

    FROM PERSONA
    LEFT JOIN PERSONAFIGURA ON PERSONAFIGURA.personaid =PERSONA.ID
    LEFT JOIN sat_partetransporte ON sat_partetransporte.id = PERSONAFIGURA.sat_partetransporteid 
    LEFT JOIN sat_figuratransporte ON sat_figuratransporte.id = PERSONAFIGURA.sat_figuratransporteid 
    LEFT join SAT_COLONIA on SAT_COLONIA.id = PERSONA.sat_coloniaid 
    LEFT join SAT_LOCALIDAD on SAT_LOCALIDAD.id = PERSONA.sat_localidadid
    LEFT join SAT_MUNICIPIO on SAT_MUNICIPIO.id = PERSONA.sat_municipioid  
    LEFT join ESTADO on ESTADO.CLAVE = PERSONA.estado   
    WHERE PERSONA.ID =  :DUENIOID
    INTO
        :TIPOFIGURA,
        :RFCFIGURA,
        :NUMLICENCIA,
        :NOMBREFIGURA,
        :NUMREGIDTRIB,
        :RESIDENCIAFISCAL,
        :PARTETRANSPORTE,
        :CALLE,
        :NUMEROEXTERIOR,
        :NUMEROINTERIOR,
        :COLONIA,
        :LOCALIDAD,
        :REFERENCIA,
        :MUNICIPIO,
        :ESTADO,
        :PAIS,
        :CODIGOPOSTAL;


             
        ID = :ID + 1; 
        ORDENLINEA = 5;
        TIPOLINEA = 'CARTAPORTE_TRANSPTIPOFIGURA';
        SUSPEND;

   END





END