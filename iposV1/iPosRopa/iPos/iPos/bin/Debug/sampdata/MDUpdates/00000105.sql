CREATE OR ALTER TRIGGER MOVTO_AIU_30 FOR MOVTO
ACTIVE AFTER INSERT OR UPDATE POSITION 30
AS
   DECLARE VARIABLE ALMACENID D_FK;
   DECLARE VARIABLE TIPODOCTOID D_FK;
   DECLARE VARIABLE ERRORCODE D_ERRORCODE;
BEGIN
   IF (NEW.ESTATUSMOVTOID <> 1) THEN
   BEGIN
      EXIT;
   END

   SELECT TIPODOCTOID, ALMACENID
   FROM DOCTO
   WHERE ID = NEW.DOCTOID
   INTO :TIPODOCTOID, :ALMACENID;

   -- Unicamente para Compras.
   IF (:TIPODOCTOID = 11) THEN
   BEGIN
      SELECT ERRORCODE FROM CALCULAR_COSTO_PROMEDIO(
         :ALMACENID, NEW.PRODUCTOID, NEW.PRECIO, NEW.CANTIDAD)
      INTO :ERRORCODE;

      UPDATE PRODUCTO
      SET COSTOULTIMO = NEW.COSTO,
         COSTOREPOSICION = NEW.COSTO
      WHERE ID = NEW.PRODUCTOID;
   END
END