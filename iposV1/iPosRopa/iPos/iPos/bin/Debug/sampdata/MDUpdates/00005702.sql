create or alter procedure GET_MAXEXISTENCIAPARAKIT (
    PRODUCTOID D_FK,
    ALMACENID D_FK)
returns (
    CANTMAXENSAMBLAR D_CANTIDAD,
    ERRORCODE D_ERRORCODE)
as
declare variable MANEJAALMACEN D_BOOLCN;
declare variable CUENTANECESARIOS integer;
BEGIN


    SELECT FIRST 1 COALESCE(MANEJAALMACEN,'N')
    FROM PARAMETRO
    into :MANEJAALMACEN;

    IF (:MANEJAALMACEN = 'S') THEN
   BEGIN
   
   
       SELECT MIN(COALESCE(CANTIDADMAXENSAMBLAR,0)) CANTMAXENSAMBLAR, COUNT(*) CUENTANECESARIOS FROM
      (
        SELECT ((invcantidad - SUM(COALESCE(PRODUCTOALMACEN.enprocesodesalida,0)))/ CANTIDADPORKIT) CANTIDADMAXENSAMBLAR

        FROM
        (
            SELECT k.productoparteid, sum(inv.cantidad) invcantidad, (COALESCE(K.cantidadparte,0)   ) CANTIDADPORKIT  FROM KITSUNNIVEL_VIEW K
            INNER JOIN PRODUCTO P ON K.productoparteid = P.ID
                LEFT JOIN INVENTARIO INV ON INV.PRODUCTOID = K.PRODUCTOPARTEID AND INV.ALMACENID = :ALMACENID  AND COALESCE(INV.ESAPARTADO,'N') = 'N'
            WHERE COALESCE(K.productokitid, 0) = :PRODUCTOID AND COALESCE(P.INVENTARIABLE,'N') = 'S'  AND COALESCE(P.negativos,'N') = 'N'
            GROUP BY K.PRODUCTOPARTEID  , K.cantidadparte
         ) INVEXIS
            LEFT join PRODUCTOALMACEN ON PRODUCTOALMACEN.productoid = INVEXIS.PRODUCTOPARTEID AND PRODUCTOALMACEN.almacenid = :ALMACENID

            GROUP BY  INVEXIS.productoparteid , INVEXIS.invcantidad,  INVEXIS.CANTIDADPORKIT
            HAVING CANTIDADPORKIT > 0

        )

        INTO :CANTMAXENSAMBLAR, :CUENTANECESARIOS;



   END
   ELSE
   BEGIN


        SELECT MIN((COALESCE(P.EXISTENCIA,0) - COALESCE(P.ENPROCESODESALIDA,0)) / COALESCE(K.cantidadparte,0)  ) CANTMAXENSAMBLAR, COUNT(*) CUENTANECESARIOS
        FROM KITSUNNIVEL_VIEW K
        INNER JOIN PRODUCTO P ON K.productoparteid = P.ID
        WHERE COALESCE(K.productokitid, 0) = :PRODUCTOID   AND COALESCE(P.INVENTARIABLE,'N') = 'S'  AND COALESCE(P.negativos,'N') = 'N'
        AND COALESCE(K.cantidadparte,0) > 0

        INTO :CANTMAXENSAMBLAR, :CUENTANECESARIOS;
    END


    IF(COALESCE(:CUENTANECESARIOS,0) = 0) THEN
    BEGIN
      CANTMAXENSAMBLAR = -1;
    END


   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1043;
      SUSPEND;
   END 
END