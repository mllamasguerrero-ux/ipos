CREATE OR ALTER PROCEDURE CORTE_ABRIR (
    FECHACORTE D_FECHA,
    SUCURSALID D_FK,
    CAJAID D_FK,
    CAJEROID D_FK,
    TURNOID D_FK,
    SALDOINICIAL D_IMPORTE)
RETURNS (
    CORTEID D_FK,
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE ACTIVO D_BOOLCN;
DECLARE VARIABLE REABRIRCORTE D_BOOLCN;
BEGIN
   SELECT REABRIRCORTES
   FROM PARAMETRO
   INTO :REABRIRCORTE;

   IF (:REABRIRCORTE = 'N') THEN
   BEGIN
      SELECT ID
      FROM CORTE
      WHERE FECHACORTE = :FECHACORTE
        AND CAJAID = :CAJAID
        AND SUCURSALID = :SUCURSALID
        AND TURNOID = :TURNOID
      INTO :CORTEID;
   
      IF ((:CORTEID IS NOT NULL)) THEN
      BEGIN
         ERRORCODE = 1017;
         SUSPEND;
         EXIT;
      END
   END

   SELECT ID, ACTIVO
   FROM CORTE
   WHERE FECHACORTE = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND CAJAID = :CAJAID
     AND TURNOID = :TURNOID
     AND CAJEROID = :CAJEROID
   INTO :CORTEID, :ACTIVO;

   IF ((:CORTEID IS NOT NULL) AND (:ACTIVO = 'S')) THEN
   BEGIN
      ERRORCODE = 1017;
      SUSPEND;
      EXIT;
   END

   IF ((:CORTEID IS NOT NULL) AND (:ACTIVO = 'N')) THEN
   BEGIN
      UPDATE CORTE
      SET ACTIVO = 'S'
      WHERE ID = :CORTEID;
   END
   ELSE
   BEGIN
      INSERT INTO CORTE (
         FECHACORTE,
         SUCURSALID,
         CAJAID,
         CAJEROID,
         TURNOID,
         INICIA,
         SALDOINICIAL
      ) VALUES (
         :FECHACORTE,
         :SUCURSALID,
         :CAJAID,
         :CAJEROID,
         :TURNOID,
         CURRENT_TIMESTAMP,
         :SALDOINICIAL
      ) RETURNING ID INTO :CORTEID;
   END
   
   UPDATE CAJA
   SET
      FECHACORTE = :FECHACORTE,
      CORTEID = :CORTEID,
      CAJEROID = :CAJEROID,
      TURNOID = :TURNOID
   WHERE ID = :CAJAID;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1019;
      SUSPEND;
   END 
END;