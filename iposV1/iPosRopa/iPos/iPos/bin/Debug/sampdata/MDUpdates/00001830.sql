create or alter procedure MOVIL_SETEXISTENCIA (
    PRODUCTOID D_FK,
    CANTIDAD D_CANTIDAD)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable CANTIDADACTUAL D_CANTIDAD;
declare variable DIFERENCIA D_CANTIDAD;
BEGIN

SELECT EXISTENCIA FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :CANTIDADACTUAL;
DIFERENCIA = :CANTIDAD - COALESCE(:CANTIDADACTUAL ,0)  ;


IF(:DIFERENCIA > 0) THEN
BEGIN
    
      INSERT INTO KARDEX
         (TIPODOCTOID, DOCTOID, MOVTOID, FECHA, FECHAHORA,
          ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, ORIGENFISCALID, ESAPARTADO)
      VALUES
         (51, -51, 0, CURRENT_DATE, current_timestamp,
          1, :PRODUCTOID, NULL, NULL, :DIFERENCIA, 0, 0, 2 ,'N');
END
ELSE IF(:DIFERENCIA < 0) THEN
BEGIN
    
    DIFERENCIA = :DIFERENCIA * -1;

      INSERT INTO KARDEX
         (TIPODOCTOID, DOCTOID, MOVTOID, FECHA, FECHAHORA,
          ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, ORIGENFISCALID, ESAPARTADO)
      VALUES
         (52, -52, 0, CURRENT_DATE, current_timestamp,
          1, :PRODUCTOID, NULL, NULL, :DIFERENCIA, 0, 0, 2 ,'N');
END

END