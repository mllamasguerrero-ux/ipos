create or alter procedure INVENTARIO_INICIAL_AGREGAR (
    ALMACENID D_FK,
    PRODUCTOCLAVE D_CLAVE,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    CANTIDAD D_CANTIDAD,
    PRECIO D_PRECIO,
    COSTO D_COSTO)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable INVENTARIOID type of D_FK;
declare variable PRODUCTOID type of D_FK;
BEGIN

   

      SELECT ID
      FROM PRODUCTO
      WHERE CLAVE = :PRODUCTOCLAVE
      INTO :PRODUCTOID;


   if( :PRODUCTOID IS NULL) then
   BEGIN
      ERRORCODE = 1069;
      SUSPEND;
      EXIT;
   END

   if (:LOTE IS NULL) then
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
        AND ORIGENFISCALID = 2
      INTO :INVENTARIOID;
   END
   ELSE
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
        AND LOTE = :LOTE
        AND FECHAVENCE = :FECHAVENCE 
        AND ORIGENFISCALID = 2
      INTO :INVENTARIOID;
   END


  

   IF (:INVENTARIOID IS NULL) THEN
   BEGIN
      INSERT INTO INVENTARIO
         (ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD,CANTIDADINICIAL, FECHAINICIAL,ORIGENFISCALID)
      VALUES
         (:ALMACENID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :CANTIDAD, CURRENT_DATE, 2)
      RETURNING ID
         INTO :INVENTARIOID;
   END
   ELSE
   BEGIN
      if (:LOTE IS NULL) then
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD =  :CANTIDAD,
            CANTIDADINICIAL = :CANTIDAD,
            FECHAINICIAL = CURRENT_DATE ,
            ORIGENFISCALID = 2
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
         RETURNING ID
            INTO :INVENTARIOID;
      END
      ELSE
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD =  :CANTIDAD,
            CANTIDADINICIAL = :CANTIDAD ,
            FECHAINICIAL = CURRENT_DATE,
            ORIGENFISCALID = 2 
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
           AND LOTE = :LOTE
           AND FECHAVENCE = :FECHAVENCE
         RETURNING ID
            INTO :INVENTARIOID;
      END
   END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1016;
      SUSPEND;
   END 
END