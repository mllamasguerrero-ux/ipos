create or alter procedure KIT_ACTUALIZARIMPUESTOKIT (
    PRODUCTOKITID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESKIT D_BOOLCN;
declare variable MANEJAKIT D_BOOLCN;
declare variable PORCENTAJEIEPS D_PORCENTAJE;
declare variable PORCENTAJEIVA D_PORCENTAJE;
declare variable PORCENTAJEIMPUESTO D_PORCENTAJE;
declare variable PORCENTAJEIEPSEXT D_DECIMAL_EXACT;
declare variable PORCENTAJEIVAEXT D_DECIMAL_EXACT;
declare variable PORCENTAJEIMPUESTOEXT D_DECIMAL_EXACT;
declare variable TASAIVAID D_FK;
BEGIN

    ERRORCODE = 0;


    SELECT FIRST 1 MANEJAKITS FROM PARAMETRO WHERE 1 = 1 INTO :MANEJAKIT;
    IF(COALESCE(:MANEJAKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -2;
        SUSPEND;  
        EXIT;
    END

    SELECT ESKIT, TASAIVAID, TASAIVA, TASAIEPS, TASAIMPUESTO
        FROM PRODUCTO
        WHERE ID = :PRODUCTOKITID
        INTO :ESKIT, :TASAIVAID, :PORCENTAJEIVA, :PORCENTAJEIEPS, :PORCENTAJEIMPUESTO;
     IF(COALESCE(:ESKIT, 'N') <> 'S') THEN
    BEGIN
        ERRORCODE = -1;
        SUSPEND;
        EXIT;
    END


    SELECT PORCENTAJEIEPS, PORCENTAJEIVA, PORCENTAJEIMPUESTO,  TASAIVAID ,ERRORCODE
    FROM KIT_TOTALIZARIMPUESTOS(:productokitid)
    INTO  :PORCENTAJEIEPSEXT, :PORCENTAJEIVAEXT, :PORCENTAJEIMPUESTOEXT,  :TASAIVAID , :ERRORCODE;


    PORCENTAJEIEPS = cast(COALESCE(:PORCENTAJEIEPSEXT,0.0) as d_porcentaje);
    PORCENTAJEIVA = cast(COALESCE(:PORCENTAJEIVAEXT,0.0) as d_porcentaje);
    PORCENTAJEIMPUESTO = cast(COALESCE(:PORCENTAJEIMPUESTOEXT,0.0) as d_porcentaje);


    IF(:ERRORCODE = 0 ) THEN
    BEGIN

      UPDATE PRODUCTO SET TASAIEPS = :PORCENTAJEIEPS ,
                        TASAIVA = :PORCENTAJEIVA  ,
                        TASAIVAID = :TASAIVAID ,
                        TASAIMPUESTO = :PORCENTAJEIEPS ,
                        TASAIVAEXT = :PORCENTAJEIVAEXT,
                        TASAIEPSEXT = :PORCENTAJEIEPSEXT,
                        TASAIMPEXT = :PORCENTAJEIMPUESTOEXT
                WHERE ID = :productokitid;
    END

    ERRORCODE = 0;
    SUSPEND;

  /* WHEN ANY DO
   BEGIN
     ERRORCODE = 4006;
     SUSPEND;
   END  */

END