create or alter procedure CORTE_TOTALES (
    SUCURSALID D_FK,
    CAJEROID D_FK)
returns (
    CORTEID D_FK,
    FECHACORTE D_FECHA,
    SALDOINICIAL D_IMPORTE,
    INGRESO D_IMPORTE,
    EGRESO D_IMPORTE,
    DEVOLUCION D_IMPORTE,
    SALDOFINAL D_IMPORTE,
    APORTACION D_IMPORTE,
    RETIRO D_IMPORTE,
    INGRESOTARJETA D_IMPORTE,
    INGRESOEFECTIVO D_IMPORTE,
    INGRESOCREDITO D_IMPORTE,
    INGRESOCHEQUE D_IMPORTE,
    INGRESOVALE D_IMPORTE,
    CAMBIOCHEQUE D_IMPORTE,
    SALDOREAL D_IMPORTE,
    PAGOPROVEEDORES D_IMPORTE,
    EGRESOTARJETA D_IMPORTE,
    EGRESOEFECTIVO D_IMPORTE,
    EGRESOCREDITO D_IMPORTE,
    EGRESOCHEQUE D_IMPORTE,
    EGRESOVALE D_IMPORTE,
    SALDOREALCREDITO D_IMPORTE,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCN;
declare variable TICKETSVENTA integer;
declare variable TICKETSDEVOLUCION integer;
declare variable INGRESOPORIVA D_IMPORTE;
declare variable INGRESOSUBTOTAL D_IMPORTE;
declare variable INGRESODESCUENTO D_IMPORTE;
declare variable INGRESOIMPORTE D_IMPORTE;
declare variable TOTALAFECTACION D_IMPORTE;
BEGIN

   SELECT CORTEID
   FROM PERSONA
   WHERE ID = :CAJEROID
   INTO :CORTEID ;




   SELECT  ACTIVO, SALDOINICIAL, APORTACION, RETIRO, FECHACORTE , SALDOREAL, coalesce(SALDOREALCREDITO,0)
   FROM CORTE
   WHERE ID = :CORTEID
   INTO :ACTIVO, :SALDOINICIAL, :APORTACION, :RETIRO,  :FECHACORTE, :SALDOREAL, :SALDOREALCREDITO;

   IF (:CORTEID IS NULL) THEN
   BEGIN
      ERRORCODE = 1020;
      SUSPEND;
      EXIT;
   END

   IF (:ACTIVO <> 'S') THEN
   BEGIN
      ERRORCODE = 1021;
      SUSPEND;
      EXIT;
   END







    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.iva,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5) AND  P.TIPOPAGOID = 1
    INTO :INGRESOPORIVA;

            
     select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.subtotal,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5) AND  P.TIPOPAGOID = 1
    INTO :INGRESOSUBTOTAL;

    
    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.descuento,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5) AND  P.TIPOPAGOID = 1
    INTO :INGRESODESCUENTO;

    
    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.importe,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5) AND  P.TIPOPAGOID = 1
    INTO :INGRESOIMPORTE;




   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1, 2)
   INTO :TICKETSVENTA;









   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 23
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :TICKETSDEVOLUCION;



       /*
    select coalesce(sum(p.importe),0) from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5) AND  P.TIPOPAGOID = 2 AND D.tipodoctoid = 23
    INTO :DEVOLUCION;


     
    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1) AND  P.TIPOPAGOID = 1
    INTO :INGRESOEFECTIVO;



                              
   
    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (2) AND  P.TIPOPAGOID = 1
   INTO :INGRESOTARJETA;

             
   
    select coalesce(sum(p.importe),0),coalesce(sum(p.importecambio),0)  from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (3) AND  P.TIPOPAGOID = 1
   INTO :INGRESOCHEQUE, :CAMBIOCHEQUE;

             
   
    select coalesce(sum(p.importe),0) from doctopago P 
    left join docto de on p.doctoid = de.id
    left join docto ds on p.doctosalidaid = ds.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (4) AND  P.TIPOPAGOID = 1
    and coalesce(ds.tipodoctoid,0) not in (11,15) and coalesce(de.tipodoctoid, 0)not in (12,13)
   INTO :INGRESOCREDITO;



   IF(:ABONOSMISMOCORTECREDITO > 0) THEN
   BEGIN
     INGRESOCREDITO = :INGRESOCREDITO - :ABONOSMISMOCORTECREDITO;
   END


    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (5) AND  P.TIPOPAGOID = 1
   INTO :INGRESOVALE;






   
    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1) AND  P.TIPOPAGOID = 2
    INTO :EGRESOEFECTIVO;

    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (2) AND  P.TIPOPAGOID = 2
   INTO :EGRESOTARJETA;

             
   
    select coalesce(sum(p.importe),0)  from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (3) AND  P.TIPOPAGOID = 2
   INTO :EGRESOCHEQUE;

             
   
    select coalesce(sum(p.importe),0) from doctopago P  
    left join docto de on p.doctoid = de.id
    left join docto ds on p.doctosalidaid = ds.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (4) AND  P.TIPOPAGOID = 2
    and coalesce(ds.tipodoctoid,0) not in (11,15) and coalesce(de.tipodoctoid, 0)not in (12,13)
   INTO :EGRESOCREDITO;



   IF(:EGRESOMISMOCORTECREDITO > 0) THEN
   BEGIN
     EGRESOCREDITO = :EGRESOCREDITO - :EGRESOMISMOCORTECREDITO;
   END



    select coalesce(sum(p.importe),0)  from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (5) AND  P.TIPOPAGOID = 2
   INTO :EGRESOVALE;





   
      SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (60)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :PAGOPROVEEDORES  ;


      SELECT COALESCE(SUM(TOTAL), 0.00)
   FROM DOCTO
   WHERE TIPODOCTOID IN (61)
     AND FECHA = :FECHACORTE
     AND SUCURSALID = :SUCURSALID
     AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :RETIRO  ;

   
   -- calculo del egreso
    select coalesce(sum(p.importe),0) from doctopago P
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,5) AND  P.TIPOPAGOID = 2
    INTO :EGRESO;


    EGRESO = :EGRESO + :PAGOPROVEEDORES + :RETIRO;


     INGRESO = :INGRESO + :INGRESOCREDITO;  
     EGRESO = :EGRESO + :EGRESOCREDITO;*/


     SELECT INGRESO, EGRESO, DEVOLUCION, RETIRO, PAGOPROVEEDORES,
     INGRESOEFECTIVO, INGRESOCREDITO, INGRESOCHEQUE, CAMBIOCHEQUE, INGRESOVALE, INGRESOTARJETA,
     EGRESOEFECTIVO, EGRESOCREDITO, EGRESOCHEQUE, EGRESOVALE, EGRESOTARJETA , TOTAL
     FROM CORTE_CALCULO_TOTALES WHERE CORTEID = :CORTEID
     INTO :INGRESO, :EGRESO, :DEVOLUCION, :RETIRO, :PAGOPROVEEDORES,
     :INGRESOEFECTIVO, :INGRESOCREDITO, :INGRESOCHEQUE, :CAMBIOCHEQUE, :INGRESOVALE, :INGRESOTARJETA,
     :EGRESOEFECTIVO, :EGRESOCREDITO, :EGRESOCHEQUE, :EGRESOVALE, :EGRESOTARJETA , :TOTALAFECTACION;






   SALDOFINAL = :SALDOINICIAL + :TOTALAFECTACION;  --+ :INGRESO - :EGRESO;

   UPDATE CORTE
   SET
      INGRESO = :INGRESO,
      EGRESO = :EGRESO,
      SALDOFINAL = :SALDOFINAL,
      DEVOLUCION = :DEVOLUCION,
        NUMEROTICKETS = :TICKETSVENTA,
        NUMERODEVOLUCIONES = :TICKETSDEVOLUCION ,
        INGRESOEFECTIVO = :INGRESOEFECTIVO,
        INGRESOTARJETA = :INGRESOTARJETA,
        INGRESOCREDITO = :INGRESOCREDITO,    
        INGRESOCHEQUE = :INGRESOCHEQUE ,
        INGRESOVALE = :INGRESOVALE ,
        CAMBIOCHEQUE = :CAMBIOCHEQUE,
        INGRESOPORIVA = :INGRESOPORIVA,
        INGRESOSUBTOTAL = :INGRESOSUBTOTAL,
        INGRESODESCUENTO = :INGRESODESCUENTO,
        INGRESOIMPORTE = :INGRESOIMPORTE,
        RETIRO = :RETIRO ,
        PAGOPROVEEDORES = :PAGOPROVEEDORES,
        EGRESOEFECTIVO = :EGRESOEFECTIVO,
        EGRESOTARJETA = :EGRESOTARJETA,
        EGRESOCREDITO = :EGRESOCREDITO,
        EGRESOCHEQUE = :EGRESOCHEQUE ,
        EGRESOVALE = :EGRESOVALE




   WHERE ID = :CORTEID;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1022;
      SUSPEND;
   END
END