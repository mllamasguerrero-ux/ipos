create or alter procedure INVFIS_PREPARARCIERRE (
    DOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable TIPODOCTOID D_FK;
declare variable ESTATUSDOCTOID D_FK;
BEGIN

  ERRORCODE = 0;

   SELECT TIPODOCTOID, ESTATUSDOCTOID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :TIPODOCTOID, :ESTATUSDOCTOID;

   -- Interceptar docto no existente
   IF ((:TIPODOCTOID IS NULL) OR (:ESTATUSDOCTOID IS NULL)) THEN
   BEGIN
      ERRORCODE = 10710;
      SUSPEND;
      EXIT;
   END

   -- Solo admitir TipoDocto = 50, captura de inventario fisico.
   IF (:TIPODOCTOID NOT IN (50,53)) THEN
   BEGIN
      ERRORCODE = 1071;
      SUSPEND;
      EXIT;
   END

   -- Solo admitir EstatusDocto = 0, Borrador.
   IF (:ESTATUSDOCTOID != 0 AND :ESTATUSDOCTOID != 3) THEN
   BEGIN
      ERRORCODE = 1072;
      SUSPEND;
      EXIT;
   END


   DELETE FROM inventario WHERE PRODUCTOID NOT IN (SELECT ID FROM PRODUCTO );

   DELETE FROM MOVTO WHERE PRODUCTOID NOT IN (SELECT ID FROM PRODUCTO) AND DOCTOID = :DOCTOID;

   UPDATE INVENTARIO SET LOTE = 'XXX'
   WHERE ID IN
   (SELECT INVENTARIO.ID FROM inventario
    inner JOIN PRODUCTO ON PRODUCTO.ID = INVENTARIO.PRODUCTOID
    WHERE COALESCE(LOTE,'') = ''  AND PRODUCTO.manejalote = 'S'  ) ;

    
   UPDATE INVENTARIO SET FECHAVENCE = CURRENT_DATE
   WHERE ID IN
   (SELECT INVENTARIO.ID FROM inventario
    inner JOIN PRODUCTO ON PRODUCTO.ID = INVENTARIO.PRODUCTOID
    WHERE INVENTARIO.FECHAVENCE IS NULL  AND PRODUCTO.manejalote = 'S'  ) ;


    
   UPDATE MOVTO SET LOTE = 'XXX'
   WHERE ID IN
   (SELECT MOVTO.ID FROM MOVTO
    inner JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
    WHERE MOVTO.DOCTOID = :DOCTOID AND COALESCE(MOVTO.LOTE,'') = ''  AND PRODUCTO.manejalote = 'S'  ) ;

    
   UPDATE MOVTO SET FECHAVENCE = CURRENT_DATE
   WHERE ID IN
   (SELECT MOVTO.ID FROM MOVTO
    inner JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
    WHERE MOVTO.DOCTOID = :DOCTOID AND MOVTO.FECHAVENCE IS NULL  AND PRODUCTO.manejalote = 'S'  ) ;



   -- Regresar el errorcode que haya, sea 0 o No;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
     ERRORCODE = 8076;
     SUSPEND;
   END
END
