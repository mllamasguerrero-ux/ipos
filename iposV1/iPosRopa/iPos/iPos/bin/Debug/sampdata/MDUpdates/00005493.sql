create or alter procedure DOCTO_RECALCULAR_GASTOSADIC (
    DOCTORECALCULARID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTORECALCULARID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable LOTEIMPORTADO D_FK;
declare variable TOTALGASTOSADIC D_PRECIO;
declare variable TOTALORIGINALDOCTO D_PRECIO;
declare variable MOVTOTOTALORIGINAL D_PRECIO;
declare variable MOVTOTOTALNUEVO D_PRECIO;
declare variable RESTANTEGASTOSADIC D_PRECIO;
declare variable RESTANTEORIGINALDOCTO D_PRECIO;
declare variable FACTORGASTOSADIC numeric(18,4);
declare variable COSTONUEVO D_PRECIO;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID , TOTAL
   FROM DOCTO
   WHERE ID = :DOCTORECALCULARID
   INTO :ESTATUSDOCTOID, :TIPODOCTORECALCULARID, :TOTALORIGINALDOCTO;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 0 AND :TIPODOCTORECALCULARID <> 16) THEN
   BEGIN
      ERRORCODE = 1082;
      SUSPEND;
      EXIT;
   END

   -- Si no es compra.
   IF (:TIPODOCTORECALCULARID NOT IN (11,16)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   SELECT SUM(movtogastosadic.monto) FROM MOVTOGASTOSADIC WHERE DOCTOID = :DOCTORECALCULARID INTO :TOTALGASTOSADIC;

   IF(COALESCE(:TOTALGASTOSADIC,0) <= 0) THEN
   BEGIN
      ERRORCODE = 0;
      SUSPEND;
      EXIT;
   END

      
   RESTANTEGASTOSADIC = :TOTALGASTOSADIC ;
   RESTANTEORIGINALDOCTO = :TOTALORIGINALDOCTO;



   -- Leer del DOCTO a recalcular.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID
   FROM DOCTO
   WHERE ID = :DOCTORECALCULARID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID;



   -- Agrega los MOVTO.
   


   FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, 
      TIPODIFERENCIAINVENTARIOID , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3, LOTEIMPORTADO, TOTAL
   FROM MOVTO
   WHERE DOCTOID = :DOCTORECALCULARID
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :LOTEIMPORTADO, :MOVTOTOTALORIGINAL
   DO
   BEGIN

       FACTORGASTOSADIC =  (:RESTANTEORIGINALDOCTO +  :RESTANTEGASTOSADIC) /  :RESTANTEORIGINALDOCTO;
       COSTONUEVO = ROUND( (:COSTO * :FACTORGASTOSADIC) , 2);

      SELECT ERRORCODE
      FROM MOVTO_INSERT (
         :DOCTORECALCULARID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTORECALCULARID, 0, 0, :PERSONAID, 5, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, /*:CANTIDAD*/0, 0, 0, 0, 0, /*:PRECIO*/NULL, 0,
         /*:REFERENCIA*/ '', /*:REFERENCIAS*/ '', :COSTONUEVO, :SUCURSALID, :ALMACENID, 'N',
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, null,NULL ,NULL,NULL,:MOVTOID,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL, :LOTEIMPORTADO , 'N','N'
      ) INTO :ERRORCODE;

        IF(:ERRORCODE <> 0) THEN
        BEGIN
          SUSPEND;
          EXIT;
        END

          
         SELECT TOTAL FROM MOVTO WHERE ID = :MOVTOID INTO :MOVTOTOTALNUEVO;

        RESTANTEGASTOSADIC = :RESTANTEGASTOSADIC - (:MOVTOTOTALNUEVO - :MOVTOTOTALORIGINAL ) ;
        RESTANTEORIGINALDOCTO = :RESTANTEORIGINALDOCTO - :MOVTOTOTALORIGINAL ;




   END


   UPDATE DOCTO SET GASTOSADICAPLICADOS =  TOTAL - :TOTALORIGINALDOCTO
     WHERE ID = :DOCTORECALCULARID ;



   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END