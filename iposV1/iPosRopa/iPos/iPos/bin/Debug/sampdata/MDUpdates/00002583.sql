create or alter procedure PERSONA_USUARIO_UPDATE (
    PERSONAID D_FK,
    CLAVE D_CLAVE,
    NOMBRE D_NOMBRE,
    USERNAME D_STDTEXT_SHORT,
    EMPRESAID D_FK,
    VIGENCIA D_FECHA,
    GAFFETE D_CLAVE_NULL,
    LISTAPRECIOID D_FK,
    TICKETLARGO D_BOOLCN,
    ALMACENID D_FK,
    CAJASBOTELLAS D_STDTEXT_MEDIUM,
    TICKETLARGOCREDITO D_BOOLCN,
    VENDEDORID D_FK)
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable REPETIDOS integer;
BEGIN

   ERRORCODE = 0;
   REPETIDOS = 0;

    SELECT COUNT(*) FROM PERSONA WHERE GAFFETE IS NOT NULL AND GAFFETE =:GAFFETE
    AND id <> :personaid into  :REPETIDOS;

    IF(COALESCE(:REPETIDOS ,0) > 0) THEN
    begin
         ERRORCODE = 3002;
         SUSPEND;
         EXIT;
    end 
    
    ALMACENID = case WHEN COALESCE(:ALMACENID,0) = 0 THEN 1 ELSE :ALMACENID END;

   UPDATE PERSONA 
   SET
    CLAVE = :CLAVE,
    NOMBRE = :NOMBRE,
    USERNAME = :USERNAME,
    EMPRESAID = :EMPRESAID,
    VIGENCIA  = :VIGENCIA,
    GAFFETE = :GAFFETE  ,
    LISTAPRECIOID = :LISTAPRECIOID ,
    TICKETLARGO = :TICKETLARGO,
    ALMACENID = :ALMACENID ,
    CAJASBOTELLAS = :CAJASBOTELLAS ,
    TICKETLARGOCREDITO = :TICKETLARGOCREDITO ,
    VENDEDORID = :VENDEDORID
   WHERE ID =  :PERSONAID;

   SUSPEND;
END