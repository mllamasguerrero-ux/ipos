create or alter procedure CORTE_TOTALES_PORID (
    CORTEID D_FK)
returns (
    FECHACORTE D_FECHA,
    SALDOINICIAL D_IMPORTE,
    INGRESO D_IMPORTE,
    EGRESO D_IMPORTE,
    DEVOLUCION D_IMPORTE,
    SALDOFINAL D_IMPORTE,
    APORTACION D_IMPORTE,
    RETIRO D_IMPORTE,
    INGRESOTARJETA D_IMPORTE,
    INGRESOEFECTIVO D_IMPORTE,
    INGRESOCREDITO D_IMPORTE,
    INGRESOCHEQUE D_IMPORTE,
    INGRESOVALE D_IMPORTE,
    CAMBIOCHEQUE D_IMPORTE,
    SALDOREAL D_IMPORTE,
    PAGOPROVEEDORES D_IMPORTE,
    EGRESOTARJETA D_IMPORTE,
    EGRESOEFECTIVO D_IMPORTE,
    EGRESOCREDITO D_IMPORTE,
    EGRESOCHEQUE D_IMPORTE,
    EGRESOVALE D_IMPORTE,
    SALDOREALCREDITO D_IMPORTE,
    INGRESOMONEDERO D_IMPORTE,
    EGRESOMONEDERO D_IMPORTE,
    INGRESOTRANSFERENCIA D_IMPORTE,
    EGRESOTRANSFERENCIA D_IMPORTE,
    INGRESOINDEFINIDO D_IMPORTE,
    EGRESOINDEFINIDO D_IMPORTE,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCN;
declare variable TICKETSVENTA integer;
declare variable TICKETSDEVOLUCION integer;
declare variable INGRESOPORIVA D_IMPORTE;
declare variable INGRESOSUBTOTAL D_IMPORTE;
declare variable INGRESODESCUENTO D_IMPORTE;
declare variable INGRESOIMPORTE D_IMPORTE;
declare variable TOTALAFECTACION D_IMPORTE;
declare variable SUBTOTALSINIVA D_IMPORTE;
declare variable SUBTOTALCONIVA D_IMPORTE;
declare variable MONTOIVA D_IMPORTE;
declare variable MONTOIEPS D_IMPORTE;
declare variable MONTOIMPUESTO D_IMPORTE;
declare variable MANEJAIEPS D_BOOLCN;
declare variable DEVOLUCIONEFECTIVO D_IMPORTE;
declare variable DEVOLUCIONCREDITO D_IMPORTE;
declare variable DEVOLUCIONTARJETA D_IMPORTE;
declare variable DEVOLUCIONCHEQUE D_IMPORTE;
declare variable DEVOLUCIONVALE D_IMPORTE;
declare variable DEVOLUCIONMONEDERO D_IMPORTE;
declare variable DEVOLUCIONTRANSFERENCIA D_IMPORTE;
declare variable DEVOLUCIONINDEFINIDO D_IMPORTE;
declare variable RETIROSDECAJA D_IMPORTE;
declare variable GASTOS D_IMPORTE;
BEGIN


   ERRORCODE = 0;

    
   IF (:CORTEID IS NULL) THEN
   BEGIN
      ERRORCODE = 1020;
      SUSPEND;
      EXIT;
   END


   SELECT  ACTIVO, SALDOINICIAL, APORTACION, RETIRO, FECHACORTE , SALDOREAL, coalesce(SALDOREALCREDITO,0)
   FROM CORTE
   WHERE ID = :CORTEID
   INTO :ACTIVO, :SALDOINICIAL, :APORTACION, :RETIRO,  :FECHACORTE, :SALDOREAL, :SALDOREALCREDITO;


   IF (:ACTIVO <> 'S') THEN
   BEGIN
      ERRORCODE = 1021;
      SUSPEND;
      EXIT;
   END







    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.iva,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16) AND  P.TIPOPAGOID = 1
    INTO :INGRESOPORIVA;

            
     select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.subtotal,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16) AND  P.TIPOPAGOID = 1
    INTO :INGRESOSUBTOTAL;

    
    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.descuento,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16) AND  P.TIPOPAGOID = 1
    INTO :INGRESODESCUENTO;

    
    select  coalesce(sum(p.importe * (case when coalesce(d.total,0) = 0 then 0 else (coalesce(d.importe,0)/d.total) end)),0)  from doctopago P
    INNER JOIN docto D ON p.doctoid = d.id
    WHERE P.CORTEID = :CORTEID AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16) AND  P.TIPOPAGOID = 1
    INTO :INGRESOIMPORTE;




   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 21
     AND FECHA = :FECHACORTE
     AND CORTEID = :CORTEID
     --AND SUCURSALID = :SUCURSALID
     --AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID IN (1, 2)
   INTO :TICKETSVENTA;









   SELECT COALESCE(COUNT(*), 0)
   FROM DOCTO
   WHERE TIPODOCTOID = 23
     AND FECHA = :FECHACORTE  
     AND CORTEID = :CORTEID
     --AND SUCURSALID = :SUCURSALID
     --AND VENDEDORID = :CAJEROID
      AND ESTATUSDOCTOID = 1
   INTO :TICKETSDEVOLUCION;





     SELECT INGRESO, EGRESO, DEVOLUCION, RETIRO, PAGOPROVEEDORES,
     INGRESOEFECTIVO, INGRESOCREDITO, INGRESOCHEQUE, CAMBIOCHEQUE, INGRESOVALE, INGRESOTARJETA,
     EGRESOEFECTIVO, EGRESOCREDITO, EGRESOCHEQUE, EGRESOVALE, EGRESOTARJETA , TOTAL, INGRESOMONEDERO, EGRESOMONEDERO ,
     cast(SUBTOTALSINIVA as d_importe),
     cast(SUBTOTALCONIVA as d_importe),
     cast(MONTOIVA as d_importe),
     INGRESOTRANSFERENCIA, EGRESOTRANSFERENCIA,
     INGRESOINDEFINIDO, EGRESOINDEFINIDO ,
     cast(MONTOIEPS as d_importe),     
     cast(MONTOIMPUESTO as d_importe),
     DEVOLUCIONEFECTIVO, DEVOLUCIONCREDITO, DEVOLUCIONTARJETA, DEVOLUCIONCHEQUE, DEVOLUCIONVALE, DEVOLUCIONMONEDERO, DEVOLUCIONTRANSFERENCIA, DEVOLUCIONINDEFINIDO,
     RETIROSDECAJA, GASTOS
     FROM CORTE_CALCULO_TOTALES WHERE CORTEID = :CORTEID
     INTO :INGRESO, :EGRESO, :DEVOLUCION, :RETIRO, :PAGOPROVEEDORES,
     :INGRESOEFECTIVO, :INGRESOCREDITO, :INGRESOCHEQUE, :CAMBIOCHEQUE, :INGRESOVALE, :INGRESOTARJETA,
     :EGRESOEFECTIVO, :EGRESOCREDITO, :EGRESOCHEQUE, :EGRESOVALE, :EGRESOTARJETA , :TOTALAFECTACION, :INGRESOMONEDERO, :EGRESOMONEDERO,
     :SUBTOTALSINIVA, :SUBTOTALCONIVA , :MONTOIVA,
     :INGRESOTRANSFERENCIA, :EGRESOTRANSFERENCIA,
     :INGRESOINDEFINIDO, :EGRESOINDEFINIDO,
     :MONTOIEPS, :MONTOIMPUESTO,
     :DEVOLUCIONEFECTIVO, :DEVOLUCIONCREDITO, :DEVOLUCIONTARJETA, :DEVOLUCIONCHEQUE, :DEVOLUCIONVALE, :DEVOLUCIONMONEDERO, :DEVOLUCIONTRANSFERENCIA, :DEVOLUCIONINDEFINIDO,
     :RETIROSDECAJA, :GASTOS
     ;






   SALDOFINAL = :SALDOINICIAL + :TOTALAFECTACION;  --+ :INGRESO - :EGRESO;

   UPDATE CORTE
   SET
      INGRESO = :INGRESO,
      EGRESO = :EGRESO,
      SALDOFINAL = :SALDOFINAL,
      DEVOLUCION = :DEVOLUCION,
        NUMEROTICKETS = :TICKETSVENTA,
        NUMERODEVOLUCIONES = :TICKETSDEVOLUCION ,
        INGRESOEFECTIVO = :INGRESOEFECTIVO,
        INGRESOTARJETA = :INGRESOTARJETA,
        INGRESOCREDITO = :INGRESOCREDITO,    
        INGRESOCHEQUE = :INGRESOCHEQUE ,
        INGRESOVALE = :INGRESOVALE ,
        CAMBIOCHEQUE = :CAMBIOCHEQUE,
        INGRESOPORIVA = :INGRESOPORIVA,
        INGRESOSUBTOTAL = :INGRESOSUBTOTAL,
        INGRESODESCUENTO = :INGRESODESCUENTO,
        INGRESOIMPORTE = :INGRESOIMPORTE,
        RETIRO = :RETIRO ,
        PAGOPROVEEDORES = :PAGOPROVEEDORES,
        EGRESOEFECTIVO = :EGRESOEFECTIVO,
        EGRESOTARJETA = :EGRESOTARJETA,
        EGRESOCREDITO = :EGRESOCREDITO,
        EGRESOCHEQUE = :EGRESOCHEQUE ,
        EGRESOVALE = :EGRESOVALE   ,
        INGRESOMONEDERO = :INGRESOMONEDERO,
        EGRESOMONEDERO = :EGRESOMONEDERO,

        SUBTOTALSINIVA = :SUBTOTALSINIVA, 
        SUBTOTALCONIVA = :SUBTOTALCONIVA,
        MONTOIVA = :MONTOIVA  ,

        INGRESOTRANSFERENCIA = :INGRESOTRANSFERENCIA,
        EGRESOTRANSFERENCIA = :EGRESOTRANSFERENCIA,
        INGRESOINDEFINIDO = :INGRESOINDEFINIDO,
        EGRESOINDEFINIDO = :EGRESOINDEFINIDO,
        MONTOIEPS = :MONTOIEPS ,
        MONTOIMPUESTO = :MONTOIMPUESTO ,
        DEVOLUCIONEFECTIVO = :DEVOLUCIONEFECTIVO,
        DEVOLUCIONCREDITO = :DEVOLUCIONCREDITO,
        DEVOLUCIONTARJETA = :DEVOLUCIONTARJETA,
        DEVOLUCIONCHEQUE = :DEVOLUCIONCHEQUE,
        DEVOLUCIONVALE = :DEVOLUCIONVALE,
        DEVOLUCIONMONEDERO = :DEVOLUCIONMONEDERO,
        DEVOLUCIONTRANSFERENCIA = :DEVOLUCIONTRANSFERENCIA,
        DEVOLUCIONINDEFINIDO = :DEVOLUCIONINDEFINIDO ,

        RETIROSDECAJA = :RETIROSDECAJA,
        GASTOS = :GASTOS





   WHERE ID = :CORTEID;






   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1022;
      SUSPEND;
   END
END
