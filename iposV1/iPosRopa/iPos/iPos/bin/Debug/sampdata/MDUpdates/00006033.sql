create or alter procedure REP_VENTA_CONIEPS_PRODDIA (
    FECHAINI D_FECHA,
    FECHAFIN D_FECHA,
    STR_REMISIONFACTURA D_STDTEXT_LIGHT)
returns (
    NUMERO integer,
    FECHA D_FECHA,
    SUBTOTAL D_IMPORTE,
    IVA D_IMPORTE,
    TOTAL D_IMPORTE,
    ESFACTURAELECTRONICA D_BOOLCN,
    IEPS D_IMPORTE,
    IMPUESTO D_IMPORTE,
    IEPS_01_IMPORTE D_IMPORTE,
    IEPS_01_PORC D_PORCENTAJE,
    IEPS_02_IMPORTE D_IMPORTE,
    IEPS_02_PORC D_PORCENTAJE,
    IEPS_03_IMPORTE D_IMPORTE,
    IEPS_03_PORC D_PORCENTAJE,
    IEPS_04_IMPORTE D_IMPORTE,
    IEPS_04_PORC D_PORCENTAJE,
    IEPS_05_IMPORTE D_IMPORTE,
    IEPS_05_PORC D_PORCENTAJE,
    IEPS_06_IMPORTE D_IMPORTE,
    IEPS_06_PORC D_PORCENTAJE,
    IEPS_07_IMPORTE D_IMPORTE,
    IEPS_07_PORC D_PORCENTAJE,
    IEPS_08_IMPORTE D_IMPORTE,
    IEPS_08_PORC D_PORCENTAJE,
    IEPS_09_IMPORTE D_IMPORTE,
    IEPS_09_PORC D_PORCENTAJE,
    IEPS_10_IMPORTE D_IMPORTE,
    IEPS_10_PORC D_PORCENTAJE,
    ESTATUS D_STDTEXT_MEDIUM,
    PRODUCTOID D_FK,
    PRODUCTOCLAVE D_CLAVE,
    PRODUCTONOMBRE D_NOMBRE,
    PRODUCTODESCRIPCION D_DESCRIPCION,
    MARCAID D_FK,
    MARCACLAVE D_CLAVE,
    MARCANOMBRE D_NOMBRE,
    IEPS_01_GPOIMP D_CLAVE_NULL,
    IEPS_02_GPOIMP D_CLAVE_NULL,
    IEPS_03_GPOIMP D_CLAVE_NULL,
    IEPS_04_GPOIMP D_CLAVE_NULL,
    IEPS_05_GPOIMP D_CLAVE_NULL,
    IEPS_06_GPOIMP D_CLAVE_NULL,
    IEPS_07_GPOIMP D_CLAVE_NULL,
    IEPS_08_GPOIMP D_CLAVE_NULL,
    IEPS_09_GPOIMP D_CLAVE_NULL,
    IEPS_10_GPOIMP D_CLAVE_NULL)
as
declare variable IEPS_X_IMPORTE D_IMPORTE;
declare variable IEPS_X_PORC D_PORCENTAJE;   
declare variable IEPS_X_GPOIMP D_CLAVE_NULL;
declare variable CUENTA integer;
declare variable TIPODOCTOID D_FK;
declare variable REMISIONFACTURA integer;
BEGIN

   if(:str_remisionfactura = 'F') then
    begin
      REMISIONFACTURA = 2;
    end
    else  if(:str_remisionfactura = 'R') then
    begin
        REMISIONFACTURA = 1;
    end
    else
    begin
      REMISIONFACTURA = 0;
    end

   TIPODOCTOID = 21;

   NUMERO = 0;
   CUENTA = 1;


    IEPS_01_PORC  = -1;
    IEPS_02_PORC  = -1;
    IEPS_03_PORC  = -1;
    IEPS_04_PORC  = -1;
    IEPS_05_PORC  = -1;
    IEPS_06_PORC  = -1;
    IEPS_07_PORC  = -1;
    IEPS_08_PORC  = -1;
    IEPS_09_PORC  = -1;
    IEPS_10_PORC  = -1;
    
    IEPS_01_GPOIMP = '';
    IEPS_02_GPOIMP = '';
    IEPS_03_GPOIMP = '';
    IEPS_04_GPOIMP = '';
    IEPS_05_GPOIMP = '';
    IEPS_06_GPOIMP = '';
    IEPS_07_GPOIMP = '';
    IEPS_08_GPOIMP = '';
    IEPS_09_GPOIMP = '';
    IEPS_10_GPOIMP = '';

    ESTATUS = 'REMISION';


  FOR SELECT
       coalesce(m.TASAIEPS, 0) ,  COALESCE(LINEA.GPOIMP,'')
       FROM MOVTO M
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID 
            LEFT JOIN PRODUCTO ON M.PRODUCTOID = PRODUCTO.ID
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
      WHERE ( D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23))
          OR (:TIPODOCTOID = -31 AND d.TIPODOCTOID IN (31,81)) )
     AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
     AND D.ESTATUSDOCTOID = 1
    group by m.tasaieps ,COALESCE(LINEA.GPOIMP,'')
    order by m.tasaieps desc
    INTO :IEPS_X_PORC   , :IEPS_X_GPOIMP
    DO
    BEGIN
        IF(:CUENTA = 1 ) THEN
        BEGIN
            IEPS_01_PORC =  :IEPS_X_PORC;
            IEPS_01_GPOIMP = :IEPS_X_GPOIMP;
        END        
        IF(:CUENTA = 2 ) THEN
        BEGIN
            IEPS_02_PORC =  :IEPS_X_PORC;  
            IEPS_02_GPOIMP = :IEPS_X_GPOIMP;
        END        
        IF(:CUENTA = 3 ) THEN
        BEGIN
            IEPS_03_PORC =  :IEPS_X_PORC;
            IEPS_03_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 4 ) THEN
        BEGIN
            IEPS_04_PORC =  :IEPS_X_PORC;   
            IEPS_04_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 5 ) THEN
        BEGIN
            IEPS_05_PORC =  :IEPS_X_PORC;  
            IEPS_05_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 6 ) THEN
        BEGIN
            IEPS_06_PORC =  :IEPS_X_PORC;  
            IEPS_06_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 7 ) THEN
        BEGIN
            IEPS_07_PORC =  :IEPS_X_PORC;  
            IEPS_07_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 8 ) THEN
        BEGIN
            IEPS_08_PORC =  :IEPS_X_PORC;
            IEPS_08_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 9 ) THEN
        BEGIN
            IEPS_09_PORC =  :IEPS_X_PORC; 
            IEPS_09_GPOIMP = :IEPS_X_GPOIMP;
        END 
        IF(:CUENTA = 10 ) THEN
        BEGIN
            IEPS_10_PORC =  :IEPS_X_PORC; 
            IEPS_10_GPOIMP = :IEPS_X_GPOIMP;
        END
        CUENTA = CUENTA + 1;
    END




   FOR SELECT
      D.FECHA,
      SUM(COALESCE(M.SUBTOTAL,0)) SUBTOTAL,
      SUM(COALESCE(M.IVA,0)) IVA,
      SUM(COALESCE(M.TOTAL,0)) TOTAL,
      D.esfacturaelectronica FACTURAELECTRONICA,

      SUM(COALESCE(M.IEPS,0))  IEPS,
      SUM(COALESCE(M.IMPUESTO,0)) IMPUESTO,


      CASE WHEN COALESCE(D.ESFACTURAELECTRONICA,'N') <> 'S' THEN 'REMISION' ELSE 'FACTURA' END ESTATUS ,
      M.PRODUCTOID PRODUCTOID,
      P.CLAVE PRODUCTOCLAVE,
      P.NOMBRE PRODUCTONOMBRE,
      P.DESCRIPCION PRODUCTODESCRIPCION  ,
      P.MARCAID MARCAID,
      R.CLAVE MARCACLAVE,
      R.NOMBRE MARCANOMBRE



   FROM DOCTO D
       Inner join MOVTO M
         ON M.doctoid = D.ID
        INNER JOIN PRODUCTO P
        ON P.id = M.productoid
        INNER JOIN MARCA R
        ON R.ID = P.MARCAID
   WHERE (d.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND d.TIPODOCTOID IN (21,31,23,81))
          OR (:TIPODOCTOID = -31 AND d.TIPODOCTOID IN (31,81)) )
     AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
     AND D.ESTATUSDOCTOID = 1
     AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
     AND COALESCE(m.IEPS,0) > 0

     GROUP BY D.FECHA,D.ESFACTURAELECTRONICA  ,m.productoid,P.CLAVE ,P.NOMBRE , P.DESCRIPCION, P.MARCAID,  R.CLAVE , R.NOMBRE
   INTO
      :FECHA ,
      :SUBTOTAL,
      :IVA ,
      :TOTAL ,
      :ESFACTURAELECTRONICA  ,
      :IEPS,
      :IMPUESTO ,
      :ESTATUS  ,
      :PRODUCTOID,
      :PRODUCTOCLAVE ,
      :PRODUCTONOMBRE ,
      :PRODUCTODESCRIPCION ,
      :MARCAID,
      :MARCACLAVE ,
      :MARCANOMBRE 


   DO
   BEGIN
        IF(:IEPS_01_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
                AND MOVTO.TASAIEPS = :IEPS_01_PORC   AND (COALESCE(:IEPS_01_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_01_IMPORTE = :IEPS_X_IMPORTE;
        END
        
        IF(:IEPS_02_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID    
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_02_PORC  AND (COALESCE(:IEPS_02_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_02_IMPORTE = :IEPS_X_IMPORTE;
        END

        
        IF(:IEPS_03_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID  
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_03_PORC  AND (COALESCE(:IEPS_03_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_03_IMPORTE = :IEPS_X_IMPORTE;
        END

        
        IF(:IEPS_04_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID   
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_04_PORC  AND (COALESCE(:IEPS_04_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_04_IMPORTE = :IEPS_X_IMPORTE;
        END
              
        IF(:IEPS_05_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID 
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_05_PORC AND (COALESCE(:IEPS_05_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_05_IMPORTE = :IEPS_X_IMPORTE;
        END       
              
        IF(:IEPS_06_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID   
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_06_PORC  AND (COALESCE(:IEPS_06_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_06_IMPORTE = :IEPS_X_IMPORTE;
        END        
              
        IF(:IEPS_07_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID   
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID  AND (COALESCE(:IEPS_07_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            AND MOVTO.TASAIEPS = :IEPS_07_PORC
            INTO :IEPS_X_IMPORTE;
            IEPS_07_IMPORTE = :IEPS_X_IMPORTE;
        END         
              
        IF(:IEPS_08_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID  
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_08_PORC   AND (COALESCE(:IEPS_08_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_08_IMPORTE = :IEPS_X_IMPORTE;
        END    
              
        IF(:IEPS_09_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID  
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_09_PORC AND (COALESCE(:IEPS_09_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_09_IMPORTE = :IEPS_X_IMPORTE;
        END        
              
        IF(:IEPS_10_PORC <> -1) THEN
        BEGIN     
            SELECT SUM(COALESCE(MOVTO.IEPS,0))
            FROM MOVTO
            INNER JOIN DOCTO D ON D.ID = MOVTO.DOCTOID   
            LEFT JOIN PRODUCTO ON MOVTO.PRODUCTOID = PRODUCTO.ID 
            LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
            WHERE (D.TIPODOCTOID = :TIPODOCTOID  OR (:TIPODOCTOID = -21 AND D.TIPODOCTOID IN (21,31,23,81))
                OR (:TIPODOCTOID = -31 AND D.TIPODOCTOID IN (31,81)) )
                AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
                AND D.ESTATUSDOCTOID = 1
                AND (:REMISIONFACTURA = 0 or (:REMISIONFACTURA = 1 AND Coalesce(D.esfacturaelectronica,'N') <> 'S') or (:REMISIONFACTURA = 2 AND Coalesce(D.esfacturaelectronica,'N') = 'S') )
                AND COALESCE(MOVTO.IEPS,0) > 0
                AND D.FECHA = :FECHA
                AND MOVTO.PRODUCTOID = :PRODUCTOID
            AND MOVTO.TASAIEPS = :IEPS_10_PORC AND (COALESCE(:IEPS_10_GPOIMP,'') = COALESCE(LINEA.GPOIMP,''))
            INTO :IEPS_X_IMPORTE;
            IEPS_10_IMPORTE = :IEPS_X_IMPORTE;
        END
      SUSPEND;
   END

   if (:numero = 0) then
   begin
      numero = 0;
      fecha = current_date;
      SUBTOTAL = 0.00;
      IVA = 0.00;
      TOTAL = 0.00;
      ESFACTURAELECTRONICA  = 'N';
      IEPS = 0;
      IMPUESTO = 0;
      -- sin suspend para no regresar renglon falso




      IEPS_01_IMPORTE = NULL;
      IEPS_01_PORC  = NULL;
      IEPS_02_IMPORTE  = NULL;
      IEPS_02_PORC   = NULL;
      IEPS_03_IMPORTE  = NULL;
      IEPS_03_PORC    = NULL;
      IEPS_04_IMPORTE  = NULL;
      IEPS_04_PORC    = NULL;
      IEPS_05_IMPORTE  = NULL;
      IEPS_05_PORC    = NULL;
      IEPS_06_IMPORTE = NULL;
      IEPS_06_PORC    = NULL;
      IEPS_07_IMPORTE  = NULL;
      IEPS_07_PORC    = NULL;
      IEPS_08_IMPORTE  = NULL;
      IEPS_08_PORC    = NULL;
      IEPS_09_IMPORTE  = NULL;
      IEPS_09_PORC    = NULL;
      IEPS_10_IMPORTE  = NULL;
      IEPS_10_PORC    = NULL;

      ESTATUS = 'REMISION';

            
    PRODUCTOID  = 0;
    PRODUCTOCLAVE = '';
    PRODUCTONOMBRE = '';
    PRODUCTODESCRIPCION= '';
    MARCAID = 0;
    MARCACLAVE = '';
    MARCANOMBRE = '';


   end

END