create or alter procedure GUIADETALLE_INSERT (
    GUIAID D_FK,
    DOCTOID D_FK,
    ENCARGADOGUIAID D_FK,
    ESTADOGUIAID D_FK,
    CAJEROID D_FK,
    FECHA D_FECHA,
    NOTA D_DESCRIPCION)
returns (
    GUIAIDRETORNO D_FK,
    GUIADETALLEID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable CORTEID2 D_FK;
declare variable FECHACORTE D_FECHA;
declare variable CUENTAGUIADET D_FK;
BEGIN

  -- FALTA COMPLETAR
  
   SELECT HAYCORTEACTIVO,CORTEID, FECHACORTE, ERRORCODE
   FROM HAY_CORTE_ACTIVO(:CAJEROID)
   INTO :HAYCORTEACTIVO, :CORTEID2, :FECHACORTE, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
        GUIAIDRETORNO = 0;
        GUIADETALLEID = 0;
        SUSPEND;
        EXIT;
   END


   IF(:FECHACORTE IS NULL or  COALESCE(:FECHACORTE,CURRENT_DATE) <> CURRENT_DATE) THEN
   BEGIN
        ERRORCODE = 1001;
        SUSPEND;
        EXIT;
   END


   IF(COALESCE(:GUIAID,0) = 0) THEN
   BEGIN

        INSERT INTO GUIA
        (ENCARGADOGUIAID , ESTADOGUIAID, cajeroid,  CORTEID, FECHA, FECHAHORA, NOTA)
        VALUES
        (:ENCARGADOGUIAID,  :ESTADOGUIAID  , :CAJEROID, :CORTEID2,  current_date,  CURRENT_TIME, :NOTA)
        RETURNING ID INTO :GUIAIDRETORNO;

        GUIAID = :GUIAIDRETORNO;

   END
   ELSE
   BEGIN
    GUIAIDRETORNO = :GUIAID;
   END


   SELECT ID FROM GUIADETALLE WHERE GUIAID = :GUIAID AND DOCTOID = :DOCTOID INTO :GUIADETALLEID;

   IF(COALESCE(:GUIADETALLEID,0) > 0) THEN
   BEGIN
        SUSPEND;
        EXIT;
   END

   INSERT INTO GUIADETALLE
   (  GUIAID, DOCTOID, ESTADOGUIAID)
   VALUES
   (:GUIAID, :DOCTOID, :ESTADOGUIAID)
   RETURNING ID  INTO :GUIADETALLEID;

   UPDATE DOCTO SET ESTADOGUIAID = :ESTADOGUIAID,
     GUIAID = :GUIAID WHERE ID = :DOCTOID;



   ERRORCODE = 0;
   SUSPEND;
END