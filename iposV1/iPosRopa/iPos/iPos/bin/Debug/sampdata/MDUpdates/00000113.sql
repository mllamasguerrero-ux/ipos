CREATE OR ALTER PROCEDURE INVFIS_GEN_COMPLETO (
    DOCTOID D_FK,
    PERSONAID D_FK)
RETURNS (
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE TIPODOCTOID D_FK;
DECLARE VARIABLE ESTATUSDOCTOID D_FK;
DECLARE VARIABLE PRODUCTOID D_FK;
DECLARE VARIABLE LOTE D_LOTE;
DECLARE VARIABLE FECHAVENCE D_FECHAVENCE;
DECLARE VARIABLE CANTIDAD D_CANTIDAD;
DECLARE VARIABLE COSTO D_COSTO;
DECLARE VARIABLE ALMACENID D_FK;
DECLARE VARIABLE SUCURSALID D_FK;
DECLARE VARIABLE DUMMY_DOCTOID D_FK;
DECLARE VARIABLE MOVTOID D_FK;
BEGIN
   SELECT TIPODOCTOID, ESTATUSDOCTOID, ALMACENID, SUCURSALID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :TIPODOCTOID, :ESTATUSDOCTOID, :ALMACENID, :SUCURSALID;
   
   -- Solo admitir TipoDocto = 50, captura de inventario fisico.
   IF (:TIPODOCTOID <> 50) THEN
   BEGIN
      ERRORCODE = 1071;
      SUSPEND;
      EXIT;
   END

   -- Solo admitir EstatusDocto = 0, Borrador.
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1072;
      SUSPEND;
      EXIT;
   END

   -- Insertar en el docto, los productos del inventario, con existencia, que no esten ya en el docto.
   FOR
      SELECT PRODUCTOID, CANTIDAD, LOTE, FECHAVENCE, COSTO
      FROM INVENTARIO
      WHERE CANTIDAD > 0
        AND PRODUCTOID NOT IN (SELECT PRODUCTOID FROM MOVTO WHERE DOCTOID = :DOCTOID)
      INTO :PRODUCTOID, :CANTIDAD, :LOTE, :FECHAVENCE, :COSTO 
   DO
   BEGIN
      SELECT DOCTOID, MOVTOID, ERRORCODE
      FROM MOVTO_INSERT(:DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1, 0,
         :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, 0, 0,
         '', '', :COSTO, 0, 0, 'N', 0, CURRENT_DATE, CURRENT_DATE)
      INTO :DUMMY_DOCTOID, :MOVTOID, :ERRORCODE;
      
      IF ((:ERRORCODE IS NOT NULL) AND (:ERRORCODE > 0)) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END
   END
   
   IF (:ERRORCODE <> 0) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END

   -- Regresar el errorcode que haya, sea 0 o No;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END
END
