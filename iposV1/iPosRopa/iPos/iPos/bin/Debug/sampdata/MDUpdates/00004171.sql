CREATE OR ALTER PROCEDURE KARDEX_INVENTARIO_UPDATE (
    DOCTOID D_FK,
    MOVTOID D_FK,
    PRODUCTOID D_FK,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    CANTIDAD D_CANTIDAD,
    PRECIO D_PRECIO,
    COSTO D_COSTO,
    ORIGENFISCALID D_FK,
    ESAPARTADO D_BOOLCN,
    KARDEXID D_FK,
    LOTEIMPORTADO D_FK)
RETURNS (
    OK D_BOOLCN,
    ERRORCODE D_ERRORCODE)
AS
declare variable SENTIDOINVENTARIO D_SENTIDO;
declare variable SENTIDOINVENTARIOAPARTADOS D_SENTIDO;
declare variable ALMACENID D_FK;
declare variable TIPODOCTOID D_FK;
BEGIN

   IF (:DOCTOID IS NULL) THEN
   BEGIN
      ERRORCODE = 1032;
   END
   
   IF (:MOVTOID IS NULL) THEN
   BEGIN
      ERRORCODE = 1033;
   END

   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1034;
   END

   SELECT SENTIDOINVENTARIO, ALMACENID, SENTIDOINVENTARIOAPARTADOS  , TIPODOCTOID
   FROM GET_DOCTO_PARAMS(:DOCTOID)
   INTO :SENTIDOINVENTARIO, :ALMACENID, :SENTIDOINVENTARIOAPARTADOS, :TIPODOCTOID;

   -- Aplicar el sentido del tipomovto
   IF(:ESAPARTADO = 'N') THEN
   BEGIN
    CANTIDAD = :SENTIDOINVENTARIO * :CANTIDAD;
   END
   ELSE
   BEGIN  
    CANTIDAD = :SENTIDOINVENTARIOAPARTADOS * :CANTIDAD;
   END

   IF(:TIPODOCTOID NOT IN (401,402,403,404)) THEN
   BEGIN

    SELECT OK, ERRORCODE
    FROM INVENTARIO_UI (
      :ALMACENID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO ,:ORIGENFISCALID,:ESAPARTADO, :KARDEXID , :LOTEIMPORTADO
    ) INTO :OK, :ERRORCODE;
   END

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1035;
      SUSPEND;
   END
END


