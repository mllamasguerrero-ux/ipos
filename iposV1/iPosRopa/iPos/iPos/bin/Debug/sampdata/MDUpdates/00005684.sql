CREATE OR ALTER VIEW INVENTARIOKITDESG_VIEW(
    ALMACENID,
    PRODUCTOID,
    LOTE,
    FECHAVENCE,
    CANTIDAD,
    COSTO,
    COSTOULTIMO,
    COSTOPROMEDIO,
    ULTIMAFECHACOMPRA,
    ULTIMAFECHAVENTA,
    CANTIDADINICIAL,
    FECHAINICIAL,
    ORIGENFISCALID,
    ESAPARTADO,
    LOTEIMPORTADO)
AS
SELECT

    TTQ.ALMACENID,
    TTQ.PRODUCTOID,
    TTQ.LOTE LOTE,
    TTQ.FECHAVENCE FECHAVENCE,
    SUM(COALESCE(TTQ.CANTIDAD,0)) CANTIDAD,
    MIN(COALESCE(TTQ.COSTO,0)) COSTO,
    MIN(COALESCE(TTQ.COSTOULTIMO,0)) COSTOULTIMO,
    MIN(COALESCE(TTQ.COSTOPROMEDIO,0)) COSTOPROMEDIO,
    MAX(TTQ.ULTIMAFECHACOMPRA) ULTIMAFECHACOMPRA,
    MAX(TTQ.ULTIMAFECHAVENTA) ULTIMAFECHAVENTA,
    MAX(COALESCE(TTQ.CANTIDADINICIAL,0)) CANTIDADINICIAL,
    MAX( TTQ.FECHAINICIAL) FECHAINICIAL,
    TTQ.ORIGENFISCALID,
    TTQ.ESAPARTADO,
    TTQ.LOTEIMPORTADO

    FROM

    (

SELECT
    INVENTARIO.ALMACENID,
    INVENTARIO.PRODUCTOID,
    INVENTARIO.LOTE,
    INVENTARIO.FECHAVENCE,
    INVENTARIO.CANTIDAD,
    INVENTARIO.COSTO,
    INVENTARIO.COSTOULTIMO,
    INVENTARIO.COSTOPROMEDIO,
    INVENTARIO.ULTIMAFECHACOMPRA,
    INVENTARIO.ULTIMAFECHAVENTA,
    INVENTARIO.CANTIDADINICIAL,
    INVENTARIO.FECHAINICIAL,
    INVENTARIO.ORIGENFISCALID,
    INVENTARIO.ESAPARTADO,
    INVENTARIO.LOTEIMPORTADO
    FROM
    INVENTARIO

    UNION ALL


   SELECT
    INVENTARIO.ALMACENID,
    KITSUNNIVEL_VIEW.PRODUCTOPARTEID PRODUCTOID,
    CASE WHEN PRODUCTO.MANEJALOTE = 'S' THEN 'KIT' ELSE NULL END LOTE,
    INVENTARIO.FECHAVENCE,
    CAST(COALESCE(KITSUNNIVEL_VIEW.CANTIDADPARTE,0) * COALESCE(INVENTARIO.CANTIDAD,0) AS D_CANTIDAD) CANTIDAD,
    PRODUCTO.COSTOPROMEDIO COSTO,
    PRODUCTO.COSTOULTIMO,
    PRODUCTO.COSTOPROMEDIO,
    PRODUCTO.ULTIMACOMPRA ULTIMAFECHACOMPRA,
    PRODUCTO.ULTIMAVENTA ULTIMAFECHAVENTA,
    INVENTARIO.CANTIDADINICIAL,
    INVENTARIO.FECHAINICIAL,
    INVENTARIO.ORIGENFISCALID,
    INVENTARIO.ESAPARTADO,
    INVENTARIO.LOTEIMPORTADO
    FROM
      KITSUNNIVEL KITSUNNIVEL_VIEW
       INNER JOIN  INVENTARIO ON INVENTARIO.PRODUCTOID = KITSUNNIVEL_VIEW.PRODUCTOID
       LEFT JOIN PRODUCTO ON PRODUCTO.ID = KITSUNNIVEL_VIEW.PRODUCTOPARTEID

       ) TTQ

       GROUP BY 
    TTQ.ALMACENID,
    TTQ.PRODUCTOID, 
    TTQ.LOTE,
    TTQ.FECHAVENCE,
    TTQ.ORIGENFISCALID,
    TTQ.ESAPARTADO,
    TTQ.LOTEIMPORTADO
;