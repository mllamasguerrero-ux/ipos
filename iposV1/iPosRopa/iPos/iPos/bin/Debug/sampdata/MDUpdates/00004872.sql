create or alter procedure CONSOLIDADO_ABONOS (
    FACTCONSID D_FK)
returns (
    IDPAGO D_FK,
    FOLIODOCTO D_FK,
    TIPODOCTONOMBRE D_NOMBRE_NULL,
    DOCTOFECHA D_FECHA,
    PAGOFECHA D_FECHA,
    CLIENTECLAVE D_CLAVE,
    CLIENTENOMBRE D_NOMBRE,
    ABONO D_PRECIO,
    FORMADEPAGO D_NOMBRE_NULL,
    BANCONOMBRE D_NOMBRE_NULL,
    REFERENCIABANCARIA D_STDTEXT_LIGHT,
    PAGOMES integer,
    PAGOANIO integer,
    PAGOANIOMES integer)
as
declare variable NUMERO integer;
BEGIN
   NUMERO = 0;


   FOR SELECT
         DOCTOPAGO.ID IDPAGO,
         DOCTO.folio FOLIODOCTO,
         TIPODOCTO.NOMBRE TIPODOCTONOMBRE,
         DOCTO.FECHA DOCTOFECHA,
         DOCTOPAGO.fecha PAGOFECHA,
         PERSONA.CLAVE CLIENTECLAVE,
         PERSONA.NOMBRE CLIENTENOMBRE,
         coalesce((DOCTOPAGO.importe *
          (CASE WHEN ((DOCTOPAGO.TIPOPAGOID = 1 AND DOCTOPAGO.FORMAPAGOID IN (1,2,3,5,6,14,15,16,18,20,21)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (7,19)))  THEN 1
                when ((DOCTOPAGO.TIPOPAGOID = 1 AND DOCTOPAGO.FORMAPAGOID IN (7,19)) or (DOCTOPAGO.TIPOPAGOID = 2 AND FORMAPAGOID IN (6,18))) THEN -1
                ELSE 0 END)
          ),0) as ABONO  ,
          FORMAPAGO.nombre FORMADEPAGO,
          BANCOS.NOMBRE BANCONOMBRE,
          DOCTOPAGO.referenciabancaria,
          EXTRACT(MONTH FROM DOCTOPAGO.FECHA) PAGOMES ,
          EXTRACT(YEAR FROM DOCTOPAGO.FECHA) PAGOANIO ,
          (EXTRACT(YEAR FROM DOCTOPAGO.FECHA) * 100 )  +  EXTRACT(MONTH FROM DOCTOPAGO.FECHA) PAGOANIOMES


          FROM DOCTO inner join DOCTOPAGO ON DOCTOPAGO.doctoid = DOCTO.ID
          LEFT JOIN PERSONA ON PERSONA.ID = DOCTO.PERSONAID
          LEFT JOIN TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID
          LEFT JOIN FORMAPAGO ON FORMAPAGO.ID = DOCTOPAGO.FORMAPAGOID
          LEFT JOIN BANCOS ON BANCOS.ID = DOCTOPAGO.banco

           WHERE DOCTO.FACTCONSID = :FACTCONSID AND DOCTO.TIPODOCTOID = 21
           and  coalesce((DOCTOPAGO.importe *
          (CASE WHEN ((DOCTOPAGO.TIPOPAGOID = 1 AND DOCTOPAGO.FORMAPAGOID IN (1,2,3,5,6,14,15,16,18,20,21)) or (TIPOPAGOID = 2 AND FORMAPAGOID IN (7,19)))  THEN 1
                when ((DOCTOPAGO.TIPOPAGOID = 1 AND DOCTOPAGO.FORMAPAGOID IN (7, 19)) or (DOCTOPAGO.TIPOPAGOID = 2 AND FORMAPAGOID IN (6, 18))) THEN -1
                ELSE 0 END)
          ),0) <> 0
          AND COALESCE(DOCTOPAGO.factconsid ,0) = 0



        UNION



         SELECT

            DOCTOPAGO.ID IDPAGO,
            DOCTO.folio FOLIODOCTO,
            TIPODOCTO.NOMBRE TIPODOCTONOMBRE,
            DOCTO.FECHA DOCTOFECHA,
            DOCTOPAGO.fecha PAGOFECHA,
            PERSONA.clave CLIENTECLAVE,
            PERSONA.NOMBRE CLIENTENOMBRE,

            coalesce((DOCTOPAGO.importe *
           (CASE WHEN ((DOCTOPAGO.TIPOPAGOID = 2 AND DOCTOPAGO.FORMAPAGOID IN (1,2,3,5,14,15,16,20,21)) )  THEN -1
                ELSE 0 END)),0) ABONO ,
          FORMAPAGO.nombre FORMADEPAGO,
          BANCOS.NOMBRE BANCONOMBRE,
          DOCTOPAGO.referenciabancaria,
          EXTRACT(MONTH FROM DOCTOPAGO.FECHA) PAGOMES   ,
          EXTRACT(YEAR FROM DOCTOPAGO.FECHA) PAGOANIO ,
          (EXTRACT(YEAR FROM DOCTOPAGO.FECHA) * 100 )  +  EXTRACT(MONTH FROM DOCTOPAGO.FECHA) PAGOANIOMES


        FROM    DOCTO  inner join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTO.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID
                LEFT JOIN PERSONA ON PERSONA.ID = DOCTO.PERSONAID  
                LEFT JOIN FORMAPAGO ON FORMAPAGO.ID = DOCTOPAGO.FORMAPAGOID
                LEFT JOIN BANCOS ON BANCOS.ID = DOCTOPAGO.banco


        WHERE DOCTO.FACTCONSID = :FACTCONSID AND DOCTO.TIPODOCTOID = 22



   INTO
           :IDPAGO,
           :FOLIODOCTO,
           :TIPODOCTONOMBRE,
           :DOCTOFECHA,
           :PAGOFECHA,
           :CLIENTECLAVE,
           :CLIENTENOMBRE,
           :ABONO     ,
           :FORMADEPAGO ,
           :BANCONOMBRE ,
           :REFERENCIABANCARIA ,
           :PAGOMES ,
           :PAGOANIO ,
           :PAGOANIOMES
   DO
   BEGIN
      NUMERO = :NUMERO + 1;
      SUSPEND;
   END

   if (:numero = 0) then
   begin
           IDPAGO = 0;
           FOLIODOCTO = 0;
           TIPODOCTONOMBRE = '';
           DOCTOFECHA = CURRENT_DATE;
           PAGOFECHA = CURRENT_DATE;
           CLIENTECLAVE = '';
           CLIENTENOMBRE = '';
           ABONO = 0.0;
           FORMADEPAGO  = '';
           BANCONOMBRE = '';
           REFERENCIABANCARIA = '';
           PAGOMES = 0;  
           PAGOANIO = 0;
           PAGOANIOMES = 0;
   end

END