CREATE OR ALTER trigger docto_bi for docto
active before insert position 5
AS
declare variable PENDMAXDIAS INTEGER;
declare variable COMISIONTARJETAEMPRESA D_PORCENTAJE;
declare variable IVACOMISIONTARJETAEMPRESA D_PORCENTAJE;
BEGIN
   IF ((NEW.ID IS NULL) OR (NEW.ID = 0)) THEN
    NEW.ID = GEN_ID(SEQ_DOCTO, 1);
    
   IF (NEW.ACTIVO IS NULL) THEN
    NEW.ACTIVO = 'Y';

   IF (NEW.CREADO IS NULL) THEN
    NEW.CREADO = CURRENT_TIMESTAMP;
    
   IF (NEW.MODIFICADO IS NULL) THEN
    NEW.MODIFICADO = CURRENT_TIMESTAMP;

   IF (NEW.FECHAHORA IS NULL) THEN
      NEW.FECHAHORA = CURRENT_TIMESTAMP;

   IF (NEW.FECHA IS NULL) THEN
      NEW.FECHA = CURRENT_DATE;

   IF (NEW.HORA IS NULL) THEN
      NEW.HORA = CURRENT_TIME;

      
   IF (NEW.ESFACTURAELECTRONICA IS NULL) THEN
      NEW.ESFACTURAELECTRONICA = 'N';

   NEW.ESTATUSDOCTOID = 0;
   NEW.ESTATUSDOCTOPAGOID = 0;
   NEW.ESTATUSDOCTOPEDIDOID = 0;

   /*SELECT CORTEID, CAJEROID, TURNOID
   FROM CAJA
   WHERE ID = NEW.CAJAID
   INTO NEW.CORTEID, NEW.CAJEROID, NEW.TURNOID;  */

   IF (COALESCE(NEW.CORTEID,0) = 0 ) THEN
   BEGIN
        SELECT CORTEID, PENDMAXDIAS
        FROM PERSONA
        WHERE ID = NEW.VENDEDORID
        INTO NEW.CORTEID, :PENDMAXDIAS ;

    
        IF (COALESCE(NEW.CORTEID,0) = 0 ) THEN
            EXCEPTION  ERR_DOCTO_INSERT;


   END


      
   SELECT FECHACORTE
   FROM CORTE
   WHERE ID = NEW.CORTEID
   INTO NEW.FECHACORTE;


   NEW.pendmaxfecha = DATEADD(COALESCE(:PENDMAXDIAS,0) day to NEW.FECHA);



   SELECT FIRST 1 COMISIONTARJETAEMPRESA, IVACOMISIONTARJETAEMPRESA FROM PARAMETRO  INTO :COMISIONTARJETAEMPRESA, :IVACOMISIONTARJETAEMPRESA;
   NEW.COMISIONTARJETAEMPRESA = :COMISIONTARJETAEMPRESA;
   NEW.ivacomisiontarjetaempresa = :IVACOMISIONTARJETAEMPRESA;


END