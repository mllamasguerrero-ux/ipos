CREATE OR ALTER trigger doctopago_ppc_insert_suc_tr for doctopago
active after insert position 9998
AS
declare variable CLAVEMATRIZ D_CLAVE_NULL;
declare variable SUCURSALCLAVE D_CLAVE_NULL; 
declare variable DESTINOSUCURSALCLAVE D_CLAVE_NULL;
declare variable DOCTOSALIDAID D_CLAVE_NULL; 
declare variable TIPODOCTOSALIDAID D_CLAVE_NULL; 
declare variable SUBTIPODOCTOSALIDAID D_CLAVE_NULL;
declare variable ESTATUSDOCTOID D_FK;

declare variable TIPODOCTOENTRADAID D_CLAVE_NULL;  
declare variable SUBTIPODOCTOENTRADAID D_CLAVE_NULL;  
declare variable HABPPC D_BOOLCN;

begin
  /* Trigger text */

  -- SI NO CUMPLE LA CONDICION PARA SEGUIR SALIRSE
  
  IF( NOT (NEW.FORMAPAGOID in (6,7) AND COALESCE(NEW.DOCTOSALIDAID,0) > 0  AND COALESCE(NEW.DOCTOID,0) > 0 AND
        COALESCE(NEW.TIPOPAGOID,0) in (1,2) AND COALESCE(NEW.TIPOABONOID,0) <> 3)) THEN
  BEGIN
        EXIT;
  END       

  SELECT SUCURSALNUMERO, HABPPC FROM PARAMETRO INTO :SUCURSALCLAVE, :HABPPC;

  IF(COALESCE(:HABPPC,'N') <> 'S') THEN
  BEGIN
    EXIT;
  END

  SELECT FIRST 1 CLAVEMATRIZ FROM MATRIZPRINCIPAL INTO :CLAVEMATRIZ;

  IF(COALESCE(:SUCURSALCLAVE,'') <> COALESCE(:CLAVEMATRIZ,'')) THEN
  BEGIN


  
    IF(NEW.FORMAPAGOID in (6,7) AND COALESCE(NEW.DOCTOSALIDAID,0) > 0  AND COALESCE(NEW.DOCTOID,0) > 0 AND
        COALESCE(NEW.TIPOPAGOID,0) in (1,2) AND COALESCE(NEW.TIPOABONOID,0) <> 3) THEN
    BEGIN

        SELECT DOCTO.TIPODOCTOID,  :CLAVEMATRIZ DESTINOSUCURSALCLAVE
        FROM DOCTO
        WHERE DOCTO.ID = NEW.DOCTOSALIDAID
        INTO :TIPODOCTOSALIDAID,  :DESTINOSUCURSALCLAVE;


        IF(COALESCE(:TIPODOCTOSALIDAID,0) = 11
            AND COALESCE(:DESTINOSUCURSALCLAVE,'') <> '') THEN
         BEGIN
            
                UPDATE OR INSERT INTO REPLEXPOCTRL
                (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
                VALUES (:DESTINOSUCURSALCLAVE,  NEW.ID, CURRENT_TIMESTAMP, 10, 1)
                MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);
         END

         
        SELECT DOCTO.TIPODOCTOID,  :CLAVEMATRIZ DESTINOSUCURSALCLAVE
        FROM DOCTO
        WHERE DOCTO.ID = NEW.DOCTOID
        INTO :TIPODOCTOENTRADAID,  :DESTINOSUCURSALCLAVE;

               
        IF(COALESCE(:TIPODOCTOENTRADAID,0) = 12 AND NEW.FORMAPAGOID in (6)
            AND COALESCE(:DESTINOSUCURSALCLAVE,'') <> '') THEN
         BEGIN
            
                UPDATE OR INSERT INTO REPLEXPOCTRL
                (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
                VALUES (:DESTINOSUCURSALCLAVE,  NEW.ID, CURRENT_TIMESTAMP, 11, 1)
                MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);
         END



    END







  END


end