CREATE OR ALTER PROCEDURE CALC_COMISIONES (
    FECHAINI DATE,
    FECHAFIN DATE)
RETURNS (
    COMISIONISTA VARCHAR(64) CHARACTER SET NONE,
    TURNOCLAVE VARCHAR(32) CHARACTER SET NONE,
    COMISION NUMERIC(18,4))
AS
DECLARE VARIABLE INGRESO NUMERIC(18,4);
DECLARE VARIABLE COMISIONMEDICO NUMERIC(18,4);
DECLARE VARIABLE COMISIONDEPENDIENTE NUMERIC(18,4);
DECLARE VARIABLE CUENTA1 INTEGER;
DECLARE VARIABLE DOCTOID INTEGER;
BEGIN
   -- Totales para los medicos
   SELECT COMISIONMEDICO, COMISIONDEPENDIENTE
   FROM PARAMETRO
   INTO :COMISIONMEDICO, :COMISIONDEPENDIENTE;

   -- Limpiar
   DELETE FROM DOCTO_REP;

   -- Doctos de consulta
   FOR
   SELECT DISTINCT M.DOCTOID
   FROM MOVTO M
     LEFT JOIN DOCTO D
      ON D.ID = M.DOCTOID
     LEFT JOIN PRODUCTO P
      ON P.ID = M.PRODUCTOID
   WHERE D.TIPODOCTOID = 21
     AND P.LINEAID = 4
     AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
   INTO :DOCTOID DO
   BEGIN
      INSERT INTO DOCTO_REP VALUES (:DOCTOID);
   END

   COMISIONISTA = 'MEDICO';

   FOR
      SELECT T.ID || ' - ' || T.CLAVE AS TURNOCLAVE, SUM(M.TOTAL) AS SUMTOTAL
      FROM MOVTO M
      LEFT JOIN PRODUCTO P
         ON P.ID = M.PRODUCTOID
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID
      LEFT JOIN TURNO T
         ON T.ID = D.TURNOID
      WHERE D.ID IN (SELECT DOCTOID FROM DOCTO_REP)
        AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
        AND D.TIPODOCTOID = 21
        AND P.LINEAID = 1
      GROUP BY TURNOCLAVE
      ORDER BY TURNOCLAVE
      INTO :TURNOCLAVE, :INGRESO DO
   BEGIN
      COMISION = :INGRESO * :COMISIONMEDICO / 100.00;
      SUSPEND;
   END

   COMISIONISTA = 'DEPENDIENTE';

   FOR
      SELECT T.ID || ' - ' || T.CLAVE AS TURNOCLAVE, SUM(M.TOTAL) AS SUMTOTAL
      FROM MOVTO M
      LEFT JOIN PRODUCTO P
         ON P.ID = M.PRODUCTOID
      LEFT JOIN DOCTO D
         ON D.ID = M.DOCTOID
      LEFT JOIN TURNO T
         ON T.ID = D.TURNOID
      WHERE D.ID NOT IN (SELECT DOCTOID FROM DOCTO_REP)
        AND D.FECHA BETWEEN :FECHAINI AND :FECHAFIN
        AND D.TIPODOCTOID = 21
        AND P.LINEAID = 1
      GROUP BY TURNOCLAVE
      ORDER BY TURNOCLAVE
      INTO :TURNOCLAVE, :INGRESO DO
   BEGIN
      COMISION = :INGRESO * :COMISIONDEPENDIENTE / 100.00;
      SUSPEND;
   END
END;
;