create or alter procedure GET_MAYOREOLINEA_PRECIO (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD,
    PRECIO1 D_PRECIO,
    PRECIOPREVIO D_PRECIO,
    PAGOCONTARJETA D_CHAR,
    PRECIOMEDIOMAYOREO D_PRECIO,
    PRECIOMAYOREO D_PRECIO,
    TIPOMAYOREOID D_FK,
    PRECIOMAYOREOTARJETA D_PRECIO)
returns (
    PRECIOEXPORTACIONLINEA D_PRECIO,
    TIPOMAYOREOLINEAIDAPLICADO D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIOACTUAL D_PRECIO;
declare variable PRECIOBUFFER D_PRECIO;
declare variable PRECIOSINPROMO D_PRECIO;
declare variable TASAIVA D_PORCENTAJE;
declare variable TASAIMPUESTO D_PORCENTAJE;
declare variable COMISIONPORTARJETA D_PRECIO;
declare variable MULTXCOMISION D_PRECIO;
BEGIN


     PRECIOACTUAL = :PRECIOPREVIO;
     PRECIOEXPORTACIONLINEA = :PRECIOPREVIO;

     TIPOMAYOREOLINEAIDAPLICADO = 1;


     IF(COALESCE(:TIPOMAYOREOID,1) = 1) THEN
     BEGIN
        SUSPEND;
        EXIT;
     END

     IF(COALESCE(:PAGOCONTARJETA,'N') IN ('S','D','C')) THEN
     BEGIN
        SELECT CASE WHEN COALESCE(:PAGOCONTARJETA,'N') = 'D' THEN
                        COMISIONDEBPORTARJETA
                 ELSE   COMISIONPORTARJETA
               END FROM PARAMETRO INTO :COMISIONPORTARJETA;
     END
     ELSE
     BEGIN
        COMISIONPORTARJETA = 0;
     END

     --MULTXCOMISION = ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);
     
     IF(COALESCE(:TIPOMAYOREOID,1) = 2) THEN
     BEGIN

         PRECIOBUFFER = :PRECIOMEDIOMAYOREO * ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);--:MULTXCOMISION;

        IF( :PRECIOBUFFER < :PRECIOACTUAL) THEN
        BEGIN
            PRECIOACTUAL = :PRECIOBUFFER; 
            TIPOMAYOREOLINEAIDAPLICADO = 2;
        END
     END


     
     IF(COALESCE(:TIPOMAYOREOID,1) = 3) THEN
     BEGIN
        --PRECIOBUFFER = :PRECIOMAYOREO * ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);--:MULTXCOMISION;

         IF(COALESCE(:COMISIONPORTARJETA,0.00) > 0 AND COALESCE(:PRECIOMAYOREOTARJETA,0 ) > 0 ) THEN
        BEGIN
            PRECIOBUFFER = :PRECIOMAYOREOTARJETA;
            PRECIOACTUAL = :PRECIOBUFFER;
        END
        ELSE
        BEGIN
            PRECIOBUFFER = :PRECIOMAYOREO * ((100.00 + COALESCE(:COMISIONPORTARJETA,0.00))/100.00);
            
            IF( :PRECIOBUFFER < :PRECIOACTUAL) THEN
            BEGIN
                PRECIOACTUAL = :PRECIOBUFFER;
                TIPOMAYOREOLINEAIDAPLICADO = 3;
            END
        END

     END

     PRECIOEXPORTACIONLINEA = :PRECIOACTUAL ;

   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END 
END
