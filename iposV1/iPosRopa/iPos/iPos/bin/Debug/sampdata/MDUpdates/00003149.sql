create or alter procedure TTL_REP_PROD_VENTA_COMPARACION (
    PRODUCTOID_P D_FK,
    ANIO1 D_DIAS,
    ANIO2 D_DIAS,
    INCLUIRTRASL varchar(1))
returns (
    MES D_CLAVE,
    PRODUCTOID D_FK,
    CANTIDADANIO1 D_DIAS,
    TOTALANIO1 D_PRECIO,
    CANTIDADANIO2 D_DIAS,
    TOTALANIO2 D_PRECIO,
    DIFERENCIA D_CANTIDAD,
    PORCENTAJEDIFERENCIA D_PORCENTAJE,
    ACUMULADODIFERENCIA D_CANTIDAD,
    PORCACUMULADODIFERENCIA D_PORCENTAJE)
as
declare variable ACUMULADOANIO1 D_PRECIO;
begin





MES  = '';
PRODUCTOID  = 0;
CANTIDADANIO1  = 0;
TOTALANIO1  = 0;
CANTIDADANIO2  = 0;
TOTALANIO2  = 0;
DIFERENCIA  = 0;


ACUMULADODIFERENCIA = 0;
ACUMULADOANIO1 = 0;
PORCACUMULADODIFERENCIA = 0;

  FOR
SELECT M.clave MES,
D1.PRODUCTOID,
D1.CANTIDAD CANTIDADANIO1,
D1.TOTAL TOTALANIO1,
D2.CANTIDAD CANTIDADANIO2,
D2.TOTAL TOTALANIO2,
COALESCE(D2.CANTIDAD ,0) -  COALESCE(D1.CANTIDAD ,0) DIFERENCIA,
((COALESCE(D2.CANTIDAD ,0) -  COALESCE(D1.CANTIDAD ,0)) /  CASE WHEN COALESCE(D1.CANTIDAD,0)  <> 0 THEN D1.CANTIDAD  WHEN COALESCE(D2.CANTIDAD,0)  <> 0 THEN D2.CANTIDAD ELSE 1 END) * 100  PORCDIFERENCIA
FROM
MESES M LEFT JOIN
(
select
        PRODUCTOID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_prod_tipo_mes
      where
          ANIO = :ANIO1   AND PRODUCTOID = :PRODUCTOID_P AND

          ( (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (21,22,23,24)) or (:INCLUIRTRASL = 'N' AND TIPODOCTOID IN (21,22,23,24) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))   OR  (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (31,32,33,81,83) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))    )

      group by PRODUCTOID,
            MES,
            ANIO

            )   D1 ON D1.MES = M.ID

              LEFT JOIN
            (
select
        PRODUCTOID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_prod_tipo_mes
      where
          ANIO = :ANIO2   AND PRODUCTOID = :PRODUCTOID_P AND
          ( (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (21,22,23,24)) or (:INCLUIRTRASL = 'N' AND TIPODOCTOID IN (21,22,23,24) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8)) OR  (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (31,32,33,81,83) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))    )

      group by PRODUCTOID,
            MES,
            ANIO

            )  D2 ON D2.MES = M.ID

      INTO :MES ,
:PRODUCTOID ,
:CANTIDADANIO1 ,
:TOTALANIO1 ,
:CANTIDADANIO2 ,
:TOTALANIO2 ,
:DIFERENCIA ,
:PORCENTAJEDIFERENCIA

    DO
    BEGIN

       ACUMULADODIFERENCIA = :ACUMULADODIFERENCIA + COALESCE(:DIFERENCIA,0);
       ACUMULADOANIO1 = :ACUMULADOANIO1 + COALESCE(:CANTIDADANIO1,0);
       PORCACUMULADODIFERENCIA =  (:ACUMULADODIFERENCIA / ( CASE WHEN COALESCE(:ACUMULADOANIO1,0) <> 0 THEN :acumuladoanio1 ELSE 1 END )) * 100;

     SUSPEND;
    END




end