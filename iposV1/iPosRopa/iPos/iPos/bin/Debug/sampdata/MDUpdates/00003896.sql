create or alter procedure GUIADETALLE_ACTUALIZARESTADO (
    GUIAID D_FK,
    CAJEROID D_FK)
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable CUENTADETALLESGUIA integer;
declare variable CUENTADETALLESRECIBIDOS integer;
BEGIN
  ERRORCODE = 0;


     SELECT COUNT(*) FROM GUIADETALLE WHERE GUIAID = :GUIAID INTO :CUENTADETALLESGUIA;

     SELECT COUNT(*) FROM guiadetalle WHERE GUIAID = :GUIAID AND COALESCE(ESTADOGUIAID ,0) = 3
     INTO :CUENTADETALLESRECIBIDOS;


     IF(COALESCE(:CUENTADETALLESGUIA,0) = COALESCE(:CUENTADETALLESRECIBIDOS,0) AND
        COALESCE(:CUENTADETALLESGUIA ,0) >  0) THEN
     BEGIN
        UPDATE GUIA SET ESTADOGUIAID = 3 WHERE ID = :GUIAID;
     END     
     ELSE IF(COALESCE(:CUENTADETALLESGUIA,0) > COALESCE(:CUENTADETALLESRECIBIDOS,0) AND
        COALESCE(:CUENTADETALLESRECIBIDOS ,0) >  0) THEN
     BEGIN
        UPDATE GUIA SET ESTADOGUIAID = 4 WHERE ID = :GUIAID;
     END  
     ELSE if (COALESCE(:CUENTADETALLESRECIBIDOS ,0) =  0) THEN
     BEGIN
        UPDATE GUIA SET ESTADOGUIAID = 1 WHERE ID = :GUIAID;
     END




   ERRORCODE = 0;
   SUSPEND;
END