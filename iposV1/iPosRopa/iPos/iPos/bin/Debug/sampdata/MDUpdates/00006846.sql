create or alter procedure GET_EXISTENCIA (
    PRODUCTOID D_FK,
    ALMACENID D_FK,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE)
returns (
    EXISTENCIA D_CANTIDAD,
    EXISTENCIAFACTURADO D_CANTIDAD,
    EXISTENCIAREMISIONADO D_CANTIDAD,
    ERRORCODE D_ERRORCODE)
as
declare variable MANEJALOTE D_BOOLCN;
declare variable MANEJAALMACEN D_BOOLCN;
BEGIN
   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1039;
      SUSPEND;
      EXIT;
   END
   
   IF ((:ALMACENID IS NULL) OR (:ALMACENID = 0)) THEN
   BEGIN
      /*ERRORCODE = 1040;
      SUSPEND;
      EXIT;*/
      ALMACENID = 1;
   END

   SELECT COALESCE(MANEJALOTE ,'N')
   FROM PRODUCTO
   WHERE ID = :PRODUCTOID
   INTO :MANEJALOTE;

   IF (:MANEJALOTE = 'S') THEN
   BEGIN
      IF ((:LOTE IS NULL) OR (:LOTE = '')) THEN
      BEGIN
         ERRORCODE = 1041;
         SUSPEND;
         EXIT;
      END

      IF ((:FECHAVENCE IS NULL) /*OR (:FECHAVENCE < (CURRENT_DATE - 365))*/) THEN
      BEGIN
         ERRORCODE = 1042;
         SUSPEND;
         EXIT;
      END
   END


   SELECT FIRST 1 COALESCE(MANEJAALMACEN,'N')
   FROM PARAMETRO
   into :MANEJAALMACEN;

     

     
    EXISTENCIA = 0;
    EXISTENCIAFACTURADO = 0;
    EXISTENCIAREMISIONADO = 0;

   IF (:MANEJAALMACEN = 'S') THEN
   BEGIN
   
      SELECT SUM(COALESCE(CANTIDAD, 0)  )
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
       AND PRODUCTOID = :PRODUCTOID
       AND ESAPARTADO = 'N'
      INTO :EXISTENCIA;


      
         SELECT SUM(COALESCE(CANTIDAD, 0))
         FROM INVENTARIO
         WHERE ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
           AND ESAPARTADO = 'N'
           AND ORIGENFISCALID = 3
         INTO :EXISTENCIAFACTURADO;
         
         SELECT SUM(COALESCE(CANTIDAD, 0))
         FROM INVENTARIO
         WHERE ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
           AND ESAPARTADO = 'N'
           AND ORIGENFISCALID = 2
         INTO :EXISTENCIAREMISIONADO;
   END
   ELSE
   BEGIN



         SELECT COALESCE(EXISTENCIA,0), COALESCE(EXISTENCIAFACTURADO,0) , COALESCE(EXISTENCIAREMISIONADO,0)
         FROM PRODUCTO where id = :productoid  INTO :EXISTENCIA, :EXISTENCIAFACTURADO, :EXISTENCIAREMISIONADO;

   END





   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1043;
      SUSPEND;
   END 
END