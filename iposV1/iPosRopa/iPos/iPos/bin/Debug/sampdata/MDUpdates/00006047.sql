create or alter procedure GUIADETALLE_INSERT (
    GUIAID D_FK,
    DOCTOID D_FK,
    ENCARGADOGUIAID D_FK,
    ESTADOGUIAID D_FK,
    CAJEROID D_FK,
    FECHA D_FECHA,
    NOTA D_DESCRIPCION,
    TIPOENTREGAID D_FK,
    GUIAPAQUETERIA D_STDTEXT_MEDIUM)
returns (
    GUIAIDRETORNO D_FK,
    GUIADETALLEID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable CORTEID2 D_FK;
declare variable FECHACORTE D_FECHA;
declare variable CUENTAGUIADET D_FK;
declare variable DIAS D_FK;
BEGIN

  -- FALTA COMPLETAR
  
   SELECT HAYCORTEACTIVO,CORTEID, FECHACORTE, ERRORCODE
   FROM HAY_CORTE_ACTIVO(:CAJEROID)
   INTO :HAYCORTEACTIVO, :CORTEID2, :FECHACORTE, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
        GUIAIDRETORNO = 0;
        GUIADETALLEID = 0;
        SUSPEND;
        EXIT;
   END


   IF(:FECHACORTE IS NULL or  COALESCE(:FECHACORTE,CURRENT_DATE) <> CURRENT_DATE) THEN
   BEGIN
        ERRORCODE = 1001;
        SUSPEND;
        EXIT;
   END


   IF(COALESCE(:GUIAID,0) = 0) THEN
   BEGIN

        INSERT INTO GUIA
        (ENCARGADOGUIAID , ESTADOGUIAID, cajeroid,  CORTEID, FECHA, FECHAHORA, NOTA, TIPOENTREGAID, GUIAPAQUETERIA)
        VALUES
        (:ENCARGADOGUIAID,  :ESTADOGUIAID  , :CAJEROID, :CORTEID2,  current_date,  CURRENT_TIME, :NOTA, :TIPOENTREGAID, :GUIAPAQUETERIA)
        RETURNING ID INTO :GUIAIDRETORNO;

        GUIAID = :GUIAIDRETORNO;

   END
   ELSE
   BEGIN
    GUIAIDRETORNO = :GUIAID;
   END



   SELECT ID FROM GUIADETALLE WHERE GUIAID = :GUIAID AND DOCTOID = :DOCTOID INTO :GUIADETALLEID;

   IF(COALESCE(:GUIADETALLEID,0) > 0) THEN
   BEGIN
        SUSPEND;
        EXIT;
   END


  /* -- si es entrega directa el estado de guia detalle sera recibido de inicio
    SELECT TIPOENTREGAID FROM GUIA WHERE ID = :GUIAID INTO :TIPOENTREGAID;

    IF(coalesce(:TIPOENTREGAID,0) = 1) THEN
    BEGIN
        ESTADOGUIAID = 3;
    END    */


   INSERT INTO GUIADETALLE
   (  GUIAID, DOCTOID, ESTADOGUIAID)
   VALUES
   (:GUIAID, :DOCTOID, :ESTADOGUIAID)
   RETURNING ID  INTO :GUIADETALLEID;

   UPDATE DOCTO SET ESTADOGUIAID = :ESTADOGUIAID,
     GUIAID = :GUIAID, FECHAGUIAENVIADO = current_date
      WHERE ID = :DOCTOID;

    
    IF(coalesce(:ESTADOGUIAID,0) = 3) THEN
    BEGIN             
          SELECT PERSONA.dias FROM DOCTO INNER JOIN PERSONA ON PERSONA.ID = DOCTO.personaid INTO :DIAS;

           UPDATE DOCTO SET FECHAGUIARECIBIDO = current_date , DOCTO.vence = DATEADD(COALESCE(:DIAS,0) DAY TO CURRENT_DATE)
            WHERE ID = :DOCTOID;

    END
    
  SELECT ERRORCODE FROM GUIADETALLE_ACTUALIZARESTADO(:GUIAID, :CAJEROID) INTO :ERRORCODE;



   ERRORCODE = 0;
   SUSPEND;
END