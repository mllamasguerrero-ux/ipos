create or alter procedure DEVOLUCION_CANCEL_INICIAR (
    DOCTOCANCELARID D_FK,
    VENDEDORID D_FK)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable TOTAL D_FK;
declare variable PRODUCTOSINSUFICIENTES D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable SUBTIPODOCTOID D_FK;
declare variable MOVTOREFID D_FK;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID, SUBTIPODOCTOID
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ESTATUSDOCTOID, :TIPODOCTOCANCELARID, :SUBTIPODOCTOID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   -- Si no es devolucion
   IF (:TIPODOCTOCANCELARID NOT IN (22)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END


  
   PRODUCTOSINSUFICIENTES = 0;

    -- checar si hay existencia suficiente a retirar
   /*select count(*) from movto m left join producto p on m.productoid = p.id
   WHERE M.DOCTOID = :DOCTOCANCELARID AND ( coalesce(m.cantidaddefactura,0) > coalesce(p.existenciafacturado,0)
   or coalesce(m.cantidadderemision,0) > coalesce(p.existenciaremisionado,0) )
   INTO :PRODUCTOSINSUFICIENTES;*/

           
   -- Si no es de los tipos b?sicos: Salir.
   IF (COALESCE(:PRODUCTOSINSUFICIENTES,0) > 0) THEN
   BEGIN
      ERRORCODE = 3001;
      SUSPEND;
      EXIT;
   END

   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID, TOTAL
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID,  :TOTAL;

   REFERENCIA = CAST('CANCELADO DEL DOCTO ' || COALESCE(SERIE, '' ) || '-' || COALESCE(:FOLIO, '') AS VARCHAR(31));

   REFERENCIAS = NULL;

   IF (:TIPODOCTOCANCELARID = 22) THEN
      TIPODOCTOID = 24;

   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT,DOCTOREFID, IEPS, IMPUESTO)
   SELECT
    ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
    PERSONAID, CAJEROID, :VENDEDORID, CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, SERIE, FOLIO,
    PLAZO, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
    CAJAID, :REFERENCIA, :REFERENCIAS, SUCURSALTID, ALMACENTID, 'N' , ESFACTURAELECTRONICA,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT ,ID, 0.00, 0.00
    FROM DOCTO WHERE ID = :DOCTOCANCELARID
   RETURNING ID INTO :DOCTOID;

   -- Agrega los MOVTO.
   FOR SELECT
      ID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD, PRECIO, COSTO, 
      TIPODIFERENCIAINVENTARIOID  , CANTIDADDEFACTURA, CANTIDADDEREMISION, CANTIDADDEINDEFINIDO , DESCRIPCION1, DESCRIPCION2, DESCRIPCION3  , MOVTOREFID
   FROM MOVTO
   WHERE DOCTOID = :DOCTOCANCELARID
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :CANTIDADDEFACTURA, :CANTIDADDEREMISION, :CANTIDADDEINDEFINIDO , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3  , :MOVTOREFID
   DO
   BEGIN
      SELECT ERRORCODE,MOVTOID
      FROM MOVTO_INSERT (
         :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, 0, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, :PRECIO, 0,
         :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,:DOCTOCANCELARID ,NULL,NULL,NULL,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
      ) INTO :ERRORCODE,:NEWMOVTOID;


      
      IF (:ERRORCODE <> 0) THEN
      BEGIN
         SUSPEND;
         EXIT;
      END

      --asegurate de que se pasen las cantidades de facturado y remisionado
         UPDATE MOVTO  SET  CANTIDADDEFACTURA = :CANTIDADDEFACTURA  ,
           CANTIDADDEREMISION = :CANTIDADDEREMISION, CANTIDADDEINDEFINIDO = :CANTIDADDEINDEFINIDO,
           MOVTOREFID = :MOVTOID
           WHERE id = :NEWMOVTOID;

           UPDATE MOVTO SET ESTADOREBAJA = 1 WHERE ID = :MOVTOREFID;


   END

        /*Echar para atras pagos*/
              SELECT ERRORCODE FROM DEVOLUCION_REVERTIR_PAGOS(:DOCTOCANCELARID, :DOCTOID, :VENDEDORID) INTO :ERRORCODE;
        /*Fin echar para atras pagos*/



    
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END

   SELECT ERRORCODE FROM DOCTO_SAVE( :DOCTOID) INTO :ERRORCODE;
     
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END


   -- Completa el documento.
   --SELECT ERRORCODE
   --FROM DOCTO_SAVE (:DOCTOID)
   --INTO :ERRORCODE; *


   -- Marca el documento original como cancelado.
   UPDATE DOCTO
   SET ESTATUSDOCTOID = 2
   WHERE ID = :DOCTOCANCELARID;







   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END