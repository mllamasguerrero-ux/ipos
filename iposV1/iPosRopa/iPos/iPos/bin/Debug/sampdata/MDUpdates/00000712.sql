create or alter procedure OBTEN_CANTIDADORIGEN_FRI (
    EXISTENCIADEFACTURA D_CANTIDAD,
    EXISTENCIADEREMISION D_CANTIDAD,
    CANTIDAD D_CANTIDAD,
    ULTIMOORIGENFISCAL D_FK)
returns (
    CANTIDADDEFACTURA D_CANTIDAD,
    CANTIDADDEREMISION D_CANTIDAD,
    CANTIDADINDEFINIDO D_CANTIDAD,
    NUEVOULTIMOORIGENFISCAL D_FK)
as
declare variable CANTIDADAASIGNAR D_CANTIDAD;
declare variable CANTIDADAPROCESAR D_CANTIDAD;
BEGIN
            
   CANTIDADINDEFINIDO = 0;

   CANTIDADAPROCESAR = :CANTIDAD;
   IF(:CANTIDAD > (:EXISTENCIADEFACTURA + :EXISTENCIADEREMISION) ) THEN
   BEGIN
        if((:EXISTENCIADEFACTURA + :EXISTENCIADEREMISION) > 0 ) then
        begin
            CANTIDADAPROCESAR  = :EXISTENCIADEFACTURA + :EXISTENCIADEREMISION;
        end
        else
        begin      
            CANTIDADAPROCESAR  = 0;
        end

   END

     NUEVOULTIMOORIGENFISCAL = :ULTIMOORIGENFISCAL;
     CANTIDADAASIGNAR = :CANTIDADAPROCESAR;
     CANTIDADDEFACTURA = 0;
     CANTIDADDEREMISION = 0;
     CANTIDADINDEFINIDO = 0;

            IF(:CANTIDADAASIGNAR <= :EXISTENCIADEFACTURA  ) THEN
            BEGIN
                    CANTIDADDEFACTURA = :CANTIDADAASIGNAR ;
                    NUEVOULTIMOORIGENFISCAL = 3;
                    CANTIDADAASIGNAR = 0;
            END
            ELSE
            BEGIN
                    CANTIDADDEFACTURA =  (:EXISTENCIADEFACTURA);
                    CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  - :CANTIDADDEFACTURA;
            END


            IF(:CANTIDADAASIGNAR > 0) THEN
            BEGIN
                IF(:CANTIDADAASIGNAR <= :EXISTENCIADEREMISION   ) THEN
                BEGIN
                    CANTIDADDEREMISION = :CANTIDADAASIGNAR ;
                    NUEVOULTIMOORIGENFISCAL = 2;
                    CANTIDADAASIGNAR = 0;
                END
                ELSE
                BEGIN
                    CANTIDADDEREMISION = :EXISTENCIADEREMISION ;
                    CANTIDADAASIGNAR =   :CANTIDADAASIGNAR  -  :CANTIDADDEREMISION;
                END
            END

            --CANTIDADINDEFINIDO = :CANTIDADAASIGNAR;
            CANTIDADDEREMISION = :CANTIDADDEREMISION + :CANTIDADAASIGNAR + ( :CANTIDAD -:CANTIDADAPROCESAR );




   SUSPEND;

END