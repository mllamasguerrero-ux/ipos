CREATE OR ALTER VIEW INVENTARIOKITDESG_VIEW(
    ALMACENID,
    PRODUCTOID,
    LOTE,
    FECHAVENCE,
    CANTIDAD,
    COSTO,
    COSTOULTIMO,
    COSTOPROMEDIO,
    ULTIMAFECHACOMPRA,
    ULTIMAFECHAVENTA,
    CANTIDADINICIAL,
    FECHAINICIAL,
    ORIGENFISCALID,
    ESAPARTADO,
    LOTEIMPORTADO)
AS
SELECT

    Q.ALMACENID,
    Q.PRODUCTOID,
    Q.LOTE LOTE,
    Q.FECHAVENCE FECHAVENCE,
    SUM(COALESCE(Q.CANTIDAD,0)) CANTIDAD,
    MIN(COALESCE(Q.COSTO,0)) COSTO,
    MIN(COALESCE(Q.COSTOULTIMO,0)) COSTOULTIMO,
    MIN(COALESCE(Q.COSTOPROMEDIO,0)) COSTOPROMEDIO,
    MAX(Q.ULTIMAFECHACOMPRA) ULTIMAFECHACOMPRA,
    MAX(Q.ULTIMAFECHAVENTA) ULTIMAFECHAVENTA,
    MAX(COALESCE(Q.CANTIDADINICIAL,0)) CANTIDADINICIAL,
    MAX( Q.FECHAINICIAL) FECHAINICIAL,
    Q.ORIGENFISCALID,
    Q.ESAPARTADO,
    Q.LOTEIMPORTADO

    FROM

    (

SELECT
    INVENTARIO.ALMACENID,
    INVENTARIO.PRODUCTOID,
    INVENTARIO.LOTE,
    INVENTARIO.FECHAVENCE,
    INVENTARIO.CANTIDAD,
    INVENTARIO.COSTO,
    INVENTARIO.COSTOULTIMO,
    INVENTARIO.COSTOPROMEDIO,
    INVENTARIO.ULTIMAFECHACOMPRA,
    INVENTARIO.ULTIMAFECHAVENTA,
    INVENTARIO.CANTIDADINICIAL,
    INVENTARIO.FECHAINICIAL,
    INVENTARIO.ORIGENFISCALID,
    INVENTARIO.ESAPARTADO,
    INVENTARIO.LOTEIMPORTADO
    FROM
    INVENTARIO

    UNION ALL


   SELECT
    INVENTARIO.ALMACENID,
    KITSUNNIVEL_VIEW.PRODUCTOPARTEID PRODUCTOID,
    CASE WHEN PRODUCTO.MANEJALOTE = 'S' THEN 'KIT' ELSE NULL END LOTE,
    INVENTARIO.FECHAVENCE,
    CAST(COALESCE(KITSUNNIVEL_VIEW.CANTIDADPARTE,0) * COALESCE(INVENTARIO.CANTIDAD,0) AS D_CANTIDAD) CANTIDAD,
    PRODUCTO.COSTOPROMEDIO COSTO,
    PRODUCTO.COSTOULTIMO,
    PRODUCTO.COSTOPROMEDIO,
    PRODUCTO.ULTIMACOMPRA ULTIMAFECHACOMPRA,
    PRODUCTO.ULTIMAVENTA ULTIMAFECHAVENTA,
    INVENTARIO.CANTIDADINICIAL,
    INVENTARIO.FECHAINICIAL,
    INVENTARIO.ORIGENFISCALID,
    INVENTARIO.ESAPARTADO,
    INVENTARIO.LOTEIMPORTADO
    FROM
       KITSUNNIVEL_VIEW
       INNER JOIN  INVENTARIO ON INVENTARIO.PRODUCTOID = KITSUNNIVEL_VIEW.PRODUCTOID
       LEFT JOIN PRODUCTO ON PRODUCTO.ID = KITSUNNIVEL_VIEW.PRODUCTOPARTEID

       ) Q

       GROUP BY 
    Q.ALMACENID,
    Q.PRODUCTOID, 
    Q.LOTE,
    Q.FECHAVENCE,
    Q.ORIGENFISCALID,
    Q.ESAPARTADO,
    Q.LOTEIMPORTADO
;