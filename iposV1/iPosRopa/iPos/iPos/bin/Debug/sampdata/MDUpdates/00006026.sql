create or alter procedure ACTUALIZAR_TABLA_IEPS
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable IEPS_X_IMPORTE D_IMPORTE;
declare variable IEPS_X_PORC D_PORCENTAJE;
declare variable CUENTA integer;
declare variable MAX_FECHA D_FECHA;
declare variable MIN_FECHA D_FECHA;
declare variable REPETIDO integer;
declare variable GPOIMP D_CLAVE_NULL;
BEGIN

   CUENTA = 1;
   ERRORCODE = 0;

    DELETE FROM TASASIEPS;


  FOR SELECT
       CASE WHEN COALESCE(M.ESKIT,'N') <> 'S' AND COALESCE(T.sentidoinventario,0) <> 0 THEN  coalesce(m.TASAIEPS, 0)  ELSE -1 END,
       COUNT(*) REPETIDO,
       MAX(D.FECHA) MAX_FECHA,
       MIN(D.FECHA) MIN_FECHA,
       COALESCE(LINEA.GPOIMP,'') GPOIMP
       FROM DOCTO D
      LEFT JOIN MOVTO M
         ON  (M.DOCTOID = D.ID or M.DOCTOID = COALESCE(D.DOCTOKITREFID,0)) --(M.DOCTOID IN ( D.ID, COALESCE(D.doctokitrefid,0))  )
      LEFT JOIN TIPODOCTO T ON T.id = D.tipodoctoid
      LEFT JOIN PRODUCTO ON PRODUCTO.ID = M.PRODUCTOID
      LEFT JOIN LINEA ON LINEA.ID = PRODUCTO.LINEAID
      WHERE   D.ESTATUSDOCTOID = 1
    group by (CASE WHEN COALESCE(M.ESKIT,'N') <> 'S' AND COALESCE(T.sentidoinventario,0) <> 0 THEN  coalesce(m.TASAIEPS, 0)  ELSE -1 END) ,COALESCE(LINEA.GPOIMP,'')
    order by (CASE WHEN COALESCE(M.ESKIT,'N') <> 'S' AND COALESCE(T.sentidoinventario,0) <> 0 THEN  coalesce(m.TASAIEPS, 0)  ELSE -1 END) desc , COALESCE(LINEA.GPOIMP,'')
    INTO :IEPS_X_PORC  , :REPETIDO , :MAX_FECHA, :MIN_FECHA, :GPOIMP
    DO
    BEGIN
        IF(COALESCE(:IEPS_X_PORC ,-1) <> -1) THEN
        BEGIN
            INSERT INTO TASASIEPS(ACTIVO, TASA, CANTIDADREG, PRIMERAFECHA, ULTIMAFECHA, GPOIMP)
            VALUES('S', :IEPS_X_PORC, :REPETIDO, :MIN_FECHA, :MAX_FECHA, COALESCE(:GPOIMP,''));

        END

    END

    SUSPEND;


END