create or alter procedure REPL_IMPO_PAGOSSUCURSAL (
    DOCTOID D_FK,
    FORMAPAGOID D_FK,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    IMPORTE D_IMPORTE,
    IMPORTERECIBIDO D_IMPORTE,
    IMPORTECAMBIO D_IMPORTE,
    TIPOPAGOID D_FK,
    DOCTOSALIDAID D_FK,
    ESAPARTADO D_BOOLCN,
    TIPOAPLICACIONCREDITOID D_FK,
    BANCOCLAVE D_CLAVE_NULL,
    REFERENCIABANCARIA D_STDTEXT_LIGHT,
    NOTAS D_STDTEXT_MEDIUM,
    FECHAELABORACION D_FECHA,
    FECHARECEPCION D_FECHA,
    ESPAGOINICIAL D_BOOLCN,
    TIPOABONOID D_FK,
    FORMAPAGOSATID D_FK,
    COMISION D_IMPORTE,
    CUENTAPAGOCREDITO D_STDTEXT_LIGHT,
    APLICADO D_BOOLCN_NULL,
    FECHAAPLICADO D_FECHA,
    SUCURSALFUENTE D_CLAVE_NULL,
    USERID D_FK)
returns (
    DOCTOPAGOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable TIPODOCTOID D_FK;
declare variable CORTEID D_FK;
declare variable BANCO D_FK;
declare variable SUCURSALID D_FK;
declare variable ESTATUSDOCTOENTRADAID D_FK;
declare variable ESTATUSDOCTOSALIDAID D_FK;
BEGIN

    SELECT PARAMETRO.SUCURSALID FROM PARAMETRO INTO :SUCURSALID;

    
   
   SELECT ID FROM CORTE WHERE CAJEROID = :USERID AND FECHACORTE = :FECHA INTO :CORTEID;

   IF(COALESCE(:CORTEID , 0) = 0) THEN
   BEGIN
       SELECT ERRORCODE,  CORTEID FROM
        CORTE_ABRIR (
                :FECHA,
                :SUCURSALID ,
                :USERID ,
                0,
            1) INTO :ERRORCODE, :CORTEID;

            
        IF (:ERRORCODE > 0) THEN
        BEGIN
            SUSPEND;
            EXIT;
        END
   END


   IF(COALESCE(:BANCOCLAVE,'') <> '') THEN
   BEGIN
   
    SELECT ID
    FROM BANCOS
    WHERE CLAVE = :BANCOCLAVE
    INTO :BANCO;


    if( :BANCO is null  )  then
    begin
      insert into BANCOS (
         clave,
         nombre,
         rfc
      ) values (
         :BANCOCLAVE,
         :BANCOCLAVE,
         NULL
      ) RETURNING ID INTO :BANCO;
    end
   END

   --IF(COALESCE(:FORMAPAGOID,0) = 7 ) THEN
   --BEGIN
   --    FORMAPAGOID = 7;
   --END


   IF(COALESCE(:DOCTOID,0) <> 0) THEN
   BEGIN

       SELECT ESTATUSDOCTOID FROM DOCTO WHERE ID = :DOCTOID INTO :ESTATUSDOCTOENTRADAID;

      IF(COALESCE(:ESTATUSDOCTOENTRADAID,0) <> 1) THEN
      BEGIN
            ERRORCODE = 0;
            SUSPEND;
            EXIT;
      END
   END


   
   IF(COALESCE(:DOCTOSALIDAID,0) <> 0) THEN
   BEGIN

       SELECT ESTATUSDOCTOID FROM DOCTO WHERE ID = :DOCTOSALIDAID INTO :ESTATUSDOCTOSALIDAID;

      IF(COALESCE(:ESTATUSDOCTOSALIDAID,0) <> 1) THEN
      BEGIN
            ERRORCODE = 0;
            SUSPEND;
            EXIT;
      END
   END




   SELECT DOCTOPAGOID, ERRORCODE FROM DOCTOPAGO_INSERT (
    :DOCTOID ,
    :FORMAPAGOID ,
    :FECHA ,
    :FECHAHORA ,
    :CORTEID ,
    :IMPORTE ,
    :IMPORTERECIBIDO ,
    :IMPORTECAMBIO ,
    :TIPOPAGOID ,
    :DOCTOSALIDAID ,
    :ESAPARTADO ,
    :TIPOAPLICACIONCREDITOID ,
    :BANCO ,
    :REFERENCIABANCARIA ,
    :NOTAS ,
    :FECHAELABORACION ,
    :FECHARECEPCION ,
    :ESPAGOINICIAL ,
    :TIPOABONOID ,
    NULL,--DOCTOPAGOREFID ,
    :FORMAPAGOSATID ,
    NULL,--BANCOMERPARAMID ,
    :COMISION ,
    :CUENTAPAGOCREDITO ,
    NULL,--CUENTABANCOEMPRESAID ,
    :APLICADO ,
    :FECHAAPLICADO ,
    NULL, --PAGOID
    NULL ,
    NULL
    )
    INTO :DOCTOPAGOID, :ERRORCODE;

     
    IF (:ERRORCODE > 0) THEN
    BEGIN
            SUSPEND;
            EXIT;
    END


   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1012;
      SUSPEND;
   END
END