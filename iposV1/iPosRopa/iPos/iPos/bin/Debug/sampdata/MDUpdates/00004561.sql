create or alter procedure GET_PRODUCTO_PRECIO (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD,
    PAGOCONTARJETA D_BOOLCN_NULL,
    TIPOMAYOREOID D_FK,
    PAGOACREDITO D_BOOLCN_NULL)
returns (
    PRECIO D_PRECIO,
    ESPROMOCION D_BOOLCN,
    PROMOCIONID D_FK,
    PROMOCIONDESGLOSE D_STDTEXT_64,
    MONEDEROABONO D_PRECIO,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIO1 D_PRECIO;
declare variable PRECIO2 D_PRECIO;
declare variable PRECIO3 D_PRECIO;
declare variable PRECIO4 D_PRECIO;
declare variable PRECIO5 D_PRECIO;
declare variable PRECIO6 D_PRECIO;
declare variable LISTAPRECIO varchar(1);
declare variable LIMITEPRECIO2 D_CANTIDAD;
declare variable U_EMPAQUE D_CANTIDAD;
declare variable PZACAJA D_CANTIDAD;
declare variable UNIDAD varchar(10);
declare variable INI_MAYO D_CANTIDAD;
declare variable MAYOKGS char(1);
declare variable LISTAPRECIOCLIENTE varchar(1);
declare variable CAMBIARPRECIOXUEMPAQUE D_BOOLCN;
declare variable CAMBIARPRECIOXPZACAJA D_BOOLCN;
declare variable LISTAPRECIOXUEMPAQUE D_FK;
declare variable LISTAPRECIOXPZACAJA D_FK;
declare variable LISTAPRECIOINIMAYO D_FK;
declare variable LINEA_CLAVE D_CLAVE_NULL;
declare variable SUPERLISTAPRECIOID D_FK;
declare variable MANEJASUPERLISTAPRECIO D_BOOLCN;
declare variable TIPODESCUENTOPRODID D_FK;
declare variable PRODUCTODESCUENTO D_PORCENTAJE;
declare variable TEMPPRECIO D_PRECIO;
declare variable APLICARMAYOREOPORLINEA D_BOOLCN;
declare variable PRECIOSORDENADOS D_BOOLCS;
declare variable FORZARPRECIOLISTA D_BOOLCN;
declare variable HABPROMOCIONBODEGAZO D_BOOLCN;
declare variable LINEAAPLICAMAYOREO D_BOOLCN;
declare variable PRECIOXLISTACLIENTE D_PRECIO;
declare variable APLICAPRECIOCAJA D_BOOLCN;
declare variable DESCXLINEAPERSONA D_PORCENTAJE;
declare variable PRECIOXLINEAPERSONA D_PRECIO;
declare variable LINEAID D_FK;
declare variable HABDESCLINEAPERSONA D_BOOLCN;
declare variable PAGOTARJMENORPRECIOLISTA D_BOOLCN;
BEGIN

   APLICAPRECIOCAJA = 'N';

   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1048;
      SUSPEND;
      EXIT;
   END
   
   IF ((:PERSONAID IS NULL) OR (:PERSONAID = 0)) THEN
   BEGIN
      ERRORCODE = 1049;
      SUSPEND;
      EXIT;
   END


   
   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1050;
      SUSPEND;
      EXIT;
   END
   

   




   -- Tomar la lista de precios correspondiente a la persona.
   -- Null, 1..5. Para Precio1, ... Precio5
   SELECT CAST(COALESCE(LISTAPRECIOID, 1) AS CHAR(1)),SUPERLISTAPRECIOID , PAGOTARJMENORPRECIOLISTA
   FROM PERSONA
   WHERE ID = :PERSONAID
   INTO :LISTAPRECIOCLIENTE,:SUPERLISTAPRECIOID, :PAGOTARJMENORPRECIOLISTA;

    SELECT MANEJASUPERLISTAPRECIO, TIPODESCUENTOPRODID FROM PARAMETRO INTO :MANEJASUPERLISTAPRECIO, :TIPODESCUENTOPRODID;
    IF(COALESCE(:MANEJASUPERLISTAPRECIO ,'N') = 'N') THEN
    BEGIN
        SUPERLISTAPRECIOID = 1;
     END


   select first 1 CAST(COALESCE(LISTA_PRECIO_DEF, 1) AS CHAR(1)),
   CAMBIARPRECIOXUEMPAQUE, CAMBIARPRECIOXPZACAJA ,
   LISTAPRECIOXUEMPAQUE, LISTAPRECIOXPZACAJA , LISTAPRECIOINIMAYO, APLICARMAYOREOPORLINEA, PRECIOSORDENADOS , HABDESCLINEAPERSONA
   FROM parametro
   INTO :LISTAPRECIO, :CAMBIARPRECIOXUEMPAQUE, :CAMBIARPRECIOXPZACAJA
   , :LISTAPRECIOXUEMPAQUE, :LISTAPRECIOXPZACAJA , :LISTAPRECIOINIMAYO, :APLICARMAYOREOPORLINEA, :PRECIOSORDENADOS, :HABDESCLINEAPERSONA ;

   -- Tomar los precios y el LimitePrecio2 del Producto.

   IF(COALESCE(:SUPERLISTAPRECIOID,1) = 2) THEN
   BEGIN          
        SELECT SPRECIO1, SPRECIO2, SPRECIO3, SPRECIO4, SPRECIO5, PRECIO6, COALESCE(LIMITEPRECIO2, 0.00)
        ,COALESCE(U_EMPAQUE ,0), COALESCE(PZACAJA,0), COALESCE(UNIDAD, ' '), COALESCE(INI_MAYO,0) , COALESCE(MAYOKGS,'N') ,
        LINEA.CLAVE, PRODUCTO.DESCUENTO , LINEA.aplicamayoreoxlinea
        FROM PRODUCTO
        LEFT JOIN LINEA ON PRODUCTO.LINEAID = LINEA.ID
        WHERE PRODUCTO.ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5, :PRECIO6, :LIMITEPRECIO2,
        :U_EMPAQUE, :PZACAJA , :UNIDAD ,  :INI_MAYO, :MAYOKGS, :LINEA_CLAVE, :PRODUCTODESCUENTO, :LINEAAPLICAMAYOREO;
    
   END
   ELSE
   BEGIN      
        SELECT PRECIO1, PRECIO2, PRECIO3, PRECIO4, PRECIO5, PRECIO6, COALESCE(LIMITEPRECIO2, 0.00)
        ,COALESCE(U_EMPAQUE ,0), COALESCE(PZACAJA,0), COALESCE(UNIDAD, ' '), COALESCE(INI_MAYO,0) , COALESCE(MAYOKGS,'N') ,
        LINEA.CLAVE ,PRODUCTO.DESCUENTO , LINEA.aplicamayoreoxlinea
        FROM PRODUCTO
        LEFT JOIN LINEA ON PRODUCTO.LINEAID = LINEA.ID
        WHERE PRODUCTO.ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5, :PRECIO6, :LIMITEPRECIO2,
        :U_EMPAQUE, :PZACAJA , :UNIDAD ,  :INI_MAYO, :MAYOKGS, :LINEA_CLAVE, :PRODUCTODESCUENTO, :LINEAAPLICAMAYOREO;
   END


   -- Para la lista de precio1
   PRECIO = :PRECIO1;






   FORZARPRECIOLISTA = 'N';
   IF( COALESCE(:PRECIOSORDENADOS,'S') = 'N') THEN
   BEGIN
        FORZARPRECIOLISTA = 'S';
   END


   if(:CANTIDAD >= :LIMITEPRECIO2  AND coalesce(:LIMITEPRECIO2,0) > 1)then
   begin
         PRECIO = :PRECIO2;
   end


   if (:PZACAJA > 1  AND :LISTAPRECIO = '1' AND :CANTIDAD>= :U_EMPAQUE AND :U_EMPAQUE>1  AND :CAMBIARPRECIOXUEMPAQUE = 'S' ) then
   begin
            --PRECIO = :PRECIO2;
            PRECIO = (case when :LISTAPRECIOXUEMPAQUE = 1 then :PRECIO1
              when :LISTAPRECIOXUEMPAQUE = 2 then  :PRECIO2
              when :LISTAPRECIOXUEMPAQUE = 3 then  :PRECIO3
              when :LISTAPRECIOXUEMPAQUE = 4 then  :PRECIO4
              when :LISTAPRECIOXUEMPAQUE = 5 then  :PRECIO5
              else  :PRECIO2
            end);

            FORZARPRECIOLISTA = 'N';
   end
   if (:PZACAJA > 1  AND :LISTAPRECIO = '1' AND :CANTIDAD>= :PZACAJA   AND :CAMBIARPRECIOXPZACAJA = 'S' ) then
   begin
            APLICAPRECIOCAJA = 'S';
            --PRECIO = :PRECIO3;  
            PRECIO = (case when :LISTAPRECIOXPZACAJA = 1 then :PRECIO1
              when :LISTAPRECIOXPZACAJA = 2 then  :PRECIO2
              when :LISTAPRECIOXPZACAJA = 3 then  :PRECIO3
              when :LISTAPRECIOXPZACAJA = 4 then  :PRECIO4
              when :LISTAPRECIOXPZACAJA = 5 then  :PRECIO5
              else  :PRECIO3
            end);
            FORZARPRECIOLISTA = 'N';
   end
   if(trim(:UNIDAD) = 'KG'  AND :CANTIDAD>= :INI_MAYO AND :MAYOKGS = 'S') then
   begin
            --PRECIO = :PRECIO3;  
            PRECIO = (case when :LISTAPRECIOINIMAYO = 1 then :PRECIO1
              when :LISTAPRECIOINIMAYO = 2 then  :PRECIO2
              when :LISTAPRECIOINIMAYO = 3 then  :PRECIO3
              when :LISTAPRECIOINIMAYO = 4 then  :PRECIO4
              when :LISTAPRECIOINIMAYO = 5 then  :PRECIO5
              else  :PRECIO3
            end);
            FORZARPRECIOLISTA = 'N';
   end


   
   --calcular el precio segun la lista de precio del cliente (precio menudeo)
   PRECIOXLISTACLIENTE = CASE WHEN :LISTAPRECIOCLIENTE = '1' THEN :PRECIO1
                              WHEN :LISTAPRECIOCLIENTE = '2' THEN :PRECIO2
                              WHEN :LISTAPRECIOCLIENTE = '3' THEN :PRECIO3
                              WHEN :LISTAPRECIOCLIENTE = '4' THEN :PRECIO4
                              WHEN :LISTAPRECIOCLIENTE = '5' THEN :PRECIO5
                           END;
   -- comparar con el precio hasta el momento ( o ver si se debe forzar el precio del cliente (precio menudeo))
   IF(:PRECIO > :PRECIOXLISTACLIENTE  OR COALESCE(:FORZARPRECIOLISTA,'N') = 'S') THEN
   BEGIN
       PRECIO = :PRECIOXLISTACLIENTE;
   END


     --DESCLINEAPERSONA

   IF(COALESCE(:HABDESCLINEAPERSONA,'N') = 'S') THEN
   BEGIN
        SELECT LINEAID FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :LINEAID;
        SELECT DESCUENTO FROM DESCLINEAPERS WHERE LINEAID = :LINEAID AND PERSONAID = :PERSONAID INTO :DESCXLINEAPERSONA;

        IF(COALESCE(:DESCXLINEAPERSONA,0) > 0) THEN
        BEGIN
            PRECIOXLINEAPERSONA = :PRECIO1 * ((100 - COALESCE(:DESCXLINEAPERSONA,0)) / 100) ;

            IF(COALESCE(:PRECIOXLINEAPERSONA,0) < COALESCE(:PRECIO,0)) THEN
            BEGIN
                PRECIO = :PRECIOXLINEAPERSONA;
            END
        END
   END



      --INSERT INTO TRAZA(VALOR) VALUES('PT ' || :PAGOCONTARJETA);

      


   IF(COALESCE(:PAGOCONTARJETA,'N') = 'S') THEN
   BEGIN              
        SELECT PRECIOEXPORTACIONLINEA, ERRORCODE FROM GET_PRECIO_CONCOMISIONTARJETA(:PRODUCTOID ,:PERSONAID, :CANTIDAD ,:PRECIO1 ,:PRECIO,:PAGOCONTARJETA)
        INTO :PRECIO , :ERRORCODE;


        --si el precio ya supera el precio de menudeo volver a poner el precio de menudeo
        IF(:PRECIO > :PRECIOXLISTACLIENTE AND COALESCE(:PAGOTARJMENORPRECIOLISTA,'N') = 'S' ) THEN
        BEGIN
            PRECIO = :PRECIOXLISTACLIENTE;
        END


        -- si aplica precio caja entonces poner precio mayoreo con tarjeta
        IF(:aplicapreciocaja = 'S' and coalesce(:PRECIO6,0) > 0) THEN
        BEGIN
            PRECIO = :PRECIO6;
        END


   END



   IF(coalesce(/*:APLICARMAYOREOPORLINEA*/:LINEAAPLICAMAYOREO,'N') = 'S') THEN
   BEGIN
        SELECT PRECIOEXPORTACIONLINEA, ERRORCODE FROM GET_MAYOREOLINEA_PRECIO(:PRODUCTOID ,:PERSONAID, :CANTIDAD ,:PRECIO1 ,:PRECIO,:PAGOCONTARJETA,:PRECIO3,:PRECIO4, :TIPOMAYOREOID, :PRECIO6)
        INTO :PRECIO , :ERRORCODE;
   END

   
--INSERT INTO TRAZA(VALOR) VALUES ( 'CE 2 ' || CAST(:PRECIO AS VARCHAR(12)));



      /* temporal por lo del buen fin */
     if(current_date >= '2013-11-16' and current_date < '2013-11-19' and :precio > :precio2
       and COALESCE(:linea_clave,'') not in ('')  ) then
     begin
            precio = :precio2;
     end


     IF(:TIPODESCUENTOPRODID = 2 AND COALESCE(:PRODUCTODESCUENTO,0) > 0) THEN
     BEGIN
        PRECIO =  :PRECIO * ((100 - COALESCE(:PRODUCTODESCUENTO,0)) / 100) ;
     END


     HABPROMOCIONBODEGAZO = 'N';

     
   IF(coalesce(:LINEAAPLICAMAYOREO,'N') = 'S' AND COALESCE(:PAGOCONTARJETA,'N') = 'N' AND COALESCE(:PAGOACREDITO,'N') = 'N') THEN
   BEGIN
       HABPROMOCIONBODEGAZO = 'S';

   END


    SELECT PRECIOPROMO, ESPROMOCION, PROMOCIONID ,PROMOCIONDESGLOSE, MONEDEROABONO, ERRORCODE
    FROM GET_PROMO_PRECIO(:PRODUCTOID ,:PERSONAID, :CANTIDAD ,:PRECIO1 ,:PRECIO, :HABPROMOCIONBODEGAZO)
    INTO :PRECIO, :ESPROMOCION, :PROMOCIONID ,:PROMOCIONDESGLOSE, :MONEDEROABONO, :ERRORCODE;

    IF(:TIPODESCUENTOPRODID = 1 AND COALESCE(:PRODUCTODESCUENTO,0) > 0) THEN
    BEGIN
      TEMPPRECIO = :PRECIO1 * ((100 - COALESCE(:PRODUCTODESCUENTO,0)) / 100) ;
      IF(:TEMPPRECIO < :PRECIO) THEN
      BEGIN
        PRECIO = :TEMPPRECIO;
      END
    END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END
END