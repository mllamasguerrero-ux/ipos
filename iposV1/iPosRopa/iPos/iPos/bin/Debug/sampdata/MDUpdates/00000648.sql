create or alter procedure MONEDERO_CANCEL_DOCTO (
    DOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable MONEDERO D_FK;
declare variable SALDO D_PRECIO;
declare variable VIGENCIA D_FECHA;
declare variable NUEVOMONTOMONEDERO D_PRECIO;
declare variable NUEVAVIGENCIAMONEDERO D_FECHA;
declare variable ABONOMONEDERO D_PRECIO;
declare variable FECHA D_FECHA;
BEGIN


   SELECT COALESCE(MONEDERO,0), COALESCE(ABONOMONEDERO,0), COALESCE(FECHA, CURRENT_DATE)
    FROM DOCTO WHERE ID = :DOCTOID INTO :MONEDERO, :ABONOMONEDERO, :FECHA;

   IF(:MONEDERO = 0) THEN
   BEGIN               
        INSERT INTO MONEDEROMOVTO (MONEDERO,DOCTOID, MONTO, TIPOMONEDEROMOVTOID)
        VALUES (:MONEDERO, :DOCTOID, :ABONOMONEDERO, 5);
   END
   ELSE
   BEGIN
   
        SELECT COALESCE(SALDO,0), VIGENCIA FROM MONEDERO WHERE ID = :MONEDERO INTO :SALDO, :VIGENCIA;
  
         NUEVOMONTOMONEDERO  = :SALDO - :ABONOMONEDERO;
         NUEVAVIGENCIAMONEDERO = :VIGENCIA;

        INSERT INTO MONEDEROMOVTO (MONEDERO,DOCTOID, MONTO, TIPOMONEDEROMOVTOID, MONTOMONEDERO,VIGENCIAMONEDERO,FECHA)
        VALUES (:MONEDERO, :DOCTOID, :ABONOMONEDERO, 5, :NUEVOMONTOMONEDERO, :NUEVAVIGENCIAMONEDERO,CURRENT_DATE);

        UPDATE MONEDERO SET  SALDO = :NUEVOMONTOMONEDERO
        WHERE ID = :MONEDERO;

   END



   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1022;
      SUSPEND;
   END
END