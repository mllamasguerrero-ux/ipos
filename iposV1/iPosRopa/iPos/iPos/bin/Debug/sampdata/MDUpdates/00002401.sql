create or alter procedure DOCTO_PROMOVER_REBAJA (
    DOCTOPROMOVERREBAJAID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTORECALCULARID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable REBAJAESPECIAL D_BOOLCN;
declare variable LISTAPRECIOMINIMO D_FK;
declare variable PRECIOMINIMO D_PRECIO;
declare variable SUMATOTALCONREBAJA D_PRECIO;
declare variable SEPROMOVIOREBAJA D_BOOLCN;
declare variable SUMAMONTOREBAJA D_PRECIO;
BEGIN

   SEPROMOVIOREBAJA = 'N';

   SELECT COALESCE(REBAJAESPECIAL, 'N') , COALESCE( LISTAPRECIOMINIMO, 5) FROM PARAMETRO INTO :REBAJAESPECIAL , :LISTAPRECIOMINIMO;
              
   IF (:REBAJAESPECIAL <> 'S') THEN
   BEGIN
      SUSPEND;
      EXIT;
   END



   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID
   FROM DOCTO
   WHERE ID = :DOCTOPROMOVERREBAJAID
   INTO :ESTATUSDOCTOID, :TIPODOCTORECALCULARID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 0) THEN
   BEGIN
      ERRORCODE = 1082;
      SUSPEND;
      EXIT;
   END

   -- Si no es de los tipos b?sicos: Salir.
   IF (:TIPODOCTORECALCULARID NOT IN (21)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   -- Leer del DOCTO a recalcular.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID
   FROM DOCTO
   WHERE ID = :DOCTOPROMOVERREBAJAID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID;



   -- Agrega los MOVTO.
   


   FOR SELECT
      MOVTO.ID, MOVTO.PRODUCTOID, MOVTO.LOTE, MOVTO.FECHAVENCE, MOVTO.CANTIDAD, MOVTO.PRECIO, MOVTO.COSTO,
      MOVTO.TIPODIFERENCIAINVENTARIOID , MOVTO.DESCRIPCION1, MOVTO.DESCRIPCION2, MOVTO.DESCRIPCION3,
      (CASE :LISTAPRECIOMINIMO
                            WHEN 1 THEN COALESCE(PRODUCTO.PRECIO1 ,0)
                            WHEN 2 THEN COALESCE(PRODUCTO.PRECIO2 ,0)
                            WHEN 3 THEN COALESCE(PRODUCTO.PRECIO3 ,0)
                            WHEN 4 THEN COALESCE(PRODUCTO.PRECIO4 ,0)
                            ELSE PRODUCTO.PRECIO5
                        END
                      ) PRECIOMINIMO
   FROM MOVTO  LEFT JOIN PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID
   WHERE MOVTO.DOCTOID = :DOCTOPROMOVERREBAJAID AND
      MOVTO.PRECIO < (CASE :LISTAPRECIOMINIMO
                            WHEN 1 THEN COALESCE(PRODUCTO.PRECIO1 ,0)
                            WHEN 2 THEN COALESCE(PRODUCTO.PRECIO2 ,0)
                            WHEN 3 THEN COALESCE(PRODUCTO.PRECIO3 ,0)
                            WHEN 4 THEN COALESCE(PRODUCTO.PRECIO4 ,0)
                            ELSE PRODUCTO.PRECIO5
                        END
                      )
       AND COALESCE(PRODUCTO.PRECIOTOPE,0) > 0
   INTO
      :MOVTOID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO, 
      :TIPODIFERENCIAINVENTARIOID , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :PRECIOMINIMO
   DO
   BEGIN
         
      UPDATE MOVTO SET PRECIOCONREBAJA = PRECIO, TOTALCONREBAJA = TOTAL, ESTADOREBAJA = 1
      WHERE ID = :MOVTOID;


      SELECT ERRORCODE
      FROM MOVTO_INSERT (
         :DOCTOPROMOVERREBAJAID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTORECALCULARID, 0, 0, :PERSONAID, 5, 1,
         0, :PRODUCTOID, :LOTE, :FECHAVENCE, /*:CANTIDAD*/0, 0, 0, 0, 0,/*:PRECIO*/:PRECIOMINIMO, 0,
         /*:REFERENCIA*/ '', /*:REFERENCIAS*/ '', :COSTO, :SUCURSALID, :ALMACENID, 'N',
         :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, null,NULL ,NULL,NULL,:MOVTOID,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
      ) INTO :ERRORCODE;




        IF(:ERRORCODE <> 0) THEN
        BEGIN
          SUSPEND;
          EXIT;
        END

             
      UPDATE MOVTO SET  MONTOREBAJA = COALESCE(TOTAL,0) - COALESCE(TOTALCONREBAJA,0)
      WHERE ID = :MOVTOID;

          SEPROMOVIOREBAJA = 'S';


   END


   IF(:SEPROMOVIOREBAJA = 'S') THEN
   BEGIN



     UPDATE MOVTO SET PRECIOCONREBAJA = PRECIO, TOTALCONREBAJA = TOTAL, ESTADOREBAJA = 0  , MONTOREBAJA = 0
      WHERE DOCTOID = :DOCTOPROMOVERREBAJAID AND COALESCE(ESTADOREBAJA,0) = 0;


      SELECT SUM(COALESCE(TOTALCONREBAJA,0)) , SUM(COALESCE(MONTOREBAJA,0))
      FROM MOVTO WHERE DOCTOID = :DOCTOPROMOVERREBAJAID INTO  :SUMATOTALCONREBAJA, :SUMAMONTOREBAJA;

      UPDATE DOCTO
      SET TOTALCONREBAJA = :SUMATOTALCONREBAJA   ,
          MONTOREBAJA = :SUMAMONTOREBAJA
      WHERE ID = :DOCTOPROMOVERREBAJAID;


   END


   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END