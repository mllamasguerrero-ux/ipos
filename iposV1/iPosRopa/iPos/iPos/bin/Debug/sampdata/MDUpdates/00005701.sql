create or alter procedure KIT_ADDENPROCESODESALIDA (
    PRODUCTOID D_FK,
    ALMACENID D_FK,
    CANTIDAD D_CANTIDAD)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable PRODUCTOPARTEID D_FK;
declare variable PRODUCTOPARTECLAVE D_CLAVE;
declare variable KITCANTIDADPARTE D_CANTIDAD;
declare variable ENPROCESODESALIDAACTUAL D_FK;
declare variable PRODUCTOALMACENID D_FK;
BEGIN

    ERRORCODE = 0;

         
   FOR SELECT
         PRODUCTO.ID, KITDEFINICION.cantidadparte
    FROM  KITSUNNIVEL_VIEW KITDEFINICION INNER JOIN PRODUCTO ON PRODUCTO.ID = KITDEFINICION.productoparteid
    WHERE KITDEFINICION.productokitid = :PRODUCTOID
   INTO
      :PRODUCTOPARTEID, :KITCANTIDADPARTE
   DO
   BEGIN
        UPDATE PRODUCTO
        SET PRODUCTO.enprocesodesalida =  IIF( (COALESCE(PRODUCTO.enprocesodesalida,0) + (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0))) > 0 ,  (COALESCE(PRODUCTO.enprocesodesalida,0) + (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0))) ,  0)
        WHERE PRODUCTO.ID = :PRODUCTOPARTEID;
   END



    FOR SELECT
         coalesce(PRODUCTOALMACEN.ID,0), KITDEFINICION.productoparteid, PRODUCTO.clave , KITDEFINICION.cantidadparte  , COALESCE(PRODUCTOALMACEN.enprocesodesalida ,0)
    FROM  KITSUNNIVEL_VIEW KITDEFINICION LEFT JOIN PRODUCTOALMACEN ON PRODUCTOALMACEN.PRODUCTOID = KITDEFINICION.productoparteid AND PRODUCTOALMACEN.ALMACENID = :ALMACENID
    left join producto on producto.id =  KITDEFINICION.productoparteid
    WHERE KITDEFINICION.productokitid = :PRODUCTOID
   INTO
      :PRODUCTOALMACENID, :PRODUCTOPARTEID, :PRODUCTOPARTECLAVE, :KITCANTIDADPARTE, :ENPROCESODESALIDAACTUAL
   DO
   BEGIN

        IF(COALESCE(:PRODUCTOALMACENID,0) = 0) THEN
        BEGIN
            IF(  (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0)) > 0 ) THEN
            BEGIN
               INSERT INTO PRODUCTOALMACEN(ACTIVO,PRODUCTOCLAVE, PRODUCTOID, ALMACENID, ENPROCESODESALIDA)
                VALUES('S',:PRODUCTOPARTECLAVE,:PRODUCTOPARTEID, :almacenid , (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0)));
            END

        END
        ELSE IF( (COALESCE(:ENPROCESODESALIDAACTUAL,0) + (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0))) > 0 ) THEN
        BEGIN
            UPDATE PRODUCTOALMACEN
            SET PRODUCTOALMACEN.enprocesodesalida =   (COALESCE(PRODUCTOALMACEN.enprocesodesalida,0) + (COALESCE(:KITCANTIDADPARTE,0) * COALESCE(:CANTIDAD,0)))
            WHERE PRODUCTOALMACEN.ID = :PRODUCTOALMACENID  ;

        END
        ELSE
        BEGIN
             DELETE FROM  PRODUCTOALMACEN WHERE ID = :PRODUCTOALMACENID;


        END

   END


   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
     ERRORCODE = 1076;
     SUSPEND;
   END

END