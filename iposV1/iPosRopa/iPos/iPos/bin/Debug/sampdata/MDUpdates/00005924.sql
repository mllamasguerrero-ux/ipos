CREATE OR ALTER trigger docto_ppc_matriz_update_tr for docto
active after update position 9998
AS
declare variable CLAVEMATRIZ D_CLAVE_NULL;
declare variable SUCURSALCLAVE D_CLAVE_NULL; 
declare variable SUCURSALDESTCLAVE D_CLAVE_NULL; 
declare variable HABPPC D_BOOLCN;
begin
  /* Trigger text */

  --SI NO CAMBIA ALGUNO DE LOS ELEMENTOS PARA ENVIAR EL CAMBIO Y NO ES DEL TIPO DE COMPRAS DE SUCURSALES SALTE
  IF(
        NOT (
            NEW.ESTATUSDOCTOID = 1  AND NEW.TIPODOCTOID = 1011 AND
            ( 
                COALESCE(NEW.FECHAFACTURA,'1.1.2000') <>  COALESCE(OLD.FECHAFACTURA,'1.1.2000') OR
                COALESCE(NEW.ORIGENFISCALID,0) <>  COALESCE(OLD.ORIGENFISCALID,0) OR
                COALESCE(NEW.REFERENCIA,'') <>  COALESCE(OLD.REFERENCIA,'') OR
                COALESCE(NEW.PERSONAID,0) <>  COALESCE(OLD.PERSONAID,0)
            )
        )
      ) THEN
  BEGIN
     EXIT;
  END
  
  SELECT SUCURSALNUMERO, HABPPC FROM PARAMETRO INTO :SUCURSALCLAVE, :HABPPC;

  IF(COALESCE(:HABPPC,'N') <> 'S') THEN
  BEGIN
    EXIT;
  END

  --COMPARA LA SUCURSAL CON LA MATRIZ
  SELECT FIRST 1 CLAVEMATRIZ FROM MATRIZPRINCIPAL INTO :CLAVEMATRIZ;
  SELECT CLAVE FROM SUCURSAL WHERE ID = COALESCE(NEW.SUCURSALTID ,0) INTO :SUCURSALDESTCLAVE;

  IF(COALESCE(:SUCURSALCLAVE,'') = COALESCE(:CLAVEMATRIZ,'') AND COALESCE(:SUCURSALDESTCLAVE,'') <> '') THEN
  BEGIN

     IF(NEW.ESTATUSDOCTOID = 1  AND NEW.TIPODOCTOID = 1011 AND
            ( 
                COALESCE(NEW.FECHAFACTURA,'1.1.2000') <>  COALESCE(OLD.FECHAFACTURA,'1.1.2000') OR
                COALESCE(NEW.ORIGENFISCALID,0) <>  COALESCE(OLD.ORIGENFISCALID,0) OR
                COALESCE(NEW.REFERENCIA,'') <>  COALESCE(OLD.REFERENCIA,'') OR
                COALESCE(NEW.PERSONAID,0) <>  COALESCE(OLD.PERSONAID,0)
            )
         ) THEN
     BEGIN

        UPDATE OR INSERT INTO REPLEXPOCTRL
        (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
        VALUES (:SUCURSALDESTCLAVE,  NEW.ID, NEW.MODIFICADO, 5, 1)
        MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);
      END





  END


end
