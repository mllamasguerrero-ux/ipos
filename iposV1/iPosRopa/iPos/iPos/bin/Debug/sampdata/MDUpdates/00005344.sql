create or alter procedure INVENTARIO_APLICAR (
    INVENTARIODOCTOID D_FK,
    TIPODOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable DOCTOID D_FK;
declare variable DOCTO2ID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable CAJAID D_FK;
declare variable SUCURSALID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable CANTIDADSURTIDA D_CANTIDAD;
declare variable CANTIDADFALTANTE D_CANTIDAD;
declare variable CANTIDADDIFERENCIA D_CANTIDAD;
declare variable ESTATUSDOCTOID D_FK;
declare variable FALTANTES integer;
declare variable REFERENCIA D_REFERENCIA;
declare variable COSTO D_COSTO;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable TIPODOCTOINVFISID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable LOTEIMPORTADO D_FK;
BEGIN
   IF ((:INVENTARIODOCTOID IS NULL) OR (:INVENTARIODOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1064;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID NOT IN (51, 52)) THEN
   BEGIN
      ERRORCODE = 1064;
      SUSPEND;
      EXIT;
   END

   SELECT ALMACENID, SUCURSALID, CAJAID, TIPODOCTOID
   FROM DOCTO
   WHERE ID = :INVENTARIODOCTOID
   INTO :ALMACENID, :SUCURSALID, :CAJAID, :TIPODOCTOINVFISID;

   IF (:TIPODOCTOINVFISID <> 50) THEN
   BEGIN
      ERRORCODE = 1064;
      SUSPEND;
      EXIT;
   END

   IF (:TIPODOCTOID = 51) THEN
      REFERENCIA = 'Aplic Dif Inv Sobrante';
   ELSE IF (:TIPODOCTOID = 52) THEN
      REFERENCIA = 'Aplic Dif Inv Faltante';

   -- Inicializara para primer registro de movto
   DOCTOID = 0;

   -- Agrega un MOVTO para cada registro con diferencia
   -- entre CANTIDAD y CANTIDADSURTIDA
   FOR SELECT
      M.PRODUCTOID,
      M.LOTE,
      M.FECHAVENCE,
      M.CANTIDAD, 
      M.CANTIDADSURTIDA,
      M.CANTIDADFALTANTE,
      M.COSTO,
      M.TIPODIFERENCIAINVENTARIOID ,
      M.DESCRIPCION1,
      M.DESCRIPCION2,
      M.DESCRIPCION3,
      M.LOTEIMPORTADO
   FROM MOVTO M
   WHERE M.DOCTOID = :INVENTARIODOCTOID
      AND (M.CANTIDAD <> M.CANTIDADSURTIDA)
   INTO
      :PRODUCTOID, :LOTE, :FECHAVENCE,
      :CANTIDAD, :CANTIDADSURTIDA, :CANTIDADFALTANTE,
      :COSTO, :TIPODIFERENCIAINVENTARIOID  , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :LOTEIMPORTADO
   DO
   BEGIN
      COSTO = 0;

      SUCURSALTID = 0;
      ALMACENTID = 0;


      IF (:TIPODOCTOID = 51) THEN -- Sobrantes
         CANTIDADDIFERENCIA = :CANTIDADSURTIDA - :CANTIDAD;
      ELSE IF (:TIPODOCTOID = 51) THEN -- Faltantes
         CANTIDADDIFERENCIA = :CANTIDAD - :CANTIDADSURTIDA;
      ELSE
         CANTIDADDIFERENCIA = 0;

      IF (:CANTIDADDIFERENCIA <> 0) THEN
      BEGIN
         SELECT DOCTOID, MOVTOID, ERRORCODE
         FROM MOVTO_INSERT(:DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, 0, 0, 1, 0,
            :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, :CANTIDAD, 0, 0, 0, 0,
            :REFERENCIA, '', :COSTO, :SUCURSALTID, :ALMACENTID, 'N', :TIPODIFERENCIAINVENTARIOID,
            CURRENT_DATE, CURRENT_DATE, 0.00,NULL,NULL,NULL,NULL,NULL, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, NULL, :LOTEIMPORTADO, 'N','N')
         INTO :DOCTOID, :MOVTOID, :ERRORCODE;

         IF ((:ERRORCODE IS NOT NULL) OR (:ERRORCODE > 0)) THEN
         BEGIN
            SUSPEND;
            EXIT;
         END
      END
   END

   SELECT ERRORCODE
   FROM DOCTO_SAVE(:DOCTOID)
   INTO :ERRORCODE;

   IF ((:ERRORCODE IS NOT NULL) OR (:ERRORCODE > 0)) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END
   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
     ERRORCODE = 1065;
     SUSPEND;
   END
END