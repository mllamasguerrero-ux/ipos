create or alter procedure GET_EXISTENCIAPARAKIT (
    PRODUCTOID D_FK,
    ALMACENID D_FK,
    CANTIDAD D_CANTIDAD)
returns (
    HAYEXISTENCIA D_BOOLCS,
    ERRORCODE D_ERRORCODE)
as
declare variable CUENTASINEXIS integer;
declare variable MANEJAALMACEN D_BOOLCN;
BEGIN

    CUENTASINEXIS = 0;
    HAYEXISTENCIA = 'S';

    SELECT FIRST 1 COALESCE(MANEJAALMACEN,'N')
    FROM PARAMETRO
    into :MANEJAALMACEN;

    IF (:MANEJAALMACEN = 'S') THEN
   BEGIN
   
   
     SELECT COUNT(*) FROM
    (
    SELECT INVEXIS.productoparteid , INVEXIS.invcantidad,  INVEXIS.CANTIDADREQUERIDA, SUM(COALESCE(PRODUCTOALMACEN.enprocesodesalida,0)) ENPROCESOSALIDA
    FROM
    (
    SELECT k.productoparteid, sum(inv.cantidad) invcantidad, (COALESCE(K.cantidadparte,0) *  :CANTIDAD  ) CANTIDADREQUERIDA  FROM kitdefinicion K
    INNER JOIN PRODUCTO P ON K.productoparteid = P.ID
    LEFT JOIN INVENTARIO INV ON INV.PRODUCTOID = K.PRODUCTOPARTEID AND INV.ALMACENID = :ALMACENID  AND COALESCE(INV.ESAPARTADO,'N') = 'N'
    WHERE COALESCE(K.productokitid, 0) = :PRODUCTOID
    GROUP BY K.PRODUCTOPARTEID  , K.cantidadparte ) INVEXIS
    LEFT join PRODUCTOALMACEN ON PRODUCTOALMACEN.productoid = INVEXIS.PRODUCTOPARTEID AND PRODUCTOALMACEN.almacenid = :ALMACENID

    GROUP BY  INVEXIS.productoparteid , INVEXIS.invcantidad,  INVEXIS.CANTIDADREQUERIDA

    HAVING CANTIDADREQUERIDA > (invcantidad - SUM(COALESCE(PRODUCTOALMACEN.enprocesodesalida,0)))
    )

    INTO :CUENTASINEXIS;


   END
   ELSE
   BEGIN


    SELECT COUNT(*) FROM kitdefinicion K
    INNER JOIN PRODUCTO P ON K.productoparteid = P.ID
    WHERE COALESCE(K.productokitid, 0) = :PRODUCTOID
    AND P.EXISTENCIA  < (COALESCE(K.cantidadparte,0) *  :CANTIDAD  )
    INTO :CUENTASINEXIS;
   END

    IF( COALESCE(:CUENTASINEXIS,0) > 0 ) THEN
    BEGIN
        HAYEXISTENCIA = 'N';
    END


   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1043;
      SUSPEND;
   END 
END