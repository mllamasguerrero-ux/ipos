CREATE OR ALTER VIEW MOVTOS_SINEXISTENCIA(
    MOVTOID,
    DOCTOID,
    DOCTOFOLIO,
    PRODUCTOID,
    CLAVE,
    NOMBRE,
    DESCRIPCION,
    DESCRIPCION1,
    DESCRIPCION2,
    EXISTENCIA,
    CANTIDADMOVTO,
    DIFERENCIA)
AS
SELECT M.ID MOVTOID,
    D.ID DOCTOID,
    D.FOLIO DOCTOFOLIO,
    P.ID  PRODUCTOID,
    COALESCE(TRIM(P.CLAVE), '') CLAVE,
    COALESCE(TRIM(P.NOMBRE), '') NOMBRE,
    COALESCE(TRIM(P.DESCRIPCION), '') DESCRIPCION,
    COALESCE(TRIM(P.DESCRIPCION1),'') DESCRIPCION1,
    COALESCE(TRIM(P.DESCRIPCION2), '') DESCRIPCION2,
     COALESCE(P.existencia,0) EXISTENCIA,
     COALESCE(M.CANTIDAD,0) CANTIDADMOVTO,
     COALESCE(M.CANTIDAD,0) - COALESCE(P.EXISTENCIA,0) DIFERENCIA

  FROM MOVTO M
  INNER JOIN DOCTO D ON D.ID = M.DOCTOID
   INNER JOIN PRODUCTO  P ON P.ID = M.PRODUCTOID
   WHERE D.TIPODOCTOID IN (21,25,12,31) AND D.estatusdoctoid = 0
   AND  (COALESCE(M.CANTIDAD,0) - COALESCE(P.EXISTENCIA,0)) > 0
   and p.inventariable = 'S' AND P.negativos = 'N'


  ORDER BY M.ID
;