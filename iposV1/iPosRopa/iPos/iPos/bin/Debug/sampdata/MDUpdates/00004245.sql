create or alter procedure PRODUCTO_UPDATE (
    PRODUCTOID type of D_FK,
    ACTIVO D_BOOLCS,
    MODIFICADOPOR_USERID type of D_FK,
    CLAVE D_CLAVE,
    NOMBRE D_NOMBRE,
    DESCRIPCION D_DESCRIPCION,
    EAN D_CLAVE,
    DESCRIPCION1 D_STDTEXT_MEDIUM,
    DESCRIPCION2 D_STDTEXT_MEDIUM,
    DESCRIPCION3 varchar(40),
    PROVEEDOR1ID integer,
    PROVEEDOR2ID integer,
    LINEAID integer,
    MARCAID integer,
    PRECIO1 D_PRECIO,
    PRECIO2 D_PRECIO,
    PRECIO3 D_PRECIO,
    PRECIO4 D_PRECIO,
    PRECIO5 D_PRECIO,
    TASAIVAID D_FK,
    TASAIVA D_PORCENTAJE,
    MONEDAID D_FK,
    COSTOREPOSICION D_COSTO,
    COSTOULTIMO D_COSTO,
    COSTOPROMEDIO D_COSTO,
    PRODUCTOSUSTITUTOID D_FK,
    MANEJALOTE D_BOOLCN,
    ESKIT D_BOOLCN,
    IMPRIMIR D_BOOLCN,
    INVENTARIABLE D_BOOLCN,
    NEGATIVOS D_BOOLCN,
    LIMITEPRECIO2 D_CANTIDAD,
    PRECIOMAXIMOPUBLICO D_PRECIO,
    FECHACAMBIOPRECIO D_FECHA,
    MANEJASTOCK D_BOOLCN,
    STOCK D_CANTIDAD,
    CAMBIARPRECIO D_BOOLCN,
    COMISION D_PRECIO,
    OFERTA D_PRECIO,
    TOMARPRECIOPADRE D_BOOLCN,
    TOMARCOMISIONPADRE D_BOOLCN,
    TOMAROFERTAPADRE D_BOOLCN,
    TEXTO1 D_STDTEXT_LIGHT,
    TEXTO2 D_STDTEXT_LIGHT,
    TEXTO3 D_STDTEXT_LIGHT,
    TEXTO4 D_STDTEXT_LIGHT,
    TEXTO5 D_STDTEXT_MEDIUM,
    TEXTO6 D_STDTEXT_LARGE,
    NUMERO1 D_PRECIO,
    NUMERO2 D_PRECIO,
    NUMERO3 D_PRECIO,
    NUMERO4 D_PRECIO,
    FECHA1 D_FECHA,
    FECHA2 D_FECHA,
    PZACAJA D_CANTIDAD,
    U_EMPAQUE D_CANTIDAD,
    UNIDAD D_CLAVE_NULL,
    CBARRAS D_CLAVE_NULL,
    CEMPAQUE D_CLAVE_NULL,
    PLUG D_CLAVE_NULL,
    MAYOKGS D_BOOLCN,
    INI_MAYO D_CANTIDAD,
    DESCRIPCION_COMODIN D_BOOLCN,
    CUENTAPREDIAL D_STDTEXT_64,
    IMAGEN D_IMAGEN,
    TASAIEPS D_PORCENTAJE,
    TASAIMPUESTO D_PORCENTAJE,
    MINUTILIDAD D_PORCENTAJE,
    SPRECIO1 D_PRECIO,
    SPRECIO2 D_PRECIO,
    SPRECIO3 D_PRECIO,
    SPRECIO4 D_PRECIO,
    SPRECIO5 D_PRECIO,
    DESCUENTO D_PORCENTAJE,
    REQUIERERECETA D_BOOLCN,
    PRECIOSUGERIDO D_PRECIO,
    PRECIOTOPE D_PRECIO,
    STOCKMAX D_CANTIDAD,
    SURTIRPORCAJA D_BOOLCN,
    TIPOABC D_BOOLCN,
    PRECIOMAT char(1),
    PRECIO6 D_PRECIO,
    MENUDEO D_CANTIDAD,
    CONTENIDOID D_FK,
    CONTENIDOVALOR D_CONTENIDO,
    CLASIFICAID D_FK,
    UNIDAD2 D_CLAVE_NULL,
    CANTXPIEZA D_CANTIDAD,
    MANEJALOTEIMPORTADO D_BOOLCN,
    COSTOENDOLAR D_PRECIO)
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable ESPRODUCTOFINAL D_BOOLCN;
declare variable ESPRODUCTOPADRE D_BOOLCN;
declare variable ESSUBPRODUCTO D_BOOLCN;
declare variable CARACTERISTICAID D_FK;
declare variable PRODUCTOIDBUFFER D_FK;
declare variable PRODUCTOCARACTERISTICASID D_FK;
declare variable TASAIVAMONTO D_PORCENTAJE;
declare variable MANEJAKITS D_BOOLCN;
declare variable OLDINVENTARIABLE D_BOOLCN;
declare variable CUENTAESTAENKITSNOINV integer;
declare variable CUENTAAUX integer;
declare variable EANPUEDEREPETIRSE D_BOOLCN;
BEGIN

      PRODUCTOIDBUFFER = null;
      
      select first 1 manejakits, EANPUEDEREPETIRSE from parametro into :MANEJAKITS, :EANPUEDEREPETIRSE;

       select first 1 id, inventariable from producto where id = :productoid
       into :PRODUCTOIDBUFFER, :oldinventariable;

        IF(COALESCE(:PRODUCTOIDBUFFER,0) = 0) then
        BEGIN
            ERRORCODE = 1003;-- TODO Poner el erro code correcto
            SUSPEND;
            EXIT;
        END

        
   SELECT  COALESCE(TASA,0) FROM TASAIVA WHERE ID = :TASAIVAID INTO :TASAIVAMONTO; 
   TASAIMPUESTO = COALESCE(:TASAIEPS,0)  +  COALESCE(:TASAIVAMONTO,0) +  ((COALESCE(:TASAIEPS,0) * COALESCE(:TASAIVAMONTO,0))/100) ;
              

     IF(  COALESCE(:MANEJAKITS,'N') = 'S') THEN
     BEGIN
        IF(COALESCE(:ESKIT,'N') = 'S' AND COALESCE(:NEGATIVOS,'N') = 'S') THEN
        BEGIN   
            ERRORCODE = 4009;-- TODO Poner el erro code correcto
            SUSPEND;
            EXIT;
        END

        if(COALESCE(:OLDINVENTARIABLE,'N') = 'N' AND COALESCE(:INVENTARIABLE ,'N') = 'S') THEN
        BEGIN
            
            SELECT COUNT(*) FROM
            (SELECT PRODUCTOKITID FROM KITDEFINICION WHERE PRODUCTOPARTEID = :PRODUCTOID GROUP BY PRODUCTOKITID) KITS
            INNER JOIN PRODUCTO ON PRODUCTO.ID = KITS.PRODUCTOKITID
            WHERE COALESCE(PRODUCTO.inventariable,'N') = 'N'
            INTO :CUENTAESTAENKITSNOINV;


            IF(COALESCE(:CUENTAESTAENKITSNOINV,0) > 0) THEN
            BEGIN
                   
                ERRORCODE = 4011;
                SUSPEND;
                EXIT;
            END

        END



     END


     IF(coalesce(:EAN,'') <> ''  AND COALESCE(:EANPUEDEREPETIRSE,'N') = 'N') THEN
     BEGIN
       select count(*) from producto where ean = :ean  AND ID <> :PRODUCTOID
       into :CUENTAAUX;

        IF(COALESCE(:CUENTAAUX,0) <> 0) then
        BEGIN
            ERRORCODE = 1085;
            SUSPEND;
            EXIT;
        END
      END
      ELSE IF(coalesce(:EAN,'') = '') THEN
      BEGIN
        EAN = '';
      END




      update PRODUCTO
      set

    ACTIVO = :ACTIVO ,


MODIFICADOPOR_USERID = :MODIFICADOPOR_USERID ,

--CLAVE = :CLAVE ,

NOMBRE = :NOMBRE ,

DESCRIPCION = :DESCRIPCION ,

EAN = :EAN ,

DESCRIPCION1 = :DESCRIPCION1 ,

DESCRIPCION2 = :DESCRIPCION2 ,

DESCRIPCION3 = :DESCRIPCION3 ,

PROVEEDOR1ID = :PROVEEDOR1ID ,

PROVEEDOR2ID = :PROVEEDOR2ID ,

LINEAID = :LINEAID ,

MARCAID = :MARCAID ,

PRECIO1 = :PRECIO1 ,

PRECIO2 = :PRECIO2 ,

PRECIO3 = :PRECIO3 ,

PRECIO4 = :PRECIO4 ,

PRECIO5 = :PRECIO5 ,

TASAIVAID = :TASAIVAID ,

TASAIVA = /*:TASAIVAMONTO,--*/:TASAIVA ,

MONEDAID = :MONEDAID ,

COSTOREPOSICION = :COSTOREPOSICION ,

COSTOULTIMO = :COSTOULTIMO ,

COSTOPROMEDIO = :COSTOPROMEDIO ,

PRODUCTOSUSTITUTOID = :PRODUCTOSUSTITUTOID ,

MANEJALOTE = :MANEJALOTE ,

ESKIT = :ESKIT ,

IMPRIMIR = :IMPRIMIR ,

INVENTARIABLE = :INVENTARIABLE ,

NEGATIVOS = :NEGATIVOS ,

LIMITEPRECIO2 = :LIMITEPRECIO2 ,

PRECIOMAXIMOPUBLICO = :PRECIOMAXIMOPUBLICO ,

FECHACAMBIOPRECIO = :FECHACAMBIOPRECIO ,

MANEJASTOCK = :MANEJASTOCK ,

STOCK = :STOCK ,

CAMBIARPRECIO = :CAMBIARPRECIO  ,

COMISION = :COMISION ,
OFERTA = :OFERTA  ,
TOMARPRECIOPADRE  = :TOMARPRECIOPADRE ,
TOMARCOMISIONPADRE = :TOMARCOMISIONPADRE  ,
TOMAROFERTAPADRE = :TOMAROFERTAPADRE   ,

PZACAJA = :PZACAJA ,
U_EMPAQUE = :U_EMPAQUE,
UNIDAD = :UNIDAD ,
    CBARRAS = :CBARRAS,
    CEMPAQUE = :CEMPAQUE,
    PLUG = :PLUG,
    MAYOKGS = :MAYOKGS,

    INI_MAYO = :INI_MAYO,
    DESCRIPCION_COMODIN = :DESCRIPCION_COMODIN ,

    CUENTAPREDIAL = :CUENTAPREDIAL ,
    IMAGEN = :IMAGEN  ,
    TASAIEPS = :TASAIEPS,
    TASAIMPUESTO = :TASAIMPUESTO ,

    MINUTILIDAD = :MINUTILIDAD  ,

    SPRECIO1 = :SPRECIO1 ,

    SPRECIO2 = :SPRECIO2 ,

    SPRECIO3 = :SPRECIO3 ,

    SPRECIO4 = :SPRECIO4 ,

    SPRECIO5 = :SPRECIO5  ,

    DESCUENTO  = :DESCUENTO ,

    REQUIERERECETA = :REQUIERERECETA ,

    PRECIOSUGERIDO = :PRECIOSUGERIDO,

    PRECIOTOPE = :PRECIOTOPE ,

    STOCKMAX = :STOCKMAX,

    SURTIRPORCAJA = :SURTIRPORCAJA ,

    TIPOABC = :TIPOABC ,

     PRECIOMAT = :PRECIOMAT ,

     PRECIO6 = :PRECIO6,

    MENUDEO = :MENUDEO,

    CONTENIDOID = :CONTENIDOID,

    CONTENIDOVALOR = :CONTENIDOVALOR,

    CLASIFICAID = :CLASIFICAID  ,

    UNIDAD2 = :UNIDAD2  ,

    CANTXPIEZA = :CANTXPIEZA  ,

    MANEJALOTEIMPORTADO = :MANEJALOTEIMPORTADO ,

    COSTOENDOLAR = :COSTOENDOLAR

where id = :PRODUCTOID;

PRODUCTOCARACTERISTICASID = Null;

SELECT ID FROM PRODUCTOCARACTERISTICAS
WHERE PRODUCTOID =  :PRODUCTOID
INTO :PRODUCTOCARACTERISTICASID;

IF(COALESCE(:PRODUCTOCARACTERISTICASID  ,0) = 0) THEN
BEGIN

 INSERT INTO productocaracteristicas
 ( PRODUCTOID,
  CLAVE,
   TEXTO1,
   TEXTO2,
   TEXTO3,
   TEXTO4,
   TEXTO5,
   TEXTO6,
   NUMERO1,
   NUMERO2,
   NUMERO3,
   NUMERO4,
   FECHA1,
   FECHA2
  )
  VALUES
   (:PRODUCTOID, 
   :CLAVE,
   :TEXTO1,
   :TEXTO2,
   :TEXTO3,
   :TEXTO4,
   :TEXTO5,
   :TEXTO6,
   :NUMERO1,
   :NUMERO2,
   :NUMERO3,
   :NUMERO4,
   :FECHA1,
   :FECHA2
   );
END
ELSE
BEGIN
UPDATE  productocaracteristicas
 SET
   TEXTO1 = :TEXTO1,
   TEXTO2 = :TEXTO2,
   TEXTO3 = :TEXTO3,
   TEXTO4 = :TEXTO4,
   TEXTO5 = :TEXTO5,
   TEXTO6 = :TEXTO6,
   NUMERO1 = :NUMERO1,
   NUMERO2 = :NUMERO2,
   NUMERO3 = :NUMERO3,
   NUMERO4 = :NUMERO4,
   FECHA1 = :FECHA1,
   FECHA2 = :FECHA2
 WHERE ID = :PRODUCTOCARACTERISTICASID;

END


   ERRORCODE = 0;
   SUSPEND;
END