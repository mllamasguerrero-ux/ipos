create or alter procedure DOCTOPAGO_INSERT (
    DOCTOID D_FK,
    FORMAPAGOID D_FK,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    CORTEID D_FK,
    IMPORTE D_IMPORTE,
    IMPORTERECIBIDO D_IMPORTE,
    IMPORTECAMBIO D_IMPORTE,
    TIPOPAGOID D_FK,
    DOCTOSALIDAID D_FK,
    ESAPARTADO D_BOOLCN,
    TIPOAPLICACIONCREDITOID D_FK,
    BANCO D_FK,
    REFERENCIABANCARIA D_STDTEXT_LIGHT,
    NOTAS D_STDTEXT_MEDIUM,
    FECHAELABORACION D_FECHA,
    FECHARECEPCION D_FECHA,
    ESPAGOINICIAL D_BOOLCN,
    TIPOABONOID D_FK,
    DOCTOPAGOREFID D_FK,
    FORMAPAGOSATID D_FK,
    BANCOMERPARAMID D_FK)
returns (
    DOCTOPAGOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCS;
declare variable TIPODOCTOID D_FK;
BEGIN
  ACTIVO = 'N';
  SELECT COALESCE(ACTIVO,'N') FROM CORTE WHERE ID = :CORTEID INTO :ACTIVO;

  IF(:ACTIVO <> 'S') THEN
  BEGIN

      IF(COALESCE(:DOCTOSALIDAID ,0) <> 0 AND TIPOPAGOID = 2) THEN
      BEGIN
         SELECT FIRST 1 TIPODOCTOID FROM DOCTO WHERE ID = :DOCTOSALIDAID INTO :TIPODOCTOID;

         IF(COALESCE(:TIPODOCTOID,0) NOT IN (62,63,64,65)) THEN
         BEGIN
              
            ERRORCODE = 1001;
            SUSPEND;
            EXIT;
         END

      END
      ELSE
      BEGIN
        
        ERRORCODE = 1001;
        SUSPEND;
        EXIT;
      END

  END

   INSERT INTO DOCTOPAGO (
      DOCTOID,
      FORMAPAGOID,
      FECHA,
      FECHAHORA,
      CORTEID,
      IMPORTE,
      IMPORTERECIBIDO,
      IMPORTECAMBIO ,
      TIPOPAGOID ,
      DOCTOSALIDAID ,
      ESAPARTADO ,
      TIPOAPLICACIONCREDITOID ,
      BANCO,
      REFERENCIABANCARIA ,
      NOTAS,
      FECHAELABORACION,
      FECHARECEPCION ,
      ESPAGOINICIAL,
      TIPOABONOID,
      DOCTOPAGOREFID,
      FORMAPAGOSATID,
      BANCOMERPARAMID
   ) VALUES (
      :DOCTOID,
      :FORMAPAGOID,
      :FECHA,
      :FECHAHORA,
      :CORTEID,
      :IMPORTE,
      :IMPORTERECIBIDO,
      :IMPORTECAMBIO ,
      :TIPOPAGOID  ,
      :DOCTOSALIDAID ,
      :ESAPARTADO,
      :TIPOAPLICACIONCREDITOID ,
      :BANCO,
      :REFERENCIABANCARIA,
      :NOTAS ,
      :FECHAELABORACION,
      :FECHARECEPCION ,
      :ESPAGOINICIAL ,
      :TIPOABONOID,
      :DOCTOPAGOREFID ,
      :FORMAPAGOSATID ,
      :BANCOMERPARAMID
      )
   RETURNING ID INTO :DOCTOPAGOID;


   IF(:TIPOABONOID = 3) THEN
   BEGIN
       UPDATE doctopago SET REVERTIDO = 'S' WHERE ID = :DOCTOPAGOREFID;
   END



   IF(COALESCE(:BANCOMERPARAMID, 0) <> 0) THEN
   BEGIN
        UPDATE bancomerparam SET DOCTOPAGOID = :DOCTOPAGOID WHERE ID = :BANCOMERPARAMID;
   END
   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1012;
      SUSPEND;
   END
END