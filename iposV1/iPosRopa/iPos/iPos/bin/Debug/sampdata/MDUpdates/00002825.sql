create or alter procedure TTL_REP_PROVEEDOR_COMPARACION (
    PERSONAID_P D_FK,
    ANIO1 D_DIAS,
    ANIO2 D_DIAS,
    INCLUIRTRASL varchar(1) character set NONE)
returns (
    MES D_CLAVE,
    PERSONAID D_FK,
    CANTIDADANIO1 D_DIAS,
    TOTALANIO1 D_PRECIO,
    CANTIDADANIO2 D_DIAS,
    TOTALANIO2 D_PRECIO,
    DIFERENCIA D_PRECIO,
    PORCENTAJEDIFERENCIA D_PORCENTAJE,
    ACUMULADODIFERENCIA D_PRECIO,
    PORCACUMULADODIFERENCIA D_PORCENTAJE)
as
declare variable ACUMULADOANIO1 D_PRECIO;
begin

ANIO1 = 2014;
ANIO2 = 2015;
PERSONAID_P = 1030;
INCLUIRTRASL = 'S';



MES  = '';
PERSONAID  = 0;
CANTIDADANIO1  = 0;
TOTALANIO1  = 0;
CANTIDADANIO2  = 0;
TOTALANIO2  = 0;
DIFERENCIA  = 0;


ACUMULADODIFERENCIA = 0;
ACUMULADOANIO1 = 0;
PORCACUMULADODIFERENCIA = 0;

  FOR
SELECT M.clave MES,
D1.PERSONAID,
D1.CANTIDAD CANTIDADANIO1,
D1.TOTAL TOTALANIO1,
D2.CANTIDAD CANTIDADANIO2,
D2.TOTAL TOTALANIO2,
COALESCE(D2.TOTAL ,0) -  COALESCE(D1.TOTAL ,0) DIFERENCIA,
((COALESCE(D2.TOTAL ,0) -  COALESCE(D1.TOTAL ,0)) /  CASE WHEN COALESCE(D1.TOTAL,0)  <> 0 THEN D1.TOTAL ELSE COALESCE(D2.TOTAL,1) END) *100  PORCDIFERENCIA

FROM
MESES M LEFT JOIN
(
select
        PERSONAID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_docto_pers_mes
      where
          ANIO = :ANIO1   AND PERSONAID = :PERSONAID_P AND
          ( TIPODOCTOID IN (11,12,13) OR   (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (41,42,43) )    )

      group by PERSONAID,
            MES,
            ANIO

            )   D1 ON D1.MES = M.ID

              LEFT JOIN
            (
select
        PERSONAID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (11,41) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_docto_pers_mes
      where
          ANIO = :ANIO2   AND PERSONAID = :PERSONAID_P AND
          ( TIPODOCTOID IN (11,12,13) OR   (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (41,42,43) )    )

      group by PERSONAID,
            MES,
            ANIO

            )  D2 ON D2.MES = M.ID

      INTO :MES ,
:PERSONAID ,
:CANTIDADANIO1 ,
:TOTALANIO1 ,
:CANTIDADANIO2 ,
:TOTALANIO2 ,
:DIFERENCIA ,
:PORCENTAJEDIFERENCIA

    DO
    BEGIN


    ACUMULADODIFERENCIA = :ACUMULADODIFERENCIA + COALESCE(:DIFERENCIA,0);
    ACUMULADOANIO1 = :ACUMULADOANIO1 + COALESCE(:TOTALANIO1,0);
    PORCACUMULADODIFERENCIA =  (:ACUMULADODIFERENCIA / ( CASE WHEN COALESCE(:ACUMULADOANIO1,0) <> 0 THEN :acumuladoanio1 ELSE 1 END )) * 100;

     SUSPEND;
    END







end