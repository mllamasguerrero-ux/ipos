CREATE OR ALTER TRIGGER DOCTOPAGO_REPL_AU FOR DOCTOPAGO
ACTIVE AFTER INSERT OR UPDATE POSITION 0
AS
declare variable HABILITARREPL D_BOOLCN;
declare variable PERSONAID D_FK;
declare variable REPLID D_FK;
begin
  /* Trigger text */



  SELECT FIRST 1 habilitarrepl FROM PARAMETRO INTO :HABILITARREPL;

  IF(COALESCE(:HABILITARREPL,'N') <> 'S') THEN
  BEGIN
    EXIT;
  END
  ELSE
  BEGIN

   SELECT MAX(COALESCE(PERSONAID,0)) FROM DOCTO WHERE ID IN (COALESCE(NEW.DOCTOID,0),COALESCE(NEW.DOCTOSALIDAID,0))
    AND COALESCE(DOCTO.tipodoctoid,0) IN (21, 22, 23, 24, 25)
    INTO :PERSONAID;

   IF( COALESCE(:PERSONAID,0) NOT IN (0,1)) THEN
    BEGIN


      SELECT REPLID from REPLDOCTOPAGO WHERE ID = NEW.ID INTO :REPLID;

      IF(COALESCE(:replid, 0) = 0) THEN
      BEGIN
          
         INSERT INTO REPLDOCTOPAGO
          (
    
          ID,

          ACTIVO,

          CREADO,

          CREADOPOR_USERID,

          MODIFICADO,

          MODIFICADOPOR_USERID,

          DOCTOID,

          FORMAPAGOID,

          FECHA,

          FECHAHORA,

          CORTEID,

          IMPORTE,

          IMPORTERECIBIDO,

          IMPORTECAMBIO,

          TIPOPAGOID,

          DOCTOSALIDAID,

          ESAPARTADO,

          TIPOAPLICACIONCREDITOID,

          BANCO,

          REFERENCIABANCARIA,

          NOTAS,

          FECHAELABORACION,

          FECHARECEPCION,

          ESPAGOINICIAL,

          TIPOABONOID,

          DOCTOPAGOREFID,

          REVERTIDO,

          CORTETRANSCANCELADA
         )

         VALUES(
          NEW.ID,

          NEW.ACTIVO,

          NEW.CREADO,

          NEW.CREADOPOR_USERID,

          NEW.MODIFICADO,

          NEW.MODIFICADOPOR_USERID,

          NEW.DOCTOID,

          NEW.FORMAPAGOID,

          NEW.FECHA,

          NEW.FECHAHORA,

          NEW.CORTEID,

          NEW.IMPORTE,

          NEW.IMPORTERECIBIDO,

          NEW.IMPORTECAMBIO,

          NEW.TIPOPAGOID,

          NEW.DOCTOSALIDAID,

          NEW.ESAPARTADO,

          NEW.TIPOAPLICACIONCREDITOID,

          NEW.BANCO,

          NEW.REFERENCIABANCARIA,

          NEW.NOTAS,

          NEW.FECHAELABORACION,

          NEW.FECHARECEPCION,

          NEW.ESPAGOINICIAL,

          NEW.TIPOABONOID,

          NEW.DOCTOPAGOREFID,

          NEW.REVERTIDO,

          NEW.CORTETRANSCANCELADA
          );
          
      END
      ELSE
      BEGIN
            
  update  REPLDOCTOPAGO
  set

ID=NEW.ID,

ACTIVO=NEW.ACTIVO,

CREADOPOR_USERID=NEW.CREADOPOR_USERID,

MODIFICADO = NEW.MODIFICADO,

MODIFICADOPOR_USERID=NEW.MODIFICADOPOR_USERID,

DOCTOID=NEW.DOCTOID,

FORMAPAGOID=NEW.FORMAPAGOID,

FECHA=NEW.FECHA,

FECHAHORA = NEW.FECHAHORA,

CORTEID=NEW.CORTEID,

IMPORTE=NEW.IMPORTE,

IMPORTERECIBIDO=NEW.IMPORTERECIBIDO,

IMPORTECAMBIO=NEW.IMPORTECAMBIO,

TIPOPAGOID=NEW.TIPOPAGOID,

DOCTOSALIDAID=NEW.DOCTOSALIDAID,

ESAPARTADO=NEW.ESAPARTADO,

TIPOAPLICACIONCREDITOID=NEW.TIPOAPLICACIONCREDITOID,

BANCO=NEW.BANCO,

REFERENCIABANCARIA=NEW.REFERENCIABANCARIA,

NOTAS=NEW.NOTAS,

FECHAELABORACION=NEW.FECHAELABORACION,

FECHARECEPCION=NEW.FECHARECEPCION,

ESPAGOINICIAL=NEW.ESPAGOINICIAL,

TIPOABONOID=NEW.TIPOABONOID,

DOCTOPAGOREFID=NEW.DOCTOPAGOREFID,

REVERTIDO=NEW.REVERTIDO,

CORTETRANSCANCELADA=NEW.CORTETRANSCANCELADA ,

REPLTIMECAMBIO = CURRENT_TIMESTAMP

  where 

REPLID=:REPLID;
            
      END



     END

   END

end