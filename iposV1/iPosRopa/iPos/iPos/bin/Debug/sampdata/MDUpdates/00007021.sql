create or alter procedure GASTO_RECREARPARAEDICION (
    DOCTOCANCELARID D_FK,
    VENDEDORID D_FK)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable GASTOID D_FK;
declare variable TOTAL D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable NEWMOVTOID D_FK;
declare variable SURTIBLE D_BOOLCS;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable SUBTIPODOCTOCANCELARID D_FK;
declare variable CAJAID D_FK;
declare variable CORTEID D_FK;
declare variable FECHA D_FECHA;
declare variable VENCE D_FECHAVENCE;
declare variable CAJEROID D_FK;
declare variable SUPERVISORID D_FK;
declare variable ORIGENFISCALID D_FK;
BEGIN




   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID , SUBTIPODOCTOID , ORIGENFISCALID
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ESTATUSDOCTOID, :TIPODOCTOCANCELARID, :SUBTIPODOCTOCANCELARID, :ORIGENFISCALID;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END


   TIPODOCTOID = :TIPODOCTOCANCELARID;

   IF(COALESCE(:TIPODOCTOID,0) <> 63) THEN
   BEGIN
          ERRORCODE = 1011;
         SUSPEND;
         EXIT;
   END

   SELECT ERRORCODE FROM GASTO_CANCEL(:DOCTOCANCELARID, :VENDEDORID)
   INTO :ERRORCODE;

   
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END


   -- Leer del DOCTO a cancelar.
   SELECT ALMACENID, SUCURSALID, PERSONAID, SERIE, FOLIO, SUCURSALTID, ALMACENTID , CAJAID  , CORTEID  , FECHA, VENCE , CAJEROID,  SUPERVISORID
   FROM DOCTO
   WHERE ID = :DOCTOCANCELARID
   INTO :ALMACENID, :SUCURSALID, :PERSONAID, :SERIE, :FOLIO, :SUCURSALTID, :ALMACENTID, :CAJAID, :CORTEID, :FECHA, :VENCE, :CAJEROID, :SUPERVISORID;

   REFERENCIA = CAST('CANCELADO DEL DOCTO ' || COALESCE(SERIE, '' ) || '-' || COALESCE(:FOLIO, '') AS VARCHAR(31));

   REFERENCIAS = NULL;



   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, ESFACTURAELECTRONICA,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT,ESAPARTADO,DOCTOREFID, IEPS, IMPUESTO, ORIGENFISCALID)
   SELECT
    ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
    PERSONAID, CAJEROID, :VENDEDORID, CORTEID, FECHA, CURRENT_TIMESTAMP, null, null,
    PLAZO, CURRENT_DATE, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
    CAJAID, :REFERENCIA, :REFERENCIAS, SUCURSALTID, ALMACENTID, 'N' , ESFACTURAELECTRONICA ,
    FOLIOSAT,SERIESAT,TIMBRADOFECHA, TIMBRADOUUID,TIMBRADOCERTSAT , ESAPARTADO,ID, 0.00, 0.00, :ORIGENFISCALID
    FROM DOCTO WHERE ID = :DOCTOCANCELARID
   RETURNING ID INTO :DOCTOID;

   UPDATE DOCTO SET CORTEID = :CORTEID WHERE ID = :DOCTOID;

   -- Agrega los MOVTO.
   FOR SELECT
    ID, GASTOID , TOTAL
   FROM MOVTOGASTO
   WHERE DOCTOID = :DOCTOCANCELARID
   INTO
      :MOVTOID, :GASTOID, :TOTAL
   DO
   BEGIN


      SELECT ERRORCODE,MOVTOID
      FROM MOVTOGASTO_INSERT(
        :DOCTOID,
        0,
        :ALMACENID,
        :SUCURSALID,
        :TIPODOCTOID,
        0,
        0,
        :PERSONAID,
        :VENDEDORID,
        :CAJAID,
        0,
        :GASTOID ,
        :TOTAL,
        NULL,
        :REFERENCIA,
        :REFERENCIAS,
        :FECHA ,
        :VENCE,
        'N',
        NULL,
        :CORTEID ,
        :CAJEROID,
        :SUPERVISORID,
        :ORIGENFISCALID ,
        null


      ) INTO :ERRORCODE,:NEWMOVTOID;
            
      IF (:ERRORCODE <> 0) THEN
      BEGIN

         SUSPEND;
         EXIT;
      END







   END


     


   ERRORCODE = 0;
   SUSPEND;
      /*
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END  */
END