CREATE OR ALTER PROCEDURE INVENTARIO_UI (
    ALMACENID D_FK,
    PRODUCTOID D_FK,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    CANTIDAD D_CANTIDAD,
    PRECIO D_PRECIO,
    COSTO D_COSTO)
RETURNS (
    OK D_BOOLCN,
    ERRORCODE D_ERRORCODE)
AS
DECLARE VARIABLE INVENTARIOID TYPE OF D_FK;
DECLARE VARIABLE SENTIDOINV TYPE OF D_SENTIDO;
DECLARE VARIABLE MANEJALOTES CHAR(1);
BEGIN
   MANEJALOTES = 'N'; -- Este posteriormente proviene de parametros.

   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1026;
      SUSPEND;
      EXIT;
   END

   IF ((:LOTE IS NULL) OR (:MANEJALOTES = 'N')) THEN
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
      INTO :INVENTARIOID;

      LOTE = NULL;
      FECHAVENCE = NULL;
   END
   ELSE
   BEGIN
      SELECT ID
      FROM INVENTARIO
      WHERE ALMACENID = :ALMACENID
        AND PRODUCTOID = :PRODUCTOID
        AND LOTE = :LOTE
        AND FECHAVENCE = :FECHAVENCE
      INTO :INVENTARIOID;
   END
      
   IF (:INVENTARIOID IS NULL) THEN
   BEGIN
      INSERT INTO INVENTARIO
         (ALMACENID, PRODUCTOID, LOTE, FECHAVENCE, CANTIDAD)
      VALUES
         (:ALMACENID, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD)
      RETURNING ID
         INTO :INVENTARIOID;
   END
   ELSE
   BEGIN
      IF ((:LOTE IS NULL) OR (:MANEJALOTES = 'N')) THEN
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD = CANTIDAD + :CANTIDAD
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
         RETURNING ID
            INTO :INVENTARIOID;
      END
      ELSE
      BEGIN
         UPDATE INVENTARIO
         SET
            CANTIDAD = CANTIDAD + :CANTIDAD
         WHERE   ALMACENID = :ALMACENID
           AND PRODUCTOID = :PRODUCTOID
           AND LOTE = :LOTE
           AND FECHAVENCE = :FECHAVENCE
         RETURNING ID
            INTO :INVENTARIOID;
      END
   END

   UPDATE PRODUCTO P
   SET P.EXISTENCIA = (
      SELECT SUM(I.CANTIDAD)
      FROM INVENTARIO I
      WHERE I.PRODUCTOID = P.ID
   );
   
   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1027;
      SUSPEND;
   END 
END;