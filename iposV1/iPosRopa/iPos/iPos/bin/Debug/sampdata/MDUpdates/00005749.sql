create or alter procedure COMPRA_REASIGNAR_PROVEE (
    DOCTOID D_FK,
    PROVEEDORID D_FK,
    VENDEDORID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PROVEEDORIDANT D_FK;
declare variable CUENTADEVOLUCIONES integer;
declare variable SALDODOCTO D_PRECIO;
BEGIN

     ERRORCODE = 0;


    SELECT TIPODOCTOID, ESTATUSDOCTOID, PERSONAID, SALDO
    FROM DOCTO
    WHERE ID = :DOCTOID
    INTO :TIPODOCTOID, :ESTATUSDOCTOID, :PROVEEDORIDANT, :SALDODOCTO;

    IF(COALESCE(:TIPODOCTOID,0) NOT IN (11,1011)) THEN
    BEGIN
        ERRORCODE = 1011;
        SUSPEND;
        EXIT;
    END
    
    IF(COALESCE(:ESTATUSDOCTOID,0) NOT IN (1)) THEN
    BEGIN
        ERRORCODE = 1012;
        SUSPEND;
        EXIT;
    END

    
    IF(COALESCE(:PROVEEDORIDANT,0) = COALESCE(:PROVEEDORID,0) ) THEN
    BEGIN
        SUSPEND;
        EXIT;
    END

    SELECT COUNT(*) FROM DOCTO
    WHERE DOCTOREFID = :DOCTOID AND TIPODOCTOID = (CASE WHEN :TIPODOCTOID = 11 THEN 12 ELSE 1012 END)
    INTO :CUENTADEVOLUCIONES;

    IF(COALESCE(:CUENTADEVOLUCIONES,0) > 0) THEN
    BEGIN    
        ERRORCODE = 1013;
        SUSPEND;
        EXIT;
    END

     UPDATE DOCTO SET PERSONAID = :PROVEEDORID
     WHERE ID = :DOCTOID;


     IF(COALESCE(:TIPODOCTOID ,0) = 11) THEN
     BEGIN
        
        UPDATE PERSONA SET SALDO = COALESCE(SALDO,0) + COALESCE(:SALDODOCTO,0),
        SALDOSPOSITIVOS = COALESCE(SALDOSPOSITIVOS,0) + COALESCE(:SALDODOCTO,0)
        WHERE ID = :PROVEEDORID;

     
        UPDATE PERSONA SET SALDO = COALESCE(SALDO,0) - COALESCE(:SALDODOCTO,0),
        SALDOSPOSITIVOS = COALESCE(SALDOSPOSITIVOS,0) - COALESCE(:SALDODOCTO,0)
        WHERE ID = :PROVEEDORIDANT;

     END




   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END