create or alter procedure CONSOLIDADO_CANCELAR (
    DOCTOCONSOLIDADOID D_FK,
    VENDEDORID D_FK,
    SOLOVALIDARPOSIBILIDAD D_BOOLCN)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable PRODUCTOSINSUFICIENTES D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable SUMATOTAL D_IMPORTE;
declare variable SUMASALDO D_IMPORTE;
declare variable SUMAABONO D_IMPORTE;
declare variable SUMACARGO D_IMPORTE;
declare variable SUMAIMPORTE D_IMPORTE;
declare variable CUENTAREGISTROSDEVUELTOS integer;
declare variable CLIENTECONSOLIDADOID D_FK;
declare variable CORTEID D_FK;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable MINFOLIO D_DOCTOFOLIO;
declare variable MAXFOLIO D_DOCTOFOLIO;
declare variable DOCTOITEMID D_FK;
declare variable DOCTOPAGOID D_FK;
declare variable TIPOAPLICACION D_FK;
declare variable FECHAINICIAL D_FECHA;
declare variable FECHAFINAL D_FECHA;
declare variable TIPODOCTOCONSOLIDADOID D_FK;
BEGIN


        
   SELECT HAYCORTEACTIVO, CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :CORTEID, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END



  SELECT PARAMETRO.sucursalid, COALESCE(PARAMETRO.clienteconsolidadoid,1) FROM PARAMETRO  INTO :SUCURSALID, :CLIENTECONSOLIDADOID;



  --no debe haber devoluciones
  SELECT COUNT(*) FROM DOCTO WHERE TIPODOCTOID = 702 AND DOCTOREFID = :DOCTOCONSOLIDADOID INTO :CUENTAREGISTROSDEVUELTOS;

  IF(COALESCE(:CUENTAREGISTROSDEVUELTOS,0) > 0) THEN
  BEGIN
           
     DOCTOID = 0;
     ERRORCODE = 5013;
     SUSPEND;
     EXIT;
  END


    --obtener datos
   SELECT TIPODOCTOID, TOTAL, SALDO, ABONO, CARGO, IMPORTE, REFERENCIA , FECHAINI, FECHAFIN , ESTATUSDOCTOID
   FROM DOCTO WHERE ID = :DOCTOCONSOLIDADOID
   INTO :TIPODOCTOCONSOLIDADOID, :SUMATOTAL,  :SUMASALDO, :SUMAABONO, :SUMACARGO, :SUMAIMPORTE, :REFERENCIA, :FECHAINICIAL, :FECHAFINAL, :ESTATUSDOCTOID;


   --debe ser del tipo correcto
   IF(COALESCE(:TIPODOCTOCONSOLIDADOID,0) <> 701 ) THEN
   BEGIN  
     DOCTOID = 0;
     ERRORCODE = 1006;
     SUSPEND;
     EXIT;
   END

   

   --no debe estar ya cancelada
   IF(COALESCE(:ESTATUSDOCTOID,0) <> 1 ) THEN
   BEGIN    
     DOCTOID = 0;
     ERRORCODE = 1007;
     SUSPEND;
     EXIT;
   END


   IF(COALESCE(:SOLOVALIDARPOSIBILIDAD  ,'N') = 'S') THEN
   BEGIN
     DOCTOID = 0;
     ERRORCODE = 0;
     SUSPEND;
     EXIT;
   END


    TIPODOCTOID = 703;

   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA,
    REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, IEPS, IMPUESTO, DOCTOREFID,
    FECHAINI, FECHAFIN, ESFACTURAELECTRONICA)
   VALUES
   (
    1, :SUCURSALID, :TIPODOCTOID, 0, 0,
    :CLIENTECONSOLIDADOID, 0, :VENDEDORID, :CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, NULL, NULL,
    NULL, CURRENT_DATE, :SUMATOTAL, 0, :SUMATOTAL, 0, :SUMATOTAL, :SUMACARGO, :SUMAABONO, :SUMASALDO,
    1, :REFERENCIA,
    'CANC. FACTURA CONSOLIDADA', NULL, NULL, 'N', 0, 0 , NULL,
    :FECHAINICIAL , :FECHAFINAL, 'S'
      )
    RETURNING ID INTO :DOCTOID;


    UPDATE DOCTO SET FACTCONSID = NULL WHERE FACTCONSID = :DOCTOCONSOLIDADOID
    AND DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL;


    UPDATE DOCTOPAGO SET FACTCONSID = NULL WHERE FACTCONSID = :DOCTOCONSOLIDADOID;







   -- Completa el documento.
   SELECT ERRORCODE
   FROM DOCTO_SAVE (:DOCTOID)
   INTO :ERRORCODE;

   
   -- Marca el documento original como cancelado.
   UPDATE DOCTO
   SET ESTATUSDOCTOID = 2
   WHERE ID = :DOCTOCONSOLIDADOID;

   
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN   
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END

   ERRORCODE = 0;
   SUSPEND;


   WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END