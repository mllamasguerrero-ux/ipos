create or alter procedure CONSOLIDADO_GENERAR (
    FECHAINICIAL D_FECHA,
    FECHAFINAL D_FECHA,
    VENDEDORID D_FK,
    OMITIRVENTASAFRANQUICIAS D_BOOLCS,
    INCLUIRGASTOS D_BOOLCN_NULL,
    MAXIMOMONTO D_PRECIO,
    OMITIRVALES D_BOOLCN_NULL,
    GRUPOUSUARIOID D_FK,
    OMITIRCLIENTESRFC D_BOOLCN_NULL,
    MAXIMOPORCENTAJE D_PORCENTAJE,
    GRUPOFILTROFOLIOS D_NOMBRE_NULL)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable PRODUCTOSINSUFICIENTES D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable SUMATOTAL D_IMPORTE;
declare variable SUMASALDO D_IMPORTE;
declare variable SUMAABONO D_IMPORTE;
declare variable SUMACARGO D_IMPORTE;
declare variable SUMAIMPORTE D_IMPORTE;
declare variable SUMAIVARETENIDO D_IMPORTE;
declare variable SUMAISRRETENIDO D_IMPORTE;
declare variable CUENTAREGISTROS integer;
declare variable CLIENTECONSOLIDADOID D_FK;
declare variable CORTEID D_FK;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable MINFOLIO D_DOCTOFOLIO;
declare variable MAXFOLIO D_DOCTOFOLIO;
declare variable DOCTOITEMID D_FK;
declare variable DOCTOPAGOID D_FK;
declare variable TIPOAPLICACION D_FK;
declare variable USOCFDIID D_FK;
declare variable SUMASUBTOTAL D_IMPORTE;
declare variable SUMAIVA D_IMPORTE;
declare variable SUMAIEPS D_IMPORTE;
declare variable VERSIONCFDI D_STDTEXT_SHORT;
declare variable APLICADO D_BOOLCS;
declare variable DESCUENTO D_PRECIO;
declare variable SUMATOTALREFVALE D_PRECIO;
declare variable SUMASUBTOTALREFVALE D_PRECIO;
declare variable SUMAIVAREFVALE D_PRECIO;
declare variable SUMAIEPSREFVALE D_PRECIO;
declare variable SUMAIVARETREFVALE D_PRECIO;
declare variable SUMAISRRETREFVALE D_PRECIO;
BEGIN


        
   SELECT HAYCORTEACTIVO, CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :CORTEID, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END



  SELECT PARAMETRO.sucursalid, COALESCE(PARAMETRO.clienteconsolidadoid,1) FROM PARAMETRO  INTO :SUCURSALID, :CLIENTECONSOLIDADOID;




    DESCUENTO = 0;

   SELECT CUENTAREGISTROS, SUMATOTAL, SUMASALDO, SUMAABONO, SUMACARGO, SUMAIMPORTE, MINFOLIO, MAXFOLIO, SUMASUBTOTAL, SUMAIVA, SUMAIEPS
   FROM CONSOLIDADO_PORCONSOLIDARSUMA (
    :FECHAINICIAL, :FECHAFINAL , :OMITIRVENTASAFRANQUICIAS, :INCLUIRGASTOS, :MAXIMOMONTO, :OMITIRVALES,'N', :GRUPOUSUARIOID, :OMITIRCLIENTESRFC, :MAXIMOPORCENTAJE, :GRUPOFILTROFOLIOS)
    INTO :CUENTAREGISTROS, :SUMATOTAL, :SUMASALDO, :SUMAABONO, :SUMACARGO, :SUMAIMPORTE, :MINFOLIO, :MAXFOLIO, :SUMASUBTOTAL, :SUMAIVA, :SUMAIEPS;



   SELECT PARAMETRO.versioncfdi FROM PARAMETRO INTO :VERSIONCFDI;

   IF(COALESCE(:VERSIONCFDI ,'') <> '3.3' AND COALESCE(:VERSIONCFDI ,'') <> '4.0' ) THEN
   BEGIN
         SUMASUBTOTAL = :SUMATOTAL;
         SUMAIVA = 0;
         SUMAIEPS = 0;
   END



   IF(:CUENTAREGISTROS = 0) THEN
   BEGIN
     ERRORCODE = 5008;
     SUSPEND;
     EXIT;
   END


    TIPODOCTOID = 701;

    SELECT ID FROM sat_usocfdi
    WHERE SAT_CLAVE = 'P01'
    INTO :USOCFDIID;

   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA,
    REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, IEPS, IMPUESTO, DOCTOREFID,
    FECHAINI, FECHAFIN, ESFACTURAELECTRONICA, sat_usocfdiid, OMITIRVALES)
   VALUES
   (
    1, :SUCURSALID, :TIPODOCTOID, 0, 0,
    :CLIENTECONSOLIDADOID, 0, :VENDEDORID, :CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, NULL, NULL,
    NULL, CURRENT_DATE, :SUMASUBTOTAL , :DESCUENTO, :SUMASUBTOTAL, :SUMAIVA, :SUMATOTAL, :SUMACARGO, :SUMAABONO, :SUMASALDO,
    1, CAST(COALESCE(:MINFOLIO,0) AS VARCHAR(20)) || ' AL ' || CAST(COALESCE(:MAXFOLIO,0) AS VARCHAR(20)),
    'FACTURA CONSOLIDADA', NULL, NULL, 'N', :SUMAIEPS, COALESCE(:SUMAIVA,0) + COALESCE(:SUMAIEPS,0) , NULL,
    :FECHAINICIAL , :FECHAFINAL, 'S', :USOCFDIID, :OMITIRVALES
      )
    RETURNING ID INTO :DOCTOID;


    --si se esta omitiendo los vales.. guardar el dato de los totales con vale
    IF(COALESCE(:OMITIRVALES,'N') = 'S') THEN
    BEGIN
        SELECT  SUMATOTAL,  SUMASUBTOTAL, SUMAIVA, SUMAIEPS , SUMAIVARETENIDO, SUMAISRRETENIDO
        FROM CONSOLIDADO_PORCONSOLIDARSUMA (
            :FECHAINICIAL, :FECHAFINAL , :OMITIRVENTASAFRANQUICIAS, :INCLUIRGASTOS, :MAXIMOMONTO, 'N','S', :GRUPOUSUARIOID, :OMITIRCLIENTESRFC, :MAXIMOPORCENTAJE, :GRUPOFILTROFOLIOS)
            INTO  :SUMATOTALREFVALE,  :SUMASUBTOTALREFVALE, :SUMAIVAREFVALE, :SUMAIEPSREFVALE, :SUMAIVARETREFVALE, :SUMAISRRETREFVALE;

         UPDATE DOCTO SET SINVALE_TOTAL = :SUMATOTALREFVALE ,
                        SINVALE_SUBTOTAL = :SUMASUBTOTALREFVALE,
                        SINVALE_IVA = :SUMAIVAREFVALE,
                        SINVALE_IEPS = :SUMAIEPSREFVALE,
                        SINVALE_IVA_RET = :SUMAIVARETREFVALE,
                        SINVALE_ISR_RET = :SUMAISRRETREFVALE
               WHERE ID = :DOCTOID;

    END



      -- aqui no omitir vales ni devoluciones.. precisamente para no dejar de marcar las devoluciones
    for select id , doctopagoid ,TIPOAPLICACION , APLICADO
        FROM  CONSOLIDADO_PORCONSOLIDAR (:FECHAINICIAL, :FECHAFINAL , :OMITIRVENTASAFRANQUICIAS, :INCLUIRGASTOS, :MAXIMOMONTO, 'N','N', :GRUPOUSUARIOID, :OMITIRCLIENTESRFC, :MAXIMOPORCENTAJE,'N', :GRUPOFILTROFOLIOS)
        into :DOCTOITEMID  , :DOCTOPAGOID , :TIPOAPLICACION , :APLICADO
     do
     BEGIN
       

       IF(:TIPOAPLICACION IN (1,3)) THEN
       BEGIN
        
            UPDATE DOCTO SET FACTCONSID = :DOCTOID  , FACTCONSAPLICADO = :APLICADO
            WHERE  id  = :DOCTOITEMID;
       END
       else IF( :TIPOAPLICACION IN (2)) THEN
       BEGIN
            UPDATE DOCTOPAGO SET FACTCONSID = :DOCTOID
            WHERE ID = :DOCTOPAGOID;
       END

     END






   -- Completa el documento.
   SELECT ERRORCODE
   FROM DOCTO_SAVE (:DOCTOID)
   INTO :ERRORCODE;

   
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END

   ERRORCODE = 0;
   SUSPEND;


   WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END