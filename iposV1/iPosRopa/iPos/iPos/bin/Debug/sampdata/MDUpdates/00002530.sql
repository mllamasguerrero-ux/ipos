create or alter procedure CONTRARECIBODETAIL_INSERT (
    CREADOPOR_USERID type of D_FK,
    FECHA type of D_FECHA,
    PERSONAID type of D_FK,
    VENDEDORID type of D_FK,
    OBSERVACIONES D_STDTEXT_LARGE,
    CONTRARECIBOACTUALID type of D_FK,
    DOCTOID type of D_FK,
    DOCTOFECHA type of D_FECHA,
    DOCTOFECHAVENCE type of D_FECHA,
    DOCTOFOLIO type of D_DOCTOFOLIO,
    DOCTOSERIE type of D_DOCTOSERIE,
    DOCTOFOLIOSAT type of D_DOCTOFOLIO,
    DOCTOSERIESAT type of D_DOCTOSERIE,
    DOCTOTOTAL D_PRECIO,
    DOCTOABONO D_PRECIO,
    DOCTOSALDO D_PRECIO,
    DETALLETOTAL D_PRECIO,
    DETALLEABONO D_PRECIO,
    DETALLESALDO D_PRECIO)
returns (
    CONTRARECIBOID type of D_FK,
    CONTRARECIBODTLID type of D_FK,
    ERRORCODE type of D_ERRORCODE)
as
declare variable FECHAULTIMA D_FECHA;
BEGIN

   -- Validar la fecha VS ultima fecha de operacion
   SELECT FECHAULTIMA
   FROM PARAMETRO
   INTO :FECHAULTIMA;

   IF (:FECHAULTIMA IS NOT NULL)  THEN
   BEGIN
      IF (:FECHAULTIMA > CURRENT_DATE) THEN
      BEGIN
         ERRORCODE = 1067;
         SUSPEND;
         EXIT;
      END

      IF (:FECHAULTIMA < (CURRENT_DATE-3)) THEN
      BEGIN
         ERRORCODE = 1068;
         SUSPEND;
         EXIT;
      END
   END


   IF (:FECHA IS NULL) THEN
   BEGIN
      FECHA = CURRENT_DATE;
   END


    IF(COALESCE(:CONTRARECIBOACTUALID,0) = 0) THEN
    BEGIN
      SELECT ERRORCODE, CONTRARECIBOID  FROM  CONTRARECIBO_INSERT (
            :CREADOPOR_USERID ,
            :FECHA  ,
            :PERSONAID  ,
            :VENDEDORID ,
            0,
            0,
            0,
            0,
            :OBSERVACIONES
        ) INTO :ERRORCODE, :CONTRARECIBOID;

        IF(COALESCE(:ERRORCODE, 0) <> 0) THEN
        BEGIN
              SUSPEND;
              EXIT;
        END
    END
    ELSE
    BEGIN
         CONTRARECIBOID = :CONTRARECIBOACTUALID;
    END

    CONTRARECIBODTLID = 0;

    SELECT FIRST 1 ID FROM CONTRARECIBODTL WHERE CONTRARECIBOID = :CONTRARECIBOID AND DOCTOID = :DOCTOID INTO :CONTRARECIBODTLID;

    IF(COALESCE(:CONTRARECIBODTLID, 0) = 0) THEN
    BEGIN

     INSERT INTO CONTRARECIBODTL (
        CREADOPOR_USERID,
        CONTRARECIBOID,
        DOCTOID,
        FECHA,
        FECHAVENCE,
        FOLIO,
        SERIE,
        FOLIOSAT,
        SERIESAT,
        ESTATUSID,
        TOTALDOCTO,
        ABONODOCTO,
        SALDODOCTO,
        TOTAL,
        ABONO,
        SALDO )
     VALUES (
        :CREADOPOR_USERID,
        :CONTRARECIBOID,
        :DOCTOID,
        :DOCTOFECHA,
        :DOCTOFECHAVENCE,
        :DOCTOFOLIO,
        :DOCTOSERIE,
        :DOCTOFOLIOSAT,
        :DOCTOSERIESAT,
        0,
        :DOCTOTOTAL,
        :DOCTOABONO,
        :DOCTOSALDO,
        :DETALLETOTAL,
        :DETALLEABONO,
        :DETALLESALDO )
     RETURNING ID INTO :CONTRARECIBODTLID;

     IF ((:CONTRARECIBODTLID IS NULL) OR (:CONTRARECIBODTLID = 0)) THEN
     BEGIN
       ERRORCODE = 1002;
     END
   END

   SUSPEND;
END