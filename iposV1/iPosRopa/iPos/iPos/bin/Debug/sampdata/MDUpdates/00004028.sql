create or alter procedure GET_PRODUCTO_PRECIO_DOCTO (
    PRODUCTOID D_FK,
    PERSONAID D_FK,
    CANTIDAD D_CANTIDAD,
    TIPODOCTOID D_FK,
    SUCURSALID D_FK,
    SUCURSALTID D_FK,
    COSTOPROD D_COSTO,
    PAGOCONTARJETA D_BOOLCN_NULL,
    TIPOMAYOREOID D_FK)
returns (
    PRECIO D_PRECIO,
    ESPROMOCION D_BOOLCN,
    PROMOCIONID D_FK,
    PROMOCIONDESGLOSE D_STDTEXT_64,
    MONEDEROABONO D_PRECIO,
    ERRORCODE D_ERRORCODE)
as
declare variable PRECIO1 D_PRECIO;
declare variable PRECIO2 D_PRECIO;
declare variable PRECIO3 D_PRECIO;
declare variable PRECIO4 D_PRECIO;
declare variable PRECIO5 D_PRECIO;
declare variable LISTAPRECIO varchar(1);
declare variable PRECIOREAL D_FK;
declare variable TIPOPRECIOREAL D_FK;
declare variable SUPERLISTAPRECIOID D_FK;
declare variable MANEJASUPERLISTAPRECIO D_BOOLCN;
declare variable PERSONASUCURSALID D_FK;
declare variable CLAVECLIENTESUCURSAL D_CLAVE_NULL;
declare variable HAB_PRECIOSCLIENTE D_BOOLCN;
declare variable PRECIOCLIENTE D_PRECIO;
BEGIN

   ESPROMOCION = 'N';
   PROMOCIONID = NULL;
   PROMOCIONDESGLOSE = null;


   IF(:SUCURSALTID IS NOT NULL) THEN
   BEGIN
   
      CLAVECLIENTESUCURSAL = NULL;
      SUPERLISTAPRECIOID = 1;
      SELECT SUCURSAL.clienteclave FROM SUCURSAL WHERE ID = :SUCURSALTID AND SUCURSAL.esfranquicia = 'S'
      INTO :CLAVECLIENTESUCURSAL;

      IF(COALESCE(CLAVECLIENTESUCURSAL,'') <> '') THEN
      BEGIN
         SELECT id from persona where clave = :CLAVECLIENTESUCURSAL AND TIPOPERSONAID = 50 into :personasucursalid;

        IF(:PERSONASUCURSALID IS NOT NULL) THEN
        BEGIN
            SELECT MANEJASUPERLISTAPRECIO FROM PARAMETRO INTO :MANEJASUPERLISTAPRECIO;
            SELECT SUPERLISTAPRECIOID FROM persona WHERE ID = :personasucursalid INTO :SUPERLISTAPRECIOID;

            IF(COALESCE(:MANEJASUPERLISTAPRECIO ,'N') = 'N') THEN
            BEGIN
                SUPERLISTAPRECIOID = 1;
            END
        END
      END
   END




   IF ((:PRODUCTOID IS NULL) OR (:PRODUCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1048;
      SUSPEND;
      EXIT;
   END
   
   IF ((:PERSONAID IS NULL) OR (:PERSONAID = 0)) THEN
   BEGIN
      ERRORCODE = 1049;
      SUSPEND;
      EXIT;
   END


   
   IF ((:CANTIDAD = 0)) THEN
   BEGIN      
      ERRORCODE = 0;
      PRECIO = 0;
      SUSPEND;
      EXIT;
   END

   IF ((:CANTIDAD IS NULL) OR (:CANTIDAD = 0)) THEN
   BEGIN
      ERRORCODE = 1050;
      SUSPEND;
      EXIT;
   END

   -- Compra
   IF (:TIPODOCTOID IN (11)) THEN
   BEGIN
      PRECIO = :COSTOPROD;
   END
   -- Venta
   ELSE IF (:TIPODOCTOID IN (21, 23,25, 321, 821)) THEN
   BEGIN


      SELECT HAB_PRECIOSCLIENTE FROM PARAMETRO INTO :HAB_PRECIOSCLIENTE;

      -- Ver si acumula un precio con descuento
      SELECT PRECIO, ESPROMOCION, PROMOCIONID, PROMOCIONDESGLOSE, MONEDEROABONO, ERRORCODE
      FROM GET_PRODUCTO_PRECIO(:PRODUCTOID, :PERSONAID, :CANTIDAD, :PAGOCONTARJETA, :TIPOMAYOREOID)
      INTO :PRECIO, :ESPROMOCION, :PROMOCIONID, :PROMOCIONDESGLOSE, :MONEDEROABONO,:ERRORCODE;

      IF(COALESCE(:HAB_PRECIOSCLIENTE ,'N') = 'S') THEN
      BEGIN

        SELECT FIRST 1 PRECIO FROM preciopersona WHERE PRODUCTOID = :PRODUCTOID AND PERSONAID = :PERSONAID INTO :PRECIOCLIENTE;

        IF(coalesce(:PRECIOCLIENTE,0) <> 0) THEN
        begin
            PRECIO = :PRECIOCLIENTE;
            ESPROMOCION = 'N';
            PROMOCIONID = 0;
            PROMOCIONDESGLOSE = '';
            MONEDEROABONO = 0;

        end 

      END





   END
   -- Traspaso salida
   ELSE IF (:TIPODOCTOID IN (31)) THEN
   BEGIN




      SELECT CAST(COALESCE(LISTA_PRECIO_TRASPASO, '0') AS CHAR(1))
      FROM SUCURSAL
        WHERE ID = :SUCURSALTID
      INTO :LISTAPRECIO;
      
      IF(:SUPERLISTAPRECIOID = 2) THEN
      BEGIN      
        SELECT SPRECIO1, SPRECIO2, SPRECIO3, SPRECIO4, SPRECIO5
         FROM PRODUCTO
        WHERE ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5;
      END
      ELSE
      BEGIN       
        SELECT PRECIO1, PRECIO2, PRECIO3, PRECIO4, PRECIO5
         FROM PRODUCTO
        WHERE ID = :PRODUCTOID
        INTO :PRECIO1, :PRECIO2, :PRECIO3, :PRECIO4, :PRECIO5;
      END

      IF (:LISTAPRECIO = '1') THEN
         PRECIO = :PRECIO1;
      ELSE IF (:LISTAPRECIO = '2') THEN
         PRECIO = PRECIO2;
      ELSE IF (:LISTAPRECIO = '3') THEN
         PRECIO = PRECIO3;
      ELSE IF (:LISTAPRECIO = '4') THEN
         PRECIO = PRECIO4;
      ELSE IF (:LISTAPRECIO = '5') THEN
         PRECIO = PRECIO5;     
      ELSE IF (:LISTAPRECIO = '0') THEN
         PRECIO = 0;
      ELSE 
         PRECIO = PRECIO4;
   END
   --surtimiento de pedido
   ELSE IF (:TIPODOCTOID IN (81)) THEN
   BEGIN
         select coalesce(precioenviotraslado, (case when :tipodoctoid = 31 then 7  else 1 end))
         from SUCURSAL where id = :SUCURSALTID into :TIPOPRECIOREAL;
         if(:TIPOPRECIOREAL = 1) then
         begin
            SELECT COALESCE(COSTOREPOSICION,COALESCE(COSTOPROMEDIO,COALESCE(COSTOULTIMO,0))) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 2) then
        begin
            SELECT COALESCE(COSTOULTIMO,COALESCE(COSTOPROMEDIO,0)) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 3) then
        begin    
            SELECT COALESCE(COSTOPROMEDIO,COALESCE(COSTOULTIMO,0)) FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 4) then
        begin     
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO1,0) ELSE COALESCE(PRECIO1,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 5) then
        begin                  
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO2,0) ELSE COALESCE(PRECIO2,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 6) then
        begin       
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO3,0) ELSE COALESCE(PRECIO3,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 7) then
        begin          
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO4,0) ELSE COALESCE(PRECIO4,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else if(:TIPOPRECIOREAL = 8) then
        begin   
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO5,0) ELSE COALESCE(PRECIO5,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        else
        begin   
            SELECT CASE WHEN :SUPERLISTAPRECIOID = 2 THEN COALESCE(SPRECIO4,0) ELSE COALESCE(PRECIO4,0) END FROM PRODUCTO WHERE ID = :PRODUCTOID INTO :PRECIOREAL;
        end
        PRECIO = :PRECIOREAL;
   END
   
   ERRORCODE = 0;
   SUSPEND;

   WHEN ANY DO
   BEGIN
      ERRORCODE = 1051;
      SUSPEND;
   END
END