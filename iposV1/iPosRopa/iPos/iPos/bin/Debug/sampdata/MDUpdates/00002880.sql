EXECUTE BLOCK
AS
declare variable MOVTOID D_FK;
declare variable CANTIDADFALTANTE D_CANTIDAD;  
declare variable CANTIDADSURTIDA D_CANTIDAD;  
declare variable CANTIDADORDENADA D_CANTIDAD;
BEGIN

   FOR
     SELECT MOVTOORDEN.ID, MOVTOORDEN.CANTIDAD CANTIDADORDENADA,
      SUM(COALESCE(MOVTORECEPCION.CANTIDAD,0)) CANTIDADSURTIDA
      FROM DOCTO DOCTOORDEN               
        LEFT JOIN DOCTO DOCTORECEPCION ON DOCTORECEPCION.ID = DOCTOORDEN.DOCTOREFID AND DOCTORECEPCION.ESTATUSDOCTOID = 1 AND DOCTORECEPCION.subtipodoctoid = 16
            LEFT JOIN movto MOVTOORDEN ON MOVTOORDEN.doctoid = DOCTOORDEN.id  
                LEFT JOIN movto MOVTORECEPCION ON MOVTORECEPCION.doctoid = DOCTORECEPCION.id  AND
                                                MOVTOORDEN.PRODUCTOID = MOVTORECEPCION.productoid AND
                                                MOVTOORDEN.PRECIO = MOVTORECEPCION.PRECIO
     WHERE DOCTOORDEN.TIPODOCTOID = 16 AND DOCTOORDEN.ESTATUSDOCTOID = 1
     GROUP BY  MOVTOORDEN.ID, MOVTOORDEN.CANTIDAD
     INTO :MOVTOID, :CANTIDADORDENADA, :CANTIDADSURTIDA
     DO
     BEGIN
         CANTIDADFALTANTE = COALESCE(:cantidadordenada, 0) - COALESCE(:cantidadsurtida,  0);

         UPDATE MOVTO SET CANTIDADSURTIDA = COALESCE(:CANTIDADSURTIDA,0),
                          CANTIDADFALTANTE = COALESCE(:CANTIDADFALTANTE,0)
                          WHERE ID = :MOVTOID;

     END



end