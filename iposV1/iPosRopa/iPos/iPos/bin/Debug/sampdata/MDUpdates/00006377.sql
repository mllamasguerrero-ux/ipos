create or alter procedure PAGO_INSERT (
    FORMAPAGOID D_FK,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    CORTEID D_FK,
    IMPORTE D_IMPORTE,
    IMPORTERECIBIDO D_IMPORTE,
    IMPORTECAMBIO D_IMPORTE,
    TIPOPAGOID D_FK,
    ESAPARTADO D_BOOLCN,
    TIPOAPLICACIONCREDITOID D_FK,
    BANCO D_FK,
    REFERENCIABANCARIA D_STDTEXT_LIGHT,
    NOTAS D_STDTEXT_MEDIUM,
    FECHAELABORACION D_FECHA,
    FECHARECEPCION D_FECHA,
    ESPAGOINICIAL D_BOOLCN,
    TIPOABONOID D_FK,
    PAGOREFID D_FK,
    FORMAPAGOSATID D_FK,
    BANCOMERPARAMID D_FK,
    COMISION D_IMPORTE,
    CUENTAPAGOCREDITO D_STDTEXT_LIGHT,
    CUENTABANCOEMPRESAID D_FK,
    PERSONAID D_FK,
    APLICADO D_BOOLCN_NULL,
    FECHAAPLICADO D_FECHA,
    SUBTIPOPAGOID D_FK)
returns (
    PAGOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ACTIVO D_BOOLCS;
declare variable TIPODOCTOID D_FK;
BEGIN
  ACTIVO = 'N';
  SELECT COALESCE(ACTIVO,'N') FROM CORTE WHERE ID = :CORTEID INTO :ACTIVO;

  IF(COALESCE(:CUENTABANCOEMPRESAID, 0) = 0) THEN
  BEGIN
       SELECT FIRST 1 ID FROM CUENTABANCO WHERE ACTIVO = 'S' ORDER BY PREDETERMINADA DESC INTO :CUENTABANCOEMPRESAID;
  END
  ELSE IF(COALESCE(:CUENTABANCOEMPRESAID, 0) = -1) THEN
  BEGIN
     CUENTABANCOEMPRESAID = NULL;
  END

  
  IF(COALESCE(:FORMAPAGOID ,0) NOT IN (3)) THEN
  BEGIN
            APLICADO = 'S';
            FECHAAPLICADO =  :FECHARECEPCION;
  END
  ELSE
  BEGIN
            APLICADO = COALESCE(:APLICADO, 'N');
  END


   INSERT INTO PAGO (
      FORMAPAGOID,
      FECHA,
      FECHAHORA,
      CORTEID,
      IMPORTE,
      IMPORTERECIBIDO,
      IMPORTECAMBIO ,
      TIPOPAGOID ,
      ESAPARTADO ,
      TIPOAPLICACIONCREDITOID ,
      BANCO,
      REFERENCIABANCARIA ,
      NOTAS,
      FECHAELABORACION,
      FECHARECEPCION ,
      ESPAGOINICIAL,
      TIPOABONOID,
      PAGOREFID,
      FORMAPAGOSATID,
      BANCOMERPARAMID ,
      COMISION,
      CUENTAPAGOCREDITO,
      CUENTABANCOEMPRESAID,
      PERSONAID ,
      APLICADO,
      FECHAAPLICADO,
      SUBTIPOPAGOID
   ) VALUES (
      :FORMAPAGOID,
      :FECHA,
      :FECHAHORA,
      :CORTEID,
      :IMPORTE,
      :IMPORTERECIBIDO,
      :IMPORTECAMBIO ,
      :TIPOPAGOID  ,
      :ESAPARTADO,
      :TIPOAPLICACIONCREDITOID ,
      :BANCO,
      :REFERENCIABANCARIA,
      :NOTAS ,
      COALESCE(:FECHAELABORACION, CURRENT_DATE),
      COALESCE(:FECHARECEPCION, CURRENT_DATE) ,
      :ESPAGOINICIAL ,
      :TIPOABONOID,
      :PAGOREFID ,
      :FORMAPAGOSATID ,
      :BANCOMERPARAMID ,
      :COMISION ,
      :CUENTAPAGOCREDITO ,
      :CUENTABANCOEMPRESAID,
      :PERSONAID ,
      :APLICADO,
      :FECHAAPLICADO,
      :SUBTIPOPAGOID
      )
   RETURNING ID INTO :PAGOID;





   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1012;
      SUSPEND;
   END
END