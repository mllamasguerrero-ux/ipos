create or alter procedure CONSOLIDADO_PORCONSOLIDAR (
    FECHAINICIAL D_FECHA,
    FECHAFINAL D_FECHA,
    OMITIRVENTASAFRANQUICIAS varchar(2),
    INCLUIRGASTOS D_BOOLCN_NULL,
    MAXIMOMONTO D_PRECIO,
    OMITIRVALES D_BOOLCN_NULL,
    SUMACOMPLETAVENTAS D_BOOLCN_NULL)
returns (
    ID D_FK,
    FOLIO D_DOCTOFOLIO,
    SERIE D_DOCTOSERIE,
    IMPORTE D_PRECIO,
    DESCUENTO D_PRECIO,
    SUBTOTAL D_PRECIO,
    IVA D_PRECIO,
    IEPS D_PRECIO,
    IMPUESTO D_PRECIO,
    TOTAL D_PRECIO,
    SALDO D_PRECIO,
    ABONO D_PRECIO,
    CARGO D_PRECIO,
    TIPODOCTONOMBRE D_NOMBRE_NULL,
    FECHA D_FECHA,
    FECHAHORA D_TIMESTAMP,
    TIPODOCTOID D_FK,
    TIPOAPLICACION D_FK,
    DOCTOPAGOID D_FK,
    NOMBRETIPOAPLICACION D_NOMBRE_NULL,
    APLICADO D_BOOLCS,
    IVARETENIDO D_PRECIO,
    ISRRETENIDO D_PRECIO)
as
declare variable NUMERO integer;
declare variable VERSIONCFDI D_STDTEXT_SHORT;
declare variable VENTAIDAPLICADOMAX D_FK;
declare variable TOTALVENTABUFFER D_PRECIO;
declare variable TOTALDEVOLUCIONESBUFFER D_PRECIO;
declare variable TOTALACUMULADO D_PRECIO;
declare variable DOCTOBUFFERID D_FK;
declare variable DOCTOMAXIMOID D_FK;
declare variable SUMADESCCONVALE D_PRECIO;
declare variable SUMADESCBUFFERCONVALE D_PRECIO;
declare variable SUMADEVOLUCIONESBUFFER D_PRECIO;
BEGIN
   NUMERO = 0;
   DOCTOMAXIMOID = 0;
   
    IVARETENIDO = 0;
    ISRRETENIDO = 0;

    SELECT VERSIONCFDI FROM PARAMETRO INTO :VERSIONCFDI;


    -- SI HAY UN MAXIMO A CONSIDERAR, ENTONCES NECESITAMOS VER HASTA CUAL DOCTO CONSIDERAREMOS
    IF(COALESCE(:MAXIMOMONTO, 0) > 0  AND COALESCE(:VERSIONCFDI,'') = '3.3') THEN
    BEGIN
       TOTALACUMULADO = 0;
       SUMADESCBUFFERCONVALE = 0;
       SUMADESCCONVALE = 0;
      FOR SELECT DOCTO.ID , DOCTO.total
            FROM         DOCTO LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID LEFT JOIN
                         PARAMETRO ON 1 = 1
            WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
                AND DOCTO.esfacturaelectronica = 'N'
                AND DOCTO.ESTATUSDOCTOID = 1
                AND DOCTO.TIPODOCTOID IN (21)
                AND (DOCTO.FACTCONSID IS NULL)
                AND (DOCTO.DEVCONSID IS NULL)
                AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8))) 
                AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )
              ORDER BY DOCTO.ID
             INTO :DOCTOBUFFERID, :TOTALVENTABUFFER
             DO
             BEGIN

                    IF(COALESCE(:OMITIRVALES,'N') = 'S') THEN
                    BEGIN
                        
                        SELECT SUM(COALESCE(DOCTOPAGO.IMPORTE,0)) FROM DOCTOPAGO WHERE DOCTOID = :DOCTOBUFFERID
                        AND DOCTOPAGO.TIPOPAGOID = 1 AND DOCTOPAGO.formapagoid = 5 INTO :SUMADESCBUFFERCONVALE;

                        SUMADESCCONVALE = COALESCE(:SUMADESCCONVALE,0) +  COALESCE(:SUMADESCBUFFERCONVALE, 0);

                    END


                    SELECT SUM(COALESCE(DOCTODEV.TOTAL,0.0)) TOTAL
                    FROM    DOCTO DOCTODEV
                        LEFT join
                            DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                        LEFT JOIN
                            TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                        LEFT JOIN
                            PARAMETRO ON 1 = 1
                    WHERE
                        (DOCTODEV.FECHA >= :FECHAINICIAL) AND
                        (DOCTODEV.FECHA <= :FECHAFINAL) AND
                        (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
                        (DOCTODEV.ESTATUSDOCTOID = 1) AND
                        ( DOCTODEV.TIPODOCTOID IN (22)) AND
                        (DOCTODEV.FACTCONSID IS NULL) AND
                        (DOCTODEV.DEVCONSID IS NULL) AND
                        ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
                        AND
                        DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22  
                        AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTODEV.subtipodoctoid,0) NOT IN (24,22) )
                        AND DOCTODEV.DOCTOREFID = :DOCTOBUFFERID
                        AND COALESCE(:OMITIRVALES , 'N') = 'N'
                        INTO :TOTALDEVOLUCIONESBUFFER;


                        TOTALACUMULADO = COALESCE(:TOTALACUMULADO,0) + COALESCE(:TOTALVENTABUFFER,0) - COALESCE(:TOTALDEVOLUCIONESBUFFER,0) - COALESCE(:SUMADESCCONVALE,0);
                              
                        DOCTOMAXIMOID = :DOCTOBUFFERID;

                        IF(COALESCE(:TOTALACUMULADO,0) > COALESCE(:MAXIMOMONTO, 0)) THEN
                        BEGIN
                              BREAK;
                        END


             END


    END


    --FACTURACION 3.2

    IF(COALESCE(:VERSIONCFDI,'') <> '3.3') THEN
    BEGIN

     FOR SELECT        DOCTO.ID,
            DOCTO.FOLIO,
            DOCTO.SERIE,
            COALESCE(DOCTO.IMPORTE,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPORTE,
            COALESCE(DOCTO.DESCUENTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS DESCUENTO,
                         COALESCE(DOCTO.SUBTOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SUBTOTAL,
                         COALESCE(DOCTO.IVA,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVA,
                         COALESCE(DOCTO.IEPS,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IEPS,
                         COALESCE(DOCTO.IMPUESTO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPUESTO,
                         COALESCE(DOCTO.TOTAL,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS TOTAL,
                         COALESCE(DOCTO.SALDO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SALDO, 
                         COALESCE(DOCTO.ABONO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ABONO,
                         COALESCE(DOCTO.CARGO,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS CARGO, 
                         TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
                         DOCTO.FECHA,
                         DOCTO.FECHAHORA ,
                         DOCTO.TIPODOCTOID ,
                          1 AS TIPOAPLICACION ,
                          0 AS DOCTOPAGOID ,
                          'VENTA' NOMBRETIPOAPLICACION ,
                          CASE WHEN (COALESCE(:DOCTOMAXIMOID, 0) = 0 or COALESCE(DOCTO.id, 0) <= COALESCE(:DOCTOMAXIMOID, 0) ) THEN 'S' ELSE 'N' END APLICADO

   FROM            DOCTO LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID LEFT JOIN
                         PARAMETRO ON 1 = 1
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
         AND DOCTO.esfacturaelectronica = 'N'
         AND DOCTO.ESTATUSDOCTOID = 1
         AND DOCTO.TIPODOCTOID IN (21)
         AND (DOCTO.FACTCONSID IS NULL)
         AND (DOCTO.DEVCONSID IS NULL)
         AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8))) 
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )


        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) IMPORTE ,
            0.0 DESCUENTO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) AS SUBTOTAL,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) AS TOTAL,
            0.0 AS SALDO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) ABONO,
            COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN -1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN 1 ELSE 0 END) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTOPAGO.FECHA,
            coalesce(DOCTOPAGO.FECHAHORA,CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID   ,
            2 AS TIPOAPLICACION  ,
            DOCTOPAGO.ID DOCTOPAGOID ,
            'PAGO POR NC DENTRO DE FACT' NOMBRETIPOAPLICACION ,
            'S' APLICADO



        FROM    DOCTO INNER join
                DOCTOPAGO ON DOCTOPAGO.DOCTOID = DOCTO.id INNER JOIN
                DOCTO DOCTODEV ON DOCTOPAGO.doctosalidaid = DOCTODEV.ID  LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID  LEFT JOIN
                PARAMETRO ON 1 = 1
                AND COALESCE(:VERSIONCFDI,'') <> '3.3'


        WHERE
           (DOCTO.FECHA >= :FECHAINICIAL) AND
            (DOCTO.FECHA <= :FECHAFINAL) AND
            (DOCTO.ESFACTURAELECTRONICA = 'N') AND
            (DOCTO.ESTATUSDOCTOID = 1) AND
            ( DOCTO.TIPODOCTOID IN (21, 22)) AND 
            (DOCTO.FACTCONSID IS NULL) AND
            (DOCTO.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1 AND DOCTODEV.tipodoctoid = 22
            AND DOCTOPAGO.formapagoid IN (6,7,8,9,10,11,12,13, 18,19,20,21)
            AND DOCTOPAGO.FECHA >= :FECHAINICIAL AND DOCTOPAGO.FECHA <= :FECHAFINAL
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )


           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) SUBTOTAL ,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS DEVOLUCIONES' NOMBRETIPOAPLICACION   ,
            'S' APLICADO

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN
                PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (22)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22  
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTODEV.subtipodoctoid,0) NOT IN (24,22) )
            AND COALESCE(:VERSIONCFDI,'') <> '3.3'

         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA


        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) IMPORTE ,
            0.0 DESCUENTO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) SUBTOTAL ,
            0.0 IVA ,
            0.0 IEPS ,
            0.0 IMPUESTO ,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) AS TOTAL,
            0.0 AS SALDO,
            0.0 ABONO,
            SUM(COALESCE(DOCTOPAGO.importe,0) * (CASE WHEN DOCTOPAGO.TIPOPAGOID = 1 THEN 1 WHEN DOCTOPAGO.TIPOPAGOID = 2 THEN -1 ELSE 0 END)) CARGO,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS GASTOS' NOMBRETIPOAPLICACION,
            'S' APLICADO

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (60,61,63)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22
            and COALESCE(:INCLUIRGASTOS,'N') = 'S'
            AND COALESCE(:VERSIONCFDI,'') <> '3.3'



         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA



   INTO
          :ID ,
    :FOLIO ,
    :SERIE ,
    :IMPORTE ,
    :DESCUENTO ,
    :SUBTOTAL ,
    :IVA ,
    :IEPS ,
    :IMPUESTO ,
    :TOTAL ,
    :SALDO ,
    :ABONO ,
    :CARGO ,
    :TIPODOCTONOMBRE ,
    :FECHA ,
    :FECHAHORA,
    :TIPODOCTOID ,
    :TIPOAPLICACION,
    :DOCTOPAGOID,
    :NOMBRETIPOAPLICACION,
    :APLICADO
   DO
   BEGIN


      NUMERO = :NUMERO + 1;
      SUSPEND;
   END


   END



    --FACTURACION 3.3
  
    IF(COALESCE(:VERSIONCFDI,'') = '3.3') THEN
    BEGIN
    OMITIRVALES = COALESCE(:OMITIRVALES,'N');
   FOR SELECT        DOCTO.ID,
            DOCTO.FOLIO,
            DOCTO.SERIE,
            COALESCE(DOCTO.IMPORTE,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPORTE,
            COALESCE(
                    (CASE WHEN :OMITIRVALES = 'S' THEN COALESCE(DOCTO.IMPORTE,0) - COALESCE(DOCTO.SINVALE_SUBTOTAL,0) ELSE DOCTO.DESCUENTO END)
                    ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS DESCUENTO,
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_SUBTOTAL ELSE DOCTO.SUBTOTAL END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SUBTOTAL,
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_IVA ELSE DOCTO.IVA END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVA,
                         COALESCE(
                                 (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_IEPS ELSE DOCTO.IEPS END)
                                    ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IEPS,
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN COALESCE(DOCTO.SINVALE_IEPS,0) +  COALESCE(DOCTO.SINVALE_IVA,0) ELSE DOCTO.IMPUESTO END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IMPUESTO,
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_TOTAL ELSE DOCTO.TOTAL END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS TOTAL,
                         COALESCE(
                                DOCTO.SALDO
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS SALDO, 
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN COALESCE(DOCTO.SINVALE_TOTAL,0) - COALESCE(DOCTO.SALDO, 0) ELSE DOCTO.ABONO END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ABONO,
                         COALESCE(
                                (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_TOTAL ELSE DOCTO.TOTAL END)
                                ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS CARGO, 
                         COALESCE(
                                 (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_IVA_RET ELSE DOCTO.IVARETENIDO END)
                                    ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS IVARETENIDO,
                         COALESCE(
                                 (CASE WHEN :OMITIRVALES = 'S' THEN DOCTO.SINVALE_ISR_RET ELSE DOCTO.ISRRETENIDO END)
                                    ,0) * (CASE WHEN DOCTO.TIPODOCTOID IN (21) THEN 1 ELSE - 1 END) AS ISRRETENIDO,
                         TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
                         DOCTO.FECHA,
                         DOCTO.FECHAHORA ,
                         DOCTO.TIPODOCTOID ,
                          1 AS TIPOAPLICACION ,
                          0 AS DOCTOPAGOID ,
                          'VENTA' NOMBRETIPOAPLICACION ,
                          CASE WHEN (COALESCE(:DOCTOMAXIMOID, 0) = 0 or COALESCE(DOCTO.id, 0) <= COALESCE(:DOCTOMAXIMOID, 0) ) THEN 'S' ELSE 'N' END APLICADO

   FROM            DOCTO LEFT OUTER JOIN
                         TIPODOCTO ON TIPODOCTO.ID = DOCTO.TIPODOCTOID LEFT JOIN
                         PARAMETRO ON 1 = 1
    WHERE DOCTO.FECHA >= :FECHAINICIAL AND DOCTO.FECHA <= :FECHAFINAL
         AND DOCTO.esfacturaelectronica = 'N'
         AND DOCTO.ESTATUSDOCTOID = 1
         AND DOCTO.TIPODOCTOID IN (21)
         AND (DOCTO.FACTCONSID IS NULL)
         AND (DOCTO.DEVCONSID IS NULL)
         AND ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTO.SUBTIPODOCTOID IS NULL OR  DOCTO.SUBTIPODOCTOID NOT IN (7, 8))) 
         AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTO.subtipodoctoid,0) NOT IN (24,22) )
          
            AND (  COALESCE(:SUMACOMPLETAVENTAS , 'N') = 'N' or COALESCE(DOCTO.SINVALE_TOTAL, 0) > 0 )

            
           
        UNION


         SELECT
            DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            SUM(COALESCE(DOCTODEV.IMPORTE,0)) * -1 IMPORTE ,
            SUM(COALESCE(DOCTODEV.DESCUENTO,0)) * -1 DESCUENTO,
            SUM(COALESCE(DOCTODEV.SUBTOTAL,0)) * -1 AS SUBTOTAL,
            SUM(COALESCE(DOCTODEV.IVA,0)) * -1 IVA ,
            SUM(COALESCE(DOCTODEV.IEPS,0)) * -1 IEPS ,
            SUM(COALESCE(DOCTODEV.IMPUESTO,0)) * -1 IMPUESTO ,
            SUM(COALESCE(DOCTODEV.TOTAL,0)) * -1 AS TOTAL,
            SUM(COALESCE(DOCTODEV.SALDO,0)) * -1 AS SALDO,
            SUM(COALESCE(DOCTODEV.ABONO,0)) * -1 ABONO,
            SUM(COALESCE(DOCTODEV.CARGO,0)) * -1 CARGO, 
            SUM(COALESCE(DOCTODEV.IVARETENIDO,0)) * -1 IVARETENIDO ,
            SUM(COALESCE(DOCTODEV.ISRRETENIDO,0)) * -1 ISRRETENIDO ,
            TIPODOCTO.NOMBRE AS TIPODOCTONOMBRE,
            DOCTODEV.FECHA,
            COALESCE(MIN(DOCTOPAGO.FECHAHORA),CURRENT_TIMESTAMP) FECHAHORA ,
            DOCTODEV.TIPODOCTOID,
            3 AS TIPOAPLICACION  ,
            0 DOCTOPAGOID  ,
            'EGRESOS DEVOLUCIONES' NOMBRETIPOAPLICACION ,
            
            CASE WHEN COALESCE(:OMITIRVALES,'N') = 'N' AND (COALESCE(:DOCTOMAXIMOID, 0) = 0 or COALESCE(DOCTODEV.doctorefid, 0) <= COALESCE(:DOCTOMAXIMOID, 0) ) THEN 'S' ELSE 'N' END APLICADO

        FROM    DOCTO DOCTODEV LEFT join
                DOCTOPAGO ON DOCTOPAGO.DOCTOSALIDAID = DOCTODEV.id AND DOCTOPAGO.formapagoid IN (1,2,3,5,15,20,21)
                LEFT JOIN
                TIPODOCTO ON TIPODOCTO.ID = DOCTODEV.TIPODOCTOID
                LEFT JOIN
                PARAMETRO ON 1 = 1


        WHERE
           (DOCTODEV.FECHA >= :FECHAINICIAL) AND
            (DOCTODEV.FECHA <= :FECHAFINAL) AND
            (DOCTODEV.ESFACTURAELECTRONICA = 'N') AND
            (DOCTODEV.ESTATUSDOCTOID = 1) AND
            ( DOCTODEV.TIPODOCTOID IN (22)) AND
            (DOCTODEV.FACTCONSID IS NULL) AND
            (DOCTODEV.DEVCONSID IS NULL) AND
            ((:OMITIRVENTASAFRANQUICIAS = 'N' OR DOCTODEV.SUBTIPODOCTOID IS NULL OR  DOCTODEV.SUBTIPODOCTOID NOT IN (7, 8)))
            AND
            DOCTODEV.ESTATUSDOCTOID = 1-- AND DOCTODEV.tipodoctoid = 22  
            AND (COALESCE(PARAMETRO.pagoservconsolidado,'S') = 'S' or COALESCE(DOCTODEV.subtipodoctoid,0) NOT IN (24,22) )
            AND COALESCE(:VERSIONCFDI,'') = '3.3'
            AND COALESCE(:OMITIRVALES , 'N') = 'N'
            AND COALESCE(:SUMACOMPLETAVENTAS , 'N') = 'N'


         GROUP BY
           DOCTODEV.ID,
            DOCTODEV.FOLIO,
            DOCTODEV.SERIE,
            DOCTODEV.TIPODOCTOID,
            TIPODOCTO.NOMBRE,
            DOCTODEV.FECHA ,
            DOCTODEV.DOCTOREFID




   INTO
          :ID ,
    :FOLIO ,
    :SERIE ,
    :IMPORTE ,
    :DESCUENTO ,
    :SUBTOTAL ,
    :IVA ,
    :IEPS ,
    :IMPUESTO ,
    :TOTAL ,
    :SALDO ,
    :ABONO ,
    :CARGO ,
    :IVARETENIDO,
    :ISRRETENIDO,
    :TIPODOCTONOMBRE ,
    :FECHA ,
    :FECHAHORA,
    :TIPODOCTOID ,
    :TIPOAPLICACION,
    :DOCTOPAGOID,
    :NOMBRETIPOAPLICACION,
    :APLICADO
   DO
   BEGIN


      NUMERO = :NUMERO + 1;
      SUSPEND;
   END


  END





   if (:numero = 0) then
   begin
      ID = 0;
    FOLIO = 0;
    SERIE = '';
    IMPORTE = 0.0;
    DESCUENTO = 0.0;
    SUBTOTAL = 0.0;
    IVA = 0.0;
    IEPS  = 0.0;
    IMPUESTO  = 0.0;
    TOTAL  = 0.0;
    SALDO  = 0.0;
    ABONO  = 0.0;
    CARGO  = 0.0;
    IVARETENIDO = 0.0;
    ISRRETENIDO = 0.0;
    TIPODOCTONOMBRE = '';
    FECHA = CURRENT_DATE;
    FECHAHORA = CURRENT_TIMESTAMP;
    TIPODOCTOID = 0;
    TIPOAPLICACION = 0;
    APLICADO = 'S';
   end

END