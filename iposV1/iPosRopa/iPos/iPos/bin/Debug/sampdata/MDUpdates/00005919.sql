CREATE OR ALTER trigger docto_ppc_insert_suc_tr for docto
active after insert position 9998
AS
declare variable CLAVEMATRIZ D_CLAVE_NULL;
declare variable SUCURSALCLAVE D_CLAVE_NULL;
declare variable HABPPC D_BOOLCN;
begin
  /* Trigger text */

   --SI NO ESTA EN LAS CONDICIOENS NECESARIAS PARA SEGUIR SALIRSE
  IF( NOT (NEW.ESTATUSDOCTOID = 1 AND NEW.TIPODOCTOID IN (11,12) AND COALESCE(NEW.SUBTIPODOCTOID,0) IN (0,16))) THEN
  BEGIN
    EXIT;
  END

  SELECT SUCURSALNUMERO, HABPPC FROM PARAMETRO INTO :SUCURSALCLAVE, :HABPPC;

  IF(COALESCE(:HABPPC,'N') <> 'S') THEN
  BEGIN
    EXIT;
  END

  SELECT FIRST 1 CLAVEMATRIZ FROM MATRIZPRINCIPAL INTO :CLAVEMATRIZ;

  IF(COALESCE(:SUCURSALCLAVE,'') <> COALESCE(:CLAVEMATRIZ,'')) THEN
  BEGIN
  
    IF(NEW.ESTATUSDOCTOID = 1 AND NEW.TIPODOCTOID = 11 AND COALESCE(NEW.SUBTIPODOCTOID,0) IN (0,16)) THEN
    BEGIN
        UPDATE OR INSERT INTO REPLEXPOCTRL
        (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
        VALUES (:CLAVEMATRIZ,  NEW.ID, CURRENT_TIMESTAMP, 1, 1)
        MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);

    END


    
    IF(NEW.ESTATUSDOCTOID = 1 AND NEW.TIPODOCTOID = 12 AND COALESCE(NEW.SUBTIPODOCTOID,0) IN (0,16)) THEN
    BEGIN
        UPDATE OR INSERT INTO REPLEXPOCTRL
        (DESTINOSUCURSALCLAVE,  FUENTEID,  FECHAHORASYNC, TIPOID,  ESTATUS)
        VALUES (:CLAVEMATRIZ,  NEW.ID, CURRENT_TIMESTAMP, 3, 1)
        MATCHING (DESTINOSUCURSALCLAVE, FUENTEID, TIPOID);

    END

  END


end