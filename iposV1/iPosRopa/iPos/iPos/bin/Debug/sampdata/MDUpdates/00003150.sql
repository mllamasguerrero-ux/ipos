create or alter procedure TTL_REP_PROD_TODOS_COMPARACION (
    ANIO1 D_DIAS,
    ANIO2 D_DIAS,
    INCLUIRTRASL varchar(1),
    MES_P D_DIAS)
returns (
    MES D_CLAVE,
    PRODUCTOID D_FK,
    CANTIDADANIO1 D_DIAS,
    TOTALANIO1 D_PRECIO,
    CANTIDADANIO2 D_DIAS,
    TOTALANIO2 D_PRECIO,
    DIFERENCIA D_CANTIDAD,
    PORCENTAJEDIFERENCIA D_PORCENTAJE,
    ACUMULADODIFERENCIA D_CANTIDAD,
    PORCACUMULADODIFERENCIA D_PORCENTAJE,
    PRODUCTOCLAVE D_CLAVE_NULL,
    PRODUCTODESCRIPCION D_DESCRIPCION,
    PRODUCTODESCRIPCION1 D_DESCRIPCION,
    PRODUCTODESCRIPCION2 D_DESCRIPCION,
    REQUIERERECETA D_BOOLCN_NULL,
    PRECIOPROMEDIOANIO1 D_PRECIO,
    PRECIOPROMEDIOANIO2 D_PRECIO)
as
declare variable ACUMULADOANIO1 D_PRECIO;
declare variable PREVIOPRODUCTOID D_FK;
begin





MES  = '';
PRODUCTOID  = 0;
CANTIDADANIO1  = 0;
TOTALANIO1  = 0;
CANTIDADANIO2  = 0;
TOTALANIO2  = 0;
DIFERENCIA  = 0;


ACUMULADODIFERENCIA = 0;
ACUMULADOANIO1 = 0;
PORCACUMULADODIFERENCIA = 0;


PRODUCTOCLAVE = '';
PRODUCTODESCRIPCION  = '';
PRODUCTODESCRIPCION1  = '';
PRODUCTODESCRIPCION2  = '';
REQUIERERECETA  = 'N';
PRECIOPROMEDIOANIO1 =  0.0;
PRECIOPROMEDIOANIO2 = 0.0;

PREVIOPRODUCTOID = 0;


  FOR
SELECT M.clave MES,
P.ID PRODUCTOID,
D1.CANTIDAD CANTIDADANIO1,
D1.TOTAL TOTALANIO1,
D2.CANTIDAD CANTIDADANIO2,
D2.TOTAL TOTALANIO2,
COALESCE(D2.CANTIDAD ,0) -  COALESCE(D1.CANTIDAD ,0) DIFERENCIA,
((COALESCE(D2.CANTIDAD ,0) -  COALESCE(D1.CANTIDAD ,0)) /  CASE WHEN COALESCE(D1.CANTIDAD,0)  <> 0 THEN D1.CANTIDAD  WHEN COALESCE(D2.CANTIDAD,0)  <> 0 THEN D2.CANTIDAD ELSE 1 END) * 100  PORCDIFERENCIA ,
P.CLAVE ,
P.DESCRIPCION ,
P.DESCRIPCION1 ,
P.DESCRIPCION2,
P.REQUIERERECETA  ,
D1.TOTAL / CASE WHEN COALESCE(D1.CANTIDAD,0)  <> 0 THEN D1.CANTIDAD ELSE 1 END  PRECIOPROMEDIOANIO1,
D2.TOTAL / CASE WHEN COALESCE(D2.CANTIDAD,0)  <> 0 THEN D2.CANTIDAD ELSE 1 END  PRECIOPROMEDIOANIO2

FROM
MESES M LEFT JOIN
PRODUCTO P ON 1 = 1 LEFT JOIN
(
select
        PRODUCTOID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_prod_tipo_mes
      where
          ANIO = :ANIO1   AND ( :MES_P = 0 OR MES = :MES_P  )  AND

          ( (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (21,22,23,24)) or (:INCLUIRTRASL = 'N' AND TIPODOCTOID IN (21,22,23,24) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))   OR  (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (31,32,33,81,83) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))    )

      group by PRODUCTOID,
            MES,
            ANIO

            )   D1 ON D1.MES = M.ID AND P.ID = D1.PRODUCTOID

              LEFT JOIN
            (
select
        PRODUCTOID,
        ANIO,
        MES,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(CANTIDAD,0) ELSE COALESCE(CANTIDAD,0) * -1 END) CANTIDAD,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(TOTAL,0) ELSE COALESCE(TOTAL,0) * -1 END) TOTAL,
        SUM(CASE WHEN TIPODOCTOID IN (21,31,81,24) THEN COALESCE(UTILIDAD,0) ELSE COALESCE(UTILIDAD,0) * -1 END) UTILIDAD
      from ttl_prod_tipo_mes
      where
          ANIO = :ANIO2   AND ( :MES_P = 0 OR MES = :MES_P  ) AND
          ( (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (21,22,23,24)) or (:INCLUIRTRASL = 'N' AND TIPODOCTOID IN (21,22,23,24) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8)) OR  (:INCLUIRTRASL = 'S' AND TIPODOCTOID IN (31,32,33,81,83) AND coalesce(SUBTIPODOCTOID,0) NOT IN (7,8))    )

      group by PRODUCTOID,
            MES,
            ANIO

            )  D2 ON D2.MES = M.ID AND P.ID = D2.PRODUCTOID
            ORDER BY P.ID , M.ID

      INTO :MES ,
:PRODUCTOID ,
:CANTIDADANIO1 ,
:TOTALANIO1 ,
:CANTIDADANIO2 ,
:TOTALANIO2 ,
:DIFERENCIA ,
:PORCENTAJEDIFERENCIA ,
:PRODUCTOCLAVE ,
:PRODUCTODESCRIPCION  ,
:PRODUCTODESCRIPCION1  ,
:PRODUCTODESCRIPCION2 ,
:REQUIERERECETA  ,
:PRECIOPROMEDIOANIO1 ,
:PRECIOPROMEDIOANIO2

    DO
    BEGIN

        IF(:PREVIOPRODUCTOID <> :PRODUCTOID) THEN
        BEGIN
            PREVIOPRODUCTOID = :PRODUCTOID;   
            ACUMULADODIFERENCIA = 0;
            ACUMULADOANIO1 = 0;
            PORCACUMULADODIFERENCIA =  0;

        END

       ACUMULADODIFERENCIA = :ACUMULADODIFERENCIA + COALESCE(:DIFERENCIA,0);
       ACUMULADOANIO1 = :ACUMULADOANIO1 + COALESCE(:CANTIDADANIO1,0);
       PORCACUMULADODIFERENCIA =  (:ACUMULADODIFERENCIA / ( CASE WHEN COALESCE(:ACUMULADOANIO1,0) <> 0 THEN :acumuladoanio1 ELSE 1 END )) * 100;

     SUSPEND;
    END


     --SUSPEND;

end