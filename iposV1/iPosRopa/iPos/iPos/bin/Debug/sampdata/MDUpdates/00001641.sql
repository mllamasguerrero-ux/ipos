CREATE OR ALTER VIEW GRIDPV(
    DOCTOID,
    MOVTOID,
    PARTIDA,
    GRIDLINE,
    CANTIDAD,
    DESCRIPCION,
    PRECIOUNIDAD,
    IMPORTE,
    TITULOSTOTALES,
    DESCUENTO,
    DESCRIPCION2,
    LOTE,
    CLAVEPRODUCTO,
    SUBTOTAL,
    IVA,
    TOTALVALE,
    TASAIVA,
    TEXTO1,
    TEXTO2,
    TEXTO3,
    TEXTO4,
    TEXTO5,
    TEXTO6,
    NUMERO1,
    NUMERO2,
    NUMERO3,
    NUMERO4,
    MOVTODESCRIPCION1,
    MOVTODESCRIPCION2,
    MOVTODESCRIPCION3,
    PRODUCTOID,
    IMAGEN,
    ORDEN,
    TASAIEPS,
    DESCUENTOPORCENTAJE)
AS
SELECT
DOCTO.ID AS DOCTOID,
MOVTO.ID AS MOVTOID,
MOVTO.PARTIDA, 1 AS GRIDLINE,
MOVTO.CANTIDAD, CASE WHEN PRODUCTO.descripcion_comodin = 'S' AND
                         MOVTO.descripcion1 IS NOT NULL AND MOVTO.descripcion1 <> '' THEN MOVTO.DESCRIPCION1 ELSE PRODUCTO.DESCRIPCION1 END AS DESCRIPCION,

                         CASE WHEN MOVTO.TASAIMPUESTO IS NULL THEN MOVTO.PRECIO / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) ELSE (MOVTO.PRECIO * ((100.00 + MOVTO.TASAIVA) / 100.00) * ((100.00 + MOVTO.TASAIEPS) 
                         / 100.00)) / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) END AS PRECIOUNIDAD,

                         MOVTO.TOTAL / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) AS IMPORTE, '' AS TITULOSTOTALES,
                          
                         MOVTO.DESCUENTO / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) AS DESCUENTO,


                         CASE WHEN PRODUCTO.descripcion_comodin = 'S' AND 
                         MOVTO.descripcion1 IS NOT NULL AND MOVTO.descripcion1 <> '' THEN MOVTO.DESCRIPCION2 ELSE PRODUCTO.DESCRIPCION2 END AS DESCRIPCION2,

                         MOVTO.LOTE, PRODUCTO.CLAVE AS CLAVEPRODUCTO,
                          MOVTO.SUBTOTAL / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) AS SUBTOTAL,
                         MOVTO.IVA / (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END) AS IVA,

                         CASE WHEN PRODUCTO.TIPOABC = 'S' AND (PERSONA.LISTAPRECIOID IS NULL OR
                         PERSONA.LISTAPRECIOID = 1) AND MOVTO.INGRESOPRECIOMANUAL = 'N' AND (NOT (PRODUCTO.pzacaja > 1 AND MOVTO.CANTIDAD >= PRODUCTO.pzacaja)) AND 
                         (NOT (PRODUCTO.pzacaja > 1 AND MOVTO.CANTIDAD >= PRODUCTO.U_EMPAQUE AND PRODUCTO.U_EMPAQUE > 1)) AND 
                         (NOT (PRODUCTO.UNIDAD LIKE '%KG%' AND MOVTO.CANTIDAD >= PRODUCTO.INI_MAYO AND PRODUCTO.MAYOKGS = 'S')) 
                         THEN

                         cast( (ROUND( ROUND((MOVTO.PRECIO * ((100 - PARAMETRO.DESCUENTOVALE)/100.00)),2) * MOVTO.CANTIDAD , 2)) as d_importe)    +
                        cast( ROUND((  cast((ROUND( ROUND((MOVTO.PRECIO * ((100 - PARAMETRO.DESCUENTOVALE)/100.00)),2) * MOVTO.CANTIDAD , 2)) as d_importe)  * (1 + (COALESCE (MOVTO.tasaieps,0)/100.00)) * (COALESCE (MOVTO.tasaiva,0)/100.00)) , 2)  as d_importe) +
                        cast( ROUND((  cast((ROUND( ROUND((MOVTO.PRECIO * ((100 - PARAMETRO.DESCUENTOVALE)/100.00)),2) * MOVTO.CANTIDAD , 2)) as d_importe) * (COALESCE (MOVTO.tasaieps,0)/100.00)) ,2 )  as d_importe)


                         ELSE MOVTO.TOTAL /
                         (CASE WHEN DOCTO.TIPOCAMBIO = 0 OR
                         DOCTO.TIPOCAMBIO IS NULL THEN 1 ELSE DOCTO.TIPOCAMBIO END)

                         END AS TOTALVALE,

                         MOVTO.TASAIVA, PRODUCTOCARACTERISTICAS.TEXTO1,
                         PRODUCTOCARACTERISTICAS.TEXTO2, PRODUCTOCARACTERISTICAS.TEXTO3, PRODUCTOCARACTERISTICAS.TEXTO4, PRODUCTOCARACTERISTICAS.TEXTO5, 
                         PRODUCTOCARACTERISTICAS.TEXTO6, PRODUCTOCARACTERISTICAS.NUMERO1, PRODUCTOCARACTERISTICAS.NUMERO2, 
                         PRODUCTOCARACTERISTICAS.NUMERO3, PRODUCTOCARACTERISTICAS.NUMERO4, MOVTO.DESCRIPCION1 AS MOVTODESCRIPCION1,
                         MOVTO.DESCRIPCION2 AS MOVTODESCRIPCION2, MOVTO.DESCRIPCION3 AS MOVTODESCRIPCION3, MOVTO.PRODUCTOID, PRODUCTO.IMAGEN  ,
                         MOVTO.ORDEN , MOVTO.TASAIEPS , MOVTO.DESCUENTOPORCENTAJE


FROM            DOCTO INNER JOIN
                         MOVTO ON MOVTO.DOCTOID = DOCTO.ID LEFT OUTER JOIN
                         PRODUCTO ON PRODUCTO.ID = MOVTO.PRODUCTOID LEFT OUTER JOIN
                         LINEA ON LINEA.ID = PRODUCTO.LINEAID, PARAMETRO LEFT OUTER JOIN
                         PERSONA ON PERSONA.ID = DOCTO.PERSONAID LEFT OUTER JOIN
                         PRODUCTOCARACTERISTICAS ON PRODUCTOCARACTERISTICAS.PRODUCTOID = PRODUCTO.ID
WHERE         (MOVTO.CANTIDAD > 0)
ORDER BY MOVTO.ORDEN, MOVTO.PARTIDA
;