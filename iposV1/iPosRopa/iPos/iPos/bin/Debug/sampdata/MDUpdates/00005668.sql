create or alter procedure INVKIT_DESENSAMBLETEMP (
    DOCTOID D_FK,
    VENDEDORID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable CAJAID D_FK;
declare variable SUCURSALID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable ESTATUSDOCTOID D_FK;
declare variable FALTANTES integer;
declare variable REFERENCIA D_REFERENCIA;
declare variable PRECIO D_COSTO;
declare variable COSTO D_COSTO;
declare variable SUCURSALTID D_FK;
declare variable ALMACENTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PERSONAID D_FK;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable LOTEIMPORTADO D_FK;
declare variable TIPODOCTOIDFORKIT D_FK;
declare variable DOCTOIDFORKIT D_FK;
declare variable KITDESGLOSADO D_BOOLCN;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
BEGIN

  ERRORCODE = 0;


   SELECT TIPODOCTOID, ESTATUSDOCTOID , SUCURSALID , PERSONAID, KITDESGLOSADO , ALMACENID
   FROM DOCTO
   WHERE ID = :DOCTOID
   INTO :TIPODOCTOID, :ESTATUSDOCTOID, :SUCURSALID, :PERSONAID, :KITDESGLOSADO, :ALMACENID;

   -- Interceptar docto no existente
   IF ((:TIPODOCTOID IS NULL) OR (:ESTATUSDOCTOID IS NULL)) THEN
   BEGIN
      ERRORCODE = 1071;
      SUSPEND;
      EXIT;
   END

   -- Solo admitir TipoDocto = 50, captura de inventario fisico.
   IF (:TIPODOCTOID NOT IN (50,53)) THEN
   BEGIN
      ERRORCODE = 1071;
      SUSPEND;
      EXIT;
   END

   IF (COALESCE(:KITDESGLOSADO,'N') = 'N') THEN
   BEGIN
      ERRORCODE = 0;
      SUSPEND;
      EXIT;
   END


    TIPODOCTOIDFORKIT = 502;
    DOCTOIDFORKIT = 0;

   -- Agrega los MOVTO.
   FOR SELECT
         INVENTARIO.PRODUCTOID, INVENTARIO.LOTE, INVENTARIO.FECHAVENCE, INVENTARIO.CANTIDAD, PRODUCTO.PRECIO1, PRODUCTO.COSTOREPOSICION,
         CASE WHEN COALESCE(INVENTARIO.ORIGENFISCALID, 2) = 3 THEN INVENTARIO.CANTIDAD ELSE 0 END CANTIDADDEFACTURA,  
         CASE WHEN COALESCE(INVENTARIO.ORIGENFISCALID, 2) = 3 THEN INVENTARIO.CANTIDAD ELSE 0 END CANTIDADDEREMISION,
         CASE WHEN COALESCE(INVENTARIO.ORIGENFISCALID, 2) = 3 THEN INVENTARIO.CANTIDAD ELSE 0 END CANTIDADDEINDEFINIDO,
            PRODUCTO.DESCRIPCION1, PRODUCTO.DESCRIPCION2, PRODUCTO.DESCRIPCION3, INVENTARIO.LOTEIMPORTADO
   FROM INVENTARIO
        INNER JOIN PRODUCTO ON PRODUCTO.ID = INVENTARIO.PRODUCTOID

   WHERE INVENTARIO.PRODUCTOID IN
      (SELECT KITSUNNIVEL_VIEW.PRODUCTOKITID FROM  KITSUNNIVEL_VIEW
         WHERE  KITSUNNIVEL_VIEW.PRODUCTOPARTEID
                IN (
                    SELECT MOVTO.PRODUCTOID FROM MOVTO WHERE DOCTOID = :DOCTOID GROUP BY MOVTO.PRODUCTOID)
         GROUP BY KITSUNNIVEL_VIEW.PRODUCTOKITID
      )
   INTO
       :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, :PRECIO, :COSTO,
       :CANTIDADDEFACTURA,
       :CANTIDADDEREMISION,
       :CANTIDADDEINDEFINIDO ,
       :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, :LOTEIMPORTADO
   DO
   BEGIN




      
                     SELECT DOCTOID, MOVTOID, ERRORCODE
                        FROM MOVTO_INSERT(:DOCTOIDFORKIT, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOIDFORKIT, 0, 0, :PERSONAID, :VENDEDORID, 1, 0,
                        :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, 0, 0,
                        :REFERENCIA, '', :COSTO, :SUCURSALID, :ALMACENID, 'N', NULL, CURRENT_DATE, CURRENT_DATE, 0.00,:DOCTOID,NULL,NULL,NULL,NULL, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3, NULL, :LOTEIMPORTADO, 'N','N')
                        INTO :DOCTOIDFORKIT, :MOVTOID, :ERRORCODE;

             
        IF(COALESCE(:ERRORCODE,0) <> 0) THEN
        BEGIN    
            SUSPEND;
            EXIT;
        END

        
      --asegurate de que se pasen las cantidades de facturado y remisionado
         UPDATE MOVTO  SET  CANTIDADDEFACTURA = :CANTIDADDEFACTURA  ,
           CANTIDADDEREMISION = :CANTIDADDEREMISION, CANTIDADDEINDEFINIDO = :CANTIDADDEINDEFINIDO
           WHERE id = :MOVTOID;

   END


   SELECT ERRORCODE FROM KIT_APLICARDESENSAMBLE( :DOCTOIDFORKIT) INTO :ERRORCODE;
     
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END





    SUSPEND;
END