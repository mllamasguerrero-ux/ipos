create or alter procedure ASIGNARTOTALESSINVALE (
    DOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable MOVTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable CANTIDADINVENTARIO D_CANTIDAD;
declare variable CANTIDAD D_CANTIDAD;
declare variable ORDEN D_ORDEN;
declare variable LOTE D_LOTE;
declare variable CUENTA integer;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable CANTIDADSUMARIZADA D_CANTIDAD;
declare variable CANTIDADRESTANTE D_CANTIDAD;
declare variable CANTIDADASIGNAR D_CANTIDAD;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable EXISTENCIA D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable LOTEIMPORTADO D_FK;
declare variable IMPORTEVALE D_PRECIO;
declare variable RESULTADOEXACTOANT D_DECIMAL_EXACT;
declare variable RESULTADOEXACTO D_DECIMAL_EXACT;
declare variable DOCTOTOTAL D_DECIMAL_EXACT;
declare variable MOVTO_SINVALE_TOTAL D_DECIMAL_EXACT;
declare variable MOVTOSUBTOTAL D_PRECIO;
declare variable MOVTOIVA D_PRECIO;
declare variable MOVTOIEPS D_PRECIO;
declare variable MOVTOTOTAL D_PRECIO;
declare variable MOVTOTASAIVA D_PORCENTAJE;
declare variable MOVTOTASAIEPS D_PORCENTAJE;
declare variable MOVTOSUBTOTALSINIVASINVALE D_PRECIO;
declare variable MOVTOSUBTOTALSINIEPSSINVALE D_PRECIO;
declare variable MOVTOSUBTOTALSINVALE D_PRECIO;
declare variable MOVTOIVASINVALE D_PRECIO;
declare variable MOVTOIEPSSINVALE D_PRECIO;
declare variable MOVTOTOTALSINVALE D_PRECIO;
declare variable DOCTOSUBTOTALSINVALE D_PRECIO;
declare variable DOCTOIVASINVALE D_PRECIO;
declare variable DOCTOIEPSSINVALE D_PRECIO;
declare variable DOCTOTOTALSINVALE D_PRECIO;
declare variable DOCTOREFID D_FK;
declare variable IMPORTEDEVOLUCIONES D_PRECIO;
declare variable MOVTOIVARETENIDO D_PRECIO;
declare variable MOVTOISRRETENIDO D_PRECIO;
declare variable MOVTOIVARETENIDOSINVALE D_PRECIO;
declare variable MOVTOISRRETENIDOSINVALE D_PRECIO;
declare variable MOVTOTASAIVARETENIDO D_PORCENTAJE;
declare variable MOVTOTASAISRRETENIDO D_PORCENTAJE;
declare variable DOCTOIVARETENIDOSINVALE D_PRECIO;
declare variable DOCTOISRRETENIDOSINVALE D_PRECIO;
BEGIN

    ERRORCODE = 0;



    SELECT  ALMACENID, SUCURSALID, TIPODOCTOID, PERSONAID , REFERENCIA, REFERENCIAS, TOTAL , DOCTOREFID
    from DOCTO
    where id = :doctoid
    INTO :ALMACENID, :SUCURSALID, :TIPODOCTOID, :PERSONAID, :REFERENCIA, :REFERENCIAS, :DOCTOTOTAL, :DOCTOREFID;

    IF(COALESCE(:TIPODOCTOID,0) NOT IN (701)) THEN
    BEGIN         
           
       UPDATE DOCTO SET SINVALE_SUBTOTAL = SUBTOTAL ,
                        SINVALE_IVA = IVA,
                        SINVALE_IEPS = IEPS,
                        SINVALE_TOTAL = TOTAL ,
                        SINVALE_IVA_RET = IVARETENIDO  ,
                        SINVALE_ISR_RET = ISRRETENIDO
               WHERE ID = :DOCTOID;

      UPDATE MOVTO SET SINVALE_SUBTOTAL = SUBTOTAL ,
                        SINVALE_IVA = IVA,
                        SINVALE_IEPS = IEPS,
                        SINVALE_TOTAL = TOTAL,
                        SINVALE_IVA_RET = IVARETENIDO  ,
                        SINVALE_ISR_RET = ISRRETENIDO
               WHERE DOCTOID = :DOCTOID;
    END


    IF(COALESCE(:TIPODOCTOID,0) NOT IN (21,22,24)) THEN
    BEGIN
        SUSPEND;
        EXIT;
    END




    IF(COALESCE(:TIPODOCTOID,0) IN (22,24)) THEN
    BEGIN

        SELECT ERRORCODE FROM ASIGNARTOTALESSINVALE(:DOCTOREFID) INTO :ERRORCODE;
        SUSPEND;
        EXIT;

    END

    
    SELECT SUM(COALESCE(DOCTOPAGO.IMPORTE,0)) FROM DOCTOPAGO WHERE DOCTOID = :DOCTOID
                        --AND DOCTOPAGO.TIPOPAGOID = 1
                        AND DOCTOPAGO.formapagoid = 5 AND
                        COALESCE(DOCTOPAGO.revertido,'N') = 'N'
    INTO :IMPORTEVALE;

    SELECT SUM(COALESCE(DOCTODEV.TOTAL, 0)) FROM DOCTO  DOCTODEV
    WHERE DOCTODEV.DOCTOREFID = COALESCE(:DOCTOID,0) AND DOCTODEV.estatusdoctoid = 1
    AND DOCTODEV.tipodoctoid = 22
    INTO :IMPORTEDEVOLUCIONES;


    -- AGREGAR LAS DEVOLUCIONES A LO QUE SE TIENE QUE RESTAR
    IMPORTEVALE = COALESCE(:IMPORTEVALE,0) +  COALESCE(:IMPORTEDEVOLUCIONES,0);

      
    IF(COALESCE(:IMPORTEVALE,0) <= 0) THEN
    BEGIN



        SUSPEND;
        EXIT;
    END
    
    IF(COALESCE(:IMPORTEVALE,0) > COALESCE(:DOCTOTOTAL, 0)) THEN
    BEGIN
        IMPORTEVALE = COALESCE(:DOCTOTOTAL, 0);

    END

    IMPORTEVALE = COALESCE(:IMPORTEVALE, 0)  * -1;
    
    RESULTADOEXACTOANT = 0;
    RESULTADOEXACTO = 0;


   FOR SELECT
      M.ID, M.PRODUCTOID,  M.CANTIDAD, M.PRECIO, M.COSTO,
      M.SUBTOTAL, M.IVA, M.ieps,  M.TOTAL , M.tasaiva, M.TASAIEPS,
      M.IVARETENIDO,  M.ISRRETENIDO, M.TASAIVARETENIDO, M.TASAISRRETENIDO
   FROM MOVTO M
    inner join PRODUCTO P ON M.PRODUCTOID = P.ID
   WHERE M.DOCTOID = :DOCTOID
   INTO
      :MOVTOID, :PRODUCTOID,  :CANTIDAD, :PRECIO, :COSTO,
      :MOVTOSUBTOTAL, :MOVTOIVA, :MOVTOIEPS, :MOVTOTOTAL, :MOVTOTASAIVA, :MOVTOTASAIEPS,
      :MOVTOIVARETENIDO, :MOVTOISRRETENIDO,  :MOVTOTASAIVARETENIDO , :MOVTOTASAISRRETENIDO

   DO
   BEGIN

        RESULTADOEXACTOANT = COALESCE(:RESULTADOEXACTO, 0);
        RESULTADOEXACTO = COALESCE(:RESULTADOEXACTO, 0)  + cast(( cast((COALESCE(:MOVTOTOTAL,0.00) / COALESCE(:DOCTOTOTAL,0.00)) as NUMERIC(18,4) ) * COALESCE(:IMPORTEVALE,0.00)) as d_precio);
        MOVTO_SINVALE_TOTAL = COALESCE(:MOVTOTOTAL,0) +  Round(:RESULTADOEXACTO, 2) - Round(:RESULTADOEXACTOANT, 2);
                                                                                            /*
        INSERT INTO TRAZA(VALOR) VALUES('AISGNVALE  ' || CAST(:DOCTOID AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('IMPORTEVALE ' || CAST(:IMPORTEVALE AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('RESULTADOEXACTOANT ' || CAST(:RESULTADOEXACTOANT AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('RESULTADOEXACTO ' || CAST(:RESULTADOEXACTO AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('MOVTOTOTAL ' || CAST(:MOVTOTOTAL AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('DCOTOTOTAL ' || CAST(:DOCTOTOTAL AS VARCHAR(25)));
        INSERT INTO TRAZA(VALOR) VALUES('MVTO SINVALE ' || CAST(:MOVTO_SINVALE_TOTAL AS VARCHAR(25))); */
            
        MOVTOSUBTOTALSINIVASINVALE = ROUND(COALESCE(:MOVTO_SINVALE_TOTAL,0) / ( 1.00 +  (COALESCE(:MOVTOTASAIVA,0)/100.00)), 2);
        MOVTOIVASINVALE = COALESCE(:MOVTO_SINVALE_TOTAL,0) - COALESCE(:MOVTOSUBTOTALSINIVASINVALE,0);
        MOVTOSUBTOTALSINIEPSSINVALE = ROUND(COALESCE(:MOVTOSUBTOTALSINIVASINVALE,0) / ( 1.00 +  (COALESCE(:MOVTOTASAIEPS,0)/100.00)), 2);
        MOVTOIEPSSINVALE = COALESCE(:MOVTOSUBTOTALSINIVASINVALE,0) - COALESCE(:MOVTOSUBTOTALSINIEPSSINVALE,0);
        MOVTOSUBTOTALSINVALE =  COALESCE(:MOVTO_SINVALE_TOTAL,0) - COALESCE(:MOVTOIVASINVALE, 0) -  COALESCE(:MOVTOIEPSSINVALE,0);

        
        MOVTOIVARETENIDOSINVALE = CAST(COALESCE(:MOVTOSUBTOTALSINIVASINVALE,0) * COALESCE(:MOVTOTASAIVARETENIDO,0) AS D_PRECIO);
        MOVTOISRRETENIDOSINVALE = CAST(COALESCE(:MOVTOSUBTOTALSINIVASINVALE,0) * COALESCE(:MOVTOTASAIVARETENIDO,0) AS D_PRECIO);


        UPDATE MOVTO
        SET SINVALE_TOTAL = COALESCE(:MOVTO_SINVALE_TOTAL,0) ,
            SINVALE_IVA  =  COALESCE(:MOVTOIVASINVALE ,0) ,  
            SINVALE_IEPS  =  COALESCE(:MOVTOIEPSSINVALE ,0) ,
            SINVALE_SUBTOTAL  =  COALESCE(:MOVTOSUBTOTALSINVALE ,0),
            SINVALE_IVA_RET =  COALESCE(:MOVTOIVARETENIDOSINVALE ,0),
            SINVALE_ISR_RET =  COALESCE(:MOVTOISRRETENIDOSINVALE ,0)
          WHERE ID = :MOVTOID;

   END



   SELECT SUM(COALESCE(SINVALE_SUBTOTAL,0)) DOCTOSUBTOTALSINVALE ,
          SUM(COALESCE(SINVALE_IVA,0)) DOCTOIVASINVALE ,
          SUM(COALESCE(SINVALE_IEPS,0)) DOCTOIEPSSINVALE,
          SUM(COALESCE(SINVALE_TOTAL,0)) DOCTOTOTALSINVALE ,
          SUM(COALESCE(SINVALE_IVA_RET,0)) DOCTOIVARETENIDOSINVALE,
          SUM(COALESCE(SINVALE_ISR_RET,0)) DOCTOISRRETENIDOSINVALE
        FROM  MOVTO
        WHERE DOCTOID = :DOCTOID
        INTO       
            DOCTOSUBTOTALSINVALE ,
            DOCTOIVASINVALE ,
            DOCTOIEPSSINVALE ,
            DOCTOTOTALSINVALE,
            DOCTOIVARETENIDOSINVALE,
            DOCTOISRRETENIDOSINVALE;


       UPDATE DOCTO SET SINVALE_SUBTOTAL = :DOCTOSUBTOTALSINVALE ,
                        SINVALE_IVA = :DOCTOIVASINVALE,
                        SINVALE_IEPS = :DOCTOIEPSSINVALE,
                        SINVALE_TOTAL = :DOCTOTOTALSINVALE,
                        SINVALE_IVA_RET = :DOCTOIVARETENIDOSINVALE,
                        SINVALE_ISR_RET = :DOCTOISRRETENIDOSINVALE
               WHERE ID = :DOCTOID;


   
   ERRORCODE = 0;
   SUSPEND;
   
   /*WHEN ANY DO
   BEGIN
      ERRORCODE = 1012;
      SUSPEND;
   END  */
END