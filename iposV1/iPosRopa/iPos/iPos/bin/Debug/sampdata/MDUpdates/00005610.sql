create or alter procedure FONDEO_REVERTIR_PAGOS (
    DOCTOACANCELARID D_FK,
    DOCTODECANCELACION D_FK,
    VENDEDORID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable TIPODOCTOCANCELARID D_FK;
declare variable TOTAL D_FK;
declare variable CORTEID D_FK;
declare variable DOCTOIDBUFFER D_FK;
declare variable SALDOBUFFER D_PRECIO;
declare variable FORMAPAGOID D_FK;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable TIPOABONOID D_FK;
declare variable REVERTIDO D_BOOLCN;
declare variable CORTEACANCELAR D_FK;
declare variable VENDEDORACANCELAR D_FK;
declare variable FECHAPAGO D_FECHA;
declare variable FORMAPAGOSATID D_FK;
BEGIN
   -- Leer del DOCTO a cancelar.
   SELECT ESTATUSDOCTOID, TIPODOCTOID , CORTEID , VENDEDORID
   FROM DOCTO
   WHERE ID = :DOCTOACANCELARID
   INTO :ESTATUSDOCTOID, :TIPODOCTOCANCELARID, :CORTEACANCELAR, :VENDEDORACANCELAR;

   -- Si no esta vigente: Salir.
   IF (:ESTATUSDOCTOID <> 1) THEN
   BEGIN
      ERRORCODE = 1007;
      SUSPEND;
      EXIT;
   END

   -- Si no es devolucion
   IF (:TIPODOCTOCANCELARID NOT IN (68)) THEN
   BEGIN
      ERRORCODE = 1008;
      SUSPEND;
      EXIT;
   END

   
   
   /*SELECT  TOTAL
   FROM DOCTO
   WHERE ID = :DOCTODECANCELACION
   INTO  :TOTAL;

   SELECT HAYCORTEACTIVO,CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :CORTEID, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      SUSPEND;
      EXIT;
   END    */


   --RESTANTEBUFFER = :TOTAL;





    FOR SELECT P.doctoid, P.IMPORTE , P.FORMAPAGOID ,P.TIPOABONOID, P.REVERTIDO , P.FECHA , P.FORMAPAGOSATID
   FROM DOCTOPAGO P
   WHERE P.DOCTOSALIDAID = :DOCTOACANCELARID AND P.tipopagoid = 1 AND P.FORMAPAGOID IN (1,2,3,4,5,14,15,16,20,21)
   INTO
   :DOCTOIDBUFFER, :SALDOBUFFER, :FORMAPAGOID, :TIPOABONOID, :REVERTIDO , :FECHAPAGO  , :FORMAPAGOSATID
   DO
   BEGIN

         INSERT INTO DOCTOPAGO ( DOCTOID, FORMAPAGOID, FECHA, FECHAHORA, CORTEID, IMPORTE, IMPORTERECIBIDO, IMPORTECAMBIO, TIPOPAGOID, DOCTOSALIDAID, ESPAGOINICIAL, TIPOABONOID, REVERTIDO, CORTETRANSCANCELADA, FORMAPAGOSATID)
                             VALUES (:DOCTOACANCELARID, :FORMAPAGOID, :FECHAPAGO, CURRENT_TIME,  :CORTEACANCELAR, :SALDOBUFFER,:SALDOBUFFER, 0, 2, :DOCTODECANCELACION, 'S', :TIPOABONOID, :REVERTIDO, :CORTEACANCELAR, :FORMAPAGOSATID);

   END











   ERRORCODE = 0;
   SUSPEND;
   
    WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END