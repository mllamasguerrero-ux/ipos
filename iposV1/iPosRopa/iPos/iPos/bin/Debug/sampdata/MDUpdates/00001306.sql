create or alter procedure DOCTO_ASIGNARCLIENTEXSUCURSALT (
    DOCTOID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable SUCURSALTID D_FK;
declare variable PERSONAID D_FK;
BEGIN

   SELECT DOCTO.sucursaltid FROM DOCTO WHERE ID = :DOCTOID INTO :SUCURSALTID;

   IF(COALESCE(:SUCURSALTID ,0) = 0) THEN
   BEGIN
             
       UPDATE DOCTO SET PERSONAID = 1  WHERE ID = :DOCTOID;
      ERRORCODE = 0;
      SUSPEND;
      EXIT;
   END

   SELECT FIRST 1 PERSONA.id FROM PERSONA INNER JOIN SUCURSAL ON PERSONA.CLAVE = SUCURSAL.clienteclave
   INNER JOIN DOCTO on DOCTO.SUCURSALTID = SUCURSAL.ID
   WHERE DOCTO.ID = :DOCTOID
   INTO :PERSONAID;

   
   IF(COALESCE(:PERSONAID ,0) = 0) THEN
   BEGIN
       UPDATE DOCTO SET PERSONAID = 1  WHERE ID = :DOCTOID;  
      ERRORCODE = 0;
      SUSPEND;
      EXIT;
   END

   
       UPDATE DOCTO SET PERSONAID = :PERSONAID  WHERE ID = :DOCTOID;


   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1012;
      SUSPEND;
   END
END