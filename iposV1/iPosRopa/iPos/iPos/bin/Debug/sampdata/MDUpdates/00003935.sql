create or alter procedure GUIADETALLE_RECIBIR (
    GUIADETALLEID D_FK,
    ESTADOGUIAID D_FK,
    CAJEROID D_FK)
returns (
    ERRORCODE type of D_ERRORCODE)
as
declare variable DOCTOID D_FK;
declare variable GUIAID D_FK;
declare variable DIAS D_FK;
BEGIN
  ERRORCODE = 0;

  -- FALTA COMPLETAR

  SELECT DOCTOID, GUIAID FROM GUIADETALLE WHERE ID = :GUIADETALLEID INTO :DOCTOID, :GUIAID;

  IF(COALESCE(:DOCTOID,0) = 0  ) THEN
  BEGIN
    SUSPEND;
    EXIT;
  END
  
   UPDATE DOCTO SET ESTADOGUIAID = :ESTADOGUIAID , GUIAID = :GUIAID
    WHERE ID = :DOCTOID AND GUIAID = :GUIAID;

    
    IF(coalesce(:ESTADOGUIAID,0) = 3) THEN
    BEGIN
          SELECT PERSONA.dias FROM DOCTO INNER JOIN PERSONA ON PERSONA.ID = DOCTO.id INTO :DIAS;

           UPDATE DOCTO SET FECHAGUIARECIBIDO = current_date, DOCTO.vence = DATEADD(COALESCE(:DIAS,0) DAY TO CURRENT_DATE),
                  PERSONAIDGUIARECIBIO = :CAJEROID
            WHERE ID = :DOCTOID;

    END
    ELSE
    BEGIN 
           UPDATE DOCTO SET FECHAGUIARECIBIDO = NULL, PERSONAIDGUIARECIBIO = NULL
            WHERE ID = :DOCTOID;
    END

  
   UPDATE  GUIADETALLE  SET ESTADOGUIAID = :ESTADOGUIAID,
            FECHARECIBIDO = CASE WHEN :ESTADOGUIAID = 3 THEN CURRENT_DATE ELSE NULL END ,
            FECHAHORARECIBIDO =   CASE WHEN :ESTADOGUIAID = 3 THEN CURRENT_TIME ELSE NULL END ,
            PERSONAIDRECIBIO = CASE WHEN :ESTADOGUIAID = 3 THEN :CAJEROID ELSE NULL END
  WHERE ID = :GUIADETALLEID;

  SELECT ERRORCODE FROM GUIADETALLE_ACTUALIZARESTADO(:GUIAID, :CAJEROID) INTO :ERRORCODE;

            
  IF(COALESCE(:ERRORCODE,0) <> 0  ) THEN
  BEGIN
    SUSPEND;
    EXIT;
  END

   ERRORCODE = 0;
   SUSPEND;
END