create or alter procedure DOCTOPAGOMOVIL_CANCELAR (
    PAGOMOVILID D_FK,
    CORTEID D_FK)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable DOCTOPAGOMOVILID D_FK;
declare variable CANCELPAGOMOVILID D_FK;
declare variable ACTIVO D_BOOLCS;
declare variable ESTATUS D_FK;
BEGIN
  ACTIVO = 'N';
  SELECT COALESCE(ACTIVO,'N') FROM CORTE WHERE ID = :CORTEID INTO :ACTIVO;

  IF(:ACTIVO <> 'S') THEN
  BEGIN
      ERRORCODE = 1001;
      SUSPEND;
      EXIT;
  END


   SELECT ESTATUS FROM PAGOMOVIL WHERE ID = :PAGOMOVILID INTO :ESTATUS;

   IF(COALESCE(:ESTATUS,0) = 0) THEN
   BEGIN
        DELETE FROM pagomovil  WHERE ID = :PAGOMOVILID;
        DELETE FROM DOCTOPAGOMOVIL  WHERE PAGOMOVILID = :PAGOMOVILID;
   END
   ELSE
   BEGIN



   INSERT INTO PAGOMOVIL
      (
TIPOPAGOID,
ESTATUS,
USUARIOID,
PERSONAID,
FORMAPAGOID,
FECHA,
CORTEID,
IMPORTE,
IMPORTERECIBIDO,
IMPORTECAMBIO,
BANCO,
REFERENCIABANCARIA,
NOTAS,
FECHAELABORACION,
FECHARECEPCION,
PAGOMOVILREFID,
PERSONACLAVE,
APLICADO
         )

SELECT
6,
1,
P2.USUARIOID,
P2.PERSONAID,
P2.FORMAPAGOID,
P2.FECHA,
:CORTEID,
P2.IMPORTE,
P2.IMPORTERECIBIDO,
P2.IMPORTECAMBIO,
P2.BANCO,
P2.REFERENCIABANCARIA,
P2.NOTAS,
P2.FECHAELABORACION,
P2.FECHARECEPCION,
:PAGOMOVILID,
P2.PERSONACLAVE,
P2.APLICADO
 FROM PAGOMOVIL P2 WHERE p2.id = :PAGOMOVILID

   RETURNING ID INTO :CANCELPAGOMOVILID;



     INSERT INTO DOCTOPAGOMOVIL
      (

        PAGOMOVILID,

        COBRANZAID,

        ESTATUS,

        FECHA,

        CORTEID,

        IMPORTE,

        REVERTIDO,

        DOCTOPAGOMOVILREFID,

        TIPOPAGOID,

        VENTACOBRANZA ,

        SALDOANTERIOR,

        SALDONUEVO
         )

select


        :CANCELPAGOMOVILID,

        DP2.COBRANZAID,

        1,

        CURRENT_DATE,

        :CORTEID,

        DP2.IMPORTE,

        'N',

        DP2.ID,

        6,

        DP2.VENTACOBRANZA ,

       COBRANZAMOVIL.saldomovil,

       COBRANZAMOVIL.saldomovil +  DP2.IMPORTE

    FROM DOCTOPAGOMOVIL DP2 LEFT JOIN COBRANZAMOVIL ON COBRANZAMOVIL.ID = DP2.cobranzaid WHERE DP2.pagomovilid = :PAGOMOVILID;



    UPDATE pagomovil SET ESTATUS = 2 WHERE ID = :PAGOMOVILID;

    UPDATE DOCTOPAGOMOVIL SET ESTATUS = 2 WHERE PAGOMOVILID = :PAGOMOVILID;

   END


   
   ERRORCODE = 0;
   SUSPEND;
   
   WHEN ANY DO
   BEGIN
      ERRORCODE = 11012;
      SUSPEND;
   END
END