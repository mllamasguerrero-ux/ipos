create or alter procedure SURTIDO_CAMBIAR_LOTE_ADD (
    FIRSTMOVTOID D_FK,
    CANTIDAD D_CANTIDAD,
    LOTE D_LOTE,
    FECHAVENCE D_FECHAVENCE,
    SURTIBLE D_BOOLCS,
    MAXSURTIBLE D_CANTIDAD)
returns (
    ERRORCODE D_ERRORCODE)
as
declare variable PRODUCTOID D_FK;
declare variable DOCTOID D_FK;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable VENDEDORID D_FK;
BEGIN

   SELECT MOVTO.PRODUCTOID, MOVTO.DOCTOID, MOVTO.PRECIO
   , MOVTO.COSTO, MOVTO.TIPODIFERENCIAINVENTARIOID  ,  MOVTO.DESCRIPCION1, MOVTO.DESCRIPCION2, MOVTO.DESCRIPCION3
   , MOVTO.tipodoctoid, DOCTO.sucursalid, DOCTO.almacenid , DOCTO.vendedorid
   FROM MOVTO
    LEFT JOIN DOCTO ON DOCTO.ID = MOVTO.DOCTOID
   WHERE MOVTO.ID = :FIRSTMOVTOID
   INTO :PRODUCTOID, :DOCTOID, :PRECIO
   ,:COSTO, :TIPODIFERENCIAINVENTARIOID, :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3
   ,:TIPODOCTOID, :SUCURSALID, :ALMACENID, :VENDEDORID;


                  
    SELECT ERRORCODE  , MOVTOID
                    FROM MOVTO_INSERT (
                    :DOCTOID, 0, :ALMACENID, :SUCURSALID, :TIPODOCTOID, 0, 0, :PERSONAID, :VENDEDORID, 1,
                    0, :PRODUCTOID, :LOTE, :FECHAVENCE, :CANTIDAD, 0, 0, 0, 0, :PRECIO, 0,
                    :REFERENCIA, :REFERENCIAS, :COSTO, :SUCURSALID, :ALMACENID, 'N', 
                    :TIPODIFERENCIAINVENTARIOID, CURRENT_DATE, CURRENT_DATE, 0.00 ,NULL,NULL,NULL,null,NULL , :DESCRIPCION1, :DESCRIPCION2, :DESCRIPCION3 , NULL , NULL , 'N','N'
                ) INTO :ERRORCODE, :NEWMOVTOID;

                
    IF(COALESCE(:ERRORCODE,0) <> 0 ) THEN
    BEGIN
        SUSPEND;
        EXIT;
    END

    UPDATE MOVTO  SET SURTIBLE = :SURTIBLE, MAXSURTIBLE = :MAXSURTIBLE WHERE ID = :NEWMOVTOID;


   ERRORCODE = 0;
   SUSPEND;
         /*
   WHEN ANY DO
   BEGIN
      ERRORCODE = 1004;
      SUSPEND;
   END */
END