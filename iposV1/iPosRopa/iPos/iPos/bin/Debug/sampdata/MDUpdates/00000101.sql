CREATE OR ALTER PROCEDURE DOCTO_INSERT (
    CREADOPOR_USERID TYPE OF D_FK,
    ALMACENID TYPE OF D_FK,
    SUCURSALID TYPE OF D_FK,
    TIPODOCTOID TYPE OF D_FK,
    ESTATUSDOCTOID TYPE OF D_FK,
    ESTATUSDOCTOPAGOID TYPE OF D_FK,
    PERSONAID TYPE OF D_FK,
    VENDEDORID TYPE OF D_FK,
    CAJAID TYPE OF D_FK,
    REFERENCIA TYPE OF D_REFERENCIA,
    REFERENCIAS VARCHAR(255),
    SUCURSALTID D_FK,
    ALMACENTID D_FK,
    FECHA D_FECHA,
    VENCE D_FECHA)
RETURNS (
    DOCTOID TYPE OF D_FK,
    ERRORCODE TYPE OF D_ERRORCODE)
AS
DECLARE VARIABLE HAYCORTEACTIVO D_BOOLCN;
DECLARE VARIABLE CORTEID2 D_FK;
DECLARE VARIABLE FECHAULTIMA D_FECHA;
BEGIN
   SELECT HAYCORTEACTIVO,CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:CAJAID)
   INTO :HAYCORTEACTIVO, :CORTEID2, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END

   -- Validar MAXDOCTOSPENDIENTES
   -- Por ahora solo validar para el tipo 21: Ventas.
   IF (:TIPODOCTOID = 21) THEN
   BEGIN
      SELECT ERRORCODE 
      FROM VALIDAR_MAXDOCTOSPENDIENTES(:TIPODOCTOID)
      INTO :ERRORCODE;
   END

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END

   -- Validar la fecha VS ultima fecha de operacion
   SELECT FECHAULTIMA
   FROM PARAMETRO
   INTO :FECHAULTIMA;

   IF (:FECHAULTIMA IS NOT NULL)  THEN
   BEGIN
      IF (:FECHAULTIMA > CURRENT_DATE) THEN
      BEGIN
         ERRORCODE = 1067;
         SUSPEND;
         EXIT;
      END

      IF (:FECHAULTIMA < (CURRENT_DATE-3)) THEN
      BEGIN
         ERRORCODE = 1068;
         SUSPEND;
         EXIT;
      END
   END

   IF (:FECHA IS NULL) THEN
   BEGIN
      FECHA = CURRENT_DATE;
   END

   IF (:VENCE IS NULL) THEN
   BEGIN
      VENCE = :FECHA;
   END

   INSERT INTO DOCTO (
      CREADOPOR_USERID, 
      ALMACENID, 
      SUCURSALID, 
      TIPODOCTOID, 
      ESTATUSDOCTOID, 
      ESTATUSDOCTOPAGOID, 
      ESTATUSDOCTOPEDIDOID,
      PERSONAID, 
      VENDEDORID,
      CAJAID,
      REFERENCIA,
      REFERENCIAS,
      SUCURSALTID,
      ALMACENTID,
      FECHA,
      VENCE)
   VALUES (
      :CREADOPOR_USERID, 
      :ALMACENID, 
      :SUCURSALID, 
      :TIPODOCTOID, 
      :ESTATUSDOCTOID, 
      :ESTATUSDOCTOPAGOID, 
      0,
      :PERSONAID, 
      :VENDEDORID,
      :CAJAID,
      :REFERENCIA,
      :REFERENCIAS,
      :SUCURSALTID,
      :ALMACENTID,
      :FECHA,
      :VENCE)
   RETURNING ID INTO :DOCTOID;

   IF ((:DOCTOID IS NULL) OR (:DOCTOID = 0)) THEN
   BEGIN
      ERRORCODE = 1002;
   END

   SUSPEND;
END
