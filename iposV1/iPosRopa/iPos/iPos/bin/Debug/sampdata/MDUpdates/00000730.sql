CREATE OR ALTER TRIGGER MOVTO_AI_20 FOR MOVTO
ACTIVE AFTER INSERT POSITION 20
AS
   DECLARE VARIABLE ERRORCODE D_ERRORCODE;
   DECLARE VARIABLE INVENTARIABLE D_BOOLCS;
   declare variable TIPODOCTOID D_FK;
BEGIN
   IF ((NEW.ESTATUSMOVTOID IS NULL) OR (NEW.ESTATUSMOVTOID = 0)) THEN
   BEGIN    
      IF(NEW.registroprocesosalida = 'S' ) THEN
      BEGIN
            UPDATE PRODUCTO
            SET ENPROCESODESALIDA = COALESCE(ENPROCESODESALIDA,0) + COALESCE(NEW.CANTIDAD,0)
            WHERE ID = NEW.PRODUCTOID;
      END
      EXIT;
   END

   --IF ((NEW.TOTAL IS NULL) OR (NEW.TOTAL = 0)) THEN
   IF ((NEW.CANTIDAD IS NULL) OR (NEW.CANTIDAD = 0)) THEN
   BEGIN

      EXIT;
   END

    -- Determinar si es inventariable para registrar kardex o no.
   SELECT COALESCE(P.INVENTARIABLE, 'S')
   FROM PRODUCTO P
   WHERE P.ID = NEW.PRODUCTOID
   INTO :INVENTARIABLE;




    -- Solo si es inventariable.
   IF (:INVENTARIABLE = 'S') THEN
   BEGIN
   
   SELECT TIPODOCTOID FROM DOCTO WHERE ID = nEW.DOCTOID INTO :TIPODOCTOID;

      SELECT ERRORCODE FROM KARDEX_INSERT (
         NEW.DOCTOID,
         NEW.ID,
         NEW.PRODUCTOID,
         NEW.LOTE,
         NEW.FECHAVENCE,
         CASE when (:TIPODOCTOID = 41) THEN NEW.cantidadsurtida ELSE NEW.CANTIDAD END,
         NEW.PRECIO,
         NEW.COSTO ,
         NEW.esapartado
      ) INTO ERRORCODE;
   END
END