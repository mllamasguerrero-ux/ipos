create or alter procedure CONSOLIDADO_DEVOLVER (
    DOCTODEVOLUCIONID D_FK,
    VENDEDORID D_FK)
returns (
    DOCTOID D_FK,
    ERRORCODE D_ERRORCODE)
as
declare variable ESTATUSDOCTOID D_FK;
declare variable MOVTOID D_FK;
declare variable ALMACENID D_FK;
declare variable SUCURSALID D_FK;
declare variable PERSONAID D_FK;
declare variable TIPODOCTOID D_FK;
declare variable PRODUCTOID D_FK;
declare variable LOTE D_LOTE;
declare variable FECHAVENCE D_FECHAVENCE;
declare variable CANTIDAD D_CANTIDAD;
declare variable PRECIO D_PRECIO;
declare variable COSTO D_COSTO;
declare variable REFERENCIA D_REFERENCIA;
declare variable REFERENCIAS varchar(255);
declare variable SERIE varchar(31);
declare variable FOLIO integer;
declare variable ALMACENTID D_FK;
declare variable SUCURSALTID D_FK;
declare variable TIPODIFERENCIAINVENTARIOID D_FK;
declare variable CANTIDADDEFACTURA D_CANTIDAD;
declare variable CANTIDADDEREMISION D_CANTIDAD;
declare variable CANTIDADDEINDEFINIDO D_CANTIDAD;
declare variable NEWMOVTOID D_FK;
declare variable PRODUCTOSINSUFICIENTES D_CANTIDAD;
declare variable DESCRIPCION1 D_STDTEXT_64;
declare variable DESCRIPCION2 D_STDTEXT_64;
declare variable DESCRIPCION3 D_STDTEXT_64;
declare variable CLIENTECONSOLIDADOID D_FK;
declare variable CORTEID D_FK;
declare variable HAYCORTEACTIVO D_BOOLCN;
declare variable DOCTOFACTCONSID D_FK;
declare variable DOCTOVENTAID D_FK;
BEGIN


        
   SELECT HAYCORTEACTIVO, CORTEID,ERRORCODE
   FROM HAY_CORTE_ACTIVO(:VENDEDORID)
   INTO :HAYCORTEACTIVO, :CORTEID, :ERRORCODE;

   IF (:ERRORCODE > 0) THEN
   BEGIN
      DOCTOID = 0;
      SUSPEND;
      EXIT;
   END


   SELECT DOCTO.doctorefid FROM DOCTO WHERE ID = :DOCTODEVOLUCIONID INTO :DOCTOVENTAID;

   IF(COALESCE(:DOCTOVENTAID,0) = 0) THEN
   BEGIN
    ERRORCODE = 1001;
    SUSPEND;
    EXIT;
   END

   SELECT DOCTO.factconsid FROM DOCTO
   WHERE ID = :DOCTOVENTAID
   INTO :DOCTOFACTCONSID;

       
   IF(COALESCE(:DOCTOFACTCONSID,0) = 0) THEN
   BEGIN
    ERRORCODE = 1001;
    SUSPEND;
    EXIT;
   END


  SELECT PARAMETRO.sucursalid, COALESCE(PARAMETRO.clienteconsolidadoid,1) FROM PARAMETRO  INTO :SUCURSALID, :CLIENTECONSOLIDADOID;





    TIPODOCTOID = 702;

   -- Agrega el DOCTO.
   INSERT INTO DOCTO
    (ALMACENID, SUCURSALID, TIPODOCTOID, ESTATUSDOCTOID, ESTATUSDOCTOPAGOID,
    PERSONAID, CAJEROID, VENDEDORID, CORTEID, FECHA, FECHAHORA, SERIE, FOLIO,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    CAJAID, REFERENCIA, REFERENCIAS, SUCURSALTID, ALMACENTID, PROMOCION, IEPS, IMPUESTO, DOCTOREFID, DOCTOREFID2)
   SELECT ALMACENID, SUCURSALID, :TIPODOCTOID, 0, 0,
    :CLIENTECONSOLIDADOID, 0, :VENDEDORID, :CORTEID, CURRENT_DATE, CURRENT_TIMESTAMP, NULL, NULL,
    PLAZO, VENCE, IMPORTE, DESCUENTO, SUBTOTAL, IVA, TOTAL, CARGO, ABONO, SALDO,
    1, 'FACTURA CONSOLIDADA', 'FACTURA CONSOLIDADA', NULL, NULL, 'N', IEPS, IMPUESTO , :DOCTOFACTCONSID ,  :DOCTODEVOLUCIONID
    FROM DOCTO WHERE ID = :DOCTODEVOLUCIONID
    RETURNING ID INTO :DOCTOID;


    UPDATE DOCTO SET DOCTO.devconsid = :DOCTOID WHERE ID = :DOCTODEVOLUCIONID;




   -- Completa el documento.
   SELECT ERRORCODE
   FROM DOCTO_SAVE (:DOCTOID)
   INTO :ERRORCODE;

   
   IF(COALESCE(:ERRORCODE,0) <> 0) THEN
   BEGIN    
      SUSPEND;
      EXIT;
   END

   ERRORCODE = 0;
   SUSPEND;


   WHEN ANY DO
    BEGIN
        ERRORCODE = 1009;
        SUSPEND;
    END
END